"use strict";const e=e=>null==e,t=(t,n,l)=>e(t)?null==l?void 0:l():n(t),n=e=>Array.isArray(e),l=e=>e.length,o=e=>{throw Error(e)},r=(e,t)=>e.forEach(t),u=(e,...t)=>e.push(...t),i=e=>e.shift(),a=Object,s=e=>a.getPrototypeOf(e),c=a.entries,d=a.keys,v=a.freeze,y=(e=[])=>a.fromEntries(e),h=(e,n)=>t(e,(e=>e[n])),p=(e,t)=>t in e,f=(e,t)=>(delete e[t],e),g=(e,t)=>y(((e,t)=>((e,t)=>e.map(t))(c(e),(([e,n])=>t(n,e))))(e,((e,n)=>[n,t(e,n)]))),b=e=>l(d(e)),m=n=>(n=>!e(n)&&t(s(n),(t=>t==a.prototype||e(s(t))),(()=>!0)))(n)&&0==b(n),C=(e,t,n)=>(p(e,t)||(e[t]=n()),e[t]),S=t=>e(t)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(t),w=(e,t)=>null==e?void 0:e.forEach(t),A=(e,t)=>null==e?void 0:e.delete(t),P=e=>new Map(e),L=(e,t)=>null==e?void 0:e.get(t),O=(t,n,l)=>e(l)?(A(t,n),t):null==t?void 0:t.set(n,l),M=(e,t,n,l)=>{var o,r,u;return r=t,null!=(u=null==(o=e)?void 0:o.has(r))&&u?null==l||l(L(e,t)):O(e,t,n()),L(e,t)},j=(e,n,o,r,u=0)=>t((o?M:L)(e,n[u],u>l(n)-2?o:P),(t=>{if(u>l(n)-2)return(null==r?void 0:r(t))&&O(e,n[u]),t;const i=j(t,n,o,r,u+1);return S(t)&&O(e,n[u]),i})),x=t=>new Set(n(t)||e(t)?t:[t]),E=/^\d+$/;var D=Object.defineProperty,T=Object.getOwnPropertySymbols,z=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,F=(e,t,n)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,H=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},u=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,u);i((n=n.apply(e,t)).next())}));const I=P(),$=P(),q=(a,s,c,d,y,h,p,f={},g=0,b=[])=>{let C,D,q,B=0,G=0,J=0;M(I,b,(()=>0)),M($,b,(()=>[]));const K=P(),[N,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!m(e)||!m(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!m(e)||!m(t),t.setContent]:o("Store type not supported by this Persister"))(p,a,g),[W,X,Y]=(()=>{let n;const[o,a]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?i(e):null)?l:""+t++},t=>{E.test(t)&&l(e)<1e3&&u(e,t)}]})(),s=P();return[(e,t,l,r=[],u=()=>[])=>{null!=n||(n=re);const i=o(1);var a,c;return O(s,i,[e,t,l,r,u]),c=i,null==(a=j(t,null!=l?l:[""],x))||a.add(c),i},(e,t,...o)=>r(((e,t=[""])=>{const n=[],o=(e,i)=>i==l(t)?u(n,e):null===t[i]?w(e,(e=>o(e,i+1))):r([t[i],null],(t=>o(L(e,t),i+1)));return o(e,0),n})(e,t),(e=>w(e,(e=>L(s,e)[0](n,...null!=t?t:[],...o))))),e=>t(L(s,e),(([,t,n])=>(j(t,null!=n?n:[""],void 0,(t=>(A(t,e),S(t)?1:0))),O(s,e),a(e),n))),o=>t(L(s,o),(([t,,o=[],u,i])=>{const a=(...s)=>{var c,d;const v=l(s);v==l(o)?t(n,...s,...i(s)):e(o[v])?r(null!=(d=null==(c=u[v])?void 0:c.call(u,...s))?d:[],(e=>a(...s,e))):a(...s,o[v])};a()}))]})(),Z=e=>{e!=B&&(B=e,X(K,void 0,B))},_=e=>{(N&&n(null==e?void 0:e[0])?1===(null==e?void 0:e[2])?a.applyMergeableChanges:a.setMergeableContent:1===(null==e?void 0:e[2])?a.applyChanges:a.setContent)(e)},ee=e=>H(void 0,null,(function*(){return 2!=B&&(Z(1),G++,yield oe((()=>H(void 0,null,(function*(){try{const t=yield s();n(t)?_(t):e?V(e):o("Content is not an array: "+t)}catch(t){null==h||h(t),e&&V(e)}Z(0)}))))),re})),te=()=>(D&&(y(D),D=void 0),re),ne=e=>H(void 0,null,(function*(){return 1!=B&&(Z(2),J++,yield oe((()=>H(void 0,null,(function*(){try{yield c(Q,e)}catch(e){null==h||h(e)}Z(0)}))))),re})),le=()=>(q&&(a.delListener(q),q=void 0),re),oe=(...t)=>H(void 0,null,(function*(){return u(L($,b),...t),yield H(void 0,null,(function*(){if(!L(I,b)){for(O(I,b,1);!e(C=i(L($,b)));)try{yield C()}catch(e){null==h||h(e)}O(I,b,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))z.call(t,n)&&F(e,n,t[n]);if(T)for(var n of T(t))k.call(t,n)&&F(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>H(void 0,null,(function*(){te(),yield ee(e);try{D=yield d(((e,t)=>H(void 0,null,(function*(){t||e?2!=B&&(Z(1),G++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==h||h(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!e(D),save:ne,startAutoSave:()=>H(void 0,null,(function*(){return le(),yield ne(),q=a.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!e(q),getStatus:()=>B,addStatusListener:e=>W(e,K),delListener:e=>(Y(e),a),schedule:oe,getStore:()=>a,destroy:()=>(L($,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:G,saves:J})},f);return v(re)};var B=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},u=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,u);i((n=n.apply(e,t)).next())}));const G=(e,t)=>[e[t].t,e[t].v],J=(t,n,l,o)=>{const r=e(n)?t:C(t,n,(()=>({})));let u;return g(l,((e,t)=>{o(r,t,e)&&(u=1)})),g(r,((e,t)=>{p(l,t)||(f(r,t),u=1)})),!e(n)&&m(r)&&f(t,n),u};exports.createAutomergePersister=(n,l,o="tinybase",r)=>(l.change((e=>C(e,o,y))),q(n,(()=>B(void 0,null,(function*(){const e=yield l.doc();return 2==b(null==e?void 0:e[o])?G(e,o):void 0}))),((n,r)=>B(void 0,null,(function*(){return l.change((l=>((n,l,o,r)=>{((e,t)=>{m(e[t])&&(e[t]={t:{},v:{}})})(n,l);const[u,i]=G(n,l),a=()=>{s=1};let s=1;if(t(r,(([n,l])=>{s=0,g(n,((n,l)=>s?0:e(n)?f(u,l):t(u[l],(l=>g(n,((n,o)=>s?0:e(n)?f(l,o):t(h(l,o),(t=>g(n,((n,l)=>e(n)?f(t,l):t[l]=n))),a)))),a))),g(l,((t,n)=>s?0:e(t)?f(i,n):i[n]=t))})),s){const[e,t]=o();J(u,void 0,e,((e,t,n)=>J(u,t,n,((e,t,n)=>J(e,t,n,((e,t,n)=>{if(h(e,t)!==n)return e[t]=n,1})))))),J(i,void 0,t,((e,t,n)=>{h(i,t)!==n&&(i[t]=n)}))}})(l,o,n,r)))}))),(e=>{const t=({doc:t})=>e(G(t,o));return l.on("change",t),t}),(e=>{l.removeListener("change",e)}),r,1,{getDocHandle:()=>l}));
