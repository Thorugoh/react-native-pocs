"use strict";const e=globalThis.window,t=e=>null==e,n=(e,n,r)=>t(e)?null==r?void 0:r():n(e),r=e=>Array.isArray(e),l=e=>e.length,o=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),i=(e,...t)=>e.push(...t),u=e=>e.shift(),s=Object,d=e=>s.getPrototypeOf(e),c=s.keys,v=s.freeze,y=e=>(e=>!t(e)&&n(d(e),(e=>e==s.prototype||t(d(e))),(()=>!0)))(e)&&0==(e=>l(c(e)))(e),g=JSON.stringify,p=JSON.parse,h=e=>t(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),f=(e,t)=>null==e?void 0:e.forEach(t),b=(e,t)=>null==e?void 0:e.delete(t),S=e=>new Map(e),w=(e,t)=>null==e?void 0:e.get(t),m=(e,n,r)=>t(r)?(b(e,n),e):null==e?void 0:e.set(n,r),C=(e,t,n,r)=>{var l,o,a;return o=t,null!=(a=null==(l=e)?void 0:l.has(o))&&a?null==r||r(w(e,t)):m(e,t,n()),w(e,t)},P=(e,t,r,o,a=0)=>n((r?C:w)(e,t[a],a>l(t)-2?r:S),(n=>{if(a>l(t)-2)return(null==o?void 0:o(n))&&m(e,t[a]),n;const i=P(n,t,r,o,a+1);return h(n)&&m(e,t[a]),i})),A=e=>new Set(r(e)||t(e)?e:[e]),L=/^\d+$/;var O=Object.defineProperty,x=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable,j=(e,t,n)=>t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,T=(e,t,n)=>new Promise(((r,l)=>{var o=e=>{try{i(n.next(e))}catch(e){l(e)}},a=e=>{try{i(n.throw(e))}catch(e){l(e)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,a);i((n=n.apply(e,t)).next())}));const I=S(),N=S(),k=(e,s,d,c,g,p,O,k={},z=0,D=[])=>{let J,F,V,$=0,q=0,B=0;C(I,D,(()=>0)),C(N,D,(()=>[]));const G=S(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!y(e)||!y(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!y(e)||!y(t),t.setContent]:o("Store type not supported by this Persister"))(O,e,z),[W,X,Y]=(()=>{let e;const[r,o]=(()=>{const e=[];let t=0;return[n=>{var r;return null!=(r=n?u(e):null)?r:""+t++},t=>{L.test(t)&&l(e)<1e3&&i(e,t)}]})(),s=S();return[(t,n,l,o=[],a=()=>[])=>{null!=e||(e=oe);const i=r(1);var u,d;return m(s,i,[t,n,l,o,a]),d=i,null==(u=P(n,null!=l?l:[""],A))||u.add(d),i},(t,n,...r)=>a(((e,t=[""])=>{const n=[],r=(e,o)=>o==l(t)?i(n,e):null===t[o]?f(e,(e=>r(e,o+1))):a([t[o],null],(t=>r(w(e,t),o+1)));return r(e,0),n})(t,n),(t=>f(t,(t=>w(s,t)[0](e,...null!=n?n:[],...r))))),e=>n(w(s,e),(([,t,n])=>(P(t,null!=n?n:[""],void 0,(t=>(b(t,e),h(t)?1:0))),m(s,e),o(e),n))),r=>n(w(s,r),(([n,,r=[],o,i])=>{const u=(...s)=>{var d,c;const v=l(s);v==l(r)?n(e,...s,...i(s)):t(r[v])?a(null!=(c=null==(d=o[v])?void 0:d.call(o,...s))?c:[],(e=>u(...s,e))):u(...s,r[v])};u()}))]})(),Z=e=>{e!=$&&($=e,X(G,void 0,$))},_=t=>{(H&&r(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>T(void 0,null,(function*(){return 2!=$&&(Z(1),q++,yield le((()=>T(void 0,null,(function*(){try{const t=yield s();r(t)?_(t):e?U(e):o("Content is not an array: "+t)}catch(t){null==p||p(t),e&&U(e)}Z(0)}))))),oe})),te=()=>(F&&(g(F),F=void 0),oe),ne=e=>T(void 0,null,(function*(){return 1!=$&&(Z(2),B++,yield le((()=>T(void 0,null,(function*(){try{yield d(K,e)}catch(e){null==p||p(e)}Z(0)}))))),oe})),re=()=>(V&&(e.delListener(V),V=void 0),oe),le=(...e)=>T(void 0,null,(function*(){return i(w(N,D),...e),yield T(void 0,null,(function*(){if(!w(I,D)){for(m(I,D,1);!t(J=u(w(N,D)));)try{yield J()}catch(e){null==p||p(e)}m(I,D,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))E.call(t,n)&&j(e,n,t[n]);if(x)for(var n of x(t))M.call(t,n)&&j(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>T(void 0,null,(function*(){te(),yield ee(e);try{F=yield c(((e,t)=>T(void 0,null,(function*(){t||e?2!=$&&(Z(1),q++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==p||p(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!t(F),save:ne,startAutoSave:()=>T(void 0,null,(function*(){return re(),yield ne(),V=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),oe})),stopAutoSave:re,isAutoSaving:()=>!t(V),getStatus:()=>$,addStatusListener:e=>W(e,G),delListener:t=>(Y(t),e),schedule:le,getStore:()=>e,destroy:()=>(w(N,D).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:q,saves:B})},k);return v(oe)};var z=(e,t,n)=>new Promise(((r,l)=>{var o=e=>{try{i(n.next(e))}catch(e){l(e)}},a=e=>{try{i(n.throw(e))}catch(e){l(e)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,a);i((n=n.apply(e,t)).next())}));const D="storage",J=(t,n,r,l)=>k(t,(()=>z(void 0,null,(function*(){return e=r.getItem(n),p(e,((e,t)=>"￼"===t?void 0:t));var e}))),(e=>z(void 0,null,(function*(){return r.setItem(n,(t=e(),g(t,((e,t)=>void 0===t?"￼":t))));var t}))),(t=>{const l=e=>{if(e.storageArea===r&&e.key===n)try{t(p(e.newValue))}catch(e){t()}};return e.addEventListener(D,l),l}),(t=>e.removeEventListener(D,t)),l,3,{getStorageName:()=>n});exports.createLocalPersister=(e,t,n)=>J(e,t,localStorage,n),exports.createSessionPersister=(e,t,n)=>J(e,t,sessionStorage,n);
