"use strict";const t="t",e="v",n=t=>null==t,l=(t,e,l)=>n(t)?null==l?void 0:l():e(t),r=t=>Array.isArray(t),o=(t,e,n)=>t.slice(e,n),i=t=>t.length,u=t=>{throw Error(t)},s=(t,e)=>t.forEach(e),a=(t,...e)=>t.push(...e),c=t=>t.shift(),d=Object,v=t=>d.getPrototypeOf(t),y=d.entries,p=d.keys,f=d.freeze,h=(t,e)=>s(y(t),(([t,n])=>e(n,t))),g=t=>(t=>!n(t)&&l(v(t),(t=>t==d.prototype||n(v(t))),(()=>!0)))(t)&&0==(t=>i(p(t)))(t),b=(t,e,n)=>(((t,e)=>e in t)(t,e)||(t[e]=n()),t[e]),S=t=>n(t)||0==(t=>{var e;return null!=(e=null==t?void 0:t.size)?e:0})(t),C=(t,e)=>null==t?void 0:t.forEach(e),O=(t,e)=>null==t?void 0:t.delete(e),w=t=>new Map(t),P=(t,e)=>null==t?void 0:t.get(e),A=(t,e,l)=>n(l)?(O(t,e),t):null==t?void 0:t.set(e,l),m=(t,e,n,l)=>{var r,o,i;return o=e,null!=(i=null==(r=t)?void 0:r.has(o))&&i?null==l||l(P(t,e)):A(t,e,n()),P(t,e)},L=(t,e,n,r,o=0)=>l((n?m:P)(t,e[o],o>i(e)-2?n:w),(l=>{if(o>i(e)-2)return(null==r?void 0:r(l))&&A(t,e[o]),l;const u=L(l,e,n,r,o+1);return S(l)&&A(t,e[o]),u})),j=(t,e,n)=>{e>t[1]&&(t[1]=e),t[2]=n>>>0},x=t=>new Set(r(t)||n(t)?t:[t]),M=/^\d+$/;var E=Object.defineProperty,D=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable,J=(t,e,n)=>e in t?E(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,N=(t,e,n)=>new Promise(((l,r)=>{var o=t=>{try{u(n.next(t))}catch(t){r(t)}},i=t=>{try{u(n.throw(t))}catch(t){r(t)}},u=t=>t.done?l(t.value):Promise.resolve(t.value).then(o,i);u((n=n.apply(t,e)).next())}));const k=w(),F=w(),I=(t,e,o,d,v,y,p,h={},b=0,j=[])=>{let E,I,W,$=0,q=0,B=0;m(k,j,(()=>0)),m(F,j,(()=>[]));const G=w(),[H,K,Q,R,U]=((t=1,e,n)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!n),([[t],[e]])=>!g(t)||!g(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!g(t)||!g(e),e.setContent]:u("Store type not supported by this Persister"))(p,t,b),[V,X,Y]=(()=>{let t;const[e,r]=(()=>{const t=[];let e=0;return[n=>{var l;return null!=(l=n?c(t):null)?l:""+e++},e=>{M.test(e)&&i(t)<1e3&&a(t,e)}]})(),o=w();return[(n,l,r,i=[],u=()=>[])=>{null!=t||(t=ot);const s=e(1);var a,c;return A(o,s,[n,l,r,i,u]),c=s,null==(a=L(l,null!=r?r:[""],x))||a.add(c),s},(e,n,...l)=>s(((t,e=[""])=>{const n=[],l=(t,r)=>r==i(e)?a(n,t):null===e[r]?C(t,(t=>l(t,r+1))):s([e[r],null],(e=>l(P(t,e),r+1)));return l(t,0),n})(e,n),(e=>C(e,(e=>P(o,e)[0](t,...null!=n?n:[],...l))))),t=>l(P(o,t),(([,e,n])=>(L(e,null!=n?n:[""],void 0,(e=>(O(e,t),S(e)?1:0))),A(o,t),r(t),n))),e=>l(P(o,e),(([e,,l=[],r,o])=>{const u=(...a)=>{var c,d;const v=i(a);v==i(l)?e(t,...a,...o(a)):n(l[v])?s(null!=(d=null==(c=r[v])?void 0:c.call(r,...a))?d:[],(t=>u(...a,t))):u(...a,l[v])};u()}))]})(),Z=t=>{t!=$&&($=t,X(G,void 0,$))},_=e=>{(H&&r(null==e?void 0:e[0])?1===(null==e?void 0:e[2])?t.applyMergeableChanges:t.setMergeableContent:1===(null==e?void 0:e[2])?t.applyChanges:t.setContent)(e)},tt=t=>N(void 0,null,(function*(){return 2!=$&&(Z(1),q++,yield rt((()=>N(void 0,null,(function*(){try{const n=yield e();r(n)?_(n):t?U(t):u("Content is not an array: "+n)}catch(e){null==y||y(e),t&&U(t)}Z(0)}))))),ot})),et=()=>(I&&(I=void 0),ot),nt=t=>N(void 0,null,(function*(){return 1!=$&&(Z(2),B++,yield rt((()=>N(void 0,null,(function*(){try{yield o(K,t)}catch(t){null==y||y(t)}Z(0)}))))),ot})),lt=()=>(W&&(t.delListener(W),W=void 0),ot),rt=(...t)=>N(void 0,null,(function*(){return a(P(F,j),...t),yield N(void 0,null,(function*(){if(!P(k,j)){for(A(k,j,1);!n(E=c(P(F,j)));)try{yield E()}catch(t){null==y||y(t)}A(k,j,0)}})),ot})),ot=((t,e)=>{for(var n in e||(e={}))T.call(e,n)&&J(t,n,e[n]);if(D)for(var n of D(e))z.call(e,n)&&J(t,n,e[n]);return t})({load:tt,startAutoLoad:t=>N(void 0,null,(function*(){et(),yield tt(t);try{I=yield d(((t,e)=>N(void 0,null,(function*(){e||t?2!=$&&(Z(1),q++,_(null!=e?e:t),Z(0)):yield tt()}))))}catch(t){null==y||y(t)}return ot})),stopAutoLoad:et,isAutoLoading:()=>!n(I),save:nt,startAutoSave:()=>N(void 0,null,(function*(){return lt(),yield nt(),W=t.addDidFinishTransactionListener((()=>{const t=Q();R(t)&&nt(t)})),ot})),stopAutoSave:lt,isAutoSaving:()=>!n(W),getStatus:()=>$,addStatusListener:t=>V(t,G),delListener:e=>(Y(e),t),schedule:rt,getStore:()=>t,destroy:()=>(P(F,j).splice(0,void 0),et().stopAutoSave()),getStats:()=>({loads:q,saves:B})},h);return f(ot)},W=JSON.stringify;var $=(t,e,n)=>new Promise(((l,r)=>{var o=t=>{try{u(n.next(t))}catch(t){r(t)}},i=t=>{try{u(n.throw(t))}catch(t){r(t)}},u=t=>t.done?l(t.value):Promise.resolve(t.value).then(o,i);u((n=n.apply(t,e)).next())}));const q=()=>[{},"",0];exports.createDurableObjectStoragePersister=(n,r,i="",u)=>{const s=(t,...e)=>i+t+o(W(e,((t,e)=>void 0===e?"ï¿¼":e)),1,-1);return I(n,(()=>$(void 0,null,(function*(){const n=[{},"",0],u=[{},"",0];return(yield r.list({prefix:i})).forEach(((r,s)=>$(void 0,[r,s],(function*([r,s,a],c){return l((n=>{if(l=i,n.startsWith(l)){const l=o(n,i.length,1);return l==t||l==e?[l,...JSON.parse("["+o(n,i.length+1)+"]")]:void 0}var l})(c),(([o,...i])=>o==t?l(i[0],(t=>{const e=b(n[0],t,q);l(i[1],(t=>{const n=b(e[0],t,q);l(i[2],(t=>n[0][t]=[r,s,a]),(()=>j(n,s,a)))}),(()=>j(e,s,a)))}),(()=>j(n,s,a))):o==e?l(i[0],(t=>u[0][t]=[r,s,a]),(()=>j(u,s,a))):0))})))),[n,u]}))),((n,...l)=>$(void 0,[n,...l],(function*(n,[[l,o,i],[u,a,c]]=n()){const d=w();A(d,s(t),[0,o,i]),h(l,(([e,n,l],r)=>{A(d,s(t,r),[0,n,l]),h(e,(([e,n,l],o)=>{A(d,s(t,r,o),[0,n,l]),h(e,((e,n)=>A(d,s(t,r,o,n),e)))}))})),A(d,s(e),[0,a,c]),h(u,((t,n)=>A(d,s(e,n),t))),yield r.put((t=>{const e={};return C(t,((t,n)=>{{const l=t;e[n]=l}})),e})(d))}))),(()=>{}),0,u,2,{getStorage:()=>r})};
