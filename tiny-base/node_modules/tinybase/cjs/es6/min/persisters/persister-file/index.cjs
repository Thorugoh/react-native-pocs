"use strict";var e=require("fs"),t=require("fs/promises");const n="utf8",l=e=>null==e,r=(e,t,n)=>l(e)?null==n?void 0:n():t(e),o=e=>Array.isArray(e),i=e=>e.length,u=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),s=(e,...t)=>e.push(...t),d=e=>e.shift(),c=Object,v=e=>c.getPrototypeOf(e),y=c.keys,p=c.freeze,f=e=>(e=>!l(e)&&r(v(e),(e=>e==c.prototype||l(v(e))),(()=>!0)))(e)&&0==(e=>i(y(e)))(e),h=JSON.stringify,g=JSON.parse,b=e=>l(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),S=(e,t)=>null==e?void 0:e.forEach(t),w=(e,t)=>null==e?void 0:e.delete(t),C=e=>new Map(e),P=(e,t)=>null==e?void 0:e.get(t),O=(e,t,n)=>l(n)?(w(e,t),e):null==e?void 0:e.set(t,n),A=(e,t,n,l)=>{var r,o,i;return o=t,null!=(i=null==(r=e)?void 0:r.has(o))&&i?null==l||l(P(e,t)):O(e,t,n()),P(e,t)},m=(e,t,n,l,o=0)=>r((n?A:P)(e,t[o],o>i(t)-2?n:C),(r=>{if(o>i(t)-2)return(null==l?void 0:l(r))&&O(e,t[o]),r;const u=m(r,t,n,l,o+1);return b(r)&&O(e,t[o]),u})),L=e=>new Set(o(e)||l(e)?e:[e]),x=/^\d+$/;var F=Object.defineProperty,M=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,T=(e,t,n)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,q=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));const z=C(),D=C(),J=(e,t,n,c,v,y,h,g={},F=0,J=[])=>{let N,k,I,$=0,B=0,G=0;A(z,J,(()=>0)),A(D,J,(()=>[]));const H=C(),[K,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!f(e)||!f(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!f(e)||!f(t),t.setContent]:u("Store type not supported by this Persister"))(h,e,F),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?d(e):null)?l:""+t++},t=>{x.test(t)&&i(e)<1e3&&s(e,t)}]})(),o=C();return[(n,l,r,i=[],u=()=>[])=>{null!=e||(e=oe);const a=t(1);var s,d;return O(o,a,[n,l,r,i,u]),d=a,null==(s=m(l,null!=r?r:[""],L))||s.add(d),a},(t,n,...l)=>a(((e,t=[""])=>{const n=[],l=(e,r)=>r==i(t)?s(n,e):null===t[r]?S(e,(e=>l(e,r+1))):a([t[r],null],(t=>l(P(e,t),r+1)));return l(e,0),n})(t,n),(t=>S(t,(t=>P(o,t)[0](e,...null!=n?n:[],...l))))),e=>r(P(o,e),(([,t,l])=>(m(t,null!=l?l:[""],void 0,(t=>(w(t,e),b(t)?1:0))),O(o,e),n(e),l))),t=>r(P(o,t),(([t,,n=[],r,o])=>{const u=(...s)=>{var d,c;const v=i(s);v==i(n)?t(e,...s,...o(s)):l(n[v])?a(null!=(c=null==(d=r[v])?void 0:d.call(r,...s))?c:[],(e=>u(...s,e))):u(...s,n[v])};u()}))]})(),Z=e=>{e!=$&&($=e,X(H,void 0,$))},_=t=>{(K&&o(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>q(void 0,null,(function*(){return 2!=$&&(Z(1),B++,yield re((()=>q(void 0,null,(function*(){try{const n=yield t();o(n)?_(n):e?V(e):u("Content is not an array: "+n)}catch(t){null==y||y(t),e&&V(e)}Z(0)}))))),oe})),te=()=>(k&&(v(k),k=void 0),oe),ne=e=>q(void 0,null,(function*(){return 1!=$&&(Z(2),G++,yield re((()=>q(void 0,null,(function*(){try{yield n(Q,e)}catch(e){null==y||y(e)}Z(0)}))))),oe})),le=()=>(I&&(e.delListener(I),I=void 0),oe),re=(...e)=>q(void 0,null,(function*(){return s(P(D,J),...e),yield q(void 0,null,(function*(){if(!P(z,J)){for(O(z,J,1);!l(N=d(P(D,J)));)try{yield N()}catch(e){null==y||y(e)}O(z,J,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))j.call(t,n)&&T(e,n,t[n]);if(M)for(var n of M(t))E.call(t,n)&&T(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>q(void 0,null,(function*(){te(),yield ee(e);try{k=yield c(((e,t)=>q(void 0,null,(function*(){t||e?2!=$&&(Z(1),B++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==y||y(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!l(k),save:ne,startAutoSave:()=>q(void 0,null,(function*(){return le(),yield ne(),I=e.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!l(I),getStatus:()=>$,addStatusListener:e=>W(e,H),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(P(D,J).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:B,saves:G})},g);return p(oe)};var N=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));exports.createFilePersister=(l,r,o)=>J(l,(()=>N(void 0,null,(function*(){return e=yield t.readFile(r,n),g(e,((e,t)=>"ï¿¼"===t?void 0:t));var e}))),(e=>N(void 0,null,(function*(){return yield t.writeFile(r,(l=e(),h(l,((e,t)=>void 0===t?"ï¿¼":t))),n);var l}))),(t=>(e.existsSync(r)||e.writeFileSync(r,"",n),e.watch(r,(()=>t())))),(e=>null==e?void 0:e.close()),o,3,{getFilePath:()=>r});
