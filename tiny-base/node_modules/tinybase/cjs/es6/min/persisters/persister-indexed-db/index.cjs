"use strict";const e=Promise,t=globalThis.window,n=clearInterval,r=e=>null==e,l=(e,t,n)=>r(e)?null==n?void 0:n():t(e),o=e=>Array.isArray(e),u=e=>e.length,i=t=>new e(t),a=t=>{return n=function*(){return e.all(t)},new Promise(((e,t)=>{var r=e=>{try{o(n.next(e))}catch(e){t(e)}},l=e=>{try{o(n.throw(e))}catch(e){t(e)}},o=t=>t.done?e(t.value):Promise.resolve(t.value).then(r,l);o((n=n.apply(void 0,null)).next())}));var n},s=e=>{throw Error(e)},c=(e,t)=>e.forEach(t),d=(e,t)=>e.map(t),v=(e,...t)=>e.push(...t),y=e=>e.shift(),p=Object,h=e=>p.getPrototypeOf(e),f=p.entries,g=p.keys,b=p.freeze,w=e=>(e=>!r(e)&&l(h(e),(e=>e==p.prototype||r(h(e))),(()=>!0)))(e)&&0==(e=>u(g(e)))(e),S=e=>r(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),P=(e,t)=>null==e?void 0:e.forEach(t),m=(e,t)=>null==e?void 0:e.delete(t),x=e=>new Map(e),A=(e,t)=>null==e?void 0:e.get(t),C=(e,t,n)=>r(n)?(m(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,r)=>{var l,o,u;return o=t,null!=(u=null==(l=e)?void 0:l.has(o))&&u?null==r||r(A(e,t)):C(e,t,n()),A(e,t)},O=(e,t,n,r,o=0)=>l((n?j:A)(e,t[o],o>u(t)-2?n:x),(l=>{if(o>u(t)-2)return(null==r?void 0:r(l))&&C(e,t[o]),l;const i=O(l,t,n,r,o+1);return S(l)&&C(e,t[o]),i})),D=e=>new Set(o(e)||r(e)?e:[e]),L=/^\d+$/;var M=Object.defineProperty,k=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,T=(e,t,n)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,B=(e,t,n)=>new Promise(((r,l)=>{var o=e=>{try{i(n.next(e))}catch(e){l(e)}},u=e=>{try{i(n.throw(e))}catch(e){l(e)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,u);i((n=n.apply(e,t)).next())}));const z=x(),$=x(),F=(e,t,n,i,a,d,p,h={},f=0,g=[])=>{let M,F,K,N=0,q=0,G=0;j(z,g,(()=>0)),j($,g,(()=>[]));const H=x(),[J,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!w(e)||!w(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!w(e)||!w(t),t.setContent]:s("Store type not supported by this Persister"))(p,e,f),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var r;return null!=(r=n?y(e):null)?r:""+t++},t=>{L.test(t)&&u(e)<1e3&&v(e,t)}]})(),o=x();return[(n,r,l,u=[],i=()=>[])=>{null!=e||(e=oe);const a=t(1);var s,c;return C(o,a,[n,r,l,u,i]),c=a,null==(s=O(r,null!=l?l:[""],D))||s.add(c),a},(t,n,...r)=>c(((e,t=[""])=>{const n=[],r=(e,l)=>l==u(t)?v(n,e):null===t[l]?P(e,(e=>r(e,l+1))):c([t[l],null],(t=>r(A(e,t),l+1)));return r(e,0),n})(t,n),(t=>P(t,(t=>A(o,t)[0](e,...null!=n?n:[],...r))))),e=>l(A(o,e),(([,t,r])=>(O(t,null!=r?r:[""],void 0,(t=>(m(t,e),S(t)?1:0))),C(o,e),n(e),r))),t=>l(A(o,t),(([t,,n=[],l,o])=>{const i=(...a)=>{var s,d;const v=u(a);v==u(n)?t(e,...a,...o(a)):r(n[v])?c(null!=(d=null==(s=l[v])?void 0:s.call(l,...a))?d:[],(e=>i(...a,e))):i(...a,n[v])};i()}))]})(),Z=e=>{e!=N&&(N=e,X(H,void 0,N))},_=t=>{(J&&o(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>B(void 0,null,(function*(){return 2!=N&&(Z(1),q++,yield le((()=>B(void 0,null,(function*(){try{const n=yield t();o(n)?_(n):e?V(e):s("Content is not an array: "+n)}catch(t){null==d||d(t),e&&V(e)}Z(0)}))))),oe})),te=()=>(F&&(a(F),F=void 0),oe),ne=e=>B(void 0,null,(function*(){return 1!=N&&(Z(2),G++,yield le((()=>B(void 0,null,(function*(){try{yield n(Q,e)}catch(e){null==d||d(e)}Z(0)}))))),oe})),re=()=>(K&&(e.delListener(K),K=void 0),oe),le=(...e)=>B(void 0,null,(function*(){return v(A($,g),...e),yield B(void 0,null,(function*(){if(!A(z,g)){for(C(z,g,1);!r(M=y(A($,g)));)try{yield M()}catch(e){null==d||d(e)}C(z,g,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))E.call(t,n)&&T(e,n,t[n]);if(k)for(var n of k(t))I.call(t,n)&&T(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>B(void 0,null,(function*(){te(),yield ee(e);try{F=yield i(((e,t)=>B(void 0,null,(function*(){t||e?2!=N&&(Z(1),q++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==d||d(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!r(F),save:ne,startAutoSave:()=>B(void 0,null,(function*(){return re(),yield ne(),K=e.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),oe})),stopAutoSave:re,isAutoSaving:()=>!r(K),getStatus:()=>N,addStatusListener:e=>W(e,H),delListener:t=>(Y(t),e),schedule:le,getStore:()=>e,destroy:()=>(A($,g).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:q,saves:G})},h);return b(oe)};var K=(e,t,n)=>new Promise(((r,l)=>{var o=e=>{try{i(n.next(e))}catch(e){l(e)}},u=e=>{try{i(n.throw(e))}catch(e){l(e)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,u);i((n=n.apply(e,t)).next())}));const N=["t","v"],q={keyPath:"k"},G=(e,t)=>K(void 0,null,(function*(){const n=(t=>d(f(t),(([t,n])=>H(e,"put",{k:t,v:n}))))(t);d(yield H(e,"getAllKeys"),(r=>((e,t)=>t in e)(t,r)?0:v(n,H(e,"delete",r)))),yield a(n)})),H=(e,t,n)=>K(void 0,null,(function*(){return i(((r,l)=>{const o=e[t](n);o.onsuccess=()=>r(o.result),o.onerror=()=>l(`objectStore.${t} error`)}))}));exports.createIndexedDbPersister=(e,r,l=1,o)=>{const u=(e,...n)=>K(void 0,[e,...n],(function*(e,n=[],l=0){return i(((o,u)=>{const i=(t?t.indexedDB:indexedDB).open(r,l?2:void 0);i.onupgradeneeded=()=>l&&d(N,(e=>{try{i.result.createObjectStore(e,q)}catch(e){}})),i.onsuccess=()=>K(void 0,null,(function*(){try{const t=i.result.transaction(N,"readwrite"),r=yield a(d(N,((r,l)=>K(void 0,null,(function*(){return yield e(t.objectStore(r),n[l])})))));i.result.close(),o(r)}catch(e){i.result.close(),u(e)}})),i.onerror=()=>u("indexedDB.open error")}))}));return F(e,(()=>K(void 0,null,(function*(){return yield u((e=>K(void 0,null,(function*(){return((e=[])=>p.fromEntries(e))(d(yield H(e,"getAll"),(({k:e,v:t})=>[e,t])))}))))}))),(e=>K(void 0,null,(function*(){return yield u(((e,t)=>K(void 0,null,(function*(){return yield G(e,t)}))),e(),1)}))),(e=>setInterval(e,1e3*l)),(e=>n(e)),o,1,{getDbName:()=>r})},exports.objectStoreMatch=G;
