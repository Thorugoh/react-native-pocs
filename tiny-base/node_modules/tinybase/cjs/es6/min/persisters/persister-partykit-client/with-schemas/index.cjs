"use strict";const e=e=>typeof e,t="",n=e(t),r="message",o=e=>null==e,l=(e,t,n)=>o(e)?null==n?void 0:n():t(e),i=t=>e(t)==n,a=e=>Array.isArray(e),s=e=>e.length,u=e=>{throw Error(e)},c=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),v=e=>e.shift(),y=Object,p=e=>y.getPrototypeOf(e),f=y.keys,h=y.freeze,g=e=>(e=>!o(e)&&l(p(e),(e=>e==y.prototype||o(p(e))),(()=>!0)))(e)&&0==(e=>s(f(e)))(e),b=JSON.stringify,P=JSON.parse,O=e=>b(e,((e,t)=>t instanceof Map?y.fromEntries([...t]):t)),m="/store",S=e=>o(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),w=(e,t)=>null==e?void 0:e.forEach(t),j=(e,t)=>null==e?void 0:e.delete(t),C=e=>new Map(e),A=(e,t)=>null==e?void 0:e.get(t),L=(e,t,n)=>o(n)?(j(e,t),e):null==e?void 0:e.set(t,n),E=(e,t,n,r)=>{var o,l,i;return l=t,null!=(i=null==(o=e)?void 0:o.has(l))&&i?null==r||r(A(e,t)):L(e,t,n()),A(e,t)},M=(e,t,n,r,o=0)=>l((n?E:A)(e,t[o],o>s(t)-2?n:C),(l=>{if(o>s(t)-2)return(null==r?void 0:r(l))&&L(e,t[o]),l;const i=M(l,t,n,r,o+1);return S(l)&&L(e,t[o]),i})),x=e=>new Set(a(e)||o(e)?e:[e]),T=/^\d+$/;var D=Object.defineProperty,k=Object.getOwnPropertySymbols,z=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,J=(e,t,n)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,N=(e,t,n)=>new Promise(((r,o)=>{var l=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,i);a((n=n.apply(e,t)).next())}));const F=C(),K=C(),U=(e,n,r,i,y,p,f,b={},P=0,O=[])=>{let m,D,U,W=0,$=0,q=0;E(F,O,(()=>0)),E(K,O,(()=>[]));const B=C(),[G,H,Q,R,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!g(e)||!g(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!g(e)||!g(t),t.setContent]:u("Store type not supported by this Persister"))(f,e,P),[X,Y,Z]=(()=>{let e;const[n,r]=(()=>{const e=[];let n=0;return[r=>{var o;return null!=(o=r?v(e):null)?o:t+n++},t=>{T.test(t)&&s(e)<1e3&&d(e,t)}]})(),i=C();return[(r,o,l,a=[],s=()=>[])=>{null!=e||(e=ie);const u=n(1);var c,d;return L(i,u,[r,o,l,a,s]),d=u,null==(c=M(o,null!=l?l:[t],x))||c.add(d),u},(n,r,...o)=>c(((e,n=[t])=>{const r=[],o=(e,t)=>t==s(n)?d(r,e):null===n[t]?w(e,(e=>o(e,t+1))):c([n[t],null],(n=>o(A(e,n),t+1)));return o(e,0),r})(n,r),(t=>w(t,(t=>A(i,t)[0](e,...null!=r?r:[],...o))))),e=>l(A(i,e),(([,n,o])=>(M(n,null!=o?o:[t],void 0,(t=>(j(t,e),S(t)?1:0))),L(i,e),r(e),o))),t=>l(A(i,t),(([t,,n=[],r,l])=>{const i=(...a)=>{var u,d;const v=s(a);v==s(n)?t(e,...a,...l(a)):o(n[v])?c(null!=(d=null==(u=r[v])?void 0:u.call(r,...a))?d:[],(e=>i(...a,e))):i(...a,n[v])};i()}))]})(),_=e=>{e!=W&&(W=e,Y(B,void 0,W))},ee=t=>{(G&&a(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},te=e=>N(void 0,null,(function*(){return 2!=W&&(_(1),$++,yield le((()=>N(void 0,null,(function*(){try{const t=yield n();a(t)?ee(t):e?V(e):u("Content is not an array: "+t)}catch(t){null==p||p(t),e&&V(e)}_(0)}))))),ie})),ne=()=>(D&&(y(D),D=void 0),ie),re=e=>N(void 0,null,(function*(){return 1!=W&&(_(2),q++,yield le((()=>N(void 0,null,(function*(){try{yield r(H,e)}catch(e){null==p||p(e)}_(0)}))))),ie})),oe=()=>(U&&(e.delListener(U),U=void 0),ie),le=(...e)=>N(void 0,null,(function*(){return d(A(K,O),...e),yield N(void 0,null,(function*(){if(!A(F,O)){for(L(F,O,1);!o(m=v(A(K,O)));)try{yield m()}catch(e){null==p||p(e)}L(F,O,0)}})),ie})),ie=((e,t)=>{for(var n in t||(t={}))z.call(t,n)&&J(e,n,t[n]);if(k)for(var n of k(t))I.call(t,n)&&J(e,n,t[n]);return e})({load:te,startAutoLoad:e=>N(void 0,null,(function*(){ne(),yield te(e);try{D=yield i(((e,t)=>N(void 0,null,(function*(){t||e?2!=W&&(_(1),$++,ee(null!=t?t:e),_(0)):yield te()}))))}catch(e){null==p||p(e)}return ie})),stopAutoLoad:ne,isAutoLoading:()=>!o(D),save:re,startAutoSave:()=>N(void 0,null,(function*(){return oe(),yield re(),U=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&re(e)})),ie})),stopAutoSave:oe,isAutoSaving:()=>!o(U),getStatus:()=>W,addStatusListener:e=>X(e,B),delListener:t=>(Z(t),e),schedule:le,getStore:()=>e,destroy:()=>(A(K,O).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:$,saves:q})},b);return h(ie)};var W=Object.defineProperty,$=Object.defineProperties,q=Object.getOwnPropertyDescriptors,B=Object.getOwnPropertySymbols,G=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable,Q=(e,t,n)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,R=(e,t)=>{for(var n in t||(t={}))G.call(t,n)&&Q(e,n,t[n]);if(B)for(var n of B(t))H.call(t,n)&&Q(e,n,t[n]);return e},V=(e,t,n)=>new Promise(((r,o)=>{var l=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,i);a((n=n.apply(e,t)).next())}));exports.createPartyKitPersister=(e,n,o,a)=>{const{host:u,room:c}=n.partySocketOptions,{storeProtocol:d="https",storePath:v=m,messagePrefix:y=t}=R({},i(o)?{storeProtocol:o}:o),p=d+"://"+u+"/parties/"+n.name+"/"+c+v,f=e=>V(void 0,null,(function*(){return yield(yield fetch(p,(t=R({},e?{method:"PUT",body:O(e)}:{}),n={mode:"cors",cache:"no-store"},$(t,q(n))))).json();var t,n}));return U(e,(()=>V(void 0,null,(function*(){return yield f()}))),((e,t)=>V(void 0,null,(function*(){var r;t?n.send(y+"s"+(i(r=t)?r:O(r))):yield f(e())}))),(e=>{const t=t=>l(((e,t)=>{const n=s(e);return((e,t)=>e.startsWith(t))(t,e)?[t[n],P((r=t,o=n+1,r.slice(o,void 0)))]:void 0;var r,o})(y,t.data),(([t,n])=>{"s"==t&&e(void 0,n)}));return n.addEventListener(r,t),t}),(e=>{n.removeEventListener(r,e)}),a,1,{getConnection:()=>n})};
