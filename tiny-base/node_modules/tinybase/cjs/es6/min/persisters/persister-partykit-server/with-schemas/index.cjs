"use strict";const e=e=>typeof e,t=e(""),n="t",r=(e,t)=>e.startsWith(t),i=Promise,l=e=>null==e,s=(e,t,n)=>l(e)?null==n?void 0:n():t(e),o=(e,t,n)=>e.slice(t,n),u=e=>e.length,a=e=>{return t=function*(){return i.all(e)},new Promise(((e,n)=>{var r=e=>{try{l(t.next(e))}catch(e){n(e)}},i=e=>{try{l(t.throw(e))}catch(e){n(e)}},l=t=>t.done?e(t.value):Promise.resolve(t.value).then(r,i);l((t=t.apply(void 0,null)).next())}));var t},c=(e,t)=>e.map(t),d=(e,...t)=>e.push(...t),f=Object,h=f.entries,y=(e=[])=>f.fromEntries(e),g=(e,t)=>c(h(e),(([e,n])=>t(n,e))),v=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),p=JSON.stringify,P=JSON.parse,x=e=>p(e,((e,t)=>t instanceof Map?f.fromEntries([...t]):t)),S=(n,r,i)=>n+r+(e(i)==t?i:x(i)),m=(e,t,n)=>{const i=u(e);return r(t,e)?[t[i],(n?P:String)(o(t,i+1))]:void 0},w=(e,t)=>((e,t)=>null==e?void 0:e.forEach(t))(e,((e,n)=>t(n,e)));var b=Object.defineProperty,D=(e,t,n)=>new Promise(((r,i)=>{var l=e=>{try{o(n.next(e))}catch(e){i(e)}},s=e=>{try{o(n.throw(e))}catch(e){i(e)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,s);o((n=n.apply(e,t)).next())}));const R="hasStore",C=y(c(["Origin","Methods","Headers"],(e=>["Access-Control-Allow-"+e,"*"]))),T=(e,...t)=>D(void 0,[e,...t],(function*(e,t=""){return!!(yield e.get(t+R))})),O=(e,...t)=>D(void 0,[e,...t],(function*(e,t=""){const r={},i={};return w(yield e.list(),((e,l)=>s(m(t,e),(([e,t])=>{if(e==n){const[e,n,i]=P("["+t+"]");v(v(r,e,y),n,y)[i]=l}else"v"==e&&(i[t]=l)})))),[r,i]})),H=(e,t,n)=>D(void 0,null,(function*(){return e.party.broadcast(S(e.config.messagePrefix,"s",t),n)})),V=(e,t,i,s)=>D(void 0,null,(function*(){const o=e.party.storage,c=e.config.storagePrefix,f={[c+R]:1},h=[],y=[];yield a(g(t[0],((t,r)=>D(void 0,null,(function*(){return l(t)?!i&&(yield e.canDelTable(r,s))&&((e,...t)=>e.unshift(...t))(y,E(c,n,r)):(yield e.canSetTable(r,i,s))&&(yield a(g(t,((t,u)=>D(void 0,null,(function*(){return l(t)?!i&&(yield e.canDelRow(r,u,s))&&d(y,E(c,n,r,u)):(yield e.canSetRow(r,u,i,s))&&(yield a(g(t,((t,a)=>D(void 0,null,(function*(){const y=[r,u,a],g=E(c,n,...y);l(t)?!i&&(yield e.canDelCell(...y,s))&&d(h,g):(yield e.canSetCell(...y,t,i,s,yield o.get(g)))&&(f[g]=t)}))))))}))))))}))))),yield a(g(t[1],((t,n)=>D(void 0,null,(function*(){const r=c+"v"+n;l(t)?!i&&(yield e.canDelValue(n,s))&&d(h,r):(yield e.canSetValue(n,t,i,s,yield o.get(r)))&&(f[r]=t)}))))),0!=u(y)&&w(yield o.list(),(e=>y.every((t=>!r(e,t)||d(h,e)&&0)))),yield o.delete(h),yield o.put(f)})),E=(e,t,...n)=>S(e,t,o(x(n),1,-1)),M=(e,t,n=null)=>D(void 0,null,(function*(){return new Response(n,{status:t,headers:e.config.responseHeaders})}));exports.TinyBasePartyKitServer=class{constructor(e){var t,n,r,i,l,s,o;this.party=e,o={},(s="config")in(l=this)?b(l,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[s]=o,null!=(t=this.config).storePath||(t.storePath="/store"),null!=(n=this.config).messagePrefix||(n.messagePrefix=""),null!=(r=this.config).storagePrefix||(r.storagePrefix=""),null!=(i=this.config).responseHeaders||(i.responseHeaders=C)}onRequest(e){return D(this,null,(function*(){const{party:{storage:t},config:{storePath:n,storagePrefix:r}}=this;if(new URL(e.url).pathname.endsWith(n)){const n=yield T(t,r),i=yield e.text();return"PUT"==e.method?n?M(this,205):(yield V(this,P(i),!0,e),M(this,201)):M(this,200,n?x(yield O(t,r)):"")}return M(this,404)}))}onMessage(e,t){return D(this,null,(function*(){const{config:{messagePrefix:n,storagePrefix:r}}=this;yield s(m(n,e,1),(e=>D(this,[e],(function*([e,n]){"s"==e&&(yield T(this.party.storage,r))&&(yield V(this,n,!1,t),H(this,n,[t.id]))}))))}))}canSetTable(e,t,n){return D(this,null,(function*(){return!0}))}canDelTable(e,t){return D(this,null,(function*(){return!0}))}canSetRow(e,t,n,r){return D(this,null,(function*(){return!0}))}canDelRow(e,t,n){return D(this,null,(function*(){return!0}))}canSetCell(e,t,n,r,i,l,s){return D(this,null,(function*(){return!0}))}canDelCell(e,t,n,r){return D(this,null,(function*(){return!0}))}canSetValue(e,t,n,r,i){return D(this,null,(function*(){return!0}))}canDelValue(e,t){return D(this,null,(function*(){return!0}))}},exports.broadcastChanges=H,exports.hasStoreInStorage=T,exports.loadStoreFromStorage=O;
