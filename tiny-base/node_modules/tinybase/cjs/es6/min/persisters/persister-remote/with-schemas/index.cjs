"use strict";const e=clearInterval,t=e=>null==e,n=(e,n,l)=>t(e)?null==l?void 0:l():n(e),l=e=>Array.isArray(e),r=e=>e.length,o=e=>{throw Error(e)},i=(e,t)=>e.forEach(t),u=(e,...t)=>e.push(...t),a=e=>e.shift(),s=Object,d=e=>s.getPrototypeOf(e),c=s.keys,v=s.freeze,y=e=>(e=>!t(e)&&n(d(e),(e=>e==s.prototype||t(d(e))),(()=>!0)))(e)&&0==(e=>r(c(e)))(e),p=JSON.stringify,h=JSON.parse,f=e=>t(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),g=(e,t)=>null==e?void 0:e.forEach(t),b=(e,t)=>null==e?void 0:e.delete(t),S=e=>new Map(e),C=(e,t)=>null==e?void 0:e.get(t),m=(e,n,l)=>t(l)?(b(e,n),e):null==e?void 0:e.set(n,l),O=(e,t,n,l)=>{var r,o,i;return o=t,null!=(i=null==(r=e)?void 0:r.has(o))&&i?null==l||l(C(e,t)):m(e,t,n()),C(e,t)},P=(e,t,l,o,i=0)=>n((l?O:C)(e,t[i],i>r(t)-2?l:S),(n=>{if(i>r(t)-2)return(null==o?void 0:o(n))&&m(e,t[i]),n;const u=P(n,t,l,o,i+1);return f(n)&&m(e,t[i]),u})),w=e=>new Set(l(e)||t(e)?e:[e]),A=/^\d+$/;var E=Object.defineProperty,L=Object.getOwnPropertySymbols,M=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable,x=(e,t,n)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,T=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));const D=S(),I=S(),z=(e,s,d,c,p,h,E,z={},J=0,N=[])=>{let k,F,H,R=0,U=0,$=0;O(D,N,(()=>0)),O(I,N,(()=>[]));const q=S(),[B,G,K,Q,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!y(e)||!y(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!y(e)||!y(t),t.setContent]:o("Store type not supported by this Persister"))(E,e,J),[W,X,Y]=(()=>{let e;const[l,o]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?a(e):null)?l:""+t++},t=>{A.test(t)&&r(e)<1e3&&u(e,t)}]})(),s=S();return[(t,n,r,o=[],i=()=>[])=>{null!=e||(e=oe);const u=l(1);var a,d;return m(s,u,[t,n,r,o,i]),d=u,null==(a=P(n,null!=r?r:[""],w))||a.add(d),u},(t,n,...l)=>i(((e,t=[""])=>{const n=[],l=(e,o)=>o==r(t)?u(n,e):null===t[o]?g(e,(e=>l(e,o+1))):i([t[o],null],(t=>l(C(e,t),o+1)));return l(e,0),n})(t,n),(t=>g(t,(t=>C(s,t)[0](e,...null!=n?n:[],...l))))),e=>n(C(s,e),(([,t,n])=>(P(t,null!=n?n:[""],void 0,(t=>(b(t,e),f(t)?1:0))),m(s,e),o(e),n))),l=>n(C(s,l),(([n,,l=[],o,u])=>{const a=(...s)=>{var d,c;const v=r(s);v==r(l)?n(e,...s,...u(s)):t(l[v])?i(null!=(c=null==(d=o[v])?void 0:d.call(o,...s))?c:[],(e=>a(...s,e))):a(...s,l[v])};a()}))]})(),Z=e=>{e!=R&&(R=e,X(q,void 0,R))},_=t=>{(B&&l(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>T(void 0,null,(function*(){return 2!=R&&(Z(1),U++,yield re((()=>T(void 0,null,(function*(){try{const t=yield s();l(t)?_(t):e?V(e):o("Content is not an array: "+t)}catch(t){null==h||h(t),e&&V(e)}Z(0)}))))),oe})),te=()=>(F&&(p(F),F=void 0),oe),ne=e=>T(void 0,null,(function*(){return 1!=R&&(Z(2),$++,yield re((()=>T(void 0,null,(function*(){try{yield d(G,e)}catch(e){null==h||h(e)}Z(0)}))))),oe})),le=()=>(H&&(e.delListener(H),H=void 0),oe),re=(...e)=>T(void 0,null,(function*(){return u(C(I,N),...e),yield T(void 0,null,(function*(){if(!C(D,N)){for(m(D,N,1);!t(k=a(C(I,N)));)try{yield k()}catch(e){null==h||h(e)}m(D,N,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))M.call(t,n)&&x(e,n,t[n]);if(L)for(var n of L(t))j.call(t,n)&&x(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>T(void 0,null,(function*(){te(),yield ee(e);try{F=yield c(((e,t)=>T(void 0,null,(function*(){t||e?2!=R&&(Z(1),U++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==h||h(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!t(F),save:ne,startAutoSave:()=>T(void 0,null,(function*(){return le(),yield ne(),H=e.addDidFinishTransactionListener((()=>{const e=K();Q(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!t(H),getStatus:()=>R,addStatusListener:e=>W(e,q),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(C(I,N).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:U,saves:$})},z);return v(oe)};var J=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));const N=e=>e.headers.get("ETag");exports.createRemotePersister=(n,l,r,o=5,i)=>{let u;return z(n,(()=>J(void 0,null,(function*(){const e=yield fetch(l);return u=N(e),h(yield e.text())}))),(e=>J(void 0,null,(function*(){return yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:(t=e(),p(t,((e,t)=>t instanceof Map?s.fromEntries([...t]):t)))});var t}))),(e=>setInterval((()=>J(void 0,null,(function*(){const n=yield fetch(l,{method:"HEAD"}),r=N(n);t(u)||t(r)||r==u||(u=r,e())}))),1e3*o)),(t=>e(t)),i,1,{getUrls:()=>[l,r]})};
