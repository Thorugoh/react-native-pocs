"use strict";var e=require("yjs");const t="t",n="v",l=e=>null==e,r=(e,t,n)=>l(e)?null==n?void 0:n():t(e),o=e=>Array.isArray(e),u=e=>e.length,i=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),s=(e,...t)=>e.push(...t),c=e=>e.shift(),d=Object,v=e=>d.getPrototypeOf(e),g=d.entries,y=d.keys,p=d.freeze,f=(e=[])=>d.fromEntries(e),h=(e,t)=>t in e,b=(e,t)=>f(((e,t)=>((e,t)=>e.map(t))(g(e),(([e,n])=>t(n,e))))(e,((e,n)=>[n,t(e,n)]))),S=e=>(e=>!l(e)&&r(v(e),(e=>e==d.prototype||l(v(e))),(()=>!0)))(e)&&0==(e=>u(y(e)))(e),O=(e,t,n)=>(h(e,t)||(e[t]=n()),e[t]),w=e=>l(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),C=(e,t)=>null==e?void 0:e.forEach(t),M=(e,t)=>null==e?void 0:e.delete(t),P=e=>new Map(e),m=(e,t)=>null==e?void 0:e.get(t),A=(e,t)=>C(e,((e,n)=>t(n,e))),j=(e,t,n)=>l(n)?(M(e,t),e):null==e?void 0:e.set(t,n),L=(e,t,n,l)=>{var r,o,u;return o=t,null!=(u=null==(r=e)?void 0:r.has(o))&&u?null==l||l(m(e,t)):j(e,t,n()),m(e,t)},E=(e,t,n,l,o=0)=>r((n?L:m)(e,t[o],o>u(t)-2?n:P),(r=>{if(o>u(t)-2)return(null==l?void 0:l(r))&&j(e,t[o]),r;const i=E(r,t,n,l,o+1);return w(r)&&j(e,t[o]),i})),J=e=>new Set(o(e)||l(e)?e:[e]),N=/^\d+$/;var x=Object.defineProperty,z=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable,k=(e,t,n)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Y=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},u=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,u);i((n=n.apply(e,t)).next())}));const q=P(),F=P(),I=(e,t,n,d,v,g,y,f={},h=0,b=[])=>{let O,A,x,I=0,$=0,B=0;L(q,b,(()=>0)),L(F,b,(()=>[]));const G=P(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!S(e)||!S(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!S(e)||!S(t),t.setContent]:i("Store type not supported by this Persister"))(y,e,h),[V,W,X]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?c(e):null)?l:""+t++},t=>{N.test(t)&&u(e)<1e3&&s(e,t)}]})(),o=P();return[(n,l,r,u=[],i=()=>[])=>{null!=e||(e=oe);const a=t(1);var s,c;return j(o,a,[n,l,r,u,i]),c=a,null==(s=E(l,null!=r?r:[""],J))||s.add(c),a},(t,n,...l)=>a(((e,t=[""])=>{const n=[],l=(e,r)=>r==u(t)?s(n,e):null===t[r]?C(e,(e=>l(e,r+1))):a([t[r],null],(t=>l(m(e,t),r+1)));return l(e,0),n})(t,n),(t=>C(t,(t=>m(o,t)[0](e,...null!=n?n:[],...l))))),e=>r(m(o,e),(([,t,l])=>(E(t,null!=l?l:[""],void 0,(t=>(M(t,e),w(t)?1:0))),j(o,e),n(e),l))),t=>r(m(o,t),(([t,,n=[],r,o])=>{const i=(...s)=>{var c,d;const v=u(s);v==u(n)?t(e,...s,...o(s)):l(n[v])?a(null!=(d=null==(c=r[v])?void 0:c.call(r,...s))?d:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),Z=e=>{e!=I&&(I=e,W(G,void 0,I))},_=t=>{(H&&o(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>Y(void 0,null,(function*(){return 2!=I&&(Z(1),$++,yield re((()=>Y(void 0,null,(function*(){try{const n=yield t();o(n)?_(n):e?U(e):i("Content is not an array: "+n)}catch(t){null==g||g(t),e&&U(e)}Z(0)}))))),oe})),te=()=>(A&&(v(A),A=void 0),oe),ne=e=>Y(void 0,null,(function*(){return 1!=I&&(Z(2),B++,yield re((()=>Y(void 0,null,(function*(){try{yield n(K,e)}catch(e){null==g||g(e)}Z(0)}))))),oe})),le=()=>(x&&(e.delListener(x),x=void 0),oe),re=(...e)=>Y(void 0,null,(function*(){return s(m(F,b),...e),yield Y(void 0,null,(function*(){if(!m(q,b)){for(j(q,b,1);!l(O=c(m(F,b)));)try{yield O()}catch(e){null==g||g(e)}j(q,b,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))D.call(t,n)&&k(e,n,t[n]);if(z)for(var n of z(t))T.call(t,n)&&k(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>Y(void 0,null,(function*(){te(),yield ee(e);try{A=yield d(((e,t)=>Y(void 0,null,(function*(){t||e?2!=I&&(Z(1),$++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==g||g(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!l(A),save:ne,startAutoSave:()=>Y(void 0,null,(function*(){return le(),yield ne(),x=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!l(x),getStatus:()=>I,addStatusListener:e=>V(e,G),delListener:t=>(X(t),e),schedule:re,getStore:()=>e,destroy:()=>(m(F,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:$,saves:B})},f);return p(oe)};var $=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},u=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,u);i((n=n.apply(e,t)).next())}));const B="delete",G=e=>[e.get(t),e.get(n)],H=(t,n,r,o)=>{var u;const i=l(n)?t:null!=(u=t.get(n))?u:t.set(n,new e.Map);let a;return b(r,((e,t)=>{o(i,t,e)&&(a=1)})),i.forEach(((e,t)=>{h(r,t)||(i.delete(t),a=1)})),l(n)||i.size||t.delete(n),a};exports.createYjsPersister=(o,i,s="tinybase",d)=>{const v=i.getMap(s);return I(o,(()=>$(void 0,null,(function*(){return v.size?[v.get(t).toJSON(),v.get(n).toJSON()]:void 0}))),((o,u)=>$(void 0,null,(function*(){return i.transact((()=>((o,u,i)=>{o.size||(o.set(t,new e.Map),o.set(n,new e.Map));const[a,s]=G(o),c=()=>{d=1};let d=1;if(r(i,(([e,t])=>{d=0,b(e,((e,t)=>d?0:l(e)?a.delete(t):r(a.get(t),(t=>b(e,((e,n)=>d?0:l(e)?t.delete(n):r(t.get(n),(t=>b(e,((e,n)=>l(e)?t.delete(n):t.set(n,e)))),c)))),c))),b(t,((e,t)=>d?0:l(e)?s.delete(t):s.set(t,e)))})),d){const[e,t]=u();H(a,void 0,e,((e,t,n)=>H(a,t,n,((e,t,n)=>H(e,t,n,((e,t,n)=>{if(e.get(t)!==n)return e.set(t,n),1})))))),H(s,void 0,t,((e,t,n)=>{s.get(t)!==n&&s.set(t,n)}))}})(v,o,u)))}))),(e=>{const l=l=>e(void 0,((e,l)=>{if(1==u(l)&&(o=l[0].path,0==u(o)))return[e.get(t).toJSON(),e.get(n).toJSON(),1];var o;const[i,s]=G(e),d={},v={};return a(l,(({path:e,changes:{keys:n}})=>c(e)==t?r(c(e),(t=>{const l=O(d,t,f),o=i.get(t);r(c(e),(e=>{const t=O(l,e,f),r=o.get(e);A(n,((e,{action:n})=>t[e]=n==B?null:r.get(e)))}),(()=>A(n,((e,{action:t})=>{var n;return l[e]=t==B?null:null==(n=o.get(e))?void 0:n.toJSON()}))))}),(()=>A(n,((e,{action:t})=>{var n;return d[e]=t==B?null:null==(n=i.get(e))?void 0:n.toJSON()})))):A(n,((e,{action:t})=>v[e]=t==B?null:s.get(e))))),[d,v,1]})(v,l));return v.observeDeep(l),l}),(e=>{v.unobserveDeep(e)}),d,1,{getYDoc:()=>i})};
