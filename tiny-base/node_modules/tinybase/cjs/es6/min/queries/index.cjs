"use strict";const e=e=>typeof e,t=e(""),n=e(!0),r=e(0),l=e(e),o="Listener",s="Result",a="Ids",i="Table",d="Row",u=d+"Count",c=d+a,v="Sorted"+d+a,f="Cell",h=f+a,w=Math,g=w.max,y=w.min,L=isFinite,b=e=>null==e,p=(e,t,n)=>b(e)?null==n?void 0:n():t(e),R=t=>e(t)==l,m=e=>Array.isArray(e),T=e=>e.length,C=()=>{},I=(e,t)=>e.every(t),O=(e,t)=>e.forEach(t),S=e=>E(e,((e,t)=>e+t),0),Q=e=>0==T(e),E=(e,t,n)=>e.reduce(t,n),j=(e,...t)=>e.push(...t),x=Object,D=x.entries,M=x.freeze,k=e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0},z=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},A=e=>b(e)||0==k(e),F=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},P=e=>e.clear(),W=(e,t)=>null==e?void 0:e.forEach(t),q=(e,t)=>null==e?void 0:e.delete(t),B=e=>new Map(e),G=(e,t)=>null==e?void 0:e.get(t),H=(e,t)=>W(e,((e,n)=>t(n,e))),J=(e,t,n)=>b(n)?(q(e,t),e):null==e?void 0:e.set(t,n),K=(e,t,n,r)=>(z(e,t)?null==r||r(G(e,t)):J(e,t,n()),G(e,t)),N=(e,t,n,r,l=0)=>p((n?K:G)(e,t[l],l>T(t)-2?n:B),(o=>{if(l>T(t)-2)return(null==r?void 0:r(o))&&J(e,t[l]),o;const s=N(o,t,n,r,l+1);return A(o)&&J(e,t[l]),s})),U=e=>new Set(m(e)||b(e)?e:[e]),V=(e,t)=>null==e?void 0:e.add(t),X=B([["avg",[(e,t)=>S(e)/t,(e,t,n)=>e+(t-e)/(n+1),(e,t,n)=>e+(e-t)/(n-1),(e,t,n,r)=>e+(t-n)/r]],["max",[e=>g(...e),(e,t)=>g(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:g(t,e)]],["min",[e=>y(...e),(e,t)=>y(t,e),(e,t)=>t==e?void 0:e,(e,t,n)=>n==e?void 0:y(t,e)]],["sum",[e=>S(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,n)=>e-n+t]]]);var Y=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;const _=(()=>{const l=new WeakMap;return a=>(l.has(a)||l.set(a,(l=>{const a=l.createStore,w=a(),g=a(),y=B(),{addListener:S,callListeners:E,delListener:_}=g,[ee,te,ne,re,le,,,oe,,se,ae,ie,de,ue]=((e,t,n,r,l)=>{const o=e.hasRow,s=B(),a=B(),i=B(),d=B(),u=B(),c=B(),v=(t,n,...r)=>{const l=K(c,t,U);return O(r,(t=>V(l,t)&&n&&e.callListener(t))),r},f=(t,...n)=>p(G(c,t),(r=>{O(Q(n)?F(r):n,(t=>{e.delListener(t),q(r,t)})),A(r)&&J(c,t)})),h=(e,t)=>{J(s,e,t),z(a,e)||(J(a,e,!0),J(d,e,B()),J(u,e,B()),l(i))},w=e=>{J(s,e),J(a,e),J(d,e),J(u,e),f(e),l(i)};return[()=>e,()=>{return[...null!=(t=null==(e=s)?void 0:e.keys())?t:[]];var e,t},e=>H(a,e),e=>z(a,e),e=>G(s,e),e=>G(a,e),(e,t)=>J(a,e,t),h,(t,r,l,s,a)=>{h(t,r);const i=B(),c=B(),w=G(d,t),g=G(u,t),y=t=>{const l=n=>e.getCell(r,t,n),d=G(w,t),u=o(r,t)?n(s(l,t)):void 0;var v,f;if(d===u||m(d)&&m(u)&&(f=u,T(v=d)===T(f)&&I(v,((e,t)=>f[t]===e)))||J(i,t,[d,u]),!b(a)){const e=G(g,t),n=o(r,t)?a(l,t):void 0;e!=n&&J(c,t,n)}},L=e=>{l((()=>{W(i,(([,e],t)=>J(w,t,e))),W(c,((e,t)=>J(g,t,e)))}),i,c,w,g,e),P(i),P(c)};H(w,y),e.hasTable(r)&&O(e.getRowIds(r),(e=>{z(w,e)||y(e)})),L(!0),f(t),v(t,0,e.addRowListener(r,null,((e,t,n)=>y(n))),e.addTableListener(r,(()=>L())))},w,e=>r(e,i),()=>H(c,w),v,f]})(l,0,C,S,E),ce=(e,t,...n)=>O(n,(n=>V(K(K(y,t,B),e,U),n))),ve=e=>{p(G(y,e),(e=>{H(e,((e,t)=>W(t,(t=>e.delListener(t))))),P(e)})),O([g,w],(t=>t.delTable(e)))},fe=(e,t,n)=>ce(t,e,t.addStartTransactionListener(n.startTransaction),t.addDidFinishTransactionListener((()=>n.finishTransaction()))),he={setQueryDefinition:(o,s,a)=>{oe(o,s),ve(o);const i=[],d=[[null,[s,null,null,[],B()]]],u=[],c=[],v=[];a({select:(e,t)=>{const n=R(e)?[T(i)+"",e]:[b(t)?e:t,n=>n(e,t)];return j(i,n),{as:e=>n[0]=e}},join:(e,t,n)=>{const r=b(n)||R(t)?null:t,l=b(r)?t:n,o=[e,[e,r,R(l)?l:e=>e(l),[],B()]];return j(d,o),{as:e=>o[0]=e}},where:(e,t,n)=>j(u,R(e)?e:b(n)?n=>n(e)===t:r=>r(e,t)===n),group:(e,t,n,r,l)=>{var o;const s=[e,[e,R(t)?[t,n,r,l]:null!=(o=G(X,t))?o:[(e,t)=>t]]];return j(c,s),{as:e=>s[0]=e}},having:(e,t)=>j(v,R(e)?e:n=>n(e)===t)});const f=B(i);if(A(f))return he;const h=B(d);H(h,((e,[,t])=>p(G(h,t),(({3:t})=>b(e)?0:j(t,e)))));const y=B(c);let m=w;if(A(y)&&Q(v))m=g;else{fe(o,m,g);const l=B();H(y,((e,[t,n])=>V(K(l,t,U),[e,n])));const s=U();H(f,(e=>z(l,e)?0:V(s,e)));const a=B(),i=(s,a,i,d)=>p(s,(([u,c,f,h])=>{H(a,((o,[s])=>{const a=K(u,o,B),c=G(a,i),v=d?void 0:s;if(c!==v){const s=U([[c,v]]),d=k(a);J(a,i,v),W(G(l,o),(([l,o])=>{const i=((e,t,n,r,l,o=!1)=>{if(A(n))return;const[s,a,i,d]=l;return o||(o=b(e)),W(r,(([n,r])=>{o||(e=b(n)?null==a?void 0:a(e,r,t++):b(r)?null==i?void 0:i(e,n,t--):null==d?void 0:d(e,r,n,t),o||(o=b(e)))})),o?s(F(n),k(n)):e})(h[l],d,a,s,o);h[l]=b((l=>{const o=e(l);return(e=>e==t||e==n)(o)||o==r&&L(l)?o:void 0})(i))?null:i}))}})),A(c)||!I(v,(e=>e((e=>h[e]))))?g.delRow(o,f):b(f)?s[2]=g.addRow(o,h):g.setRow(o,f,h)}));ce(m,o,m.addRowListener(o,null,((e,t,n,r)=>{const d=[],u=[],c=B(),v=m.hasRow(o,n);let f=!v;W(s,(e=>{const[t,l,s]=r(o,n,e);j(d,l),j(u,s),f||(f=t)})),H(l,(e=>{const[t,,l]=r(o,n,e);(f||t)&&J(c,e,[l])})),f&&i(N(a,d,void 0,(([,e])=>(q(e,n),A(e)))),c,n,1),v&&i(N(a,u,(()=>{const e={};return W(s,(t=>e[t]=m.getCell(o,n,t))),[B(),U(),void 0,e]}),(([,e])=>{V(e,n)})),c,n)})))}fe(o,l,m);const C=(e,t,n,r)=>{const a=e=>l.getCell(t,n,e);O(r,(t=>{var n;const[r,,s,i,d]=G(h,t),u=null==s?void 0:s(a,e),[c,v]=null!=(n=G(d,e))?n:[];u!=c&&(b(v)||ue(o,v),J(d,e,b(u)?null:[u,...de(o,1,l.addRowListener(r,u,(()=>C(e,r,u,i))))]))})),(e=>{const t=(t,n)=>{var r,o,a;return l.getCell(...b(n)?[s,e,t]:t===s?[s,e,n]:[null==(r=G(h,t))?void 0:r[0],null==(a=G(null==(o=G(h,t))?void 0:o[4],e))?void 0:a[0],n])};m.transaction((()=>I(u,(e=>e(t)))?H(f,((n,r)=>((e,t,n,r,l)=>b(l)?e.delCell(t,n,r,!0):e.setCell(t,n,r,l))(m,o,e,n,r(t,e)))):m.delRow(o,e)))})(e)},{3:S}=G(h,null);return m.transaction((()=>de(o,1,l.addRowListener(s,null,((e,t,n)=>{l.hasRow(s,n)?C(n,s,n,S):(m.delRow(o,n),W(h,(({4:e})=>p(G(e,n),(([,t])=>{ue(o,t),J(e,n)})))))}))))),he},delQueryDefinition:e=>(ve(e),se(e),he),getStore:ee,getQueryIds:te,forEachQuery:ne,hasQuery:re,getTableId:le,addQueryIdsListener:e=>ae((()=>e(he))),delListener:e=>(_(e),he),destroy:ie,getListenerStats:()=>{const e=g.getListenerStats(),{tables:t,tableIds:n,transaction:r}=e;return((e,t)=>{var n={};for(var r in e)Z.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&Y)for(var r of Y(e))t.indexOf(r)<0&&$.call(e,r)&&(n[r]=e[r]);return n})(e,["tables","tableIds","transaction"])}};return we=([e,t],n)=>{O(e?["get","has","forEach"]:["get"],(e=>he[e+s+n]=(...t)=>g[e+n](...t))),he["add"+s+n+o]=(...e)=>{return g["add"+n+o](...(r=e,l=t,r.slice(0,l)),((n,...r)=>e[t](he,...r)),!0);var r,l}},((e=[])=>{x.fromEntries(e)})(((e,t)=>((e,t)=>e.map(t))(D(e),(([e,n])=>t(n,e))))({[i]:[1,1],[i+h]:[0,1],[u]:[0,1],[c]:[0,1],[v]:[0,5],[d]:[1,2],[h]:[0,2],[f]:[1,3]},((e,t)=>[t,we(e,t)]))),M(he);var we})(a)),l.get(a))})();exports.createQueries=_;
