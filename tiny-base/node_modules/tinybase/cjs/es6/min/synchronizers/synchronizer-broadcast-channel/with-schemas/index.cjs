"use strict";const e=(e,t="",n)=>e.split(t,n),t=Promise,n=globalThis,l=Math,o=l.floor,r=e=>null==e,a=(e,t,n)=>r(e)?null==n?void 0:n():t(e),u=e=>Array.isArray(e),i=e=>e.length,s=e=>{throw Error(e)},c=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),v=e=>e.shift(),y=Object,g=e=>y.getPrototypeOf(e),f=y.entries,p=y.keys,h=y.freeze,b=(e,t)=>c(f(e),(([e,n])=>t(n,e))),S=e=>(e=>!r(e)&&a(g(e),(e=>e==y.prototype||r(g(e))),(()=>!0)))(e)&&0==(e=>i(p(e)))(e),m=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),C=e=>r(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),M=(e,t)=>null==e?void 0:e.forEach(t),w=(e,t)=>null==e?void 0:e.delete(t),A=e=>new Map(e),O=(e,t)=>null==e?void 0:e.get(t),P=(e,t,n)=>r(n)?(w(e,t),e):null==e?void 0:e.set(t,n),L=(e,t,n,l)=>{var o,r,a;return r=t,null!=(a=null==(o=e)?void 0:o.has(r))&&a?null==l||l(O(e,t)):P(e,t,n()),O(e,t)},j=(e,t,n,l,o=0)=>a((n?L:O)(e,t[o],o>i(t)-2?n:A),(r=>{if(o>i(t)-2)return(null==l?void 0:l(r))&&P(e,t[o]),r;const a=j(r,t,n,l,o+1);return C(r)&&P(e,t[o]),a})),T=(e,t)=>t?[e,t]:[e],H=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},D=(e="")=>T(((e=[])=>y.fromEntries(e))(),e),E=e=>new Set(u(e)||r(e)?e:[e]),x=/^\d+$/;var z=Object.defineProperty,R=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable,I=(e,t,n)=>t in e?z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,N=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},a=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);u((n=n.apply(e,t)).next())}));const $=A(),k=A(),F=(e,t,n,l,o,y,g,f={},p=0,b=[])=>{let m,T,H,D=0,z=0,F=0;L($,b,(()=>0)),L(k,b,(()=>[]));const U=A(),[q,G,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!S(e)||!S(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!S(e)||!S(t),t.setContent]:s("Store type not supported by this Persister"))(g,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?v(e):null)?l:""+t++},t=>{x.test(t)&&i(e)<1e3&&d(e,t)}]})(),l=A();return[(n,o,r,a=[],u=()=>[])=>{null!=e||(e=re);const i=t(1);var s,c;return P(l,i,[n,o,r,a,u]),c=i,null==(s=j(o,null!=r?r:[""],E))||s.add(c),i},(t,n,...o)=>c(((e,t=[""])=>{const n=[],l=(e,o)=>o==i(t)?d(n,e):null===t[o]?M(e,(e=>l(e,o+1))):c([t[o],null],(t=>l(O(e,t),o+1)));return l(e,0),n})(t,n),(t=>M(t,(t=>O(l,t)[0](e,...null!=n?n:[],...o))))),e=>a(O(l,e),(([,t,o])=>(j(t,null!=o?o:[""],void 0,(t=>(w(t,e),C(t)?1:0))),P(l,e),n(e),o))),t=>a(O(l,t),(([t,,n=[],l,o])=>{const a=(...u)=>{var s,d;const v=i(u);v==i(n)?t(e,...u,...o(u)):r(n[v])?c(null!=(d=null==(s=l[v])?void 0:s.call(l,...u))?d:[],(e=>a(...u,e))):a(...u,n[v])};a()}))]})(),Z=e=>{e!=D&&(D=e,X(U,void 0,D))},_=t=>{(q&&u(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>N(void 0,null,(function*(){return 2!=D&&(Z(1),z++,yield oe((()=>N(void 0,null,(function*(){try{const n=yield t();u(n)?_(n):e?Q(e):s("Content is not an array: "+n)}catch(t){null==y||y(t),e&&Q(e)}Z(0)}))))),re})),te=()=>(T&&(o(T),T=void 0),re),ne=e=>N(void 0,null,(function*(){return 1!=D&&(Z(2),F++,yield oe((()=>N(void 0,null,(function*(){try{yield n(G,e)}catch(e){null==y||y(e)}Z(0)}))))),re})),le=()=>(H&&(e.delListener(H),H=void 0),re),oe=(...e)=>N(void 0,null,(function*(){return d(O(k,b),...e),yield N(void 0,null,(function*(){if(!O($,b)){for(P($,b,1);!r(m=v(O(k,b)));)try{yield m()}catch(e){null==y||y(e)}P($,b,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))V.call(t,n)&&I(e,n,t[n]);if(R)for(var n of R(t))B.call(t,n)&&I(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>N(void 0,null,(function*(){te(),yield ee(e);try{T=yield l(((e,t)=>N(void 0,null,(function*(){t||e?2!=D&&(Z(1),z++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==y||y(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!r(T),save:ne,startAutoSave:()=>N(void 0,null,(function*(){return le(),yield ne(),H=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!r(H),getStatus:()=>D,addStatusListener:e=>W(e,U),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(O(k,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:z,saves:F})},f);return h(re)},U=e("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),q=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>o(256*l.random()))))(e),G=(e=16)=>{return t=(e,t)=>e+U[63&t],q(new Uint8Array(e)).reduce(t,"");var t};var J=Object.defineProperty,K=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable,X=(e,t,n)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Y=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},a=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);u((n=n.apply(e,t)).next())}));exports.createBroadcastChannelSynchronizer=(e,n,l,o,u)=>{const i=G(),s=new BroadcastChannel(n);return((e,n,l,o,u,i,s,c,d={})=>{let v,y=0,g=0,f=0;const p=A(),h=()=>G(11),C=(e,t,l,o)=>{g++,null==i||i(e,t,l,o),n(e,t,l,o)},M=(e,n,l,o)=>Y(void 0,null,(function*(){return new t(((t,r)=>{const a=o+"."+G(4),i=((e,t=0)=>setTimeout(e,1e3*t))((()=>{w(p,a),r(`No response from ${null!=e?e:"anyone"} to ${a}, `+n)}),u);P(p,a,[e,(e,n)=>{clearTimeout(i),w(p,a),t([e,n,o])}]),C(e,a,n,l)}))})),L=(e,[t,n])=>{b(t,(([t,n],l)=>{const o=m(e[0],l,D);b(t,(([e,t],n)=>{const l=m(o[0],n,D);b(e,(([e,t],n)=>l[0][n]=T(e,t))),l[1]=H(l[1],t)})),o[1]=H(o[1],n)})),e[1]=H(e[1],n)},j=(...t)=>Y(void 0,[...t],(function*(t=null,n,l=h()){try{r(n)&&([n,t,l]=yield M(null,1,"",l));const[o,a]=n,[u,i]=e.getMergeableContentHashes();let s=D();if(u!=o){const[n,o]=(yield M(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!S(o)){const[n,r]=(yield M(t,5,e.getMergeableRowHashes(o),l))[0];if(L(s,n),!S(r)){const n=(yield M(t,6,e.getMergeableCellHashes(r),l))[0];L(s,n)}}}return[s,i==a?D():(yield M(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==c||c(e)}})),E=F(e,(()=>Y(void 0,null,(function*(){const e=yield j();return!e||S(e[0][0])&&S(e[1][0])?void 0:e}))),((t,n)=>Y(void 0,null,(function*(){return n?C(null,h(),3,n):C(null,h(),2,e.getMergeableContentHashes())}))),(e=>v=e),(()=>v=void 0),c,2,((e,t)=>{for(var n in t||(t={}))Q.call(t,n)&&X(e,n,t[n]);if(K)for(var n of K(t))W.call(t,n)&&X(e,n,t[n]);return e})({startSync:e=>Y(void 0,null,(function*(){return y=1,yield(yield E.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(y=0,E.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),E.stopSync()),getSynchronizerStats:()=>({sends:g,receives:f})},d),1);return l(((t,n,l,o)=>{const u=y||E.isAutoLoading();f++,null==s||s(t,n,l,o),0==l?a(O(p,n),(([e,n])=>r(e)||e==t?n(o,t):0)):2==l&&u?j(t,o,null!=n?n:void 0).then((e=>{null==v||v(void 0,e)})).catch(c):3==l&&u?null==v||v(void 0,o):a(1==l&&(y||E.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{C(t,n,0,e)}))})),E})(e,((e,t,n,l)=>s.postMessage([i,e,t,n,l])),(e=>{s.onmessage=({data:[t,n,l,o,a]})=>r(n)||n==i?e(t,l,o,a):0}),(()=>{s.close()}),.01,l,o,u,{getChannelName:()=>n})};
