"use strict";const e=(e,t="",n)=>e.split(t,n),t=Promise,n=globalThis,l=(e,t=0)=>setTimeout(e,1e3*t),r=Math,o=r.floor,a=e=>null==e,u=(e,t,n)=>a(e)?null==n?void 0:n():t(e),i=e=>Array.isArray(e),s=e=>e.length,c=e=>{throw Error(e)},d=(e,t)=>e.forEach(t),v=(e,...t)=>e.push(...t),y=e=>e.shift(),g=Object,f=e=>g.getPrototypeOf(e),p=g.entries,h=g.keys,b=g.freeze,S=(e,t)=>d(p(e),(([e,n])=>t(n,e))),m=e=>(e=>!a(e)&&u(f(e),(e=>e==g.prototype||a(f(e))),(()=>!0)))(e)&&0==(e=>s(h(e)))(e),M=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),w=e=>a(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),A=(e,t)=>null==e?void 0:e.forEach(t),C=(e,t)=>null==e?void 0:e.delete(t),O=e=>new Map(e),P=(e,t)=>null==e?void 0:e.get(t),L=(e,t,n)=>a(n)?(C(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,l)=>{var r,o,a;return o=t,null!=(a=null==(r=e)?void 0:r.has(o))&&a?null==l||l(P(e,t)):L(e,t,n()),P(e,t)},T=(e,t,n,l,r=0)=>u((n?j:P)(e,t[r],r>s(t)-2?n:O),(o=>{if(r>s(t)-2)return(null==l?void 0:l(o))&&L(e,t[r]),o;const a=T(o,t,n,l,r+1);return w(o)&&L(e,t[r]),a})),H=(e,t)=>t?[e,t]:[e],D=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},E=(e="")=>H(((e=[])=>g.fromEntries(e))(),e),x=e=>new Set(i(e)||a(e)?e:[e]),z=/^\d+$/;var R=Object.defineProperty,V=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable,k=(e,t,n)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},a=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);u((n=n.apply(e,t)).next())}));const N=O(),U=O(),q=(e,t,n,l,r,o,g,f={},p=0,h=[])=>{let S,M,H,D=0,E=0,R=0;j(N,h,(()=>0)),j(U,h,(()=>[]));const q=O(),[B,G,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!m(e)||!m(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!m(e)||!m(t),t.setContent]:c("Store type not supported by this Persister"))(g,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?y(e):null)?l:""+t++},t=>{z.test(t)&&s(e)<1e3&&v(e,t)}]})(),l=O();return[(n,r,o,a=[],u=()=>[])=>{null!=e||(e=oe);const i=t(1);var s,c;return L(l,i,[n,r,o,a,u]),c=i,null==(s=T(r,null!=o?o:[""],x))||s.add(c),i},(t,n,...r)=>d(((e,t=[""])=>{const n=[],l=(e,r)=>r==s(t)?v(n,e):null===t[r]?A(e,(e=>l(e,r+1))):d([t[r],null],(t=>l(P(e,t),r+1)));return l(e,0),n})(t,n),(t=>A(t,(t=>P(l,t)[0](e,...null!=n?n:[],...r))))),e=>u(P(l,e),(([,t,r])=>(T(t,null!=r?r:[""],void 0,(t=>(C(t,e),w(t)?1:0))),L(l,e),n(e),r))),t=>u(P(l,t),(([t,,n=[],l,r])=>{const o=(...u)=>{var i,c;const v=s(u);v==s(n)?t(e,...u,...r(u)):a(n[v])?d(null!=(c=null==(i=l[v])?void 0:i.call(l,...u))?c:[],(e=>o(...u,e))):o(...u,n[v])};o()}))]})(),Z=e=>{e!=D&&(D=e,X(q,void 0,D))},_=t=>{(B&&i(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>F(void 0,null,(function*(){return 2!=D&&(Z(1),E++,yield re((()=>F(void 0,null,(function*(){try{const n=yield t();i(n)?_(n):e?Q(e):c("Content is not an array: "+n)}catch(t){null==o||o(t),e&&Q(e)}Z(0)}))))),oe})),te=()=>(M&&(r(M),M=void 0),oe),ne=e=>F(void 0,null,(function*(){return 1!=D&&(Z(2),R++,yield re((()=>F(void 0,null,(function*(){try{yield n(G,e)}catch(e){null==o||o(e)}Z(0)}))))),oe})),le=()=>(H&&(e.delListener(H),H=void 0),oe),re=(...e)=>F(void 0,null,(function*(){return v(P(U,h),...e),yield F(void 0,null,(function*(){if(!P(N,h)){for(L(N,h,1);!a(S=y(P(U,h)));)try{yield S()}catch(e){null==o||o(e)}L(N,h,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))I.call(t,n)&&k(e,n,t[n]);if(V)for(var n of V(t))$.call(t,n)&&k(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>F(void 0,null,(function*(){te(),yield ee(e);try{M=yield l(((e,t)=>F(void 0,null,(function*(){t||e?2!=D&&(Z(1),E++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==o||o(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!a(M),save:ne,startAutoSave:()=>F(void 0,null,(function*(){return le(),yield ne(),H=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!a(H),getStatus:()=>D,addStatusListener:e=>W(e,q),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(P(U,h).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:E,saves:R})},f);return b(oe)},B=e("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),G=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>o(256*r.random()))))(e),J=(e=16)=>{return t=(e,t)=>e+B[63&t],G(new Uint8Array(e)).reduce(t,"");var t};var K=Object.defineProperty,Q=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable,Y=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Z=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},a=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);u((n=n.apply(e,t)).next())}));const _=O();exports.createLocalSynchronizer=(e,n,r,o)=>{const i=J();return((e,n,r,o,i,s,c,d,v={})=>{let y,g=0,f=0,p=0;const h=O(),b=()=>J(11),w=(e,t,l,r)=>{f++,null==s||s(e,t,l,r),n(e,t,l,r)},A=(e,n,r,o)=>Z(void 0,null,(function*(){return new t(((t,a)=>{const u=o+"."+J(4),s=l((()=>{C(h,u),a(`No response from ${null!=e?e:"anyone"} to ${u}, `+n)}),i);L(h,u,[e,(e,n)=>{clearTimeout(s),C(h,u),t([e,n,o])}]),w(e,u,n,r)}))})),j=(e,[t,n])=>{S(t,(([t,n],l)=>{const r=M(e[0],l,E);S(t,(([e,t],n)=>{const l=M(r[0],n,E);S(e,(([e,t],n)=>l[0][n]=H(e,t))),l[1]=D(l[1],t)})),r[1]=D(r[1],n)})),e[1]=D(e[1],n)},T=(...t)=>Z(void 0,[...t],(function*(t=null,n,l=b()){try{a(n)&&([n,t,l]=yield A(null,1,"",l));const[r,o]=n,[u,i]=e.getMergeableContentHashes();let s=E();if(u!=r){const[n,r]=(yield A(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!m(r)){const[n,o]=(yield A(t,5,e.getMergeableRowHashes(r),l))[0];if(j(s,n),!m(o)){const n=(yield A(t,6,e.getMergeableCellHashes(o),l))[0];j(s,n)}}}return[s,i==o?E():(yield A(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==d||d(e)}})),x=q(e,(()=>Z(void 0,null,(function*(){const e=yield T();return!e||m(e[0][0])&&m(e[1][0])?void 0:e}))),((t,n)=>Z(void 0,null,(function*(){return n?w(null,b(),3,n):w(null,b(),2,e.getMergeableContentHashes())}))),(e=>y=e),(()=>y=void 0),d,2,((e,t)=>{for(var n in t||(t={}))W.call(t,n)&&Y(e,n,t[n]);if(Q)for(var n of Q(t))X.call(t,n)&&Y(e,n,t[n]);return e})({startSync:e=>Z(void 0,null,(function*(){return g=1,yield(yield x.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(g=0,x.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),x.stopSync()),getSynchronizerStats:()=>({sends:f,receives:p})},v),1);return r(((t,n,l,r)=>{const o=g||x.isAutoLoading();p++,null==c||c(t,n,l,r),0==l?u(P(h,n),(([e,n])=>a(e)||e==t?n(r,t):0)):2==l&&o?T(t,r,null!=n?n:void 0).then((e=>{null==y||y(void 0,e)})).catch(d):3==l&&o?null==y||y(void 0,r):u(1==l&&(g||x.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(r):5==l?e.getMergeableRowDiff(r):6==l?e.getMergeableCellDiff(r):7==l?e.getMergeableValueDiff(r):void 0,(e=>{w(t,n,0,e)}))})),x})(e,((e,t,n,r)=>l((()=>{var l,o;return a(e)?(o=(e,l)=>e!=i?l(i,t,n,r):0,A(_,((e,t)=>o(t,e)))):null==(l=P(_,e))?void 0:l(i,t,n,r)}))),(e=>{L(_,i,e)}),(()=>{C(_,i)}),.01,n,r,o)};
