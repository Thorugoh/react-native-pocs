"use strict";var e=require("cloudflare:workers");const t="",n=(e,t="",n)=>e.split(t,n),l=Promise,r=globalThis,o=(e,t=0)=>setTimeout(e,1e3*t),s=Math,a=s.floor,i=e=>null==e,u=(e,t,n)=>i(e)?null==n?void 0:n():t(e),c=e=>Array.isArray(e),d=(e,t,n)=>e.slice(t,n),h=e=>e.length,v=e=>{throw Error(e)},g=(e,t)=>e.forEach(t),y=(e,t)=>e.map(t),p=(e,...t)=>e.push(...t),f=e=>e.shift(),b=Object,S=e=>b.getPrototypeOf(e),w=b.entries,m=b.keys,C=b.freeze,M=(e,t)=>g(w(e),(([e,n])=>t(n,e))),P=e=>(e=>!i(e)&&u(S(e),(e=>e==b.prototype||i(S(e))),(()=>!0)))(e)&&0==(e=>h(m(e)))(e),O=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),x=JSON.stringify,A=JSON.parse,k=(e,t)=>{const n=e.indexOf("\n");-1!==n&&t(d(e,0,n),d(e,n+1))},T=(e,...n)=>j(null!=e?e:t,x(n,((e,t)=>void 0===t?"￼":t))),j=(e,t)=>e+"\n"+t,L=e=>i(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),I=(e,t)=>null==e?void 0:e.forEach(t),D=(e,t)=>null==e?void 0:e.delete(t),W=e=>new Map(e),E=(e,t)=>null==e?void 0:e.get(t),H=(e,t,n)=>i(n)?(D(e,t),e):null==e?void 0:e.set(t,n),R=(e,t,n,l)=>{var r,o,s;return o=t,null!=(s=null==(r=e)?void 0:r.has(o))&&s?null==l||l(E(e,t)):H(e,t,n()),E(e,t)},N=(e,t,n,l,r=0)=>u((n?R:E)(e,t[r],r>h(t)-2?n:W),(o=>{if(r>h(t)-2)return(null==l?void 0:l(o))&&H(e,t[r]),o;const s=N(o,t,n,l,r+1);return L(o)&&H(e,t[r]),s})),z=(e,t)=>t?[e,t]:[e],F=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},U=(e="")=>z(((e=[])=>b.fromEntries(e))(),e),V=e=>new Set(c(e)||i(e)?e:[e]),q=/^\d+$/;var J=Object.defineProperty,$=Object.getOwnPropertySymbols,B=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,K=(e,t,n)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Q=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{a(n.next(e))}catch(e){r(e)}},s=e=>{try{a(n.throw(e))}catch(e){r(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,s);a((n=n.apply(e,t)).next())}));const X=W(),Y=W(),Z=(e,n,l,r,o,s,a,d={},y=0,b=[])=>{let S,w,m,M=0,O=0,x=0;R(X,b,(()=>0)),R(Y,b,(()=>[]));const A=W(),[k,T,j,z,F]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!P(e)||!P(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!P(e)||!P(t),t.setContent]:v("Store type not supported by this Persister"))(a,e,y),[U,J,Z]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var r;return null!=(r=l?f(e):null)?r:t+n++},t=>{q.test(t)&&h(e)<1e3&&p(e,t)}]})(),r=W();return[(l,o,s,a=[],i=()=>[])=>{null!=e||(e=se);const u=n(1);var c,d;return H(r,u,[l,o,s,a,i]),d=u,null==(c=N(o,null!=s?s:[t],V))||c.add(d),u},(n,l,...o)=>g(((e,n=[t])=>{const l=[],r=(e,t)=>t==h(n)?p(l,e):null===n[t]?I(e,(e=>r(e,t+1))):g([n[t],null],(n=>r(E(e,n),t+1)));return r(e,0),l})(n,l),(t=>I(t,(t=>E(r,t)[0](e,...null!=l?l:[],...o))))),e=>u(E(r,e),(([,n,o])=>(N(n,null!=o?o:[t],void 0,(t=>(D(t,e),L(t)?1:0))),H(r,e),l(e),o))),t=>u(E(r,t),(([t,,n=[],l,r])=>{const o=(...s)=>{var a,u;const c=h(s);c==h(n)?t(e,...s,...r(s)):i(n[c])?g(null!=(u=null==(a=l[c])?void 0:a.call(l,...s))?u:[],(e=>o(...s,e))):o(...s,n[c])};o()}))]})(),_=e=>{e!=M&&(M=e,J(A,void 0,M))},ee=t=>{(k&&c(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},te=e=>Q(void 0,null,(function*(){return 2!=M&&(_(1),O++,yield oe((()=>Q(void 0,null,(function*(){try{const t=yield n();c(t)?ee(t):e?F(e):v("Content is not an array: "+t)}catch(t){e&&F(e)}_(0)}))))),se})),ne=()=>(w&&(o(w),w=void 0),se),le=e=>Q(void 0,null,(function*(){return 1!=M&&(_(2),x++,yield oe((()=>Q(void 0,null,(function*(){try{yield l(T,e)}catch(e){}_(0)}))))),se})),re=()=>(m&&(e.delListener(m),m=void 0),se),oe=(...e)=>Q(void 0,null,(function*(){return p(E(Y,b),...e),yield Q(void 0,null,(function*(){if(!E(X,b)){for(H(X,b,1);!i(S=f(E(Y,b)));)try{yield S()}catch(e){}H(X,b,0)}})),se})),se=((e,t)=>{for(var n in t||(t={}))B.call(t,n)&&K(e,n,t[n]);if($)for(var n of $(t))G.call(t,n)&&K(e,n,t[n]);return e})({load:te,startAutoLoad:e=>Q(void 0,null,(function*(){ne(),yield te(e);try{w=yield r(((e,t)=>Q(void 0,null,(function*(){t||e?2!=M&&(_(1),O++,ee(null!=t?t:e),_(0)):yield te()}))))}catch(e){}return se})),stopAutoLoad:ne,isAutoLoading:()=>!i(w),save:le,startAutoSave:()=>Q(void 0,null,(function*(){return re(),yield le(),m=e.addDidFinishTransactionListener((()=>{const e=j();z(e)&&le(e)})),se})),stopAutoSave:re,isAutoSaving:()=>!i(m),getStatus:()=>M,addStatusListener:e=>U(e,A),delListener:t=>(Z(t),e),schedule:oe,getStore:()=>e,destroy:()=>(E(Y,b).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:O,saves:x})},d);return C(se)},_=n("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),ee=r.crypto?e=>r.crypto.getRandomValues(e):e=>y(e,(()=>a(256*s.random()))),te=(e=16)=>{return t=(e,t)=>e+_[63&t],ee(new Uint8Array(e)).reduce(t,"");var t};var ne,le,re,oe,se=Object.defineProperty,ae=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,ce=(e,t,n)=>t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,de=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{a(n.next(e))}catch(e){r(e)}},s=e=>{try{a(n.throw(e))}catch(e){r(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,s);a((n=n.apply(e,t)).next())})),he=e=>{throw TypeError(e)},ve=(e,t,n)=>t.has(e)||he("Cannot "+n),ge=(e,t,n)=>(ve(e,t,"read from private field"),n?n.call(e):t.get(e)),ye=(e,t,n)=>t.has(e)?he("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),pe=(e,t,n)=>(ve(e,t,"access private method"),n),fe=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{a(n.next(e))}catch(e){r(e)}},s=e=>{try{a(n.throw(e))}catch(e){r(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,s);a((n=n.apply(e,t)).next())}));const be=/\/([^?]*)/,Se="S",we=e=>{var n,l,r,o;return null!=(l=null==(r=new URL(e.url).pathname,o=be,n=null==r?void 0:r.match(o))?void 0:n[1])?l:t},me=e=>{var t;return"websocket"==(null==(t=e.headers.get("upgrade"))?void 0:t.toLowerCase())?e.headers.get("sec-websocket-key"):null},Ce=(e,t=null,n=null)=>new Response(n,{status:e,webSocket:t}),Me=()=>Ce(426,null,"Upgrade required");class Pe extends e.DurableObject{constructor(e,n){super(e,n),ye(this,le),ye(this,ne),this.ctx.blockConcurrencyWhile((()=>fe(this,null,(function*(){return yield u(yield this.createPersister(),(e=>fe(this,null,(function*(){const n=((e,n,r,s,a,c,d,h,v={})=>{let g,y=0,p=0,f=0;const b=W(),S=()=>te(11),w=(e,t,l,r)=>{p++,n(e,t,l,r)},m=(e,t,n,r)=>de(void 0,null,(function*(){return new l(((l,s)=>{const i=r+"."+te(4),u=o((()=>{D(b,i),s(`No response from ${null!=e?e:"anyone"} to ${i}, `+t)}),a);H(b,i,[e,(e,t)=>{clearTimeout(u),D(b,i),l([e,t,r])}]),w(e,i,t,n)}))})),C=(e,[t,n])=>{M(t,(([t,n],l)=>{const r=O(e[0],l,U);M(t,(([e,t],n)=>{const l=O(r[0],n,U);M(e,(([e,t],n)=>l[0][n]=z(e,t))),l[1]=F(l[1],t)})),r[1]=F(r[1],n)})),e[1]=F(e[1],n)},x=(...n)=>de(void 0,[...n],(function*(n=null,l,r=S()){try{i(l)&&([l,n,r]=yield m(null,1,t,r));const[o,s]=l,[a,u]=e.getMergeableContentHashes();let c=U();if(a!=o){const[t,l]=(yield m(n,4,e.getMergeableTableHashes(),r))[0];if(c=t,!P(l)){const[t,o]=(yield m(n,5,e.getMergeableRowHashes(l),r))[0];if(C(c,t),!P(o)){const t=(yield m(n,6,e.getMergeableCellHashes(o),r))[0];C(c,t)}}}return[c,u==s?U():(yield m(n,7,e.getMergeableValueHashes(),r))[0],1]}catch(e){}})),A=Z(e,(()=>de(void 0,null,(function*(){const e=yield x();return!e||P(e[0][0])&&P(e[1][0])?void 0:e}))),((t,n)=>de(void 0,null,(function*(){return n?w(null,S(),3,n):w(null,S(),2,e.getMergeableContentHashes())}))),(e=>g=e),(()=>g=void 0),0,2,((e,t)=>{for(var n in t||(t={}))ie.call(t,n)&&ce(e,n,t[n]);if(ae)for(var n of ae(t))ue.call(t,n)&&ce(e,n,t[n]);return e})({startSync:e=>de(void 0,null,(function*(){return y=1,yield(yield A.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(y=0,A.stopAutoLoad().stopAutoSave()),destroy:()=>A.stopSync(),getSynchronizerStats:()=>({sends:p,receives:f})},v),1);return r(((t,n,l,r)=>{const o=y||A.isAutoLoading();f++,0==l?u(E(b,n),(([e,n])=>i(e)||e==t?n(r,t):0)):2==l&&o?x(t,r,null!=n?n:void 0).then((e=>{null==g||g(void 0,e)})).catch(h):3==l&&o?null==g||g(void 0,r):u(1==l&&(y||A.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(r):5==l?e.getMergeableRowDiff(r):6==l?e.getMergeableCellDiff(r):7==l?e.getMergeableValueDiff(r):void 0,(e=>{w(t,n,0,e)}))})),A})(e.getStore(),((e,t,n,l)=>pe(this,le,re).call(this,Se,T(e,t,n,l))),(e=>{return n=t=>((e,t)=>k(e,((e,n)=>{return t(e,...(l=n,A(l,((e,t)=>"￼"===t?void 0:t))));var l})))(t,e),ve(this,t=ne,"write to private field"),t.set(this,n),n;var t,n}),0,1);yield e.load(),yield e.startAutoSave(),o(n.startSync)}))))}))))}fetch(e){const n=we(e);return u(me(e),(e=>{const[l,r]=(o=new WebSocketPair,b.values(o));var o,s;return s=pe(this,le,oe).call(this),0==h(s)&&this.onPathId(n,1),this.ctx.acceptWebSocket(r,[e,n]),this.onClientId(n,e,1),r.send(T(Se,null,1,t)),Ce(101,l)}),Me)}webSocketMessage(e,t){u(this.ctx.getTags(e)[0],(n=>pe(this,le,re).call(this,n,t.toString(),e)))}webSocketClose(e){const[t,n]=this.ctx.getTags(e);this.onClientId(n,t,-1),1==h(pe(this,le,oe).call(this))&&this.onPathId(n,-1)}createPersister(){}getPathId(){var e;return null==(e=this.ctx.getTags(pe(this,le,oe).call(this)[0]))?void 0:e[1]}getClientIds(){return y(pe(this,le,oe).call(this),(e=>this.ctx.getTags(e)[0]))}onPathId(e,t){}onClientId(e,t,n){}onMessage(e,t,n){}}ne=new WeakMap,le=new WeakSet,re=function(e,n,l){k(n.toString(),((n,r)=>{var o,s,a;const i=j(e,r);this.onMessage(e,n,r),n==t?(e!=Se&&(null==(o=ge(this,ne))||o.call(this,i)),g(pe(this,le,oe).call(this),(e=>{e!=l&&e.send(i)}))):n==Se?null==(s=ge(this,ne))||s.call(this,i):n!=e&&(null==(a=pe(this,le,oe).call(this,n)[0])||a.send(i))}))},oe=function(e){return this.ctx.getWebSockets(e)},exports.WsServerDurableObject=Pe,exports.getWsServerDurableObjectFetch=e=>(t,n)=>me(t)?n[e].get(n[e].idFromName(we(t))).fetch(t):Me();
