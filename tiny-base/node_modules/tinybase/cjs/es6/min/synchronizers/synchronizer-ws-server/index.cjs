"use strict";const e="",t="error",n=(e,t="",n)=>e.split(t,n),l=Promise,o=globalThis,r=Math,a=r.floor,s=e=>null==e,i=(e,t,n)=>s(e)?null==n?void 0:n():t(e),u=e=>Array.isArray(e),c=(e,t,n)=>e.slice(t,n),d=e=>e.length,v=e=>{throw Error(e)},y=(e,t)=>e.forEach(t),g=(e,t,n)=>e.reduce(t,n),f=(e,...t)=>e.push(...t),p=e=>e.shift(),h=Object,b=e=>h.getPrototypeOf(e),S=h.entries,m=h.keys,w=h.freeze,A=(e,t)=>y(S(e),(([e,n])=>t(n,e))),C=e=>(e=>!s(e)&&i(b(e),(e=>e==h.prototype||s(b(e))),(()=>!0)))(e)&&0==(e=>d(m(e)))(e),M=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),O=e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0},P=(L=O,e=>g(x(e),((e,t)=>e+L(t)),0));var L;const j=e=>s(e)||0==O(e),x=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},T=(e,t)=>null==e?void 0:e.forEach(t),H=(e,t)=>null==e?void 0:e.delete(t),D=e=>new Map(e),E=e=>{var t;return[...null!=(t=null==e?void 0:e.keys())?t:[]]},I=(e,t)=>null==e?void 0:e.get(t),k=(e,t,n)=>s(n)?(H(e,t),e):null==e?void 0:e.set(t,n),z=(e,t,n,l)=>{var o,r,a;return r=t,null!=(a=null==(o=e)?void 0:o.has(r))&&a?null==l||l(I(e,t)):k(e,t,n()),I(e,t)},N=(e,t,n,l,o=0)=>i((n?z:I)(e,t[o],o>d(t)-2?n:D),(r=>{if(o>d(t)-2)return(null==l?void 0:l(r))&&k(e,t[o]),r;const a=N(r,t,n,l,o+1);return j(r)&&k(e,t[o]),a})),R=JSON.stringify,V=JSON.parse,J=(e,t)=>{const n=e.indexOf("\n");-1!==n&&t(c(e,0,n),c(e,n+1))},W=(e,t)=>e+"\n"+t,$=(e,t)=>t?[e,t]:[e],F=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},U=(e="")=>$(((e=[])=>h.fromEntries(e))(),e),q=e=>new Set(u(e)||s(e)?e:[e]),B=/^\d+$/,G=t=>{let n;const[l,o]=(()=>{const t=[];let n=0;return[l=>{var o;return null!=(o=l?p(t):null)?o:e+n++},e=>{B.test(e)&&d(t)<1e3&&f(t,e)}]})(),r=D();return[(o,a,s,i=[],u=()=>[])=>{null!=n||(n=t());const c=l(1);var d,v;return k(r,c,[o,a,s,i,u]),v=c,null==(d=N(a,null!=s?s:[e],q))||d.add(v),c},(t,l,...o)=>y(((t,n=[e])=>{const l=[],o=(e,t)=>t==d(n)?f(l,e):null===n[t]?T(e,(e=>o(e,t+1))):y([n[t],null],(n=>o(I(e,n),t+1)));return o(t,0),l})(t,l),(e=>T(e,(e=>I(r,e)[0](n,...null!=l?l:[],...o))))),t=>i(I(r,t),(([,n,l])=>(N(n,null!=l?l:[e],void 0,(e=>(H(e,t),j(e)?1:0))),k(r,t),o(t),l))),e=>i(I(r,e),(([e,,t=[],l,o])=>{const r=(...a)=>{var i,u;const c=d(a);c==d(t)?e(n,...a,...o(a)):s(t[c])?y(null!=(u=null==(i=l[c])?void 0:i.call(l,...a))?u:[],(e=>r(...a,e))):r(...a,t[c])};r()}))]};var K=Object.defineProperty,Q=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,Z=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{s(n.next(e))}catch(e){o(e)}},a=e=>{try{s(n.throw(e))}catch(e){o(e)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);s((n=n.apply(e,t)).next())}));const ee=D(),te=D(),ne=n("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),le=o.crypto?e=>o.crypto.getRandomValues(e):e=>(e=>e.map((()=>a(256*r.random()))))(e),oe=(e=16)=>g(le(new Uint8Array(e)),((e,t)=>e+ne[63&t]),"");var re=Object.defineProperty,ae=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable,ue=(e,t,n)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ce=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{s(n.next(e))}catch(e){o(e)}},a=e=>{try{s(n.throw(e))}catch(e){o(e)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);s((n=n.apply(e,t)).next())}));var de=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{s(n.next(e))}catch(e){o(e)}},a=e=>{try{s(n.throw(e))}catch(e){o(e)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);s((n=n.apply(e,t)).next())}));const ve=/\/([^?]*)/;exports.createWsServer=(n,o,r)=>{const a=D(),c=D(),d=D(),g=D(),[h,b,S]=G((()=>x)),m=e=>{var t,n;null==(t=e[1])||t.destroy(),null==(n=e[2])||n.destroy()},L=(t,n,l)=>o=>J(o,((o,r)=>{var a,s,i;const u=W(t,r);var c;o===e?("S"!==t&&(null==(a=l[3])||a.call(l,u)),c=(e,n)=>e!==t?n.send(u):0,T(n,((e,t)=>c(t,e)))):"S"===o?null==(s=l[3])||s.call(l,u):null==(i=I(n,o))||i.send(u)}));n.on("connection",((n,h)=>{return i((S=h.url,O=ve,null==S?void 0:S.match(O)),(([,S])=>i(h.headers["sec-websocket-key"],(h=>de(void 0,null,(function*(){const O=z(d,S,D),P=z(g,S,(()=>[0])),x=L(h,O,P);j(O)&&(b(a,void 0,S,1),yield((t,n,a)=>de(void 0,null,(function*(){return i(yield null==o?void 0:o(n),(n=>{t[0]=1,t[1]=u(n)?n[0]:n;const o=L("S",a,t);t[2]=((t,n,o,r,a,c,d,y,g={})=>{let h,b=0,S=0,m=0;const O=D(),P=()=>oe(11),L=(e,t,l,o)=>{S++,n(e,t,l,o)},j=(e,t,n,o)=>ce(void 0,null,(function*(){return new l(((l,r)=>{const s=o+"."+oe(4),i=((e,t=0)=>setTimeout(e,1e3*t))((()=>{H(O,s),r(`No response from ${null!=e?e:"anyone"} to ${s}, `+t)}),a);k(O,s,[e,(e,t)=>{clearTimeout(i),H(O,s),l([e,t,o])}]),L(e,s,t,n)}))})),x=(e,[t,n])=>{A(t,(([t,n],l)=>{const o=M(e[0],l,U);A(t,(([e,t],n)=>{const l=M(o[0],n,U);A(e,(([e,t],n)=>l[0][n]=$(e,t))),l[1]=F(l[1],t)})),o[1]=F(o[1],n)})),e[1]=F(e[1],n)},T=(...n)=>ce(void 0,[...n],(function*(n=null,l,o=P()){try{s(l)&&([l,n,o]=yield j(null,1,e,o));const[r,a]=l,[i,u]=t.getMergeableContentHashes();let c=U();if(i!=r){const[e,l]=(yield j(n,4,t.getMergeableTableHashes(),o))[0];if(c=e,!C(l)){const[e,r]=(yield j(n,5,t.getMergeableRowHashes(l),o))[0];if(x(c,e),!C(r)){const e=(yield j(n,6,t.getMergeableCellHashes(r),o))[0];x(c,e)}}}return[c,u==a?U():(yield j(n,7,t.getMergeableValueHashes(),o))[0],1]}catch(e){null==y||y(e)}})),E=((e,t,n,l,o,r,a,i={},c=0,d=[])=>{let y,g,h,b=0,S=0,m=0;z(ee,d,(()=>0)),z(te,d,(()=>[]));const A=D(),[M,O,P,L,j]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!C(e)||!C(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!C(e)||!C(t),t.setContent]:v("Store type not supported by this Persister"))(a,e,c),[x,T,H]=G((()=>F)),E=e=>{e!=b&&(b=e,T(A,void 0,b))},N=t=>{(M&&u(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},R=e=>_(void 0,null,(function*(){return 2!=b&&(E(1),S++,yield $((()=>_(void 0,null,(function*(){try{const n=yield t();u(n)?N(n):e?j(e):v("Content is not an array: "+n)}catch(t){null==r||r(t),e&&j(e)}E(0)}))))),F})),V=()=>(g&&(o(g),g=void 0),F),J=e=>_(void 0,null,(function*(){return 1!=b&&(E(2),m++,yield $((()=>_(void 0,null,(function*(){try{yield n(O,e)}catch(e){null==r||r(e)}E(0)}))))),F})),W=()=>(h&&(e.delListener(h),h=void 0),F),$=(...e)=>_(void 0,null,(function*(){return f(I(te,d),...e),yield _(void 0,null,(function*(){if(!I(ee,d)){for(k(ee,d,1);!s(y=p(I(te,d)));)try{yield y()}catch(e){null==r||r(e)}k(ee,d,0)}})),F})),F=((e,t)=>{for(var n in t||(t={}))X.call(t,n)&&Z(e,n,t[n]);if(Q)for(var n of Q(t))Y.call(t,n)&&Z(e,n,t[n]);return e})({load:R,startAutoLoad:e=>_(void 0,null,(function*(){V(),yield R(e);try{g=yield l(((e,t)=>_(void 0,null,(function*(){t||e?2!=b&&(E(1),S++,N(null!=t?t:e),E(0)):yield R()}))))}catch(e){null==r||r(e)}return F})),stopAutoLoad:V,isAutoLoading:()=>!s(g),save:J,startAutoSave:()=>_(void 0,null,(function*(){return W(),yield J(),h=e.addDidFinishTransactionListener((()=>{const e=P();L(e)&&J(e)})),F})),stopAutoSave:W,isAutoSaving:()=>!s(h),getStatus:()=>b,addStatusListener:e=>x(e,A),delListener:t=>(H(t),e),schedule:$,getStore:()=>e,destroy:()=>(I(te,d).splice(0,void 0),V().stopAutoSave()),getStats:()=>({loads:S,saves:m})},i);return w(F)})(t,(()=>ce(void 0,null,(function*(){const e=yield T();return!e||C(e[0][0])&&C(e[1][0])?void 0:e}))),((e,n)=>ce(void 0,null,(function*(){return n?L(null,P(),3,n):L(null,P(),2,t.getMergeableContentHashes())}))),(e=>h=e),(()=>h=void 0),y,2,((e,t)=>{for(var n in t||(t={}))se.call(t,n)&&ue(e,n,t[n]);if(ae)for(var n of ae(t))ie.call(t,n)&&ue(e,n,t[n]);return e})({startSync:e=>ce(void 0,null,(function*(){return b=1,yield(yield E.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(b=0,E.stopAutoLoad().stopAutoSave()),destroy:()=>E.stopSync(),getSynchronizerStats:()=>({sends:S,receives:m})},g),1);return o(((e,n,l,o)=>{const r=b||E.isAutoLoading();m++,0==l?i(I(O,n),(([t,n])=>s(t)||t==e?n(o,e):0)):2==l&&r?T(e,o,null!=n?n:void 0).then((e=>{null==h||h(void 0,e)})).catch(y):3==l&&r?null==h||h(void 0,o):i(1==l&&(b||E.isAutoSaving())?t.getMergeableContentHashes():4==l?t.getMergeableTableDiff(o):5==l?t.getMergeableRowDiff(o):6==l?t.getMergeableCellDiff(o):7==l?t.getMergeableValueDiff(o):void 0,(t=>{L(e,n,0,t)}))})),E})(t[1].getStore(),((t,n,l,r)=>o(((t,...n)=>W(null!=t?t:e,R(n,((e,t)=>void 0===t?"￼":t))))(t,n,l,r))),(e=>t[3]=t=>((e,t)=>J(e,((e,n)=>{return t(e,...(l=n,V(l,((e,t)=>"￼"===t?void 0:t))));var l})))(t,e)),0,1,0,0,r),t[4]=[],t[5]=u(n)?n[1]:e=>0}))})))(P,S,O)),k(O,h,n),b(c,[S],h,1),n.on("message",(e=>{const t=e.toString("utf8");0==P[0]?x(t):f(P[4],t)})),1==P[0]&&(yield(e=>de(void 0,null,(function*(){e[0]=2,yield e[1].schedule(e[1].startAutoLoad,e[1].startAutoSave,e[2].startSync),e[5](e[1].getStore()),e[0]=0})))(P),y(P[4],x),P[4]=[]),n.on("close",(()=>{H(O,h),b(c,[S],h,-1),j(O)&&(m(P),H(g,S),H(d,S),b(a,void 0,S,-1))})),r&&n.on(t,r)}))))));var S,O})),r&&n.on(t,r);const x={getWebSocketServer:()=>n,getPathIds:()=>E(d),getClientIds:e=>E(I(d,e)),addPathIdsListener:e=>h(e,a),addClientIdsListener:(e,t)=>h(t,c,[e]),delListener:e=>(S(e),x),getStats:()=>({paths:O(d),clients:P(d)}),destroy:()=>{d.clear(),T(g,m),n.close()}};return w(x)};
