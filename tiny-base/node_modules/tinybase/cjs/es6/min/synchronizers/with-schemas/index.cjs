"use strict";const e=(e,t="",n)=>e.split(t,n),t=Promise,n=globalThis,l=Math,o=l.floor,r=e=>null==e,a=(e,t,n)=>r(e)?null==n?void 0:n():t(e),i=e=>Array.isArray(e),u=e=>e.length,s=e=>{throw Error(e)},c=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),v=e=>e.shift(),y=Object,f=e=>y.getPrototypeOf(e),g=y.entries,p=y.keys,h=y.freeze,b=(e,t)=>c(g(e),(([e,n])=>t(n,e))),C=e=>(e=>!r(e)&&a(f(e),(e=>e==y.prototype||r(f(e))),(()=>!0)))(e)&&0==(e=>u(p(e)))(e),S=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),m=e=>r(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),M=(e,t)=>null==e?void 0:e.forEach(t),w=(e,t)=>null==e?void 0:e.delete(t),A=e=>new Map(e),O=(e,t)=>null==e?void 0:e.get(t),P=(e,t,n)=>r(n)?(w(e,t),e):null==e?void 0:e.set(t,n),D=(e,t,n,l)=>{var o,r,a;return r=t,null!=(a=null==(o=e)?void 0:o.has(r))&&a?null==l||l(O(e,t)):P(e,t,n()),O(e,t)},L=(e,t,n,l,o=0)=>a((n?D:O)(e,t[o],o>u(t)-2?n:A),(r=>{if(o>u(t)-2)return(null==l?void 0:l(r))&&P(e,t[o]),r;const a=L(r,t,n,l,o+1);return m(r)&&P(e,t[o]),a})),j=(e,t)=>t?[e,t]:[e],H=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},T=(e="")=>j(((e=[])=>y.fromEntries(e))(),e),x=e=>new Set(i(e)||r(e)?e:[e]),E=/^\d+$/;var G=Object.defineProperty,R=Object.getOwnPropertySymbols,z=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable,I=(e,t,n)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,$=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));const k=A(),F=A(),N=(e,t,n,l,o,y,f,g={},p=0,b=[])=>{let S,j,H,T=0,G=0,N=0;D(k,b,(()=>0)),D(F,b,(()=>[]));const U=A(),[q,B,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!C(e)||!C(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!C(e)||!C(t),t.setContent]:s("Store type not supported by this Persister"))(f,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?v(e):null)?l:""+t++},t=>{E.test(t)&&u(e)<1e3&&d(e,t)}]})(),l=A();return[(n,o,r,a=[],i=()=>[])=>{null!=e||(e=re);const u=t(1);var s,c;return P(l,u,[n,o,r,a,i]),c=u,null==(s=L(o,null!=r?r:[""],x))||s.add(c),u},(t,n,...o)=>c(((e,t=[""])=>{const n=[],l=(e,o)=>o==u(t)?d(n,e):null===t[o]?M(e,(e=>l(e,o+1))):c([t[o],null],(t=>l(O(e,t),o+1)));return l(e,0),n})(t,n),(t=>M(t,(t=>O(l,t)[0](e,...null!=n?n:[],...o))))),e=>a(O(l,e),(([,t,o])=>(L(t,null!=o?o:[""],void 0,(t=>(w(t,e),m(t)?1:0))),P(l,e),n(e),o))),t=>a(O(l,t),(([t,,n=[],l,o])=>{const a=(...i)=>{var s,d;const v=u(i);v==u(n)?t(e,...i,...o(i)):r(n[v])?c(null!=(d=null==(s=l[v])?void 0:s.call(l,...i))?d:[],(e=>a(...i,e))):a(...i,n[v])};a()}))]})(),Z=e=>{e!=T&&(T=e,X(U,void 0,T))},_=t=>{(q&&i(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>$(void 0,null,(function*(){return 2!=T&&(Z(1),G++,yield oe((()=>$(void 0,null,(function*(){try{const n=yield t();i(n)?_(n):e?Q(e):s("Content is not an array: "+n)}catch(t){null==y||y(t),e&&Q(e)}Z(0)}))))),re})),te=()=>(j&&(o(j),j=void 0),re),ne=e=>$(void 0,null,(function*(){return 1!=T&&(Z(2),N++,yield oe((()=>$(void 0,null,(function*(){try{yield n(B,e)}catch(e){null==y||y(e)}Z(0)}))))),re})),le=()=>(H&&(e.delListener(H),H=void 0),re),oe=(...e)=>$(void 0,null,(function*(){return d(O(F,b),...e),yield $(void 0,null,(function*(){if(!O(k,b)){for(P(k,b,1);!r(S=v(O(F,b)));)try{yield S()}catch(e){null==y||y(e)}P(k,b,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))z.call(t,n)&&I(e,n,t[n]);if(R)for(var n of R(t))V.call(t,n)&&I(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>$(void 0,null,(function*(){te(),yield ee(e);try{j=yield l(((e,t)=>$(void 0,null,(function*(){t||e?2!=T&&(Z(1),G++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==y||y(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!r(j),save:ne,startAutoSave:()=>$(void 0,null,(function*(){return le(),yield ne(),H=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!r(H),getStatus:()=>T,addStatusListener:e=>W(e,U),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(O(F,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:G,saves:N})},g);return h(re)},U=e("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),q=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>o(256*l.random()))))(e),B=(e=16)=>{return t=(e,t)=>e+U[63&t],q(new Uint8Array(e)).reduce(t,"");var t};var J=Object.defineProperty,K=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable,X=(e,t,n)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Y=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));exports.Message={Response:0,GetContentHashes:1,ContentHashes:2,ContentDiff:3,GetTableDiff:4,GetRowDiff:5,GetCellDiff:6,GetValueDiff:7},exports.createCustomSynchronizer=(e,n,l,o,i,u,s,c,d={})=>{let v,y=0,f=0,g=0;const p=A(),h=()=>B(11),m=(e,t,l,o)=>{f++,null==u||u(e,t,l,o),n(e,t,l,o)},M=(e,n,l,o)=>Y(void 0,null,(function*(){return new t(((t,r)=>{const a=o+"."+B(4),u=((e,t=0)=>setTimeout(e,1e3*t))((()=>{w(p,a),r(`No response from ${null!=e?e:"anyone"} to ${a}, `+n)}),i);P(p,a,[e,(e,n)=>{clearTimeout(u),w(p,a),t([e,n,o])}]),m(e,a,n,l)}))})),D=(e,[t,n])=>{b(t,(([t,n],l)=>{const o=S(e[0],l,T);b(t,(([e,t],n)=>{const l=S(o[0],n,T);b(e,(([e,t],n)=>l[0][n]=j(e,t))),l[1]=H(l[1],t)})),o[1]=H(o[1],n)})),e[1]=H(e[1],n)},L=(...t)=>Y(void 0,[...t],(function*(t=null,n,l=h()){try{r(n)&&([n,t,l]=yield M(null,1,"",l));const[o,a]=n,[i,u]=e.getMergeableContentHashes();let s=T();if(i!=o){const[n,o]=(yield M(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!C(o)){const[n,r]=(yield M(t,5,e.getMergeableRowHashes(o),l))[0];if(D(s,n),!C(r)){const n=(yield M(t,6,e.getMergeableCellHashes(r),l))[0];D(s,n)}}}return[s,u==a?T():(yield M(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==c||c(e)}})),x=N(e,(()=>Y(void 0,null,(function*(){const e=yield L();return!e||C(e[0][0])&&C(e[1][0])?void 0:e}))),((t,n)=>Y(void 0,null,(function*(){return n?m(null,h(),3,n):m(null,h(),2,e.getMergeableContentHashes())}))),(e=>v=e),(()=>v=void 0),c,2,((e,t)=>{for(var n in t||(t={}))Q.call(t,n)&&X(e,n,t[n]);if(K)for(var n of K(t))W.call(t,n)&&X(e,n,t[n]);return e})({startSync:e=>Y(void 0,null,(function*(){return y=1,yield(yield x.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(y=0,x.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),x.stopSync()),getSynchronizerStats:()=>({sends:f,receives:g})},d),1);return l(((t,n,l,o)=>{const i=y||x.isAutoLoading();g++,null==s||s(t,n,l,o),0==l?a(O(p,n),(([e,n])=>r(e)||e==t?n(o,t):0)):2==l&&i?L(t,o,null!=n?n:void 0).then((e=>{null==v||v(void 0,e)})).catch(c):3==l&&i?null==v||v(void 0,o):a(1==l&&(y||x.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{m(t,n,0,e)}))})),x};
