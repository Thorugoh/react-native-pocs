"use strict";const e=e=>null==e,t=(t,n,r)=>e(t)?r?.():n(t),n=e=>e.length,r=(e,t)=>e.includes(t),s=(e,t)=>e.forEach(t),o=e=>0==n(e),c=(e,...t)=>e.push(...t),l=e=>e.pop(),i=e=>e.shift(),a=Object.freeze,d=e=>e?.size??0,u=(h=d,e=>{return t=(e,t)=>e+h(t),g(e).reduce(t,0);var t});var h;const p=(e,t)=>e?.has(t)??!1,k=t=>e(t)||0==d(t),g=e=>[...e?.values()??[]],C=(e,t)=>e?.forEach(t),f=(e,t)=>e?.delete(t),v=e=>new Map(e),L=(e,t)=>e?.get(t),w=(t,n,r)=>e(r)?(f(t,n),t):t?.set(n,r),S=(e,t,n,r)=>(p(e,t)?r?.(L(e,t)):w(e,t,n()),L(e,t)),y=(e,r,s,o,c=0)=>t((s?S:L)(e,r[c],c>n(r)-2?s:v),(t=>{if(c>n(r)-2)return o?.(t)&&w(e,r[c]),t;const l=y(t,r,s,o,c+1);return k(t)&&w(e,r[c]),l})),z=t=>new Set(Array.isArray(t)||e(t)?t:[t]),E=/^\d+$/,I=(()=>{const d=new WeakMap;return h=>{d.has(h)||d.set(h,(d=>{let h,g,I,V=100,A=v(),F=v(),M=1;const _=v(),b=v(),[j,x,B]=(()=>{let r;const[o,l]=(()=>{const e=[];let t=0;return[n=>(n?i(e):null)??""+t++,t=>{E.test(t)&&n(e)<1e3&&c(e,t)}]})(),a=v();return[(e,t,n,s=[],c=()=>[])=>{r??=ee;const l=o(1);var i,d;return w(a,l,[e,t,n,s,c]),i=y(t,n??[""],z),d=l,i?.add(d),l},(e,t,...o)=>s(((e,t=[""])=>{const r=[],o=(e,l)=>l==n(t)?c(r,e):null===t[l]?C(e,(e=>o(e,l+1))):s([t[l],null],(t=>o(L(e,t),l+1)));return o(e,0),r})(e,t),(e=>C(e,(e=>L(a,e)[0](r,...t??[],...o))))),e=>t(L(a,e),(([,t,n])=>(y(t,n??[""],void 0,(t=>(f(t,e),k(t)?1:0))),w(a,e),l(e),n))),o=>t(L(a,o),(([t,,o=[],c,l])=>{const i=(...a)=>{const d=n(a);d==n(o)?t(r,...a,...l(a)):e(o[d])?s(c[d]?.(...a)??[],(e=>i(...a,e))):i(...a,o[d])};i()}))]})(),O=v(),T=v(),W=[],$=[],m=(t,n)=>{M=0,d.transaction((()=>{const[r,s]=L(O,n);C(r,((n,r)=>C(n,((n,s)=>C(n,((n,o)=>((t,n,r,s,o)=>e(o)?t.delCell(n,r,s,!0):t.setCell(n,r,s,o))(d,r,s,o,n[t]))))))),C(s,((n,r)=>((t,n,r)=>e(r)?t.delValue(n):t.setValue(n,r))(d,r,n[t])))})),M=1},q=e=>{w(O,e),w(T,e),x(b,[e])},D=(e,t)=>s(((e,t)=>e.splice(0,t))(e,t??n(e)),q),G=()=>D(W,n(W)-V),H=()=>t(h,(()=>{c(W,h),G(),D($),h=void 0,I=1})),J=()=>{h=l(W),I=1};let K,N;const P=(t="")=>(e(h)&&(h=""+g++,w(O,h,[A,F]),Y(h,t),A=v(),F=v(),I=1),h),Q=()=>{o(W)||(((e,...t)=>{e.unshift(...t)})($,P()),m(0,h),h=l(W),I=1)},R=()=>{o($)||(c(W,h),h=i($),m(1,h),I=1)},U=()=>{I&&(x(_),I=0)},X=e=>{const t=P(e);return U(),t},Y=(e,t)=>(Z(e)&&L(T,e)!==t&&(w(T,e,t),x(b,[e])),ee),Z=e=>p(O,e),ee={setSize:e=>(V=e,G(),ee),addCheckpoint:X,setCheckpoint:Y,getStore:()=>d,getCheckpointIds:()=>[[...W],h,[...$]],forEachCheckpoint:e=>{return t=e,C(T,((e,n)=>t(n,e)));var t},hasCheckpoint:Z,getCheckpoint:e=>L(T,e),goBackward:()=>(Q(),U(),ee),goForward:()=>(R(),U(),ee),goTo:t=>{const n=r(W,t)?Q:r($,t)?R:null;for(;!e(n)&&t!=h;)n();return U(),ee},addCheckpointIdsListener:e=>j(e,_),addCheckpointListener:(e,t)=>j(t,b,[e]),delListener:e=>(B(e),ee),clear:()=>(D(W),D($),e(h)||q(h),h=void 0,g=0,X(),ee),clearForward:()=>(o($)||(D($),x(_)),ee),destroy:()=>{d.delListener(K),d.delListener(N)},getListenerStats:()=>({checkpointIds:u(_),checkpoint:u(b)}),_registerListeners:()=>{K=d.addCellListener(null,null,null,((e,t,n,r,s,o)=>{if(M){H();const e=S(A,t,v),c=S(e,n,v),l=S(c,r,(()=>[o,void 0]));l[1]=s,l[0]===s&&k(w(c,r))&&k(w(e,n))&&k(w(A,t))&&J(),U()}})),N=d.addValueListener(null,((e,t,n,r)=>{if(M){H();const e=S(F,t,(()=>[r,void 0]));e[1]=n,e[0]===n&&k(w(F,t))&&J(),U()}}))}};return a(ee.clear())})(h));const g=d.get(h);return g._registerListeners(),g}})();exports.createCheckpoints=I;
