"use strict";const e=e=>typeof e,t="",r=e(t),n=e(e),s=Math,i=s.max,o=s.min,c=isFinite,a=e=>null==e,d=(e,t,r)=>a(e)?r?.():t(e),l=e=>Array.isArray(e),u=e=>e.length,v=()=>{},h=(e,t)=>e.forEach(t),M=e=>f(e,((e,t)=>e+t),0),f=(e,t,r)=>e.reduce(t,r),g=(e,...t)=>e.push(...t),L=Object.freeze,m=e=>e?.size??0,w=(y=m,e=>f(I(e),((e,t)=>e+y(t)),0));var y;const p=(e,t)=>e?.has(t)??!1,b=e=>a(e)||0==m(e),I=e=>[...e?.values()??[]],x=e=>e.clear(),E=(e,t)=>e?.forEach(t),R=(e,t)=>e?.delete(t),S=e=>new Map(e),T=(e,t)=>e?.get(t),k=(e,t)=>E(e,((e,r)=>t(r,e))),z=(e,t,r)=>a(r)?(R(e,t),e):e?.set(t,r),A=(e,t,r,n)=>(p(e,t)?n?.(T(e,t)):z(e,t,r()),T(e,t)),D=(e,t,r,n,s=0)=>d((r?A:T)(e,t[s],s>u(t)-2?r:S),(i=>{if(s>u(t)-2)return n?.(i)&&z(e,t[s]),i;const o=D(i,t,r,n,s+1);return b(i)&&z(e,t[s]),o})),N=S([["avg",[(e,t)=>M(e)/t,(e,t,r)=>e+(t-e)/(r+1),(e,t,r)=>e+(e-t)/(r-1),(e,t,r,n)=>e+(t-r)/n]],["max",[e=>i(...e),(e,t)=>i(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:i(t,e)]],["min",[e=>o(...e),(e,t)=>o(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:o(t,e)]],["sum",[e=>M(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,r)=>e-r+t]]]),j=e=>new Set(l(e)||a(e)?e:[e]),C=(e,t)=>e?.add(t),F=/^\d+$/,O=(()=>{const s=new WeakMap;return i=>(s.has(i)||s.set(i,(s=>{const i=S(),[o,M,f]=(()=>{let e;const[r,n]=(()=>{const e=[];let r=0;return[n=>(n?e.shift():null)??t+r++,t=>{F.test(t)&&u(e)<1e3&&g(e,t)}]})(),s=S();return[(n,i,o,c=[],a=()=>[])=>{e??=Q;const d=r(1);return z(s,d,[n,i,o,c,a]),C(D(i,o??[t],j),d),d},(r,n,...i)=>h(((e,r=[t])=>{const n=[],s=(e,t)=>t==u(r)?g(n,e):null===r[t]?E(e,(e=>s(e,t+1))):h([r[t],null],(r=>s(T(e,r),t+1)));return s(e,0),n})(r,n),(t=>E(t,(t=>T(s,t)[0](e,...n??[],...i))))),e=>d(T(s,e),(([,r,i])=>(D(r,i??[t],void 0,(t=>(R(t,e),b(t)?1:0))),z(s,e),n(e),i))),t=>d(T(s,t),(([t,,r=[],n,s])=>{const i=(...o)=>{const c=u(o);c==u(r)?t(e,...o,...s(o)):a(r[c])?h(n[c]?.(...o)??[],(e=>i(...o,e))):i(...o,r[c])};i()}))]})(),[y,O,W,$,q,B,G,,H,J,K,P]=((e,r,n,s,i)=>{const o=e.hasRow,c=S(),v=S(),M=S(),f=S(),g=S(),L=S(),m=(t,r,...n)=>{const s=A(L,t,j);return h(n,(t=>C(s,t)&&r&&e.callListener(t))),n},w=(t,...r)=>d(T(L,t),(n=>{h(0==u(r)?I(n):r,(t=>{e.delListener(t),R(n,t)})),b(n)&&z(L,t)})),y=(e,t)=>{z(c,e,t),p(v,e)||(z(v,e,r()),z(f,e,S()),z(g,e,S()),i(M))},D=e=>{z(c,e),z(v,e),z(f,e),z(g,e),w(e),i(M)};return[()=>e,()=>{return e=c,[...e?.keys()??[]];var e},e=>k(v,e),e=>p(v,e),e=>T(c,e),e=>T(v,e),(e,t)=>z(v,e,t),y,(r,n,s,i,c)=>{y(r,n);const d=S(),v=S(),M=T(f,r),L=T(g,r),b=r=>{const s=t=>e.getCell(n,r,t),h=T(M,r),f=o(n,r)?(g=i(s,r),isNaN(g)||a(g)||!0===g||!1===g||g===t?void 0:1*g):void 0;var g,m,w,y;if(h===f||l(h)&&l(f)&&(w=f,u(m=h)===u(w)&&(y=(e,t)=>w[t]===e,m.every(y)))||z(d,r,[h,f]),!a(c)){const e=T(L,r),t=o(n,r)?c(s,r):void 0;e!=t&&z(v,r,t)}},I=e=>{s((()=>{E(d,(([,e],t)=>z(M,t,e))),E(v,((e,t)=>z(L,t,e)))}),d,v,M,L,e),x(d),x(v)};k(M,b),e.hasTable(n)&&h(e.getRowIds(n),(e=>{p(M,e)||b(e)})),I(!0),w(r),m(r,0,e.addRowListener(n,null,((e,t,r)=>b(r))),e.addTableListener(n,(()=>I())))},D,e=>s(e,M),()=>k(L,D),m,w]})(s,v,0,o,M),Q={setMetricDefinition:(t,s,o,d,l,u,v)=>{const h=e(o)==n?[o,l,u,v]:T(N,o)??T(N,"sum");return H(t,s,((e,r,n,s,o,d)=>{const l=B(t),u=m(s);d||=a(l),e();let v=((e,t,r,n,s,i=!1)=>{if(b(r))return;const[o,c,d,l]=s;return i||=a(e),E(n,(([r,n])=>{i||(e=a(r)?c?.(e,n,t++):a(n)?d?.(e,r,t--):l?.(e,n,r,t),i||=a(e))})),i?o(I(r),m(r)):e})(l,u,s,r,h,d);c(v)||(v=void 0),v!=l&&(G(t,v),M(i,[t],v,l))}),e(f=d)==r?e=>e(f):f??(()=>1)),Q;var f},delMetricDefinition:e=>(J(e),Q),getStore:y,getMetricIds:O,forEachMetric:W,hasMetric:$,getTableId:q,getMetric:B,addMetricIdsListener:K,addMetricListener:(e,t)=>o(t,i,[e]),delListener:e=>(f(e),Q),destroy:P,getListenerStats:()=>({metric:w(i)})};return L(Q)})(i)),s.get(i))})();exports.createMetrics=O;
