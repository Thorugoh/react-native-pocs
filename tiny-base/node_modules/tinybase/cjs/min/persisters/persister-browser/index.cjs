"use strict";const t=globalThis.window,e=t=>null==t,a=(t,a,s)=>e(t)?s?.():a(t),s=t=>Array.isArray(t),r=t=>t.length,n=t=>{throw Error(t)},o=(t,e)=>t.forEach(e),i=(t,...e)=>t.push(...e),c=t=>t.shift(),l=Object,u=t=>l.getPrototypeOf(t),g=l.keys,d=l.freeze,y=t=>(t=>!e(t)&&a(u(t),(t=>t==l.prototype||e(u(t))),(()=>!0)))(t)&&0==(t=>r(g(t)))(t),h=JSON.stringify,v=JSON.parse,p=t=>e(t)||0==(t=>t?.size??0)(t),w=(t,e)=>t?.forEach(e),S=(t,e)=>t?.delete(e),f=t=>new Map(t),C=(t,e)=>t?.get(e),A=(t,a,s)=>e(s)?(S(t,a),t):t?.set(a,s),L=(t,e,a,s)=>{var r,n;return r=t,n=e,r?.has(n)?s?.(C(t,e)):A(t,e,a()),C(t,e)},b=(t,e,s,n,o=0)=>a((s?L:C)(t,e[o],o>r(e)-2?s:f),(a=>{if(o>r(e)-2)return n?.(a)&&A(t,e[o]),a;const i=b(a,e,s,n,o+1);return p(a)&&A(t,e[o]),i})),M=t=>new Set(s(t)||e(t)?t:[t]),E=/^\d+$/,m=f(),O=f(),P=(t,l,u,g,h,v,P,T={},N=0,k=[])=>{let x,z,D,I=0,J=0,j=0;L(m,k,(()=>0)),L(O,k,(()=>[]));const F=f(),[V,$,q,B,G]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!y(t)||!y(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!y(t)||!y(e),e.setContent]:n("Store type not supported by this Persister"))(P,t,N),[H,K,Q]=(()=>{let t;const[s,n]=(()=>{const t=[];let e=0;return[a=>(a?c(t):null)??""+e++,e=>{E.test(e)&&r(t)<1e3&&i(t,e)}]})(),l=f();return[(e,a,r,n=[],o=()=>[])=>{t??=tt;const i=s(1);var c,u;return A(l,i,[e,a,r,n,o]),c=b(a,r??[""],M),u=i,c?.add(u),i},(e,a,...s)=>o(((t,e=[""])=>{const a=[],s=(t,n)=>n==r(e)?i(a,t):null===e[n]?w(t,(t=>s(t,n+1))):o([e[n],null],(e=>s(C(t,e),n+1)));return s(t,0),a})(e,a),(e=>w(e,(e=>C(l,e)[0](t,...a??[],...s))))),t=>a(C(l,t),(([,e,a])=>(b(e,a??[""],void 0,(e=>(S(e,t),p(e)?1:0))),A(l,t),n(t),a))),s=>a(C(l,s),(([a,,s=[],n,i])=>{const c=(...l)=>{const u=r(l);u==r(s)?a(t,...l,...i(l)):e(s[u])?o(n[u]?.(...l)??[],(t=>c(...l,t))):c(...l,s[u])};c()}))]})(),R=t=>{t!=I&&(I=t,K(F,void 0,I))},U=e=>{(V&&s(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},W=async t=>(2!=I&&(R(1),J++,await _((async()=>{try{const e=await l();s(e)?U(e):t?G(t):n("Content is not an array: "+e)}catch(e){v?.(e),t&&G(t)}R(0)}))),tt),X=()=>(z&&(h(z),z=void 0),tt),Y=async t=>(1!=I&&(R(2),j++,await _((async()=>{try{await u($,t)}catch(t){v?.(t)}R(0)}))),tt),Z=()=>(D&&(t.delListener(D),D=void 0),tt),_=async(...t)=>(i(C(O,k),...t),await(async()=>{if(!C(m,k)){for(A(m,k,1);!e(x=c(C(O,k)));)try{await x()}catch(t){v?.(t)}A(m,k,0)}})(),tt),tt={load:W,startAutoLoad:async t=>{X(),await W(t);try{z=await g((async(t,e)=>{e||t?2!=I&&(R(1),J++,U(e??t),R(0)):await W()}))}catch(t){v?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!e(z),save:Y,startAutoSave:async()=>(Z(),await Y(),D=t.addDidFinishTransactionListener((()=>{const t=q();B(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!e(D),getStatus:()=>I,addStatusListener:t=>H(t,F),delListener:e=>(Q(e),t),schedule:_,getStore:()=>t,destroy:()=>(C(O,k).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:J,saves:j}),...T};return d(tt)},T="storage",N=(e,a,s,r)=>P(e,(async()=>{return t=s.getItem(a),v(t,((t,e)=>"￼"===e?void 0:e));var t}),(async t=>{return s.setItem(a,(e=t(),h(e,((t,e)=>void 0===e?"￼":e))));var e}),(e=>{const r=t=>{if(t.storageArea===s&&t.key===a)try{e(v(t.newValue))}catch{e()}};return t.addEventListener(T,r),r}),(e=>t.removeEventListener(T,e)),r,3,{getStorageName:()=>a});exports.createLocalPersister=(t,e,a)=>N(t,e,localStorage,a),exports.createSessionPersister=(t,e,a)=>N(t,e,sessionStorage,a);
