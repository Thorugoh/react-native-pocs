"use strict";const t="t",e="v",a=t=>null==t,n=(t,e,n)=>a(t)?n?.():e(t),s=t=>Array.isArray(t),r=(t,e,a)=>t.slice(e,a),o=t=>t.length,i=t=>{throw Error(t)},c=(t,e)=>t.forEach(e),u=(t,...e)=>t.push(...e),l=t=>t.shift(),y=Object,g=t=>y.getPrototypeOf(t),d=y.entries,h=y.keys,p=y.freeze,v=(t,e)=>c(d(t),(([t,a])=>e(a,t))),w=t=>(t=>!a(t)&&n(g(t),(t=>t==y.prototype||a(g(t))),(()=>!0)))(t)&&0==(t=>o(h(t)))(t),S=(t,e,a)=>(((t,e)=>e in t)(t,e)||(t[e]=a()),t[e]),f=t=>a(t)||0==(t=>t?.size??0)(t),C=(t,e)=>t?.forEach(e),b=(t,e)=>t?.delete(e),A=t=>new Map(t),L=(t,e)=>t?.get(e),M=(t,e,n)=>a(n)?(b(t,e),t):t?.set(e,n),O=(t,e,a,n)=>{var s,r;return s=t,r=e,s?.has(r)?n?.(L(t,e)):M(t,e,a()),L(t,e)},E=(t,e,a,s,r=0)=>n((a?O:L)(t,e[r],r>o(e)-2?a:A),(n=>{if(r>o(e)-2)return s?.(n)&&M(t,e[r]),n;const i=E(n,e,a,s,r+1);return f(n)&&M(t,e[r]),i})),D=(t,e,a)=>{e>t[1]&&(t[1]=e),t[2]=a>>>0},P=t=>new Set(s(t)||a(t)?t:[t]),T=/^\d+$/,j=A(),x=A(),z=(t,e,r,y,g,d,h,v={},S=0,D=[])=>{let z,J,N,k=0,F=0,W=0;O(j,D,(()=>0)),O(x,D,(()=>[]));const $=A(),[m,q,B,G,H]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!w(t)||!w(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!w(t)||!w(e),e.setContent]:i("Store type not supported by this Persister"))(h,t,S),[I,K,Q]=(()=>{let t;const[e,s]=(()=>{const t=[];let e=0;return[a=>(a?l(t):null)??""+e++,e=>{T.test(e)&&o(t)<1e3&&u(t,e)}]})(),r=A();return[(a,n,s,o=[],i=()=>[])=>{t??=tt;const c=e(1);var u,l;return M(r,c,[a,n,s,o,i]),u=E(n,s??[""],P),l=c,u?.add(l),c},(e,a,...n)=>c(((t,e=[""])=>{const a=[],n=(t,s)=>s==o(e)?u(a,t):null===e[s]?C(t,(t=>n(t,s+1))):c([e[s],null],(e=>n(L(t,e),s+1)));return n(t,0),a})(e,a),(e=>C(e,(e=>L(r,e)[0](t,...a??[],...n))))),t=>n(L(r,t),(([,e,a])=>(E(e,a??[""],void 0,(e=>(b(e,t),f(e)?1:0))),M(r,t),s(t),a))),e=>n(L(r,e),(([e,,n=[],s,r])=>{const i=(...u)=>{const l=o(u);l==o(n)?e(t,...u,...r(u)):a(n[l])?c(s[l]?.(...u)??[],(t=>i(...u,t))):i(...u,n[l])};i()}))]})(),R=t=>{t!=k&&(k=t,K($,void 0,k))},U=e=>{(m&&s(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},V=async t=>(2!=k&&(R(1),F++,await _((async()=>{try{const a=await e();s(a)?U(a):t?H(t):i("Content is not an array: "+a)}catch(e){d?.(e),t&&H(t)}R(0)}))),tt),X=()=>(J&&(J=void 0),tt),Y=async t=>(1!=k&&(R(2),W++,await _((async()=>{try{await r(q,t)}catch(t){d?.(t)}R(0)}))),tt),Z=()=>(N&&(t.delListener(N),N=void 0),tt),_=async(...t)=>(u(L(x,D),...t),await(async()=>{if(!L(j,D)){for(M(j,D,1);!a(z=l(L(x,D)));)try{await z()}catch(t){d?.(t)}M(j,D,0)}})(),tt),tt={load:V,startAutoLoad:async t=>{X(),await V(t);try{J=await y((async(t,e)=>{e||t?2!=k&&(R(1),F++,U(e??t),R(0)):await V()}))}catch(t){d?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!a(J),save:Y,startAutoSave:async()=>(Z(),await Y(),N=t.addDidFinishTransactionListener((()=>{const t=B();G(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!a(N),getStatus:()=>k,addStatusListener:t=>I(t,$),delListener:e=>(Q(e),t),schedule:_,getStore:()=>t,destroy:()=>(L(x,D).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:F,saves:W}),...v};return p(tt)},J=JSON.stringify,N=()=>[{},"",0];exports.createDurableObjectStoragePersister=(a,s,o="",i)=>{const c=(t,...e)=>o+t+r(J(e,((t,e)=>void 0===e?"ï¿¼":e)),1,-1);return z(a,(async()=>{const a=[{},"",0],i=[{},"",0];return(await s.list({prefix:o})).forEach((async([s,c,u],l)=>n((a=>{if(n=o,a.startsWith(n)){const n=r(a,o.length,1);return n==t||n==e?[n,...JSON.parse("["+r(a,o.length+1)+"]")]:void 0}var n})(l),(([r,...o])=>r==t?n(o[0],(t=>{const e=S(a[0],t,N);n(o[1],(t=>{const a=S(e[0],t,N);n(o[2],(t=>a[0][t]=[s,c,u]),(()=>D(a,c,u)))}),(()=>D(e,c,u)))}),(()=>D(a,c,u))):r==e?n(o[0],(t=>i[0][t]=[s,c,u]),(()=>D(i,c,u))):0)))),[a,i]}),(async(a,[[n,r,o],[i,u,l]]=a())=>{const y=A();M(y,c(t),[0,r,o]),v(n,(([e,a,n],s)=>{M(y,c(t,s),[0,a,n]),v(e,(([e,a,n],r)=>{M(y,c(t,s,r),[0,a,n]),v(e,((e,a)=>M(y,c(t,s,r,a),e)))}))})),M(y,c(e),[0,u,l]),v(i,((t,a)=>M(y,c(e,a),t))),await s.put((t=>{const e={};return C(t,((t,a)=>{{const n=t;e[a]=n}})),e})(y))}),(()=>{}),0,i,2,{getStorage:()=>s})};
