"use strict";var t=require("fs"),e=require("fs/promises");const a="utf8",s=t=>null==t,r=(t,e,a)=>s(t)?a?.():e(t),n=t=>Array.isArray(t),o=t=>t.length,i=t=>{throw Error(t)},c=(t,e)=>t.forEach(e),l=(t,...e)=>t.push(...e),u=t=>t.shift(),y=Object,d=t=>y.getPrototypeOf(t),g=y.keys,h=y.freeze,p=t=>(t=>!s(t)&&r(d(t),(t=>t==y.prototype||s(d(t))),(()=>!0)))(t)&&0==(t=>o(g(t)))(t),v=JSON.stringify,w=JSON.parse,S=t=>s(t)||0==(t=>t?.size??0)(t),f=(t,e)=>t?.forEach(e),C=(t,e)=>t?.delete(e),A=t=>new Map(t),b=(t,e)=>t?.get(e),L=(t,e,a)=>s(a)?(C(t,e),t):t?.set(e,a),F=(t,e,a,s)=>{var r,n;return r=t,n=e,r?.has(n)?s?.(b(t,e)):L(t,e,a()),b(t,e)},M=(t,e,a,s,n=0)=>r((a?F:b)(t,e[n],n>o(e)-2?a:A),(r=>{if(n>o(e)-2)return s?.(r)&&L(t,e[n]),r;const i=M(r,e,a,s,n+1);return S(r)&&L(t,e[n]),i})),O=t=>new Set(n(t)||s(t)?t:[t]),P=/^\d+$/,E=A(),T=A(),q=(t,e,a,y,d,g,v,w={},q=0,x=[])=>{let z,D,J,N=0,j=0,k=0;F(E,x,(()=>0)),F(T,x,(()=>[]));const m=A(),[$,B,G,H,I]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!p(t)||!p(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!p(t)||!p(e),e.setContent]:i("Store type not supported by this Persister"))(v,t,q),[K,Q,R]=(()=>{let t;const[e,a]=(()=>{const t=[];let e=0;return[a=>(a?u(t):null)??""+e++,e=>{P.test(e)&&o(t)<1e3&&l(t,e)}]})(),n=A();return[(a,s,r,o=[],i=()=>[])=>{t??=tt;const c=e(1);var l,u;return L(n,c,[a,s,r,o,i]),l=M(s,r??[""],O),u=c,l?.add(u),c},(e,a,...s)=>c(((t,e=[""])=>{const a=[],s=(t,r)=>r==o(e)?l(a,t):null===e[r]?f(t,(t=>s(t,r+1))):c([e[r],null],(e=>s(b(t,e),r+1)));return s(t,0),a})(e,a),(e=>f(e,(e=>b(n,e)[0](t,...a??[],...s))))),t=>r(b(n,t),(([,e,s])=>(M(e,s??[""],void 0,(e=>(C(e,t),S(e)?1:0))),L(n,t),a(t),s))),e=>r(b(n,e),(([e,,a=[],r,n])=>{const i=(...l)=>{const u=o(l);u==o(a)?e(t,...l,...n(l)):s(a[u])?c(r[u]?.(...l)??[],(t=>i(...l,t))):i(...l,a[u])};i()}))]})(),U=t=>{t!=N&&(N=t,Q(m,void 0,N))},V=e=>{($&&n(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},W=async t=>(2!=N&&(U(1),j++,await _((async()=>{try{const a=await e();n(a)?V(a):t?I(t):i("Content is not an array: "+a)}catch(e){g?.(e),t&&I(t)}U(0)}))),tt),X=()=>(D&&(d(D),D=void 0),tt),Y=async t=>(1!=N&&(U(2),k++,await _((async()=>{try{await a(B,t)}catch(t){g?.(t)}U(0)}))),tt),Z=()=>(J&&(t.delListener(J),J=void 0),tt),_=async(...t)=>(l(b(T,x),...t),await(async()=>{if(!b(E,x)){for(L(E,x,1);!s(z=u(b(T,x)));)try{await z()}catch(t){g?.(t)}L(E,x,0)}})(),tt),tt={load:W,startAutoLoad:async t=>{X(),await W(t);try{D=await y((async(t,e)=>{e||t?2!=N&&(U(1),j++,V(e??t),U(0)):await W()}))}catch(t){g?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!s(D),save:Y,startAutoSave:async()=>(Z(),await Y(),J=t.addDidFinishTransactionListener((()=>{const t=G();H(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!s(J),getStatus:()=>N,addStatusListener:t=>K(t,m),delListener:e=>(R(e),t),schedule:_,getStore:()=>t,destroy:()=>(b(T,x).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:j,saves:k}),...w};return h(tt)};exports.createFilePersister=(s,r,n)=>q(s,(async()=>{return t=await e.readFile(r,a),w(t,((t,e)=>"ï¿¼"===e?void 0:e));var t}),(async t=>{return await e.writeFile(r,(s=t(),v(s,((t,e)=>void 0===e?"ï¿¼":e))),a);var s}),(e=>(t.existsSync(r)||t.writeFileSync(r,"",a),t.watch(r,(()=>e())))),(t=>t?.close()),n,3,{getFilePath:()=>r});
