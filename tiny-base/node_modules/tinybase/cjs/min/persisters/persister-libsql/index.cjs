"use strict";const t=t=>typeof t,a="tinybase",e="",n=",",s=t(e),i=Promise,r=clearInterval,o=t=>null==t,c=(t,a,e)=>o(t)?e?.():a(t),l=a=>t(a)==s,w=t=>Array.isArray(t),u=(t,a,e)=>t.slice(a,e),y=t=>t.length,d=async t=>i.all(t),v=t=>{throw Error(t)},p=(t,a)=>t.forEach(a),E=(t,a="")=>t.join(a),g=(t,a)=>t.map(a),A=t=>0==y(t),h=(t,a)=>t.filter(a),m=(t,...a)=>t.push(...a),N=t=>t.shift(),$="_",S="_id",f="SELECT",C="WHERE",O="TABLE",T="ALTER "+O,L="DELETE FROM",b=f+"*FROM",I="pragma_",D="data_version",R="schema_version",M="pragma_table_",_=t=>`"${t.replace(/"/g,'""')}"`,P=(t,a=[1])=>E(g(t,(()=>"$"+a[0]++)),n),F=(t,a)=>t?.has(a)??!1,U=t=>o(t)||0==(t=>t?.size??0)(t),j=t=>[...t?.values()??[]],x=(t,a)=>t?.forEach(a),B=(t,a)=>t?.delete(a),J=Object,Y=t=>J.getPrototypeOf(t),k=J.entries,q=J.keys,z=J.freeze,G=(t=[])=>J.fromEntries(t),H=(...t)=>J.assign({},...t),K=(t,a)=>(delete t[a],t),Q=(t,a)=>g(k(t),(([t,e])=>a(e,t))),V=(t,a)=>G(Q(t,((t,e)=>[e,a(t,e)]))),W=t=>J.values(t),X=t=>y(q(t)),Z=t=>(t=>!o(t)&&c(Y(t),(t=>t==J.prototype||o(Y(t))),(()=>!0)))(t)&&0==X(t),tt=JSON.stringify,at=JSON.parse,et=t=>new Map(t),nt=(t,a)=>t?.get(a),st=(t,a)=>g([...t?.entries()??[]],(([t,e])=>a(e,t))),it=(t,a,e)=>o(e)?(B(t,a),t):t?.set(a,e),rt=(t,a,e,n)=>(F(t,a)?n?.(nt(t,a)):it(t,a,e()),nt(t,a)),ot=(t,a,e,n,s=0)=>c((e?rt:nt)(t,a[s],s>y(a)-2?e:et),(i=>{if(s>y(a)-2)return n?.(i)&&it(t,a[s]),i;const r=ot(i,a,e,n,s+1);return U(i)&&it(t,a[s]),r})),ct=t=>new Set(w(t)||o(t)?t:[t]),lt=(t,a)=>t?.add(a),wt=/^\d+$/,ut=et(),yt=et(),dt=(t,a,n,s,i,r,l,u={},d=0,E=[])=>{let g,A,h,$=0,S=0,f=0;rt(ut,E,(()=>0)),rt(yt,E,(()=>[]));const C=et(),[O,T,L,b,I]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!Z(t)||!Z(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!Z(t)||!Z(a),a.setContent]:v("Store type not supported by this Persister"))(l,t,d),[D,R,M]=(()=>{let t;const[a,n]=(()=>{const t=[];let a=0;return[n=>(n?N(t):null)??e+a++,a=>{wt.test(a)&&y(t)<1e3&&m(t,a)}]})(),s=et();return[(n,i,r,o=[],c=()=>[])=>{t??=q;const l=a(1);return it(s,l,[n,i,r,o,c]),lt(ot(i,r??[e],ct),l),l},(a,n,...i)=>p(((t,a=[e])=>{const n=[],s=(t,e)=>e==y(a)?m(n,t):null===a[e]?x(t,(t=>s(t,e+1))):p([a[e],null],(a=>s(nt(t,a),e+1)));return s(t,0),n})(a,n),(a=>x(a,(a=>nt(s,a)[0](t,...n??[],...i))))),t=>c(nt(s,t),(([,a,i])=>(ot(a,i??[e],void 0,(a=>(B(a,t),U(a)?1:0))),it(s,t),n(t),i))),a=>c(nt(s,a),(([a,,e=[],n,s])=>{const i=(...r)=>{const c=y(r);c==y(e)?a(t,...r,...s(r)):o(e[c])?p(n[c]?.(...r)??[],(t=>i(...r,t))):i(...r,e[c])};i()}))]})(),_=t=>{t!=$&&($=t,R(C,void 0,$))},P=a=>{(O&&w(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},F=async t=>(2!=$&&(_(1),S++,await k((async()=>{try{const e=await a();w(e)?P(e):t?I(t):v("Content is not an array: "+e)}catch(a){r?.(a),t&&I(t)}_(0)}))),q),j=()=>(A&&(i(A),A=void 0),q),J=async t=>(1!=$&&(_(2),f++,await k((async()=>{try{await n(T,t)}catch(t){r?.(t)}_(0)}))),q),Y=()=>(h&&(t.delListener(h),h=void 0),q),k=async(...t)=>(m(nt(yt,E),...t),await(async()=>{if(!nt(ut,E)){for(it(ut,E,1);!o(g=N(nt(yt,E)));)try{await g()}catch(t){r?.(t)}it(ut,E,0)}})(),q),q={load:F,startAutoLoad:async t=>{j(),await F(t);try{A=await s((async(t,a)=>{a||t?2!=$&&(_(1),S++,P(a??t),_(0)):await F()}))}catch(t){r?.(t)}return q},stopAutoLoad:j,isAutoLoading:()=>!o(A),save:J,startAutoSave:async()=>(Y(),await J(),h=t.addDidFinishTransactionListener((()=>{const t=L();b(t)&&J(t)})),q),stopAutoSave:Y,isAutoSaving:()=>!o(h),getStatus:()=>$,addStatusListener:t=>D(t,C),delListener:a=>(M(a),t),schedule:k,getStore:()=>t,destroy:()=>(nt(yt,E).splice(0,void 0),j().stopAutoSave()),getStats:()=>({loads:S,saves:f}),...u};return z(q)},vt=(t,a,e,s,i,r=pt,c,l)=>{const w=et();return[async()=>{w.clear(),g(await e(t,a),(({tn:t,cn:a})=>lt(rt(w,t,ct),a)))},async(a,e)=>((t,a)=>F(nt(w,t),a))(a,e)?G(h(g(await t(b+_(a)),(t=>[t[e],l?V(K(t,e),l):K(t,e)])),(([t,a])=>!o(t)&&!Z(a)))):{},async(a,e,s,l,u,y=!1)=>{const v=ct();V(s??{},(t=>g(q(t??{}),(t=>lt(v,t)))));const p=j(v);if(!y&&u&&A(p)&&F(w,a))return await t("DROP "+O+_(a)),void it(w,a);const N=nt(w,a),$=ct(j(N));if(A(p)||(F(w,a)?await d(g([e,...p],(async(n,s)=>{B($,n)||(await t(T+_(a)+"ADD"+_(n)+i),0==s&&await t("CREATE UNIQUE INDEX pk ON "+_(a)+`(${_(e)})`),lt(N,n))}))):(await t("CREATE "+O+_(a)+`(${_(e)}${i} PRIMARY KEY${E(g(p,(t=>n+_(t)+i)))});`),it(w,a,ct([e,...p])))),await d([...!y&&l?g(j($),(async n=>{n!=e&&(await t(T+_(a)+"DROP"+_(n)),B(N,n))})):[]]),y)o(s)?await t(L+_(a)+C+" true"):await d(Q(s,(async(n,s)=>{o(n)?await t(L+_(a)+C+_(e)+"=$1",[s]):A(p)||await r(t,a,e,q(n),{[s]:c?g(W(n),c):W(n)},N)})));else if(A(p))F(w,a)&&await t(L+_(a)+C+" true");else{const n=h(j(nt(w,a)),(t=>t!=e)),i={},o=[];V(s??{},((t,a)=>{i[a]=g(n,(a=>c?c(t?.[a]):t?.[a])),m(o,a)})),await r(t,a,e,n,i),await t(L+_(a)+C+_(e)+`NOT IN(${P(o)})`,o)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){s?.(t)}return await t("END"),e}]},pt=async(t,a,e,s,i)=>{const r=[1];await t("INSERT INTO"+_(a)+"("+((...t)=>E(g(t,_),n))(e,...s)+")VALUES"+E(Q(i,(t=>"($"+r[0]+++","+P(t,r)+")")),n)+"ON CONFLICT("+_(e)+")DO UPDATE SET"+E(g(s,(t=>_(t)+"=excluded."+_(t))),n),Q(i,((t,a)=>[a,...g(t,(t=>t??null))])).flat())},Et=(t,a,e,n,s,i,r,[o,c,l],w,u,y,d,v,p)=>{const[E,g,A,h]=vt(a,w,u,s,v,p),m=dt(t,(async()=>await h((async()=>{return await E(),t=(await g(o,c))[$]?.[l]??"null",at(t,((t,a)=>"ï¿¼"===a?void 0:a));var t}))),(async t=>await h((async()=>{var a;await E(),await A(o,c,{[$]:{[l]:(a=t()??null,tt(a,((t,a)=>void 0===a?"ï¿¼":a)))}},!0,!0)}))),e,n,s,r,{[d]:()=>y,destroy:()=>(m.stopAutoLoad().stopAutoSave(),i(),m)},0,y);return m},gt=(t,a,e,n,s,i,r,[c,l,[w,u,y]],v,p,E,g,A,m,N,f)=>{const[C,O,T,L]=vt(a,v,p,s,A,m,N,f),b=async(t,a)=>await d(st(l,(async([e,n,s,i],r)=>{a&&!(r in t)||await T(e,n,t[r],s,i,a)}))),I=async(t,a)=>u?await T(y,S,{[$]:t},!0,!0,a):null,D=dt(t,(async()=>await L((async()=>{await C();const t=await(async()=>G(h(await d(st(c,(async([t,a],e)=>[t,await O(e,a)]))),(t=>!Z(t[1])))))(),a=await(async()=>w?(await O(y,S))[$]:{})();return Z(t)&&o(a)?void 0:[t,a]}))),(async(t,a)=>await L((async()=>{if(await C(),o(a)){const[a,e]=t();await b(a),await I(e)}else await b(a[0],!0),await I(a[1],!0)}))),e,n,s,r,{[g]:()=>E,destroy:()=>(D.stopAutoLoad().stopAutoSave(),i(),D)},0,E);return D},At="ColumnName",ht="store",mt="json",Nt=ht+"TableName",$t=ht+"Id"+At,St=ht+At,ft="autoLoadIntervalSeconds",Ct="rowId"+At,Ot="tableId",Tt="tableName",Lt="deleteEmptyColumns",bt="deleteEmptyTable",It={mode:mt,[ft]:1},Dt={load:0,save:0,[Tt]:a+"_values"},Rt=(t,a,e,n,s)=>{const i=et();return V(t,((t,r)=>{const c=u(W(H(a,l(t)?{[e]:t}:t)),0,X(a));o(c[0])||n(r,c[0])||(s(r,c[0]),it(i,r,c))})),i},Mt=(t,n,s,i,o,c,w,y,d,v,p="getDb",E)=>{let g,A,h;const m=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(s,c),[N,$,O,T]=(t=>{const e=(t=>H(It,l(t)?{[Nt]:t}:t??{}))(t),n=e[ft];if(e.mode==mt){const t=e[Nt]??a;return[1,n,[t,e[$t]??S,e[St]??ht],ct(t)]}const{tables:{load:s={},save:i={}}={},values:r={}}=e,o=u(W(H(Dt,r)),0,X(Dt)),c=o[2],w=ct(c),y=ct(c);return[0,n,[Rt(s,{[Ot]:null,[Ct]:S},Ot,(t=>F(y,t)),(t=>lt(w,t))),Rt(i,{[Tt]:null,[Ct]:S,[Lt]:0,[bt]:0},Tt,((t,a)=>F(y,a)),((t,a)=>lt(w,a))),o],w]})(n);return(N?Et:gt)(t,m,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await m(`${f} ${D} d,${R} s,TOTAL_CHANGES() c FROM ${I}${D} JOIN ${I}${R}`);a==g&&e==A&&n==h||(null!=g&&t(),g=a,A=e,h=n)}catch{}}),1e3*$),n=()=>{g=A=h=null,r(a)},s=i((a=>{T.has(a)&&(n(),t(),e())}));return e(),()=>{n(),o(s)}}),(t=>t()),w,y,d,O,j(T),(async(t,a)=>await t(`${f} t.name tn,c.name cn FROM ${M}list()t,${M}info(t.name)c ${C} t.schema='main'AND t.type IN('table','view')AND t.name IN(${P(a)})ORDER BY t.name,c.name`,a)),v,p,e,E,(t=>!0===t?1:!1===t?0:t),void 0)};exports.createLibSqlPersister=(t,a,e,n,s)=>Mt(t,e,(async(t,e=[])=>(await a.execute({sql:t,args:e})).rows),(()=>()=>0),(t=>t()),n,s,(()=>0),1,a,"getClient");
