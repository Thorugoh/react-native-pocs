"use strict";const a=a=>typeof a,t=a(""),e="t",s=(a,t)=>a.startsWith(t),n=Promise,r=a=>null==a,i=(a,t,e)=>r(a)?e?.():t(a),c=(a,t,e)=>a.slice(t,e),o=a=>a.length,l=async a=>n.all(a),w=(a,t)=>a.map(t),g=(a,...t)=>a.push(...t),y=Object,h=y.entries,f=(a=[])=>y.fromEntries(a),u=(a,t)=>w(h(a),(([a,e])=>t(e,a))),p=(a,t,e)=>(((a,t)=>t in a)(a,t)||(a[t]=e()),a[t]),S=JSON.stringify,d=JSON.parse,x=a=>S(a,((a,t)=>t instanceof Map?y.fromEntries([...t]):t)),P=(e,s,n)=>e+s+(a(n)==t?n:x(n)),m=(a,t,e)=>{const n=o(a);return s(t,a)?[t[n],(e?d:String)(c(t,n+1))]:void 0},D=(a,t)=>((a,t)=>a?.forEach(t))(a,((a,e)=>t(e,a))),b="hasStore",R=f(w(["Origin","Methods","Headers"],(a=>["Access-Control-Allow-"+a,"*"]))),C=async(a,t="")=>!!await a.get(t+b),T=async(a,t="")=>{const s={},n={};return D(await a.list(),((a,r)=>i(m(t,a),(([a,t])=>{if(a==e){const[a,e,n]=d("["+t+"]");p(p(s,a,f),e,f)[n]=r}else"v"==a&&(n[t]=r)})))),[s,n]},v=async(a,t,e)=>a.party.broadcast(P(a.config.messagePrefix,"s",t),e),O=async(a,t,n,i)=>{const c=a.party.storage,w=a.config.storagePrefix,y={[w+b]:1},h=[],f=[];await l(u(t[0],(async(t,s)=>r(t)?!n&&await a.canDelTable(s,i)&&((a,...t)=>a.unshift(...t))(f,V(w,e,s)):await a.canSetTable(s,n,i)&&await l(u(t,(async(t,o)=>r(t)?!n&&await a.canDelRow(s,o,i)&&g(f,V(w,e,s,o)):await a.canSetRow(s,o,n,i)&&await l(u(t,(async(t,l)=>{const f=[s,o,l],u=V(w,e,...f);r(t)?!n&&await a.canDelCell(...f,i)&&g(h,u):await a.canSetCell(...f,t,n,i,await c.get(u))&&(y[u]=t)}))))))))),await l(u(t[1],(async(t,e)=>{const s=w+"v"+e;r(t)?!n&&await a.canDelValue(e,i)&&g(h,s):await a.canSetValue(e,t,n,i,await c.get(s))&&(y[s]=t)}))),0!=o(f)&&D(await c.list(),(a=>f.every((t=>!s(a,t)||g(h,a)&&0)))),await c.delete(h),await c.put(y)},V=(a,t,...e)=>P(a,t,c(x(e),1,-1)),E=async(a,t,e=null)=>new Response(e,{status:t,headers:a.config.responseHeaders});exports.TinyBasePartyKitServer=class{constructor(a){this.party=a,this.config.storePath??="/store",this.config.messagePrefix??="",this.config.storagePrefix??="",this.config.responseHeaders??=R}config={};async onRequest(a){const{party:{storage:t},config:{storePath:e,storagePrefix:s}}=this;if(new URL(a.url).pathname.endsWith(e)){const e=await C(t,s),n=await a.text();return"PUT"==a.method?e?E(this,205):(await O(this,d(n),!0,a),E(this,201)):E(this,200,e?x(await T(t,s)):"")}return E(this,404)}async onMessage(a,t){const{config:{messagePrefix:e,storagePrefix:s}}=this;await i(m(e,a,1),(async([a,e])=>{"s"==a&&await C(this.party.storage,s)&&(await O(this,e,!1,t),v(this,e,[t.id]))}))}async canSetTable(a,t,e){return!0}async canDelTable(a,t){return!0}async canSetRow(a,t,e,s){return!0}async canDelRow(a,t,e){return!0}async canSetCell(a,t,e,s,n,r,i){return!0}async canDelCell(a,t,e,s){return!0}async canSetValue(a,t,e,s,n){return!0}async canDelValue(a,t){return!0}},exports.broadcastChanges=v,exports.hasStoreInStorage=C,exports.loadStoreFromStorage=T;
