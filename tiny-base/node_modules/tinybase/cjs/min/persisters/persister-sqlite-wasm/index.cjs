"use strict";const t=t=>typeof t,a="tinybase",e="",n=",",s=t(e),i=Promise,o=clearInterval,r=t=>null==t,c=(t,a,e)=>r(t)?e?.():a(t),l=a=>t(a)==s,u=t=>Array.isArray(t),w=(t,a,e)=>t.slice(a,e),y=t=>t.length,d=async t=>i.all(t),p=t=>{throw Error(t)},v=(t,a)=>t.forEach(a),E=(t,a="")=>t.join(a),g=(t,a)=>t.map(a),h=t=>0==y(t),m=(t,a)=>t.filter(a),A=(t,...a)=>t.push(...a),N=t=>t.shift(),$="_",S="_id",f="SELECT",C="WHERE",O="TABLE",T="ALTER "+O,b="DELETE FROM",I=f+"*FROM",L="pragma_",R="data_version",D="schema_version",_="pragma_table_",M=t=>`"${t.replace(/"/g,'""')}"`,P=(t,a=[1])=>E(g(t,(()=>"$"+a[0]++)),n),F=(t,a)=>t?.has(a)??!1,j=t=>r(t)||0==(t=>t?.size??0)(t),k=t=>[...t?.values()??[]],U=(t,a)=>t?.forEach(a),q=(t,a)=>t?.delete(a),x=Object,B=t=>x.getPrototypeOf(t),J=x.entries,Y=x.keys,z=x.freeze,G=(t=[])=>x.fromEntries(t),H=(...t)=>x.assign({},...t),V=(t,a)=>(delete t[a],t),W=(t,a)=>g(J(t),(([t,e])=>a(e,t))),K=(t,a)=>G(W(t,((t,e)=>[e,a(t,e)]))),Q=t=>x.values(t),X=t=>y(Y(t)),Z=t=>(t=>!r(t)&&c(B(t),(t=>t==x.prototype||r(B(t))),(()=>!0)))(t)&&0==X(t),tt=JSON.stringify,at=JSON.parse,et=t=>new Map(t),nt=(t,a)=>t?.get(a),st=(t,a)=>g([...t?.entries()??[]],(([t,e])=>a(e,t))),it=(t,a,e)=>r(e)?(q(t,a),t):t?.set(a,e),ot=(t,a,e,n)=>(F(t,a)?n?.(nt(t,a)):it(t,a,e()),nt(t,a)),rt=(t,a,e,n,s=0)=>c((e?ot:nt)(t,a[s],s>y(a)-2?e:et),(i=>{if(s>y(a)-2)return n?.(i)&&it(t,a[s]),i;const o=rt(i,a,e,n,s+1);return j(i)&&it(t,a[s]),o})),ct=t=>new Set(u(t)||r(t)?t:[t]),lt=(t,a)=>t?.add(a),ut=/^\d+$/,wt=et(),yt=et(),dt=(t,a,n,s,i,o,l,w={},d=0,E=[])=>{let g,h,m,$=0,S=0,f=0;ot(wt,E,(()=>0)),ot(yt,E,(()=>[]));const C=et(),[O,T,b,I,L]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!Z(t)||!Z(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!Z(t)||!Z(a),a.setContent]:p("Store type not supported by this Persister"))(l,t,d),[R,D,_]=(()=>{let t;const[a,n]=(()=>{const t=[];let a=0;return[n=>(n?N(t):null)??e+a++,a=>{ut.test(a)&&y(t)<1e3&&A(t,a)}]})(),s=et();return[(n,i,o,r=[],c=()=>[])=>{t??=Y;const l=a(1);return it(s,l,[n,i,o,r,c]),lt(rt(i,o??[e],ct),l),l},(a,n,...i)=>v(((t,a=[e])=>{const n=[],s=(t,e)=>e==y(a)?A(n,t):null===a[e]?U(t,(t=>s(t,e+1))):v([a[e],null],(a=>s(nt(t,a),e+1)));return s(t,0),n})(a,n),(a=>U(a,(a=>nt(s,a)[0](t,...n??[],...i))))),t=>c(nt(s,t),(([,a,i])=>(rt(a,i??[e],void 0,(a=>(q(a,t),j(a)?1:0))),it(s,t),n(t),i))),a=>c(nt(s,a),(([a,,e=[],n,s])=>{const i=(...o)=>{const c=y(o);c==y(e)?a(t,...o,...s(o)):r(e[c])?v(n[c]?.(...o)??[],(t=>i(...o,t))):i(...o,e[c])};i()}))]})(),M=t=>{t!=$&&($=t,D(C,void 0,$))},P=a=>{(O&&u(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},F=async t=>(2!=$&&(M(1),S++,await J((async()=>{try{const e=await a();u(e)?P(e):t?L(t):p("Content is not an array: "+e)}catch(a){o?.(a),t&&L(t)}M(0)}))),Y),k=()=>(h&&(i(h),h=void 0),Y),x=async t=>(1!=$&&(M(2),f++,await J((async()=>{try{await n(T,t)}catch(t){o?.(t)}M(0)}))),Y),B=()=>(m&&(t.delListener(m),m=void 0),Y),J=async(...t)=>(A(nt(yt,E),...t),await(async()=>{if(!nt(wt,E)){for(it(wt,E,1);!r(g=N(nt(yt,E)));)try{await g()}catch(t){o?.(t)}it(wt,E,0)}})(),Y),Y={load:F,startAutoLoad:async t=>{k(),await F(t);try{h=await s((async(t,a)=>{a||t?2!=$&&(M(1),S++,P(a??t),M(0)):await F()}))}catch(t){o?.(t)}return Y},stopAutoLoad:k,isAutoLoading:()=>!r(h),save:x,startAutoSave:async()=>(B(),await x(),m=t.addDidFinishTransactionListener((()=>{const t=b();I(t)&&x(t)})),Y),stopAutoSave:B,isAutoSaving:()=>!r(m),getStatus:()=>$,addStatusListener:t=>R(t,C),delListener:a=>(_(a),t),schedule:J,getStore:()=>t,destroy:()=>(nt(yt,E).splice(0,void 0),k().stopAutoSave()),getStats:()=>({loads:S,saves:f}),...w};return z(Y)},pt=(t,a,e,s,i,o=vt,c,l)=>{const u=et();return[async()=>{u.clear(),g(await e(t,a),(({tn:t,cn:a})=>lt(ot(u,t,ct),a)))},async(a,e)=>((t,a)=>F(nt(u,t),a))(a,e)?G(m(g(await t(I+M(a)),(t=>[t[e],l?K(V(t,e),l):V(t,e)])),(([t,a])=>!r(t)&&!Z(a)))):{},async(a,e,s,l,w,y=!1)=>{const p=ct();K(s??{},(t=>g(Y(t??{}),(t=>lt(p,t)))));const v=k(p);if(!y&&w&&h(v)&&F(u,a))return await t("DROP "+O+M(a)),void it(u,a);const N=nt(u,a),$=ct(k(N));if(h(v)||(F(u,a)?await d(g([e,...v],(async(n,s)=>{q($,n)||(await t(T+M(a)+"ADD"+M(n)+i),0==s&&await t("CREATE UNIQUE INDEX pk ON "+M(a)+`(${M(e)})`),lt(N,n))}))):(await t("CREATE "+O+M(a)+`(${M(e)}${i} PRIMARY KEY${E(g(v,(t=>n+M(t)+i)))});`),it(u,a,ct([e,...v])))),await d([...!y&&l?g(k($),(async n=>{n!=e&&(await t(T+M(a)+"DROP"+M(n)),q(N,n))})):[]]),y)r(s)?await t(b+M(a)+C+" true"):await d(W(s,(async(n,s)=>{r(n)?await t(b+M(a)+C+M(e)+"=$1",[s]):h(v)||await o(t,a,e,Y(n),{[s]:c?g(Q(n),c):Q(n)},N)})));else if(h(v))F(u,a)&&await t(b+M(a)+C+" true");else{const n=m(k(nt(u,a)),(t=>t!=e)),i={},r=[];K(s??{},((t,a)=>{i[a]=g(n,(a=>c?c(t?.[a]):t?.[a])),A(r,a)})),await o(t,a,e,n,i),await t(b+M(a)+C+M(e)+`NOT IN(${P(r)})`,r)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){s?.(t)}return await t("END"),e}]},vt=async(t,a,e,s,i)=>{const o=[1];await t("INSERT INTO"+M(a)+"("+((...t)=>E(g(t,M),n))(e,...s)+")VALUES"+E(W(i,(t=>"($"+o[0]+++","+P(t,o)+")")),n)+"ON CONFLICT("+M(e)+")DO UPDATE SET"+E(g(s,(t=>M(t)+"=excluded."+M(t))),n),W(i,((t,a)=>[a,...g(t,(t=>t??null))])).flat())},Et=(t,a,e,n,s,i,o,[r,c,l],u,w,y,d,p,v)=>{const[E,g,h,m]=pt(a,u,w,s,p,v),A=dt(t,(async()=>await m((async()=>{return await E(),t=(await g(r,c))[$]?.[l]??"null",at(t,((t,a)=>"ï¿¼"===a?void 0:a));var t}))),(async t=>await m((async()=>{var a;await E(),await h(r,c,{[$]:{[l]:(a=t()??null,tt(a,((t,a)=>void 0===a?"ï¿¼":a)))}},!0,!0)}))),e,n,s,o,{[d]:()=>y,destroy:()=>(A.stopAutoLoad().stopAutoSave(),i(),A)},0,y);return A},gt=(t,a,e,n,s,i,o,[c,l,[u,w,y]],p,v,E,g,h,A,N,f)=>{const[C,O,T,b]=pt(a,p,v,s,h,A,N,f),I=async(t,a)=>await d(st(l,(async([e,n,s,i],o)=>{a&&!(o in t)||await T(e,n,t[o],s,i,a)}))),L=async(t,a)=>w?await T(y,S,{[$]:t},!0,!0,a):null,R=dt(t,(async()=>await b((async()=>{await C();const t=await(async()=>G(m(await d(st(c,(async([t,a],e)=>[t,await O(e,a)]))),(t=>!Z(t[1])))))(),a=await(async()=>u?(await O(y,S))[$]:{})();return Z(t)&&r(a)?void 0:[t,a]}))),(async(t,a)=>await b((async()=>{if(await C(),r(a)){const[a,e]=t();await I(a),await L(e)}else await I(a[0],!0),await L(a[1],!0)}))),e,n,s,o,{[g]:()=>E,destroy:()=>(R.stopAutoLoad().stopAutoSave(),i(),R)},0,E);return R},ht="ColumnName",mt="store",At="json",Nt=mt+"TableName",$t=mt+"Id"+ht,St=mt+ht,ft="autoLoadIntervalSeconds",Ct="rowId"+ht,Ot="tableId",Tt="tableName",bt="deleteEmptyColumns",It="deleteEmptyTable",Lt={mode:At,[ft]:1},Rt={load:0,save:0,[Tt]:a+"_values"},Dt=(t,a,e,n,s)=>{const i=et();return K(t,((t,o)=>{const c=w(Q(H(a,l(t)?{[e]:t}:t)),0,X(a));r(c[0])||n(o,c[0])||(s(o,c[0]),it(i,o,c))})),i},_t=(t,n,s,i,r,c,u,y,d,p,v="getDb",E)=>{let g,h,m;const A=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(s,c),[N,$,O,T]=(t=>{const e=(t=>H(Lt,l(t)?{[Nt]:t}:t??{}))(t),n=e[ft];if(e.mode==At){const t=e[Nt]??a;return[1,n,[t,e[$t]??S,e[St]??mt],ct(t)]}const{tables:{load:s={},save:i={}}={},values:o={}}=e,r=w(Q(H(Rt,o)),0,X(Rt)),c=r[2],u=ct(c),y=ct(c);return[0,n,[Dt(s,{[Ot]:null,[Ct]:S},Ot,(t=>F(y,t)),(t=>lt(u,t))),Dt(i,{[Tt]:null,[Ct]:S,[bt]:0,[It]:0},Tt,((t,a)=>F(y,a)),((t,a)=>lt(u,a))),r],u]})(n);return(N?Et:gt)(t,A,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await A(`${f} ${R} d,${D} s,TOTAL_CHANGES() c FROM ${L}${R} JOIN ${L}${D}`);a==g&&e==h&&n==m||(null!=g&&t(),g=a,h=e,m=n)}catch{}}),1e3*$),n=()=>{g=h=m=null,o(a)},s=i((a=>{T.has(a)&&(n(),t(),e())}));return e(),()=>{n(),r(s)}}),(t=>t()),u,y,d,O,k(T),(async(t,a)=>await t(`${f} t.name tn,c.name cn FROM ${_}list()t,${_}info(t.name)c ${C} t.schema='main'AND t.type IN('table','view')AND t.name IN(${P(a)})ORDER BY t.name,c.name`,a)),p,v,e,E,(t=>!0===t?1:!1===t?0:t),void 0)};exports.createSqliteWasmPersister=(t,a,e,n,s,i)=>_t(t,n,(async(t,a=[])=>e.exec(t,{bind:a,rowMode:"object",returnValue:"resultRows"}).map((t=>({...t})))),(t=>a.capi.sqlite3_update_hook(e,((a,e,n,s)=>t(s)),0)),(()=>a.capi.sqlite3_update_hook(e,(()=>0),0)),s,i,(()=>0),3,e);
