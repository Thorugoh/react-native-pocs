"use strict";const e=e=>typeof e,t="",n=e(t),s=e=>null==e,r=(e,t,n)=>s(e)?n?.():t(e),o=e=>Array.isArray(e),i=e=>e.length,a=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),l=Object.freeze,c=e=>t=>{return n=(t,n)=>t+e(n),L(t).reduce(n,0);var n},u=e=>e?.size??0,R=c(u),h=c(R),w=(e,t)=>e?.has(t)??!1,f=e=>s(e)||0==u(e),L=e=>[...e?.values()??[]],I=e=>e.clear(),g=(e,t)=>e?.forEach(t),p=(e,t)=>e?.delete(t),v=e=>new Map(e),y=(e,t)=>e?.get(t),b=(e,t)=>g(e,((e,n)=>t(n,e))),k=(e,t,n)=>s(n)?(p(e,t),e):e?.set(t,n),m=(e,t,n,s)=>(w(e,t)?s?.(y(e,t)):k(e,t,n()),y(e,t)),E=(e,t,n,s,o=0)=>r((n?m:y)(e,t[o],o>i(t)-2?n:v),(r=>{if(o>i(t)-2)return s?.(r)&&k(e,t[o]),r;const a=E(r,t,n,s,o+1);return f(r)&&k(e,t[o]),a})),T=e=>new Set(o(e)||s(e)?e:[e]),S=(e,t)=>e?.add(t),z=/^\d+$/,A=(()=>{const c=new WeakMap;return u=>(c.has(u)||c.set(u,(c=>{const u=v(),R=v(),A=v(),D=v(),[M,j,x]=(()=>{let e;const[n,o]=(()=>{const e=[];let n=0;return[s=>(s?e.shift():null)??t+n++,t=>{z.test(t)&&i(e)<1e3&&d(e,t)}]})(),l=v();return[(s,r,o,i=[],a=()=>[])=>{e??=Q;const d=n(1);return k(l,d,[s,r,o,i,a]),S(E(r,o??[t],T),d),d},(n,s,...r)=>a(((e,n=[t])=>{const s=[],r=(e,t)=>t==i(n)?d(s,e):null===n[t]?g(e,(e=>r(e,t+1))):a([n[t],null],(n=>r(y(e,n),t+1)));return r(e,0),s})(n,s),(t=>g(t,(t=>y(l,t)[0](e,...s??[],...r))))),e=>r(y(l,e),(([,n,s])=>(E(n,s??[t],void 0,(t=>(p(t,e),f(t)?1:0))),k(l,e),o(e),s))),t=>r(y(l,t),(([t,,n=[],r,o])=>{const d=(...l)=>{const c=i(l);c==i(n)?t(e,...l,...o(l)):s(n[c])?a(r[c]?.(...l)??[],(e=>d(...l,e))):d(...l,n[c])};d()}))]})(),[C,O,W,$,q,B,,,F,G,H,J]=((e,n,d,l,c)=>{const u=e.hasRow,R=v(),h=v(),E=v(),z=v(),A=v(),D=v(),M=(t,n,...s)=>{const r=m(D,t,T);return a(s,(t=>S(r,t)&&n&&e.callListener(t))),s},j=(t,...n)=>r(y(D,t),(s=>{a(0==i(n)?L(s):n,(t=>{e.delListener(t),p(s,t)})),f(s)&&k(D,t)})),x=(e,t)=>{k(R,e,t),w(h,e)||(k(h,e,[v(),v(),v(),v()]),k(z,e,v()),k(A,e,v()),c(E))},C=e=>{k(R,e),k(h,e),k(z,e),k(A,e),j(e),c(E)};return[()=>e,()=>{return e=R,[...e?.keys()??[]];var e},e=>b(h,e),e=>w(h,e),e=>y(R,e),e=>y(h,e),(e,t)=>k(h,e,t),x,(n,r,d,l,c)=>{x(n,r);const R=v(),h=v(),f=y(z,n),L=y(A,n),p=n=>{const a=t=>e.getCell(r,n,t),d=y(f,n),w=u(r,n)?(I=l(a,n),s(I)?void 0:I+t):void 0;var I,g,p,v;if(d===w||o(d)&&o(w)&&(p=w,i(g=d)===i(p)&&(v=(e,t)=>p[t]===e,g.every(v)))||k(R,n,[d,w]),!s(c)){const e=y(L,n),t=u(r,n)?c(a,n):void 0;e!=t&&k(h,n,t)}},m=e=>{d((()=>{g(R,(([,e],t)=>k(f,t,e))),g(h,((e,t)=>k(L,t,e)))}),R,h,f,L,e),I(R),I(h)};b(f,p),e.hasTable(r)&&a(e.getRowIds(r),(e=>{w(f,e)||p(e)})),m(!0),j(n),M(n,0,e.addRowListener(r,null,((e,t,n)=>p(n))),e.addTableListener(r,(()=>m())))},C,e=>l(e,E),()=>b(D,C),M,j]})(c,0,0,M,j),K=(e,t,n)=>r(B(e),(([r,,o])=>{if(!w(o,t)){const i=T();if(q(e)!=P(e))S(i,t);else{let e=t;for(;!s(e)&&!w(i,e);)S(i,e),e=y(r,e)}if(n)return i;k(o,t,i)}return y(o,t)})),N=(e,t)=>r(B(e),(([,,e])=>k(e,t))),P=e=>y(u,e),Q={setRelationshipDefinition:(o,i,a,d)=>{return k(u,o,a),F(o,i,((e,t)=>{const n=T(),i=T(),a=T(),[d,l]=B(o);g(t,(([e,t],c)=>{s(e)||(S(i,e),r(y(l,e),(t=>{p(t,c),f(t)&&k(l,e)}))),s(t)||(S(i,t),w(l,t)||k(l,t,T()),S(y(l,t),c)),S(n,c),k(d,c,t),b(y(D,o),(e=>{w(K(o,e),c)&&S(a,e)}))})),e(),g(n,(e=>j(R,[o,e]))),g(i,(e=>j(A,[o,e]))),g(a,(e=>{N(o,e),j(D,[o,e])}))}),e(l=d)==n?e=>e(l):l??(()=>t)),Q;var l},delRelationshipDefinition:e=>(k(u,e),G(e),Q),getStore:C,getRelationshipIds:O,forEachRelationship:e=>W((t=>e(t,(e=>c.forEachRow(q(t),e))))),hasRelationship:$,getLocalTableId:q,getRemoteTableId:P,getRemoteRowId:(e,t)=>y(B(e)?.[0],t),getLocalRowIds:(e,t)=>L(y(B(e)?.[1],t)),getLinkedRowIds:(e,t)=>s(B(e))?[t]:L(K(e,t,!0)),addRelationshipIdsListener:H,addRemoteRowIdListener:(e,t,n)=>M(n,R,[e,t]),addLocalRowIdsListener:(e,t,n)=>M(n,A,[e,t]),addLinkedRowIdsListener:(e,t,n)=>(K(e,t),M(n,D,[e,t])),delListener:e=>(N(...x(e)??[]),Q),destroy:J,getListenerStats:()=>({remoteRowId:h(R),localRowIds:h(A),linkedRowIds:h(D)})};return l(Q)})(u)),c.get(u))})();exports.createRelationships=A;
