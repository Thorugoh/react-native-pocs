"use strict";const e=(e,t="",a)=>e.split(t,a),t=Promise,a=globalThis,s=Math,n=s.floor,o=e=>null==e,r=(e,t,a)=>o(e)?a?.():t(e),i=e=>Array.isArray(e),c=e=>e.length,l=e=>{throw Error(e)},g=(e,t)=>e.forEach(t),u=(e,...t)=>e.push(...t),y=e=>e.shift(),d=Object,h=e=>d.getPrototypeOf(e),f=d.entries,p=d.keys,w=d.freeze,v=(e,t)=>g(f(e),(([e,a])=>t(a,e))),b=e=>(e=>!o(e)&&r(h(e),(e=>e==d.prototype||o(h(e))),(()=>!0)))(e)&&0==(e=>c(p(e)))(e),C=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),M=e=>o(e)||0==(e=>e?.size??0)(e),S=(e,t)=>e?.forEach(t),A=(e,t)=>e?.delete(t),D=e=>new Map(e),L=(e,t)=>e?.get(t),m=(e,t,a)=>o(a)?(A(e,t),e):e?.set(t,a),H=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)?s?.(L(e,t)):m(e,t,a()),L(e,t)},T=(e,t,a,s,n=0)=>r((a?H:L)(e,t[n],n>c(t)-2?a:D),(o=>{if(n>c(t)-2)return s?.(o)&&m(e,t[n]),o;const r=T(o,t,a,s,n+1);return M(o)&&m(e,t[n]),r})),G=(e,t)=>t?[e,t]:[e],R=(e,t)=>((e??"")>(t??"")?e:t)??"",z=(e="")=>G(((e=[])=>d.fromEntries(e))(),e),E=e=>new Set(i(e)||o(e)?e:[e]),V=/^\d+$/,P=D(),x=D(),O=(e,t,a,s,n,d,h,f={},p=0,v=[])=>{let C,G,R,z=0,O=0,$=0;H(P,v,(()=>0)),H(x,v,(()=>[]));const j=D(),[k,F,N,U,q]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!b(e)||!b(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!b(e)||!b(t),t.setContent]:l("Store type not supported by this Persister"))(h,e,p),[B,I,J]=(()=>{let e;const[t,a]=(()=>{const e=[];let t=0;return[a=>(a?y(e):null)??""+t++,t=>{V.test(t)&&c(e)<1e3&&u(e,t)}]})(),s=D();return[(a,n,o,r=[],i=()=>[])=>{e??=ee;const c=t(1);var l,g;return m(s,c,[a,n,o,r,i]),l=T(n,o??[""],E),g=c,l?.add(g),c},(t,a,...n)=>g(((e,t=[""])=>{const a=[],s=(e,n)=>n==c(t)?u(a,e):null===t[n]?S(e,(e=>s(e,n+1))):g([t[n],null],(t=>s(L(e,t),n+1)));return s(e,0),a})(t,a),(t=>S(t,(t=>L(s,t)[0](e,...a??[],...n))))),e=>r(L(s,e),(([,t,n])=>(T(t,n??[""],void 0,(t=>(A(t,e),M(t)?1:0))),m(s,e),a(e),n))),t=>r(L(s,t),(([t,,a=[],s,n])=>{const r=(...i)=>{const l=c(i);l==c(a)?t(e,...i,...n(i)):o(a[l])?g(s[l]?.(...i)??[],(e=>r(...i,e))):r(...i,a[l])};r()}))]})(),K=e=>{e!=z&&(z=e,I(j,void 0,z))},Q=t=>{(k&&i(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},W=async e=>(2!=z&&(K(1),O++,await _((async()=>{try{const a=await t();i(a)?Q(a):e?q(e):l("Content is not an array: "+a)}catch(t){d?.(t),e&&q(e)}K(0)}))),ee),X=()=>(G&&(n(G),G=void 0),ee),Y=async e=>(1!=z&&(K(2),$++,await _((async()=>{try{await a(F,e)}catch(e){d?.(e)}K(0)}))),ee),Z=()=>(R&&(e.delListener(R),R=void 0),ee),_=async(...e)=>(u(L(x,v),...e),await(async()=>{if(!L(P,v)){for(m(P,v,1);!o(C=y(L(x,v)));)try{await C()}catch(e){d?.(e)}m(P,v,0)}})(),ee),ee={load:W,startAutoLoad:async e=>{X(),await W(e);try{G=await s((async(e,t)=>{t||e?2!=z&&(K(1),O++,Q(t??e),K(0)):await W()}))}catch(e){d?.(e)}return ee},stopAutoLoad:X,isAutoLoading:()=>!o(G),save:Y,startAutoSave:async()=>(Z(),await Y(),R=e.addDidFinishTransactionListener((()=>{const e=N();U(e)&&Y(e)})),ee),stopAutoSave:Z,isAutoSaving:()=>!o(R),getStatus:()=>z,addStatusListener:e=>B(e,j),delListener:t=>(J(t),e),schedule:_,getStore:()=>e,destroy:()=>(L(x,v).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:O,saves:$}),...f};return w(ee)},$=e("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),j=a.crypto?e=>a.crypto.getRandomValues(e):e=>(e=>e.map((()=>n(256*s.random()))))(e),k=(e=16)=>{return t=(e,t)=>e+$[63&t],j(new Uint8Array(e)).reduce(t,"");var t};exports.Message={Response:0,GetContentHashes:1,ContentHashes:2,ContentDiff:3,GetTableDiff:4,GetRowDiff:5,GetCellDiff:6,GetValueDiff:7},exports.createCustomSynchronizer=(e,a,s,n,i,c,l,g,u={})=>{let y,d=0,h=0,f=0;const p=D(),w=()=>k(11),M=(e,t,s,n)=>{h++,c?.(e,t,s,n),a(e,t,s,n)},S=async(e,a,s,n)=>new t(((t,o)=>{const r=n+"."+k(4),c=((e,t=0)=>setTimeout(e,1e3*t))((()=>{A(p,r),o(`No response from ${e??"anyone"} to ${r}, `+a)}),i);m(p,r,[e,(e,a)=>{clearTimeout(c),A(p,r),t([e,a,n])}]),M(e,r,a,s)})),H=(e,[t,a])=>{v(t,(([t,a],s)=>{const n=C(e[0],s,z);v(t,(([e,t],a)=>{const s=C(n[0],a,z);v(e,(([e,t],a)=>s[0][a]=G(e,t))),s[1]=R(s[1],t)})),n[1]=R(n[1],a)})),e[1]=R(e[1],a)},T=async(t=null,a,s=w())=>{try{o(a)&&([a,t,s]=await S(null,1,"",s));const[n,r]=a,[i,c]=e.getMergeableContentHashes();let l=z();if(i!=n){const[a,n]=(await S(t,4,e.getMergeableTableHashes(),s))[0];if(l=a,!b(n)){const[a,o]=(await S(t,5,e.getMergeableRowHashes(n),s))[0];if(H(l,a),!b(o)){const a=(await S(t,6,e.getMergeableCellHashes(o),s))[0];H(l,a)}}}return[l,c==r?z():(await S(t,7,e.getMergeableValueHashes(),s))[0],1]}catch(e){g?.(e)}},E=O(e,(async()=>{const e=await T();return!e||b(e[0][0])&&b(e[1][0])?void 0:e}),(async(t,a)=>a?M(null,w(),3,a):M(null,w(),2,e.getMergeableContentHashes())),(e=>y=e),(()=>y=void 0),g,2,{startSync:async e=>(d=1,await(await E.startAutoLoad(e)).startAutoSave()),stopSync:()=>(d=0,E.stopAutoLoad().stopAutoSave()),destroy:()=>(n(),E.stopSync()),getSynchronizerStats:()=>({sends:h,receives:f}),...u},1);return s(((t,a,s,n)=>{const i=d||E.isAutoLoading();f++,l?.(t,a,s,n),0==s?r(L(p,a),(([e,a])=>o(e)||e==t?a(n,t):0)):2==s&&i?T(t,n,a??void 0).then((e=>{y?.(void 0,e)})).catch(g):3==s&&i?y?.(void 0,n):r(1==s&&(d||E.isAutoSaving())?e.getMergeableContentHashes():4==s?e.getMergeableTableDiff(n):5==s?e.getMergeableRowDiff(n):6==s?e.getMergeableCellDiff(n):7==s?e.getMergeableValueDiff(n):void 0,(e=>{M(t,a,0,e)}))})),E};
