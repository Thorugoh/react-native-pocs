"use strict";const e=(e,t="",a)=>e.split(t,a),t=Promise,a=globalThis,n=Math,s=n.floor,o=e=>null==e,r=(e,t,a)=>o(e)?a?.():t(e),i=e=>Array.isArray(e),c=e=>e.length,l=e=>{throw Error(e)},g=(e,t)=>e.forEach(t),u=(e,...t)=>e.push(...t),d=e=>e.shift(),y=Object,h=e=>y.getPrototypeOf(e),p=y.entries,w=y.keys,v=y.freeze,f=(e,t)=>g(p(e),(([e,a])=>t(a,e))),b=e=>(e=>!o(e)&&r(h(e),(e=>e==y.prototype||o(h(e))),(()=>!0)))(e)&&0==(e=>c(w(e)))(e),C=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),M=e=>o(e)||0==(e=>e?.size??0)(e),S=(e,t)=>e?.forEach(t),A=(e,t)=>e?.delete(t),m=e=>new Map(e),L=(e,t)=>e?.get(t),T=(e,t,a)=>o(a)?(A(e,t),e):e?.set(t,a),H=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(L(e,t)):T(e,t,a()),L(e,t)},D=(e,t,a,n,s=0)=>r((a?H:L)(e,t[s],s>c(t)-2?a:m),(o=>{if(s>c(t)-2)return n?.(o)&&T(e,t[s]),o;const r=D(o,t,a,n,s+1);return M(o)&&T(e,t[s]),r})),z=(e,t)=>t?[e,t]:[e],E=(e,t)=>((e??"")>(t??"")?e:t)??"",P=(e="")=>z(((e=[])=>y.fromEntries(e))(),e),R=e=>new Set(i(e)||o(e)?e:[e]),V=/^\d+$/,B=m(),N=m(),O=(e,t,a,n,s,y,h,p={},w=0,f=[])=>{let C,z,E,P=0,O=0,$=0;H(B,f,(()=>0)),H(N,f,(()=>[]));const j=m(),[k,x,F,U,q]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!b(e)||!b(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!b(e)||!b(t),t.setContent]:l("Store type not supported by this Persister"))(h,e,w),[G,I,J]=(()=>{let e;const[t,a]=(()=>{const e=[];let t=0;return[a=>(a?d(e):null)??""+t++,t=>{V.test(t)&&c(e)<1e3&&u(e,t)}]})(),n=m();return[(a,s,o,r=[],i=()=>[])=>{e??=ee;const c=t(1);var l,g;return T(n,c,[a,s,o,r,i]),l=D(s,o??[""],R),g=c,l?.add(g),c},(t,a,...s)=>g(((e,t=[""])=>{const a=[],n=(e,s)=>s==c(t)?u(a,e):null===t[s]?S(e,(e=>n(e,s+1))):g([t[s],null],(t=>n(L(e,t),s+1)));return n(e,0),a})(t,a),(t=>S(t,(t=>L(n,t)[0](e,...a??[],...s))))),e=>r(L(n,e),(([,t,s])=>(D(t,s??[""],void 0,(t=>(A(t,e),M(t)?1:0))),T(n,e),a(e),s))),t=>r(L(n,t),(([t,,a=[],n,s])=>{const r=(...i)=>{const l=c(i);l==c(a)?t(e,...i,...s(i)):o(a[l])?g(n[l]?.(...i)??[],(e=>r(...i,e))):r(...i,a[l])};r()}))]})(),K=e=>{e!=P&&(P=e,I(j,void 0,P))},Q=t=>{(k&&i(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},W=async e=>(2!=P&&(K(1),O++,await _((async()=>{try{const a=await t();i(a)?Q(a):e?q(e):l("Content is not an array: "+a)}catch(t){y?.(t),e&&q(e)}K(0)}))),ee),X=()=>(z&&(s(z),z=void 0),ee),Y=async e=>(1!=P&&(K(2),$++,await _((async()=>{try{await a(x,e)}catch(e){y?.(e)}K(0)}))),ee),Z=()=>(E&&(e.delListener(E),E=void 0),ee),_=async(...e)=>(u(L(N,f),...e),await(async()=>{if(!L(B,f)){for(T(B,f,1);!o(C=d(L(N,f)));)try{await C()}catch(e){y?.(e)}T(B,f,0)}})(),ee),ee={load:W,startAutoLoad:async e=>{X(),await W(e);try{z=await n((async(e,t)=>{t||e?2!=P&&(K(1),O++,Q(t??e),K(0)):await W()}))}catch(e){y?.(e)}return ee},stopAutoLoad:X,isAutoLoading:()=>!o(z),save:Y,startAutoSave:async()=>(Z(),await Y(),E=e.addDidFinishTransactionListener((()=>{const e=F();U(e)&&Y(e)})),ee),stopAutoSave:Z,isAutoSaving:()=>!o(E),getStatus:()=>P,addStatusListener:e=>G(e,j),delListener:t=>(J(t),e),schedule:_,getStore:()=>e,destroy:()=>(L(N,f).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:O,saves:$}),...p};return v(ee)},$=e("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),j=a.crypto?e=>a.crypto.getRandomValues(e):e=>(e=>e.map((()=>s(256*n.random()))))(e),k=(e=16)=>{return t=(e,t)=>e+$[63&t],j(new Uint8Array(e)).reduce(t,"");var t};exports.createBroadcastChannelSynchronizer=(e,a,n,s,i)=>{const c=k(),l=new BroadcastChannel(a);return((e,a,n,s,i,c,l,g,u={})=>{let d,y=0,h=0,p=0;const w=m(),v=()=>k(11),M=(e,t,n,s)=>{h++,c?.(e,t,n,s),a(e,t,n,s)},S=async(e,a,n,s)=>new t(((t,o)=>{const r=s+"."+k(4),c=((e,t=0)=>setTimeout(e,1e3*t))((()=>{A(w,r),o(`No response from ${e??"anyone"} to ${r}, `+a)}),i);T(w,r,[e,(e,a)=>{clearTimeout(c),A(w,r),t([e,a,s])}]),M(e,r,a,n)})),H=(e,[t,a])=>{f(t,(([t,a],n)=>{const s=C(e[0],n,P);f(t,(([e,t],a)=>{const n=C(s[0],a,P);f(e,(([e,t],a)=>n[0][a]=z(e,t))),n[1]=E(n[1],t)})),s[1]=E(s[1],a)})),e[1]=E(e[1],a)},D=async(t=null,a,n=v())=>{try{o(a)&&([a,t,n]=await S(null,1,"",n));const[s,r]=a,[i,c]=e.getMergeableContentHashes();let l=P();if(i!=s){const[a,s]=(await S(t,4,e.getMergeableTableHashes(),n))[0];if(l=a,!b(s)){const[a,o]=(await S(t,5,e.getMergeableRowHashes(s),n))[0];if(H(l,a),!b(o)){const a=(await S(t,6,e.getMergeableCellHashes(o),n))[0];H(l,a)}}}return[l,c==r?P():(await S(t,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){g?.(e)}},R=O(e,(async()=>{const e=await D();return!e||b(e[0][0])&&b(e[1][0])?void 0:e}),(async(t,a)=>a?M(null,v(),3,a):M(null,v(),2,e.getMergeableContentHashes())),(e=>d=e),(()=>d=void 0),g,2,{startSync:async e=>(y=1,await(await R.startAutoLoad(e)).startAutoSave()),stopSync:()=>(y=0,R.stopAutoLoad().stopAutoSave()),destroy:()=>(s(),R.stopSync()),getSynchronizerStats:()=>({sends:h,receives:p}),...u},1);return n(((t,a,n,s)=>{const i=y||R.isAutoLoading();p++,l?.(t,a,n,s),0==n?r(L(w,a),(([e,a])=>o(e)||e==t?a(s,t):0)):2==n&&i?D(t,s,a??void 0).then((e=>{d?.(void 0,e)})).catch(g):3==n&&i?d?.(void 0,s):r(1==n&&(y||R.isAutoSaving())?e.getMergeableContentHashes():4==n?e.getMergeableTableDiff(s):5==n?e.getMergeableRowDiff(s):6==n?e.getMergeableCellDiff(s):7==n?e.getMergeableValueDiff(s):void 0,(e=>{M(t,a,0,e)}))})),R})(e,((e,t,a,n)=>l.postMessage([c,e,t,a,n])),(e=>{l.onmessage=({data:[t,a,n,s,r]})=>o(a)||a==c?e(t,n,s,r):0}),(()=>{l.close()}),.01,n,s,i,{getChannelName:()=>a})};
