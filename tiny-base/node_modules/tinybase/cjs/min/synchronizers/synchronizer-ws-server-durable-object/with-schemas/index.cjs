"use strict";var e=require("cloudflare:workers");const t="",s=(e,t="",s)=>e.split(t,s),a=Promise,n=globalThis,r=(e,t=0)=>setTimeout(e,1e3*t),o=Math,i=o.floor,c=e=>null==e,l=(e,t,s)=>c(e)?s?.():t(e),g=e=>Array.isArray(e),u=(e,t,s)=>e.slice(t,s),h=e=>e.length,d=e=>{throw Error(e)},y=(e,t)=>e.forEach(t),w=(e,t)=>e.map(t),v=(e,...t)=>e.push(...t),S=e=>e.shift(),b=Object,p=e=>b.getPrototypeOf(e),C=b.entries,f=b.keys,M=b.freeze,A=(e,t)=>y(C(e),(([e,s])=>t(s,e))),k=e=>(e=>!c(e)&&l(p(e),(e=>e==b.prototype||c(p(e))),(()=>!0)))(e)&&0==(e=>h(f(e)))(e),m=(e,t,s)=>(((e,t)=>t in e)(e,t)||(e[t]=s()),e[t]),L=JSON.stringify,T=JSON.parse,x=(e,t)=>{const s=e.indexOf("\n");-1!==s&&t(u(e,0,s),u(e,s+1))},P=(e,...s)=>D(e??t,L(s,((e,t)=>void 0===t?"￼":t))),D=(e,t)=>e+"\n"+t,I=e=>c(e)||0==(e=>e?.size??0)(e),O=(e,t)=>e?.forEach(t),H=(e,t)=>e?.delete(t),W=e=>new Map(e),R=(e,t)=>e?.get(t),j=(e,t,s)=>c(s)?(H(e,t),e):e?.set(t,s),E=(e,t,s,a)=>{var n,r;return n=e,r=t,n?.has(r)?a?.(R(e,t)):j(e,t,s()),R(e,t)},N=(e,t,s,a,n=0)=>l((s?E:R)(e,t[n],n>h(t)-2?s:W),(r=>{if(n>h(t)-2)return a?.(r)&&j(e,t[n]),r;const o=N(r,t,s,a,n+1);return I(r)&&j(e,t[n]),o})),z=(e,t)=>t?[e,t]:[e],F=(e,t)=>((e??"")>(t??"")?e:t)??"",U=(e="")=>z(((e=[])=>b.fromEntries(e))(),e),V=e=>new Set(g(e)||c(e)?e:[e]),q=/^\d+$/,J=W(),$=W(),B=(e,s,a,n,r,o,i,u={},w=0,b=[])=>{let p,C,f,A=0,m=0,L=0;E(J,b,(()=>0)),E($,b,(()=>[]));const T=W(),[x,P,D,z,F]=((e=1,t,s)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!s),([[e],[t]])=>!k(e)||!k(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!k(e)||!k(t),t.setContent]:d("Store type not supported by this Persister"))(i,e,w),[U,B,G]=(()=>{let e;const[s,a]=(()=>{const e=[];let s=0;return[a=>(a?S(e):null)??t+s++,t=>{q.test(t)&&h(e)<1e3&&v(e,t)}]})(),n=W();return[(a,r,o,i=[],c=()=>[])=>{e??=te;const l=s(1);var g,u;return j(n,l,[a,r,o,i,c]),g=N(r,o??[t],V),u=l,g?.add(u),l},(s,a,...r)=>y(((e,s=[t])=>{const a=[],n=(e,t)=>t==h(s)?v(a,e):null===s[t]?O(e,(e=>n(e,t+1))):y([s[t],null],(s=>n(R(e,s),t+1)));return n(e,0),a})(s,a),(t=>O(t,(t=>R(n,t)[0](e,...a??[],...r))))),e=>l(R(n,e),(([,s,r])=>(N(s,r??[t],void 0,(t=>(H(t,e),I(t)?1:0))),j(n,e),a(e),r))),t=>l(R(n,t),(([t,,s=[],a,n])=>{const r=(...o)=>{const i=h(o);i==h(s)?t(e,...o,...n(o)):c(s[i])?y(a[i]?.(...o)??[],(e=>r(...o,e))):r(...o,s[i])};r()}))]})(),K=e=>{e!=A&&(A=e,B(T,void 0,A))},Q=t=>{(x&&g(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},X=async e=>(2!=A&&(K(1),m++,await ee((async()=>{try{const t=await s();g(t)?Q(t):e?F(e):d("Content is not an array: "+t)}catch(t){e&&F(e)}K(0)}))),te),Y=()=>(C&&(r(C),C=void 0),te),Z=async e=>(1!=A&&(K(2),L++,await ee((async()=>{try{await a(P,e)}catch(e){}K(0)}))),te),_=()=>(f&&(e.delListener(f),f=void 0),te),ee=async(...e)=>(v(R($,b),...e),await(async()=>{if(!R(J,b)){for(j(J,b,1);!c(p=S(R($,b)));)try{await p()}catch(e){}j(J,b,0)}})(),te),te={load:X,startAutoLoad:async e=>{Y(),await X(e);try{C=await n((async(e,t)=>{t||e?2!=A&&(K(1),m++,Q(t??e),K(0)):await X()}))}catch(e){}return te},stopAutoLoad:Y,isAutoLoading:()=>!c(C),save:Z,startAutoSave:async()=>(_(),await Z(),f=e.addDidFinishTransactionListener((()=>{const e=D();z(e)&&Z(e)})),te),stopAutoSave:_,isAutoSaving:()=>!c(f),getStatus:()=>A,addStatusListener:e=>U(e,T),delListener:t=>(G(t),e),schedule:ee,getStore:()=>e,destroy:()=>(R($,b).splice(0,void 0),Y().stopAutoSave()),getStats:()=>({loads:m,saves:L}),...u};return M(te)},G=s("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),K=n.crypto?e=>n.crypto.getRandomValues(e):e=>w(e,(()=>i(256*o.random()))),Q=(e=16)=>{return t=(e,t)=>e+G[63&t],K(new Uint8Array(e)).reduce(t,"");var t},X=/\/([^?]*)/,Y="S",Z=e=>{return(s=new URL(e.url).pathname,a=X,s?.match(a))?.[1]??t;var s,a},_=e=>"websocket"==e.headers.get("upgrade")?.toLowerCase()?e.headers.get("sec-websocket-key"):null,ee=(e,t=null,s=null)=>new Response(s,{status:e,webSocket:t}),te=()=>ee(426,null,"Upgrade required");class se extends e.DurableObject{#e;constructor(e,s){super(e,s),this.ctx.blockConcurrencyWhile((async()=>await l(await this.createPersister(),(async e=>{const s=((e,s,n,o,i,g,u,h,d={})=>{let y,w=0,v=0,S=0;const b=W(),p=()=>Q(11),C=(e,t,a,n)=>{v++,s(e,t,a,n)},f=async(e,t,s,n)=>new a(((a,o)=>{const c=n+"."+Q(4),l=r((()=>{H(b,c),o(`No response from ${e??"anyone"} to ${c}, `+t)}),i);j(b,c,[e,(e,t)=>{clearTimeout(l),H(b,c),a([e,t,n])}]),C(e,c,t,s)})),M=(e,[t,s])=>{A(t,(([t,s],a)=>{const n=m(e[0],a,U);A(t,(([e,t],s)=>{const a=m(n[0],s,U);A(e,(([e,t],s)=>a[0][s]=z(e,t))),a[1]=F(a[1],t)})),n[1]=F(n[1],s)})),e[1]=F(e[1],s)},L=async(s=null,a,n=p())=>{try{c(a)&&([a,s,n]=await f(null,1,t,n));const[r,o]=a,[i,l]=e.getMergeableContentHashes();let g=U();if(i!=r){const[t,a]=(await f(s,4,e.getMergeableTableHashes(),n))[0];if(g=t,!k(a)){const[t,r]=(await f(s,5,e.getMergeableRowHashes(a),n))[0];if(M(g,t),!k(r)){const t=(await f(s,6,e.getMergeableCellHashes(r),n))[0];M(g,t)}}}return[g,l==o?U():(await f(s,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){}},T=B(e,(async()=>{const e=await L();return!e||k(e[0][0])&&k(e[1][0])?void 0:e}),(async(t,s)=>s?C(null,p(),3,s):C(null,p(),2,e.getMergeableContentHashes())),(e=>y=e),(()=>y=void 0),0,2,{startSync:async e=>(w=1,await(await T.startAutoLoad(e)).startAutoSave()),stopSync:()=>(w=0,T.stopAutoLoad().stopAutoSave()),destroy:()=>T.stopSync(),getSynchronizerStats:()=>({sends:v,receives:S}),...d},1);return n(((t,s,a,n)=>{const r=w||T.isAutoLoading();S++,0==a?l(R(b,s),(([e,s])=>c(e)||e==t?s(n,t):0)):2==a&&r?L(t,n,s??void 0).then((e=>{y?.(void 0,e)})).catch(h):3==a&&r?y?.(void 0,n):l(1==a&&(w||T.isAutoSaving())?e.getMergeableContentHashes():4==a?e.getMergeableTableDiff(n):5==a?e.getMergeableRowDiff(n):6==a?e.getMergeableCellDiff(n):7==a?e.getMergeableValueDiff(n):void 0,(e=>{C(t,s,0,e)}))})),T})(e.getStore(),((e,t,s,a)=>this.#t(Y,P(e,t,s,a))),(e=>this.#e=t=>((e,t)=>x(e,((e,s)=>{return t(e,...(a=s,T(a,((e,t)=>"￼"===t?void 0:t))));var a})))(t,e)),0,1);await e.load(),await e.startAutoSave(),r(s.startSync)}))))}fetch(e){const s=Z(e);return l(_(e),(e=>{const[a,n]=(r=new WebSocketPair,b.values(r));var r,o;return o=this.#s(),0==h(o)&&this.onPathId(s,1),this.ctx.acceptWebSocket(n,[e,s]),this.onClientId(s,e,1),n.send(P(Y,null,1,t)),ee(101,a)}),te)}webSocketMessage(e,t){l(this.ctx.getTags(e)[0],(s=>this.#t(s,t.toString(),e)))}webSocketClose(e){const[t,s]=this.ctx.getTags(e);this.onClientId(s,t,-1),1==h(this.#s())&&this.onPathId(s,-1)}#t(e,s,a){x(s.toString(),((s,n)=>{const r=D(e,n);this.onMessage(e,s,n),s==t?(e!=Y&&this.#e?.(r),y(this.#s(),(e=>{e!=a&&e.send(r)}))):s==Y?this.#e?.(r):s!=e&&this.#s(s)[0]?.send(r)}))}#s(e){return this.ctx.getWebSockets(e)}createPersister(){}getPathId(){return this.ctx.getTags(this.#s()[0])?.[1]}getClientIds(){return w(this.#s(),(e=>this.ctx.getTags(e)[0]))}onPathId(e,t){}onClientId(e,t,s){}onMessage(e,t,s){}}exports.WsServerDurableObject=se,exports.getWsServerDurableObjectFetch=e=>(t,s)=>_(t)?s[e].get(s[e].idFromName(Z(t))).fetch(t):te();
