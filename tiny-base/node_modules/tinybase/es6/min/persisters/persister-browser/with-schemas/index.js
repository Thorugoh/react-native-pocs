const e=globalThis.window,t=e=>null==e,n=(e,n,l)=>t(e)?null==l?void 0:l():n(e),l=e=>Array.isArray(e),r=e=>e.length,o=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),u=(e,...t)=>e.push(...t),i=e=>e.shift(),s=Object,d=e=>s.getPrototypeOf(e),c=s.keys,v=s.freeze,y=e=>(e=>!t(e)&&n(d(e),(e=>e==s.prototype||t(d(e))),(()=>!0)))(e)&&0==(e=>r(c(e)))(e),g=JSON.stringify,p=JSON.parse,h=e=>t(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),f=(e,t)=>null==e?void 0:e.forEach(t),b=(e,t)=>null==e?void 0:e.delete(t),S=e=>new Map(e),w=(e,t)=>null==e?void 0:e.get(t),m=(e,n,l)=>t(l)?(b(e,n),e):null==e?void 0:e.set(n,l),C=(e,t,n,l)=>{var r,o,a;return o=t,null!=(a=null==(r=e)?void 0:r.has(o))&&a?null==l||l(w(e,t)):m(e,t,n()),w(e,t)},A=(e,t,l,o,a=0)=>n((l?C:w)(e,t[a],a>r(t)-2?l:S),(n=>{if(a>r(t)-2)return(null==o?void 0:o(n))&&m(e,t[a]),n;const u=A(n,t,l,o,a+1);return h(n)&&m(e,t[a]),u})),O=e=>new Set(l(e)||t(e)?e:[e]),L=/^\d+$/;var P=Object.defineProperty,E=Object.getOwnPropertySymbols,M=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable,x=(e,t,n)=>t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,T=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},a=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);u((n=n.apply(e,t)).next())}));const I=S(),N=S(),k=(e,s,d,c,g,p,P,k={},z=0,D=[])=>{let J,F,V,$=0,q=0,B=0;C(I,D,(()=>0)),C(N,D,(()=>[]));const G=S(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!y(e)||!y(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!y(e)||!y(t),t.setContent]:o("Store type not supported by this Persister"))(P,e,z),[W,X,Y]=(()=>{let e;const[l,o]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?i(e):null)?l:""+t++},t=>{L.test(t)&&r(e)<1e3&&u(e,t)}]})(),s=S();return[(t,n,r,o=[],a=()=>[])=>{null!=e||(e=oe);const u=l(1);var i,d;return m(s,u,[t,n,r,o,a]),d=u,null==(i=A(n,null!=r?r:[""],O))||i.add(d),u},(t,n,...l)=>a(((e,t=[""])=>{const n=[],l=(e,o)=>o==r(t)?u(n,e):null===t[o]?f(e,(e=>l(e,o+1))):a([t[o],null],(t=>l(w(e,t),o+1)));return l(e,0),n})(t,n),(t=>f(t,(t=>w(s,t)[0](e,...null!=n?n:[],...l))))),e=>n(w(s,e),(([,t,n])=>(A(t,null!=n?n:[""],void 0,(t=>(b(t,e),h(t)?1:0))),m(s,e),o(e),n))),l=>n(w(s,l),(([n,,l=[],o,u])=>{const i=(...s)=>{var d,c;const v=r(s);v==r(l)?n(e,...s,...u(s)):t(l[v])?a(null!=(c=null==(d=o[v])?void 0:d.call(o,...s))?c:[],(e=>i(...s,e))):i(...s,l[v])};i()}))]})(),Z=e=>{e!=$&&($=e,X(G,void 0,$))},_=t=>{(H&&l(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>T(void 0,null,(function*(){return 2!=$&&(Z(1),q++,yield re((()=>T(void 0,null,(function*(){try{const t=yield s();l(t)?_(t):e?U(e):o("Content is not an array: "+t)}catch(t){null==p||p(t),e&&U(e)}Z(0)}))))),oe})),te=()=>(F&&(g(F),F=void 0),oe),ne=e=>T(void 0,null,(function*(){return 1!=$&&(Z(2),B++,yield re((()=>T(void 0,null,(function*(){try{yield d(K,e)}catch(e){null==p||p(e)}Z(0)}))))),oe})),le=()=>(V&&(e.delListener(V),V=void 0),oe),re=(...e)=>T(void 0,null,(function*(){return u(w(N,D),...e),yield T(void 0,null,(function*(){if(!w(I,D)){for(m(I,D,1);!t(J=i(w(N,D)));)try{yield J()}catch(e){null==p||p(e)}m(I,D,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))M.call(t,n)&&x(e,n,t[n]);if(E)for(var n of E(t))j.call(t,n)&&x(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>T(void 0,null,(function*(){te(),yield ee(e);try{F=yield c(((e,t)=>T(void 0,null,(function*(){t||e?2!=$&&(Z(1),q++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==p||p(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!t(F),save:ne,startAutoSave:()=>T(void 0,null,(function*(){return le(),yield ne(),V=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!t(V),getStatus:()=>$,addStatusListener:e=>W(e,G),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(w(N,D).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:q,saves:B})},k);return v(oe)};var z=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},a=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);u((n=n.apply(e,t)).next())}));const D="storage",J=(t,n,l,r)=>k(t,(()=>z(void 0,null,(function*(){return e=l.getItem(n),p(e,((e,t)=>"￼"===t?void 0:t));var e}))),(e=>z(void 0,null,(function*(){return l.setItem(n,(t=e(),g(t,((e,t)=>void 0===t?"￼":t))));var t}))),(t=>{const r=e=>{if(e.storageArea===l&&e.key===n)try{t(p(e.newValue))}catch(e){t()}};return e.addEventListener(D,r),r}),(t=>e.removeEventListener(D,t)),r,3,{getStorageName:()=>n}),F=(e,t,n)=>J(e,t,localStorage,n),V=(e,t,n)=>J(e,t,sessionStorage,n);export{F as createLocalPersister,V as createSessionPersister};
