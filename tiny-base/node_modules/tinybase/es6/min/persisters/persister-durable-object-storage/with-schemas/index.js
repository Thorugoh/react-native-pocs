const t="t",e="v",n=t=>null==t,l=(t,e,l)=>n(t)?null==l?void 0:l():e(t),o=t=>Array.isArray(t),r=(t,e,n)=>t.slice(e,n),i=t=>t.length,u=t=>{throw Error(t)},a=(t,e)=>t.forEach(e),s=(t,...e)=>t.push(...e),c=t=>t.shift(),d=Object,v=t=>d.getPrototypeOf(t),y=d.entries,p=d.keys,f=d.freeze,h=(t,e)=>a(y(t),(([t,n])=>e(n,t))),g=t=>(t=>!n(t)&&l(v(t),(t=>t==d.prototype||n(v(t))),(()=>!0)))(t)&&0==(t=>i(p(t)))(t),b=(t,e,n)=>(((t,e)=>e in t)(t,e)||(t[e]=n()),t[e]),S=t=>n(t)||0==(t=>{var e;return null!=(e=null==t?void 0:t.size)?e:0})(t),C=(t,e)=>null==t?void 0:t.forEach(e),w=(t,e)=>null==t?void 0:t.delete(e),O=t=>new Map(t),A=(t,e)=>null==t?void 0:t.get(e),P=(t,e,l)=>n(l)?(w(t,e),t):null==t?void 0:t.set(e,l),m=(t,e,n,l)=>{var o,r,i;return r=e,null!=(i=null==(o=t)?void 0:o.has(r))&&i?null==l||l(A(t,e)):P(t,e,n()),A(t,e)},L=(t,e,n,o,r=0)=>l((n?m:A)(t,e[r],r>i(e)-2?n:O),(l=>{if(r>i(e)-2)return(null==o?void 0:o(l))&&P(t,e[r]),l;const u=L(l,e,n,o,r+1);return S(l)&&P(t,e[r]),u})),x=(t,e,n)=>{e>t[1]&&(t[1]=e),t[2]=n>>>0},M=t=>new Set(o(t)||n(t)?t:[t]),j=/^\d+$/;var E=Object.defineProperty,T=Object.getOwnPropertySymbols,z=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable,J=(t,e,n)=>e in t?E(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,N=(t,e,n)=>new Promise(((l,o)=>{var r=t=>{try{u(n.next(t))}catch(t){o(t)}},i=t=>{try{u(n.throw(t))}catch(t){o(t)}},u=t=>t.done?l(t.value):Promise.resolve(t.value).then(r,i);u((n=n.apply(t,e)).next())}));const k=O(),F=O(),I=(t,e,r,d,v,y,p,h={},b=0,x=[])=>{let E,I,W,$=0,q=0,B=0;m(k,x,(()=>0)),m(F,x,(()=>[]));const G=O(),[H,K,Q,R,U]=((t=1,e,n)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!n),([[t],[e]])=>!g(t)||!g(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!g(t)||!g(e),e.setContent]:u("Store type not supported by this Persister"))(p,t,b),[V,X,Y]=(()=>{let t;const[e,o]=(()=>{const t=[];let e=0;return[n=>{var l;return null!=(l=n?c(t):null)?l:""+e++},e=>{j.test(e)&&i(t)<1e3&&s(t,e)}]})(),r=O();return[(n,l,o,i=[],u=()=>[])=>{null!=t||(t=rt);const a=e(1);var s,c;return P(r,a,[n,l,o,i,u]),c=a,null==(s=L(l,null!=o?o:[""],M))||s.add(c),a},(e,n,...l)=>a(((t,e=[""])=>{const n=[],l=(t,o)=>o==i(e)?s(n,t):null===e[o]?C(t,(t=>l(t,o+1))):a([e[o],null],(e=>l(A(t,e),o+1)));return l(t,0),n})(e,n),(e=>C(e,(e=>A(r,e)[0](t,...null!=n?n:[],...l))))),t=>l(A(r,t),(([,e,n])=>(L(e,null!=n?n:[""],void 0,(e=>(w(e,t),S(e)?1:0))),P(r,t),o(t),n))),e=>l(A(r,e),(([e,,l=[],o,r])=>{const u=(...s)=>{var c,d;const v=i(s);v==i(l)?e(t,...s,...r(s)):n(l[v])?a(null!=(d=null==(c=o[v])?void 0:c.call(o,...s))?d:[],(t=>u(...s,t))):u(...s,l[v])};u()}))]})(),Z=t=>{t!=$&&($=t,X(G,void 0,$))},_=e=>{(H&&o(null==e?void 0:e[0])?1===(null==e?void 0:e[2])?t.applyMergeableChanges:t.setMergeableContent:1===(null==e?void 0:e[2])?t.applyChanges:t.setContent)(e)},tt=t=>N(void 0,null,(function*(){return 2!=$&&(Z(1),q++,yield ot((()=>N(void 0,null,(function*(){try{const n=yield e();o(n)?_(n):t?U(t):u("Content is not an array: "+n)}catch(e){null==y||y(e),t&&U(t)}Z(0)}))))),rt})),et=()=>(I&&(I=void 0),rt),nt=t=>N(void 0,null,(function*(){return 1!=$&&(Z(2),B++,yield ot((()=>N(void 0,null,(function*(){try{yield r(K,t)}catch(t){null==y||y(t)}Z(0)}))))),rt})),lt=()=>(W&&(t.delListener(W),W=void 0),rt),ot=(...t)=>N(void 0,null,(function*(){return s(A(F,x),...t),yield N(void 0,null,(function*(){if(!A(k,x)){for(P(k,x,1);!n(E=c(A(F,x)));)try{yield E()}catch(t){null==y||y(t)}P(k,x,0)}})),rt})),rt=((t,e)=>{for(var n in e||(e={}))z.call(e,n)&&J(t,n,e[n]);if(T)for(var n of T(e))D.call(e,n)&&J(t,n,e[n]);return t})({load:tt,startAutoLoad:t=>N(void 0,null,(function*(){et(),yield tt(t);try{I=yield d(((t,e)=>N(void 0,null,(function*(){e||t?2!=$&&(Z(1),q++,_(null!=e?e:t),Z(0)):yield tt()}))))}catch(t){null==y||y(t)}return rt})),stopAutoLoad:et,isAutoLoading:()=>!n(I),save:nt,startAutoSave:()=>N(void 0,null,(function*(){return lt(),yield nt(),W=t.addDidFinishTransactionListener((()=>{const t=Q();R(t)&&nt(t)})),rt})),stopAutoSave:lt,isAutoSaving:()=>!n(W),getStatus:()=>$,addStatusListener:t=>V(t,G),delListener:e=>(Y(e),t),schedule:ot,getStore:()=>t,destroy:()=>(A(F,x).splice(0,void 0),et().stopAutoSave()),getStats:()=>({loads:q,saves:B})},h);return f(rt)},W=JSON.stringify;var $=(t,e,n)=>new Promise(((l,o)=>{var r=t=>{try{u(n.next(t))}catch(t){o(t)}},i=t=>{try{u(n.throw(t))}catch(t){o(t)}},u=t=>t.done?l(t.value):Promise.resolve(t.value).then(r,i);u((n=n.apply(t,e)).next())}));const q=()=>[{},"",0],B=(n,o,i="",u)=>{const a=(t,...e)=>i+t+r(W(e,((t,e)=>void 0===e?"ï¿¼":e)),1,-1);return I(n,(()=>$(void 0,null,(function*(){const n=[{},"",0],u=[{},"",0];return(yield o.list({prefix:i})).forEach(((o,a)=>$(void 0,[o,a],(function*([o,a,s],c){return l((n=>{if(l=i,n.startsWith(l)){const l=r(n,i.length,1);return l==t||l==e?[l,...JSON.parse("["+r(n,i.length+1)+"]")]:void 0}var l})(c),(([r,...i])=>r==t?l(i[0],(t=>{const e=b(n[0],t,q);l(i[1],(t=>{const n=b(e[0],t,q);l(i[2],(t=>n[0][t]=[o,a,s]),(()=>x(n,a,s)))}),(()=>x(e,a,s)))}),(()=>x(n,a,s))):r==e?l(i[0],(t=>u[0][t]=[o,a,s]),(()=>x(u,a,s))):0))})))),[n,u]}))),((n,...l)=>$(void 0,[n,...l],(function*(n,[[l,r,i],[u,s,c]]=n()){const d=O();P(d,a(t),[0,r,i]),h(l,(([e,n,l],o)=>{P(d,a(t,o),[0,n,l]),h(e,(([e,n,l],r)=>{P(d,a(t,o,r),[0,n,l]),h(e,((e,n)=>P(d,a(t,o,r,n),e)))}))})),P(d,a(e),[0,s,c]),h(u,((t,n)=>P(d,a(e,n),t))),yield o.put((t=>{const e={};return C(t,((t,n)=>{{const l=t;e[n]=l}})),e})(d))}))),(()=>{}),0,u,2,{getStorage:()=>o})};export{B as createDurableObjectStoragePersister};
