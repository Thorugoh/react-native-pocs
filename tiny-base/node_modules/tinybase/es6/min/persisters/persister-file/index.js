import{existsSync as t,writeFileSync as e,watch as n}from"fs";import{readFile as l,writeFile as o}from"fs/promises";const r="utf8",i=t=>null==t,u=(t,e,n)=>i(t)?null==n?void 0:n():e(t),a=t=>Array.isArray(t),s=t=>t.length,d=t=>{throw Error(t)},c=(t,e)=>t.forEach(e),v=(t,...e)=>t.push(...e),y=t=>t.shift(),p=Object,f=t=>p.getPrototypeOf(t),h=p.keys,g=p.freeze,b=t=>(t=>!i(t)&&u(f(t),(t=>t==p.prototype||i(f(t))),(()=>!0)))(t)&&0==(t=>s(h(t)))(t),S=JSON.stringify,m=JSON.parse,C=t=>i(t)||0==(t=>{var e;return null!=(e=null==t?void 0:t.size)?e:0})(t),w=(t,e)=>null==t?void 0:t.forEach(e),O=(t,e)=>null==t?void 0:t.delete(e),P=t=>new Map(t),A=(t,e)=>null==t?void 0:t.get(e),L=(t,e,n)=>i(n)?(O(t,e),t):null==t?void 0:t.set(e,n),M=(t,e,n,l)=>{var o,r,i;return r=e,null!=(i=null==(o=t)?void 0:o.has(r))&&i?null==l||l(A(t,e)):L(t,e,n()),A(t,e)},j=(t,e,n,l,o=0)=>u((n?M:A)(t,e[o],o>s(e)-2?n:P),(r=>{if(o>s(e)-2)return(null==l?void 0:l(r))&&L(t,e[o]),r;const i=j(r,e,n,l,o+1);return C(r)&&L(t,e[o]),i})),x=t=>new Set(a(t)||i(t)?t:[t]),E=/^\d+$/;var T=Object.defineProperty,z=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable,J=(t,e,n)=>e in t?T(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,N=(t,e,n)=>new Promise(((l,o)=>{var r=t=>{try{u(n.next(t))}catch(t){o(t)}},i=t=>{try{u(n.throw(t))}catch(t){o(t)}},u=t=>t.done?l(t.value):Promise.resolve(t.value).then(r,i);u((n=n.apply(t,e)).next())}));const k=P(),I=P(),$=(t,e,n,l,o,r,p,f={},h=0,S=[])=>{let m,T,$,q=0,B=0,G=0;M(k,S,(()=>0)),M(I,S,(()=>[]));const H=P(),[K,Q,R,U,V]=((t=1,e,n)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!n),([[t],[e]])=>!b(t)||!b(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!b(t)||!b(e),e.setContent]:d("Store type not supported by this Persister"))(p,t,h),[W,X,Y]=(()=>{let t;const[e,n]=(()=>{const t=[];let e=0;return[n=>{var l;return null!=(l=n?y(t):null)?l:""+e++},e=>{E.test(e)&&s(t)<1e3&&v(t,e)}]})(),l=P();return[(n,o,r,i=[],u=()=>[])=>{null!=t||(t=rt);const a=e(1);var s,d;return L(l,a,[n,o,r,i,u]),d=a,null==(s=j(o,null!=r?r:[""],x))||s.add(d),a},(e,n,...o)=>c(((t,e=[""])=>{const n=[],l=(t,o)=>o==s(e)?v(n,t):null===e[o]?w(t,(t=>l(t,o+1))):c([e[o],null],(e=>l(A(t,e),o+1)));return l(t,0),n})(e,n),(e=>w(e,(e=>A(l,e)[0](t,...null!=n?n:[],...o))))),t=>u(A(l,t),(([,e,o])=>(j(e,null!=o?o:[""],void 0,(e=>(O(e,t),C(e)?1:0))),L(l,t),n(t),o))),e=>u(A(l,e),(([e,,n=[],l,o])=>{const r=(...u)=>{var a,d;const v=s(u);v==s(n)?e(t,...u,...o(u)):i(n[v])?c(null!=(d=null==(a=l[v])?void 0:a.call(l,...u))?d:[],(t=>r(...u,t))):r(...u,n[v])};r()}))]})(),Z=t=>{t!=q&&(q=t,X(H,void 0,q))},_=e=>{(K&&a(null==e?void 0:e[0])?1===(null==e?void 0:e[2])?t.applyMergeableChanges:t.setMergeableContent:1===(null==e?void 0:e[2])?t.applyChanges:t.setContent)(e)},tt=t=>N(void 0,null,(function*(){return 2!=q&&(Z(1),B++,yield ot((()=>N(void 0,null,(function*(){try{const n=yield e();a(n)?_(n):t?V(t):d("Content is not an array: "+n)}catch(e){null==r||r(e),t&&V(t)}Z(0)}))))),rt})),et=()=>(T&&(o(T),T=void 0),rt),nt=t=>N(void 0,null,(function*(){return 1!=q&&(Z(2),G++,yield ot((()=>N(void 0,null,(function*(){try{yield n(Q,t)}catch(t){null==r||r(t)}Z(0)}))))),rt})),lt=()=>($&&(t.delListener($),$=void 0),rt),ot=(...t)=>N(void 0,null,(function*(){return v(A(I,S),...t),yield N(void 0,null,(function*(){if(!A(k,S)){for(L(k,S,1);!i(m=y(A(I,S)));)try{yield m()}catch(t){null==r||r(t)}L(k,S,0)}})),rt})),rt=((t,e)=>{for(var n in e||(e={}))D.call(e,n)&&J(t,n,e[n]);if(z)for(var n of z(e))F.call(e,n)&&J(t,n,e[n]);return t})({load:tt,startAutoLoad:t=>N(void 0,null,(function*(){et(),yield tt(t);try{T=yield l(((t,e)=>N(void 0,null,(function*(){e||t?2!=q&&(Z(1),B++,_(null!=e?e:t),Z(0)):yield tt()}))))}catch(t){null==r||r(t)}return rt})),stopAutoLoad:et,isAutoLoading:()=>!i(T),save:nt,startAutoSave:()=>N(void 0,null,(function*(){return lt(),yield nt(),$=t.addDidFinishTransactionListener((()=>{const t=R();U(t)&&nt(t)})),rt})),stopAutoSave:lt,isAutoSaving:()=>!i($),getStatus:()=>q,addStatusListener:t=>W(t,H),delListener:e=>(Y(e),t),schedule:ot,getStore:()=>t,destroy:()=>(A(I,S).splice(0,void 0),et().stopAutoSave()),getStats:()=>({loads:B,saves:G})},f);return g(rt)};var q=(t,e,n)=>new Promise(((l,o)=>{var r=t=>{try{u(n.next(t))}catch(t){o(t)}},i=t=>{try{u(n.throw(t))}catch(t){o(t)}},u=t=>t.done?l(t.value):Promise.resolve(t.value).then(r,i);u((n=n.apply(t,e)).next())}));const B=(i,u,a)=>$(i,(()=>q(void 0,null,(function*(){return t=yield l(u,r),m(t,((t,e)=>"￼"===e?void 0:e));var t}))),(t=>q(void 0,null,(function*(){return yield o(u,(e=t(),S(e,((t,e)=>void 0===e?"￼":e))),r);var e}))),(l=>(t(u)||e(u,"",r),n(u,(()=>l())))),(t=>null==t?void 0:t.close()),a,3,{getFilePath:()=>u});export{B as createFilePersister};
