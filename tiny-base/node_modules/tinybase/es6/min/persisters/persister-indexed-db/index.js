const e=Promise,t=globalThis.window,n=clearInterval,l=e=>null==e,r=(e,t,n)=>l(e)?null==n?void 0:n():t(e),o=e=>Array.isArray(e),u=e=>e.length,i=t=>new e(t),a=t=>{return n=function*(){return e.all(t)},new Promise(((e,t)=>{var l=e=>{try{o(n.next(e))}catch(e){t(e)}},r=e=>{try{o(n.throw(e))}catch(e){t(e)}},o=t=>t.done?e(t.value):Promise.resolve(t.value).then(l,r);o((n=n.apply(void 0,null)).next())}));var n},s=e=>{throw Error(e)},d=(e,t)=>e.forEach(t),c=(e,t)=>e.map(t),v=(e,...t)=>e.push(...t),y=e=>e.shift(),p=Object,f=e=>p.getPrototypeOf(e),h=p.entries,g=p.keys,b=p.freeze,w=e=>(e=>!l(e)&&r(f(e),(e=>e==p.prototype||l(f(e))),(()=>!0)))(e)&&0==(e=>u(g(e)))(e),S=e=>l(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),m=(e,t)=>null==e?void 0:e.forEach(t),P=(e,t)=>null==e?void 0:e.delete(t),A=e=>new Map(e),C=(e,t)=>null==e?void 0:e.get(t),x=(e,t,n)=>l(n)?(P(e,t),e):null==e?void 0:e.set(t,n),O=(e,t,n,l)=>{var r,o,u;return o=t,null!=(u=null==(r=e)?void 0:r.has(o))&&u?null==l||l(C(e,t)):x(e,t,n()),C(e,t)},j=(e,t,n,l,o=0)=>r((n?O:C)(e,t[o],o>u(t)-2?n:A),(r=>{if(o>u(t)-2)return(null==l?void 0:l(r))&&x(e,t[o]),r;const i=j(r,t,n,l,o+1);return S(r)&&x(e,t[o]),i})),L=e=>new Set(o(e)||l(e)?e:[e]),D=/^\d+$/;var M=Object.defineProperty,k=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable,B=(e,t,n)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,I=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},u=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,u);i((n=n.apply(e,t)).next())}));const z=A(),$=A(),F=(e,t,n,i,a,c,p,f={},h=0,g=[])=>{let M,F,K,N=0,q=0,G=0;O(z,g,(()=>0)),O($,g,(()=>[]));const H=A(),[J,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!w(e)||!w(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!w(e)||!w(t),t.setContent]:s("Store type not supported by this Persister"))(p,e,h),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?y(e):null)?l:""+t++},t=>{D.test(t)&&u(e)<1e3&&v(e,t)}]})(),o=A();return[(n,l,r,u=[],i=()=>[])=>{null!=e||(e=oe);const a=t(1);var s,d;return x(o,a,[n,l,r,u,i]),d=a,null==(s=j(l,null!=r?r:[""],L))||s.add(d),a},(t,n,...l)=>d(((e,t=[""])=>{const n=[],l=(e,r)=>r==u(t)?v(n,e):null===t[r]?m(e,(e=>l(e,r+1))):d([t[r],null],(t=>l(C(e,t),r+1)));return l(e,0),n})(t,n),(t=>m(t,(t=>C(o,t)[0](e,...null!=n?n:[],...l))))),e=>r(C(o,e),(([,t,l])=>(j(t,null!=l?l:[""],void 0,(t=>(P(t,e),S(t)?1:0))),x(o,e),n(e),l))),t=>r(C(o,t),(([t,,n=[],r,o])=>{const i=(...a)=>{var s,c;const v=u(a);v==u(n)?t(e,...a,...o(a)):l(n[v])?d(null!=(c=null==(s=r[v])?void 0:s.call(r,...a))?c:[],(e=>i(...a,e))):i(...a,n[v])};i()}))]})(),Z=e=>{e!=N&&(N=e,X(H,void 0,N))},_=t=>{(J&&o(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>I(void 0,null,(function*(){return 2!=N&&(Z(1),q++,yield re((()=>I(void 0,null,(function*(){try{const n=yield t();o(n)?_(n):e?V(e):s("Content is not an array: "+n)}catch(t){null==c||c(t),e&&V(e)}Z(0)}))))),oe})),te=()=>(F&&(a(F),F=void 0),oe),ne=e=>I(void 0,null,(function*(){return 1!=N&&(Z(2),G++,yield re((()=>I(void 0,null,(function*(){try{yield n(Q,e)}catch(e){null==c||c(e)}Z(0)}))))),oe})),le=()=>(K&&(e.delListener(K),K=void 0),oe),re=(...e)=>I(void 0,null,(function*(){return v(C($,g),...e),yield I(void 0,null,(function*(){if(!C(z,g)){for(x(z,g,1);!l(M=y(C($,g)));)try{yield M()}catch(e){null==c||c(e)}x(z,g,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))E.call(t,n)&&B(e,n,t[n]);if(k)for(var n of k(t))T.call(t,n)&&B(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>I(void 0,null,(function*(){te(),yield ee(e);try{F=yield i(((e,t)=>I(void 0,null,(function*(){t||e?2!=N&&(Z(1),q++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==c||c(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!l(F),save:ne,startAutoSave:()=>I(void 0,null,(function*(){return le(),yield ne(),K=e.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!l(K),getStatus:()=>N,addStatusListener:e=>W(e,H),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(C($,g).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:q,saves:G})},f);return b(oe)};var K=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},u=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,u);i((n=n.apply(e,t)).next())}));const N=["t","v"],q={keyPath:"k"},G=(e,t)=>K(void 0,null,(function*(){const n=(t=>c(h(t),(([t,n])=>H(e,"put",{k:t,v:n}))))(t);c(yield H(e,"getAllKeys"),(l=>((e,t)=>t in e)(t,l)?0:v(n,H(e,"delete",l)))),yield a(n)})),H=(e,t,n)=>K(void 0,null,(function*(){return i(((l,r)=>{const o=e[t](n);o.onsuccess=()=>l(o.result),o.onerror=()=>r(`objectStore.${t} error`)}))})),J=(e,l,r=1,o)=>{const u=(e,...n)=>K(void 0,[e,...n],(function*(e,n=[],r=0){return i(((o,u)=>{const i=(t?t.indexedDB:indexedDB).open(l,r?2:void 0);i.onupgradeneeded=()=>r&&c(N,(e=>{try{i.result.createObjectStore(e,q)}catch(e){}})),i.onsuccess=()=>K(void 0,null,(function*(){try{const t=i.result.transaction(N,"readwrite"),l=yield a(c(N,((l,r)=>K(void 0,null,(function*(){return yield e(t.objectStore(l),n[r])})))));i.result.close(),o(l)}catch(e){i.result.close(),u(e)}})),i.onerror=()=>u("indexedDB.open error")}))}));return F(e,(()=>K(void 0,null,(function*(){return yield u((e=>K(void 0,null,(function*(){return((e=[])=>p.fromEntries(e))(c(yield H(e,"getAll"),(({k:e,v:t})=>[e,t])))}))))}))),(e=>K(void 0,null,(function*(){return yield u(((e,t)=>K(void 0,null,(function*(){return yield G(e,t)}))),e(),1)}))),(e=>setInterval(e,1e3*r)),(e=>n(e)),o,1,{getDbName:()=>l})};export{J as createIndexedDbPersister,G as objectStoreMatch};
