const e=e=>typeof e,n=e(""),t="t",i=(e,n)=>e.startsWith(n),r=Promise,l=e=>null==e,s=(e,n,t)=>l(e)?null==t?void 0:t():n(e),o=(e,n,t)=>e.slice(n,t),u=e=>e.length,a=e=>{return n=function*(){return r.all(e)},new Promise(((e,t)=>{var i=e=>{try{l(n.next(e))}catch(e){t(e)}},r=e=>{try{l(n.throw(e))}catch(e){t(e)}},l=n=>n.done?e(n.value):Promise.resolve(n.value).then(i,r);l((n=n.apply(void 0,null)).next())}));var n},c=(e,n)=>e.map(n),d=(e,...n)=>e.push(...n),f=Object,h=f.entries,y=(e=[])=>f.fromEntries(e),g=(e,n)=>c(h(e),(([e,t])=>n(t,e))),v=(e,n,t)=>(((e,n)=>n in e)(e,n)||(e[n]=t()),e[n]),p=JSON.stringify,P=JSON.parse,m=e=>p(e,((e,n)=>n instanceof Map?f.fromEntries([...n]):n)),x=(t,i,r)=>t+i+(e(r)==n?r:m(r)),w=(e,n,t)=>{const r=u(e);return i(n,e)?[n[r],(t?P:String)(o(n,r+1))]:void 0},S=(e,n)=>((e,n)=>null==e?void 0:e.forEach(n))(e,((e,t)=>n(t,e)));var b=Object.defineProperty,D=(e,n,t)=>new Promise(((i,r)=>{var l=e=>{try{o(t.next(e))}catch(e){r(e)}},s=e=>{try{o(t.throw(e))}catch(e){r(e)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(l,s);o((t=t.apply(e,n)).next())}));const R="hasStore",C=y(c(["Origin","Methods","Headers"],(e=>["Access-Control-Allow-"+e,"*"]))),O=(e,...n)=>D(void 0,[e,...n],(function*(e,n=""){return!!(yield e.get(n+R))})),T=(e,...n)=>D(void 0,[e,...n],(function*(e,n=""){const i={},r={};return S(yield e.list(),((e,l)=>s(w(n,e),(([e,n])=>{if(e==t){const[e,t,r]=P("["+n+"]");v(v(i,e,y),t,y)[r]=l}else"v"==e&&(r[n]=l)})))),[i,r]})),H=(e,n,t)=>D(void 0,null,(function*(){return e.party.broadcast(x(e.config.messagePrefix,"s",n),t)})),V=(e,n,r,s)=>D(void 0,null,(function*(){const o=e.party.storage,c=e.config.storagePrefix,f={[c+R]:1},h=[],y=[];yield a(g(n[0],((n,i)=>D(void 0,null,(function*(){return l(n)?!r&&(yield e.canDelTable(i,s))&&((e,...n)=>e.unshift(...n))(y,E(c,t,i)):(yield e.canSetTable(i,r,s))&&(yield a(g(n,((n,u)=>D(void 0,null,(function*(){return l(n)?!r&&(yield e.canDelRow(i,u,s))&&d(y,E(c,t,i,u)):(yield e.canSetRow(i,u,r,s))&&(yield a(g(n,((n,a)=>D(void 0,null,(function*(){const y=[i,u,a],g=E(c,t,...y);l(n)?!r&&(yield e.canDelCell(...y,s))&&d(h,g):(yield e.canSetCell(...y,n,r,s,yield o.get(g)))&&(f[g]=n)}))))))}))))))}))))),yield a(g(n[1],((n,t)=>D(void 0,null,(function*(){const i=c+"v"+t;l(n)?!r&&(yield e.canDelValue(t,s))&&d(h,i):(yield e.canSetValue(t,n,r,s,yield o.get(i)))&&(f[i]=n)}))))),0!=u(y)&&S(yield o.list(),(e=>y.every((n=>!i(e,n)||d(h,e)&&0)))),yield o.delete(h),yield o.put(f)})),E=(e,n,...t)=>x(e,n,o(m(t),1,-1)),M=(e,n,t=null)=>D(void 0,null,(function*(){return new Response(t,{status:n,headers:e.config.responseHeaders})}));class j{constructor(e){var n,t,i,r,l,s,o;this.party=e,o={},(s="config")in(l=this)?b(l,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):l[s]=o,null!=(n=this.config).storePath||(n.storePath="/store"),null!=(t=this.config).messagePrefix||(t.messagePrefix=""),null!=(i=this.config).storagePrefix||(i.storagePrefix=""),null!=(r=this.config).responseHeaders||(r.responseHeaders=C)}onRequest(e){return D(this,null,(function*(){const{party:{storage:n},config:{storePath:t,storagePrefix:i}}=this;if(new URL(e.url).pathname.endsWith(t)){const t=yield O(n,i),r=yield e.text();return"PUT"==e.method?t?M(this,205):(yield V(this,P(r),!0,e),M(this,201)):M(this,200,t?m(yield T(n,i)):"")}return M(this,404)}))}onMessage(e,n){return D(this,null,(function*(){const{config:{messagePrefix:t,storagePrefix:i}}=this;yield s(w(t,e,1),(e=>D(this,[e],(function*([e,t]){"s"==e&&(yield O(this.party.storage,i))&&(yield V(this,t,!1,n),H(this,t,[n.id]))}))))}))}canSetTable(e,n,t){return D(this,null,(function*(){return!0}))}canDelTable(e,n){return D(this,null,(function*(){return!0}))}canSetRow(e,n,t,i){return D(this,null,(function*(){return!0}))}canDelRow(e,n,t){return D(this,null,(function*(){return!0}))}canSetCell(e,n,t,i,r,l,s){return D(this,null,(function*(){return!0}))}canDelCell(e,n,t,i){return D(this,null,(function*(){return!0}))}canSetValue(e,n,t,i,r){return D(this,null,(function*(){return!0}))}canDelValue(e,n){return D(this,null,(function*(){return!0}))}}export{j as TinyBasePartyKitServer,H as broadcastChanges,O as hasStoreInStorage,T as loadStoreFromStorage};
