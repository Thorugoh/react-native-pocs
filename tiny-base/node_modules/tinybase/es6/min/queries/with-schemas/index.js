const e=e=>typeof e,n=e(""),t=e(!0),r=e(0),l=e(e),o="Listener",s="Result",a="Ids",i="Table",d="Row",u=d+"Count",c=d+a,v="Sorted"+d+a,f="Cell",h=f+a,w=Math,g=w.max,y=w.min,L=isFinite,b=e=>null==e,p=(e,n,t)=>b(e)?null==t?void 0:t():n(e),R=n=>e(n)==l,m=e=>Array.isArray(e),T=e=>e.length,C=()=>{},I=(e,n)=>e.every(n),O=(e,n)=>e.forEach(n),S=e=>Q(e,((e,n)=>e+n),0),E=e=>0==T(e),Q=(e,n,t)=>e.reduce(n,t),j=(e,...n)=>e.push(...n),x=Object,D=x.entries,M=x.freeze,k=e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0},z=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},A=e=>b(e)||0==k(e),F=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},P=e=>e.clear(),W=(e,n)=>null==e?void 0:e.forEach(n),q=(e,n)=>null==e?void 0:e.delete(n),B=e=>new Map(e),G=(e,n)=>null==e?void 0:e.get(n),H=(e,n)=>W(e,((e,t)=>n(t,e))),J=(e,n,t)=>b(t)?(q(e,n),e):null==e?void 0:e.set(n,t),K=(e,n,t,r)=>(z(e,n)?null==r||r(G(e,n)):J(e,n,t()),G(e,n)),N=(e,n,t,r,l=0)=>p((t?K:G)(e,n[l],l>T(n)-2?t:B),(o=>{if(l>T(n)-2)return(null==r?void 0:r(o))&&J(e,n[l]),o;const s=N(o,n,t,r,l+1);return A(o)&&J(e,n[l]),s})),U=e=>new Set(m(e)||b(e)?e:[e]),V=(e,n)=>null==e?void 0:e.add(n),X=B([["avg",[(e,n)=>S(e)/n,(e,n,t)=>e+(n-e)/(t+1),(e,n,t)=>e+(e-n)/(t-1),(e,n,t,r)=>e+(n-t)/r]],["max",[e=>g(...e),(e,n)=>g(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:g(n,e)]],["min",[e=>y(...e),(e,n)=>y(n,e),(e,n)=>n==e?void 0:e,(e,n,t)=>t==e?void 0:y(n,e)]],["sum",[e=>S(e),(e,n)=>e+n,(e,n)=>e-n,(e,n,t)=>e-t+n]]]);var Y=Object.getOwnPropertySymbols,Z=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;const _=(()=>{const l=new WeakMap;return a=>(l.has(a)||l.set(a,(l=>{const a=l.createStore,w=a(),g=a(),y=B(),{addListener:S,callListeners:Q,delListener:_}=g,[ee,ne,te,re,le,,,oe,,se,ae,ie,de,ue]=((e,n,t,r,l)=>{const o=e.hasRow,s=B(),a=B(),i=B(),d=B(),u=B(),c=B(),v=(n,t,...r)=>{const l=K(c,n,U);return O(r,(n=>V(l,n)&&t&&e.callListener(n))),r},f=(n,...t)=>p(G(c,n),(r=>{O(E(t)?F(r):t,(n=>{e.delListener(n),q(r,n)})),A(r)&&J(c,n)})),h=(e,n)=>{J(s,e,n),z(a,e)||(J(a,e,!0),J(d,e,B()),J(u,e,B()),l(i))},w=e=>{J(s,e),J(a,e),J(d,e),J(u,e),f(e),l(i)};return[()=>e,()=>{return[...null!=(n=null==(e=s)?void 0:e.keys())?n:[]];var e,n},e=>H(a,e),e=>z(a,e),e=>G(s,e),e=>G(a,e),(e,n)=>J(a,e,n),h,(n,r,l,s,a)=>{h(n,r);const i=B(),c=B(),w=G(d,n),g=G(u,n),y=n=>{const l=t=>e.getCell(r,n,t),d=G(w,n),u=o(r,n)?t(s(l,n)):void 0;var v,f;if(d===u||m(d)&&m(u)&&(f=u,T(v=d)===T(f)&&I(v,((e,n)=>f[n]===e)))||J(i,n,[d,u]),!b(a)){const e=G(g,n),t=o(r,n)?a(l,n):void 0;e!=t&&J(c,n,t)}},L=e=>{l((()=>{W(i,(([,e],n)=>J(w,n,e))),W(c,((e,n)=>J(g,n,e)))}),i,c,w,g,e),P(i),P(c)};H(w,y),e.hasTable(r)&&O(e.getRowIds(r),(e=>{z(w,e)||y(e)})),L(!0),f(n),v(n,0,e.addRowListener(r,null,((e,n,t)=>y(t))),e.addTableListener(r,(()=>L())))},w,e=>r(e,i),()=>H(c,w),v,f]})(l,0,C,S,Q),ce=(e,n,...t)=>O(t,(t=>V(K(K(y,n,B),e,U),t))),ve=e=>{p(G(y,e),(e=>{H(e,((e,n)=>W(n,(n=>e.delListener(n))))),P(e)})),O([g,w],(n=>n.delTable(e)))},fe=(e,n,t)=>ce(n,e,n.addStartTransactionListener(t.startTransaction),n.addDidFinishTransactionListener((()=>t.finishTransaction()))),he={setQueryDefinition:(o,s,a)=>{oe(o,s),ve(o);const i=[],d=[[null,[s,null,null,[],B()]]],u=[],c=[],v=[];a({select:(e,n)=>{const t=R(e)?[T(i)+"",e]:[b(n)?e:n,t=>t(e,n)];return j(i,t),{as:e=>t[0]=e}},join:(e,n,t)=>{const r=b(t)||R(n)?null:n,l=b(r)?n:t,o=[e,[e,r,R(l)?l:e=>e(l),[],B()]];return j(d,o),{as:e=>o[0]=e}},where:(e,n,t)=>j(u,R(e)?e:b(t)?t=>t(e)===n:r=>r(e,n)===t),group:(e,n,t,r,l)=>{var o;const s=[e,[e,R(n)?[n,t,r,l]:null!=(o=G(X,n))?o:[(e,n)=>n]]];return j(c,s),{as:e=>s[0]=e}},having:(e,n)=>j(v,R(e)?e:t=>t(e)===n)});const f=B(i);if(A(f))return he;const h=B(d);H(h,((e,[,n])=>p(G(h,n),(({3:n})=>b(e)?0:j(n,e)))));const y=B(c);let m=w;if(A(y)&&E(v))m=g;else{fe(o,m,g);const l=B();H(y,((e,[n,t])=>V(K(l,n,U),[e,t])));const s=U();H(f,(e=>z(l,e)?0:V(s,e)));const a=B(),i=(s,a,i,d)=>p(s,(([u,c,f,h])=>{H(a,((o,[s])=>{const a=K(u,o,B),c=G(a,i),v=d?void 0:s;if(c!==v){const s=U([[c,v]]),d=k(a);J(a,i,v),W(G(l,o),(([l,o])=>{const i=((e,n,t,r,l,o=!1)=>{if(A(t))return;const[s,a,i,d]=l;return o||(o=b(e)),W(r,(([t,r])=>{o||(e=b(t)?null==a?void 0:a(e,r,n++):b(r)?null==i?void 0:i(e,t,n--):null==d?void 0:d(e,r,t,n),o||(o=b(e)))})),o?s(F(t),k(t)):e})(h[l],d,a,s,o);h[l]=b((l=>{const o=e(l);return(e=>e==n||e==t)(o)||o==r&&L(l)?o:void 0})(i))?null:i}))}})),A(c)||!I(v,(e=>e((e=>h[e]))))?g.delRow(o,f):b(f)?s[2]=g.addRow(o,h):g.setRow(o,f,h)}));ce(m,o,m.addRowListener(o,null,((e,n,t,r)=>{const d=[],u=[],c=B(),v=m.hasRow(o,t);let f=!v;W(s,(e=>{const[n,l,s]=r(o,t,e);j(d,l),j(u,s),f||(f=n)})),H(l,(e=>{const[n,,l]=r(o,t,e);(f||n)&&J(c,e,[l])})),f&&i(N(a,d,void 0,(([,e])=>(q(e,t),A(e)))),c,t,1),v&&i(N(a,u,(()=>{const e={};return W(s,(n=>e[n]=m.getCell(o,t,n))),[B(),U(),void 0,e]}),(([,e])=>{V(e,t)})),c,t)})))}fe(o,l,m);const C=(e,n,t,r)=>{const a=e=>l.getCell(n,t,e);O(r,(n=>{var t;const[r,,s,i,d]=G(h,n),u=null==s?void 0:s(a,e),[c,v]=null!=(t=G(d,e))?t:[];u!=c&&(b(v)||ue(o,v),J(d,e,b(u)?null:[u,...de(o,1,l.addRowListener(r,u,(()=>C(e,r,u,i))))]))})),(e=>{const n=(n,t)=>{var r,o,a;return l.getCell(...b(t)?[s,e,n]:n===s?[s,e,t]:[null==(r=G(h,n))?void 0:r[0],null==(a=G(null==(o=G(h,n))?void 0:o[4],e))?void 0:a[0],t])};m.transaction((()=>I(u,(e=>e(n)))?H(f,((t,r)=>((e,n,t,r,l)=>b(l)?e.delCell(n,t,r,!0):e.setCell(n,t,r,l))(m,o,e,t,r(n,e)))):m.delRow(o,e)))})(e)},{3:S}=G(h,null);return m.transaction((()=>de(o,1,l.addRowListener(s,null,((e,n,t)=>{l.hasRow(s,t)?C(t,s,t,S):(m.delRow(o,t),W(h,(({4:e})=>p(G(e,t),(([,n])=>{ue(o,n),J(e,t)})))))}))))),he},delQueryDefinition:e=>(ve(e),se(e),he),getStore:ee,getQueryIds:ne,forEachQuery:te,hasQuery:re,getTableId:le,addQueryIdsListener:e=>ae((()=>e(he))),delListener:e=>(_(e),he),destroy:ie,getListenerStats:()=>{const e=g.getListenerStats(),{tables:n,tableIds:t,transaction:r}=e;return((e,n)=>{var t={};for(var r in e)Z.call(e,r)&&n.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&Y)for(var r of Y(e))n.indexOf(r)<0&&$.call(e,r)&&(t[r]=e[r]);return t})(e,["tables","tableIds","transaction"])}};return we=([e,n],t)=>{O(e?["get","has","forEach"]:["get"],(e=>he[e+s+t]=(...n)=>g[e+t](...n))),he["add"+s+t+o]=(...e)=>{return g["add"+t+o](...(r=e,l=n,r.slice(0,l)),((t,...r)=>e[n](he,...r)),!0);var r,l}},((e=[])=>{x.fromEntries(e)})(((e,n)=>((e,n)=>e.map(n))(D(e),(([e,t])=>n(t,e))))({[i]:[1,1],[i+h]:[0,1],[u]:[0,1],[c]:[0,1],[v]:[0,5],[d]:[1,2],[h]:[0,2],[f]:[1,3]},((e,n)=>[n,we(e,n)]))),M(he);var we})(a)),l.get(a))})();export{_ as createQueries};
