const e=(e,t="",n)=>e.split(t,n),t=Promise,n=globalThis,l=(e,t=0)=>setTimeout(e,1e3*t),o=Math,r=o.floor,u=e=>null==e,a=(e,t,n)=>u(e)?null==n?void 0:n():t(e),i=e=>Array.isArray(e),s=e=>e.length,c=e=>{throw Error(e)},d=(e,t)=>e.forEach(t),v=(e,...t)=>e.push(...t),y=e=>e.shift(),g=Object,f=e=>g.getPrototypeOf(e),p=g.entries,h=g.keys,b=g.freeze,S=(e,t)=>d(p(e),(([e,n])=>t(n,e))),m=e=>(e=>!u(e)&&a(f(e),(e=>e==g.prototype||u(f(e))),(()=>!0)))(e)&&0==(e=>s(h(e)))(e),M=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),w=e=>u(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),A=(e,t)=>null==e?void 0:e.forEach(t),C=(e,t)=>null==e?void 0:e.delete(t),O=e=>new Map(e),P=(e,t)=>null==e?void 0:e.get(t),L=(e,t,n)=>u(n)?(C(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,l)=>{var o,r,u;return r=t,null!=(u=null==(o=e)?void 0:o.has(r))&&u?null==l||l(P(e,t)):L(e,t,n()),P(e,t)},T=(e,t,n,l,o=0)=>a((n?j:P)(e,t[o],o>s(t)-2?n:O),(r=>{if(o>s(t)-2)return(null==l?void 0:l(r))&&L(e,t[o]),r;const u=T(r,t,n,l,o+1);return w(r)&&L(e,t[o]),u})),H=(e,t)=>t?[e,t]:[e],D=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},E=(e="")=>H(((e=[])=>g.fromEntries(e))(),e),x=e=>new Set(i(e)||u(e)?e:[e]),z=/^\d+$/;var R=Object.defineProperty,V=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable,k=(e,t,n)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},u=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,u);a((n=n.apply(e,t)).next())}));const N=O(),U=O(),q=(e,t,n,l,o,r,g,f={},p=0,h=[])=>{let S,M,H,D=0,E=0,R=0;j(N,h,(()=>0)),j(U,h,(()=>[]));const q=O(),[B,G,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!m(e)||!m(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!m(e)||!m(t),t.setContent]:c("Store type not supported by this Persister"))(g,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?y(e):null)?l:""+t++},t=>{z.test(t)&&s(e)<1e3&&v(e,t)}]})(),l=O();return[(n,o,r,u=[],a=()=>[])=>{null!=e||(e=re);const i=t(1);var s,c;return L(l,i,[n,o,r,u,a]),c=i,null==(s=T(o,null!=r?r:[""],x))||s.add(c),i},(t,n,...o)=>d(((e,t=[""])=>{const n=[],l=(e,o)=>o==s(t)?v(n,e):null===t[o]?A(e,(e=>l(e,o+1))):d([t[o],null],(t=>l(P(e,t),o+1)));return l(e,0),n})(t,n),(t=>A(t,(t=>P(l,t)[0](e,...null!=n?n:[],...o))))),e=>a(P(l,e),(([,t,o])=>(T(t,null!=o?o:[""],void 0,(t=>(C(t,e),w(t)?1:0))),L(l,e),n(e),o))),t=>a(P(l,t),(([t,,n=[],l,o])=>{const r=(...a)=>{var i,c;const v=s(a);v==s(n)?t(e,...a,...o(a)):u(n[v])?d(null!=(c=null==(i=l[v])?void 0:i.call(l,...a))?c:[],(e=>r(...a,e))):r(...a,n[v])};r()}))]})(),Z=e=>{e!=D&&(D=e,X(q,void 0,D))},_=t=>{(B&&i(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>F(void 0,null,(function*(){return 2!=D&&(Z(1),E++,yield oe((()=>F(void 0,null,(function*(){try{const n=yield t();i(n)?_(n):e?Q(e):c("Content is not an array: "+n)}catch(t){null==r||r(t),e&&Q(e)}Z(0)}))))),re})),te=()=>(M&&(o(M),M=void 0),re),ne=e=>F(void 0,null,(function*(){return 1!=D&&(Z(2),R++,yield oe((()=>F(void 0,null,(function*(){try{yield n(G,e)}catch(e){null==r||r(e)}Z(0)}))))),re})),le=()=>(H&&(e.delListener(H),H=void 0),re),oe=(...e)=>F(void 0,null,(function*(){return v(P(U,h),...e),yield F(void 0,null,(function*(){if(!P(N,h)){for(L(N,h,1);!u(S=y(P(U,h)));)try{yield S()}catch(e){null==r||r(e)}L(N,h,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))I.call(t,n)&&k(e,n,t[n]);if(V)for(var n of V(t))$.call(t,n)&&k(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>F(void 0,null,(function*(){te(),yield ee(e);try{M=yield l(((e,t)=>F(void 0,null,(function*(){t||e?2!=D&&(Z(1),E++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==r||r(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!u(M),save:ne,startAutoSave:()=>F(void 0,null,(function*(){return le(),yield ne(),H=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!u(H),getStatus:()=>D,addStatusListener:e=>W(e,q),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(P(U,h).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:E,saves:R})},f);return b(re)},B=e("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),G=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>r(256*o.random()))))(e),J=(e=16)=>{return t=(e,t)=>e+B[63&t],G(new Uint8Array(e)).reduce(t,"");var t};var K=Object.defineProperty,Q=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable,Y=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Z=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},u=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,u);a((n=n.apply(e,t)).next())}));const _=O(),ee=(e,n,o,r)=>{const i=J();return((e,n,o,r,i,s,c,d,v={})=>{let y,g=0,f=0,p=0;const h=O(),b=()=>J(11),w=(e,t,l,o)=>{f++,null==s||s(e,t,l,o),n(e,t,l,o)},A=(e,n,o,r)=>Z(void 0,null,(function*(){return new t(((t,u)=>{const a=r+"."+J(4),s=l((()=>{C(h,a),u(`No response from ${null!=e?e:"anyone"} to ${a}, `+n)}),i);L(h,a,[e,(e,n)=>{clearTimeout(s),C(h,a),t([e,n,r])}]),w(e,a,n,o)}))})),j=(e,[t,n])=>{S(t,(([t,n],l)=>{const o=M(e[0],l,E);S(t,(([e,t],n)=>{const l=M(o[0],n,E);S(e,(([e,t],n)=>l[0][n]=H(e,t))),l[1]=D(l[1],t)})),o[1]=D(o[1],n)})),e[1]=D(e[1],n)},T=(...t)=>Z(void 0,[...t],(function*(t=null,n,l=b()){try{u(n)&&([n,t,l]=yield A(null,1,"",l));const[o,r]=n,[a,i]=e.getMergeableContentHashes();let s=E();if(a!=o){const[n,o]=(yield A(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!m(o)){const[n,r]=(yield A(t,5,e.getMergeableRowHashes(o),l))[0];if(j(s,n),!m(r)){const n=(yield A(t,6,e.getMergeableCellHashes(r),l))[0];j(s,n)}}}return[s,i==r?E():(yield A(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==d||d(e)}})),x=q(e,(()=>Z(void 0,null,(function*(){const e=yield T();return!e||m(e[0][0])&&m(e[1][0])?void 0:e}))),((t,n)=>Z(void 0,null,(function*(){return n?w(null,b(),3,n):w(null,b(),2,e.getMergeableContentHashes())}))),(e=>y=e),(()=>y=void 0),d,2,((e,t)=>{for(var n in t||(t={}))W.call(t,n)&&Y(e,n,t[n]);if(Q)for(var n of Q(t))X.call(t,n)&&Y(e,n,t[n]);return e})({startSync:e=>Z(void 0,null,(function*(){return g=1,yield(yield x.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(g=0,x.stopAutoLoad().stopAutoSave()),destroy:()=>(r(),x.stopSync()),getSynchronizerStats:()=>({sends:f,receives:p})},v),1);return o(((t,n,l,o)=>{const r=g||x.isAutoLoading();p++,null==c||c(t,n,l,o),0==l?a(P(h,n),(([e,n])=>u(e)||e==t?n(o,t):0)):2==l&&r?T(t,o,null!=n?n:void 0).then((e=>{null==y||y(void 0,e)})).catch(d):3==l&&r?null==y||y(void 0,o):a(1==l&&(g||x.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{w(t,n,0,e)}))})),x})(e,((e,t,n,o)=>l((()=>{var l,r;return u(e)?(r=(e,l)=>e!=i?l(i,t,n,o):0,A(_,((e,t)=>r(t,e)))):null==(l=P(_,e))?void 0:l(i,t,n,o)}))),(e=>{L(_,i,e)}),(()=>{C(_,i)}),.01,n,o,r)};export{ee as createLocalSynchronizer};
