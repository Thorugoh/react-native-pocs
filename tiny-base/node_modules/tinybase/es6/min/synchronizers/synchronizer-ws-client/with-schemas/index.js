const e="",t=(e,t="",n)=>e.split(t,n),n=Promise,l=globalThis,r=Math,o=r.floor,a=e=>null==e,i=(e,t,n)=>a(e)?null==n?void 0:n():t(e),u=e=>Array.isArray(e),s=(e,t,n)=>e.slice(t,n),c=e=>e.length,d=e=>new n(e),v=e=>{throw Error(e)},y=(e,t)=>e.forEach(t),g=(e,...t)=>e.push(...t),f=e=>e.shift(),p=Object,h=e=>p.getPrototypeOf(e),b=p.entries,S=p.keys,m=p.freeze,w=(e,t)=>y(b(e),(([e,n])=>t(n,e))),M=e=>(e=>!a(e)&&i(h(e),(e=>e==p.prototype||a(h(e))),(()=>!0)))(e)&&0==(e=>c(S(e)))(e),O=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),A=JSON.stringify,C=JSON.parse,P=e=>a(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),L=(e,t)=>null==e?void 0:e.forEach(t),j=(e,t)=>null==e?void 0:e.delete(t),E=e=>new Map(e),x=(e,t)=>null==e?void 0:e.get(t),T=(e,t,n)=>a(n)?(j(e,t),e):null==e?void 0:e.set(t,n),H=(e,t,n,l)=>{var r,o,a;return o=t,null!=(a=null==(r=e)?void 0:r.has(o))&&a?null==l||l(x(e,t)):T(e,t,n()),x(e,t)},D=(e,t,n,l,r=0)=>i((n?H:x)(e,t[r],r>c(t)-2?n:E),(o=>{if(r>c(t)-2)return(null==l?void 0:l(o))&&T(e,t[r]),o;const a=D(o,t,n,l,r+1);return P(o)&&T(e,t[r]),a})),N=(e,t)=>t?[e,t]:[e],z=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},R=(e="")=>N(((e=[])=>p.fromEntries(e))(),e),V=e=>new Set(u(e)||a(e)?e:[e]),k=/^\d+$/;var I=Object.defineProperty,J=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable,U=(e,t,n)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,W=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},a=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);i((n=n.apply(e,t)).next())}));const q=E(),B=E(),G=(t,n,l,r,o,s,d,p={},h=0,b=[])=>{let S,w,O,A=0,C=0,N=0;H(q,b,(()=>0)),H(B,b,(()=>[]));const z=E(),[R,I,G,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!M(e)||!M(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!M(e)||!M(t),t.setContent]:v("Store type not supported by this Persister"))(d,t,h),[X,Y,Z]=(()=>{let t;const[n,l]=(()=>{const t=[];let n=0;return[l=>{var r;return null!=(r=l?f(t):null)?r:e+n++},e=>{k.test(e)&&c(t)<1e3&&g(t,e)}]})(),r=E();return[(l,o,a,i=[],u=()=>[])=>{null!=t||(t=ae);const s=n(1);var c,d;return T(r,s,[l,o,a,i,u]),d=s,null==(c=D(o,null!=a?a:[e],V))||c.add(d),s},(n,l,...o)=>y(((t,n=[e])=>{const l=[],r=(e,t)=>t==c(n)?g(l,e):null===n[t]?L(e,(e=>r(e,t+1))):y([n[t],null],(n=>r(x(e,n),t+1)));return r(t,0),l})(n,l),(e=>L(e,(e=>x(r,e)[0](t,...null!=l?l:[],...o))))),t=>i(x(r,t),(([,n,o])=>(D(n,null!=o?o:[e],void 0,(e=>(j(e,t),P(e)?1:0))),T(r,t),l(t),o))),e=>i(x(r,e),(([e,,n=[],l,r])=>{const o=(...i)=>{var u,s;const d=c(i);d==c(n)?e(t,...i,...r(i)):a(n[d])?y(null!=(s=null==(u=l[d])?void 0:u.call(l,...i))?s:[],(e=>o(...i,e))):o(...i,n[d])};o()}))]})(),_=e=>{e!=A&&(A=e,Y(z,void 0,A))},ee=e=>{(R&&u(null==e?void 0:e[0])?1===(null==e?void 0:e[2])?t.applyMergeableChanges:t.setMergeableContent:1===(null==e?void 0:e[2])?t.applyChanges:t.setContent)(e)},te=e=>W(void 0,null,(function*(){return 2!=A&&(_(1),C++,yield oe((()=>W(void 0,null,(function*(){try{const t=yield n();u(t)?ee(t):e?Q(e):v("Content is not an array: "+t)}catch(t){null==s||s(t),e&&Q(e)}_(0)}))))),ae})),ne=()=>(w&&(o(w),w=void 0),ae),le=e=>W(void 0,null,(function*(){return 1!=A&&(_(2),N++,yield oe((()=>W(void 0,null,(function*(){try{yield l(I,e)}catch(e){null==s||s(e)}_(0)}))))),ae})),re=()=>(O&&(t.delListener(O),O=void 0),ae),oe=(...e)=>W(void 0,null,(function*(){return g(x(B,b),...e),yield W(void 0,null,(function*(){if(!x(q,b)){for(T(q,b,1);!a(S=f(x(B,b)));)try{yield S()}catch(e){null==s||s(e)}T(q,b,0)}})),ae})),ae=((e,t)=>{for(var n in t||(t={}))$.call(t,n)&&U(e,n,t[n]);if(J)for(var n of J(t))F.call(t,n)&&U(e,n,t[n]);return e})({load:te,startAutoLoad:e=>W(void 0,null,(function*(){ne(),yield te(e);try{w=yield r(((e,t)=>W(void 0,null,(function*(){t||e?2!=A&&(_(1),C++,ee(null!=t?t:e),_(0)):yield te()}))))}catch(e){null==s||s(e)}return ae})),stopAutoLoad:ne,isAutoLoading:()=>!a(w),save:le,startAutoSave:()=>W(void 0,null,(function*(){return re(),yield le(),O=t.addDidFinishTransactionListener((()=>{const e=G();K(e)&&le(e)})),ae})),stopAutoSave:re,isAutoSaving:()=>!a(O),getStatus:()=>A,addStatusListener:e=>X(e,z),delListener:e=>(Z(e),t),schedule:oe,getStore:()=>t,destroy:()=>(x(B,b).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:C,saves:N})},p);return m(ae)},K=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),Q=l.crypto?e=>l.crypto.getRandomValues(e):e=>(e=>e.map((()=>o(256*r.random()))))(e),X=(e=16)=>{return t=(e,t)=>e+K[63&t],Q(new Uint8Array(e)).reduce(t,"");var t};var Y=Object.defineProperty,Z=Object.getOwnPropertySymbols,_=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable,te=(e,t,n)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ne=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},a=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,a);i((n=n.apply(e,t)).next())}));const le=(t,n,l=1,r,o,u)=>{return c=function*(){const c=(e,t)=>(n.addEventListener(e,t),()=>n.removeEventListener(e,t)),v=((t,n,l,r,o,u,s,c,v={})=>{let y,g=0,f=0,p=0;const h=E(),b=()=>X(11),S=(e,t,l,r)=>{f++,null==u||u(e,t,l,r),n(e,t,l,r)},m=(e,t,n,l)=>ne(void 0,null,(function*(){return d(((r,a)=>{const i=l+"."+X(4),u=((e,t=0)=>setTimeout(e,1e3*t))((()=>{j(h,i),a(`No response from ${null!=e?e:"anyone"} to ${i}, `+t)}),o);T(h,i,[e,(e,t)=>{clearTimeout(u),j(h,i),r([e,t,l])}]),S(e,i,t,n)}))})),A=(e,[t,n])=>{w(t,(([t,n],l)=>{const r=O(e[0],l,R);w(t,(([e,t],n)=>{const l=O(r[0],n,R);w(e,(([e,t],n)=>l[0][n]=N(e,t))),l[1]=z(l[1],t)})),r[1]=z(r[1],n)})),e[1]=z(e[1],n)},C=(...n)=>ne(void 0,[...n],(function*(n=null,l,r=b()){try{a(l)&&([l,n,r]=yield m(null,1,e,r));const[o,i]=l,[u,s]=t.getMergeableContentHashes();let c=R();if(u!=o){const[e,l]=(yield m(n,4,t.getMergeableTableHashes(),r))[0];if(c=e,!M(l)){const[e,o]=(yield m(n,5,t.getMergeableRowHashes(l),r))[0];if(A(c,e),!M(o)){const e=(yield m(n,6,t.getMergeableCellHashes(o),r))[0];A(c,e)}}}return[c,s==i?R():(yield m(n,7,t.getMergeableValueHashes(),r))[0],1]}catch(e){null==c||c(e)}})),P=G(t,(()=>ne(void 0,null,(function*(){const e=yield C();return!e||M(e[0][0])&&M(e[1][0])?void 0:e}))),((e,n)=>ne(void 0,null,(function*(){return n?S(null,b(),3,n):S(null,b(),2,t.getMergeableContentHashes())}))),(e=>y=e),(()=>y=void 0),c,2,((e,t)=>{for(var n in t||(t={}))_.call(t,n)&&te(e,n,t[n]);if(Z)for(var n of Z(t))ee.call(t,n)&&te(e,n,t[n]);return e})({startSync:e=>ne(void 0,null,(function*(){return g=1,yield(yield P.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(g=0,P.stopAutoLoad().stopAutoSave()),destroy:()=>(r(),P.stopSync()),getSynchronizerStats:()=>({sends:f,receives:p})},v),1);return l(((e,n,l,r)=>{const o=g||P.isAutoLoading();p++,null==s||s(e,n,l,r),0==l?i(x(h,n),(([t,n])=>a(t)||t==e?n(r,e):0)):2==l&&o?C(e,r,null!=n?n:void 0).then((e=>{null==y||y(void 0,e)})).catch(c):3==l&&o?null==y||y(void 0,r):i(1==l&&(g||P.isAutoSaving())?t.getMergeableContentHashes():4==l?t.getMergeableTableDiff(r):5==l?t.getMergeableRowDiff(r):6==l?t.getMergeableCellDiff(r):7==l?t.getMergeableValueDiff(r):void 0,(t=>{S(e,n,0,t)}))})),P})(t,((t,...l)=>n.send(((t,...n)=>{return l=null!=t?t:e,r=A(n,((e,t)=>void 0===t?"￼":t)),l+"\n"+r;var l,r})(t,...l))),(e=>c("message",(({data:t})=>((e,t)=>(e=>{const n=e.indexOf("\n");var l,r,o;-1!==n&&(l=s(e,0,n),r=s(e,n+1),t(l,...(o=r,C(o,((e,t)=>"￼"===t?void 0:t)))))})(e))(t.toString("utf8"),e)))),(()=>{n.close()}),l,r,o,u,{getWebSocket:()=>n});return d((e=>{if(n.readyState!=n.OPEN){const t=t=>{t&&(null==u||u(t)),n(),l(),e(v)},n=c("open",(()=>t())),l=c("error",t)}else e(v)}))},new Promise(((e,t)=>{var n=e=>{try{r(c.next(e))}catch(e){t(e)}},l=e=>{try{r(c.throw(e))}catch(e){t(e)}},r=t=>t.done?e(t.value):Promise.resolve(t.value).then(n,l);r((c=c.apply(void 0,null)).next())}));var c};export{le as createWsSynchronizer};
