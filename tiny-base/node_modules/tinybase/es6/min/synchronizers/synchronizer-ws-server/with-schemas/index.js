const e="",t="error",n=(e,t="",n)=>e.split(t,n),l=Promise,o=globalThis,r=Math,a=r.floor,i=e=>null==e,u=(e,t,n)=>i(e)?null==n?void 0:n():t(e),s=e=>Array.isArray(e),d=(e,t,n)=>e.slice(t,n),c=e=>e.length,v=e=>{throw Error(e)},y=(e,t)=>e.forEach(t),g=(e,t,n)=>e.reduce(t,n),f=(e,...t)=>e.push(...t),p=e=>e.shift(),h=Object,b=e=>h.getPrototypeOf(e),S=h.entries,m=h.keys,w=h.freeze,A=(e,t)=>y(S(e),(([e,n])=>t(n,e))),C=e=>(e=>!i(e)&&u(b(e),(e=>e==h.prototype||i(b(e))),(()=>!0)))(e)&&0==(e=>c(m(e)))(e),M=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),O=e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0},P=(L=O,e=>g(x(e),((e,t)=>e+L(t)),0));var L;const j=e=>i(e)||0==O(e),x=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},T=(e,t)=>null==e?void 0:e.forEach(t),H=(e,t)=>null==e?void 0:e.delete(t),D=e=>new Map(e),E=e=>{var t;return[...null!=(t=null==e?void 0:e.keys())?t:[]]},I=(e,t)=>null==e?void 0:e.get(t),k=(e,t,n)=>i(n)?(H(e,t),e):null==e?void 0:e.set(t,n),z=(e,t,n,l)=>{var o,r,a;return r=t,null!=(a=null==(o=e)?void 0:o.has(r))&&a?null==l||l(I(e,t)):k(e,t,n()),I(e,t)},N=(e,t,n,l,o=0)=>u((n?z:I)(e,t[o],o>c(t)-2?n:D),(r=>{if(o>c(t)-2)return(null==l?void 0:l(r))&&k(e,t[o]),r;const a=N(r,t,n,l,o+1);return j(r)&&k(e,t[o]),a})),R=JSON.stringify,V=JSON.parse,J=(e,t)=>{const n=e.indexOf("\n");-1!==n&&t(d(e,0,n),d(e,n+1))},$=(e,t)=>e+"\n"+t,F=(e,t)=>t?[e,t]:[e],U=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},W=(e="")=>F(((e=[])=>h.fromEntries(e))(),e),q=e=>new Set(s(e)||i(e)?e:[e]),B=/^\d+$/,G=t=>{let n;const[l,o]=(()=>{const t=[];let n=0;return[l=>{var o;return null!=(o=l?p(t):null)?o:e+n++},e=>{B.test(e)&&c(t)<1e3&&f(t,e)}]})(),r=D();return[(o,a,i,u=[],s=()=>[])=>{null!=n||(n=t());const d=l(1);var c,v;return k(r,d,[o,a,i,u,s]),v=d,null==(c=N(a,null!=i?i:[e],q))||c.add(v),d},(t,l,...o)=>y(((t,n=[e])=>{const l=[],o=(e,t)=>t==c(n)?f(l,e):null===n[t]?T(e,(e=>o(e,t+1))):y([n[t],null],(n=>o(I(e,n),t+1)));return o(t,0),l})(t,l),(e=>T(e,(e=>I(r,e)[0](n,...null!=l?l:[],...o))))),t=>u(I(r,t),(([,n,l])=>(N(n,null!=l?l:[e],void 0,(e=>(H(e,t),j(e)?1:0))),k(r,t),o(t),l))),e=>u(I(r,e),(([e,,t=[],l,o])=>{const r=(...a)=>{var u,s;const d=c(a);d==c(t)?e(n,...a,...o(a)):i(t[d])?y(null!=(s=null==(u=l[d])?void 0:u.call(l,...a))?s:[],(e=>r(...a,e))):r(...a,t[d])};r()}))]};var K=Object.defineProperty,Q=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,Z=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));const ee=D(),te=D(),ne=n("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),le=o.crypto?e=>o.crypto.getRandomValues(e):e=>(e=>e.map((()=>a(256*r.random()))))(e),oe=(e=16)=>g(le(new Uint8Array(e)),((e,t)=>e+ne[63&t]),"");var re=Object.defineProperty,ae=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,se=(e,t,n)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,de=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));var ce=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));const ve=/\/([^?]*)/,ye=(n,o,r)=>{const a=D(),d=D(),c=D(),g=D(),[h,b,S]=G((()=>x)),m=e=>{var t,n;null==(t=e[1])||t.destroy(),null==(n=e[2])||n.destroy()},L=(t,n,l)=>o=>J(o,((o,r)=>{var a,i,u;const s=$(t,r);var d;o===e?("S"!==t&&(null==(a=l[3])||a.call(l,s)),d=(e,n)=>e!==t?n.send(s):0,T(n,((e,t)=>d(t,e)))):"S"===o?null==(i=l[3])||i.call(l,s):null==(u=I(n,o))||u.send(s)}));n.on("connection",((n,h)=>{return u((S=h.url,O=ve,null==S?void 0:S.match(O)),(([,S])=>u(h.headers["sec-websocket-key"],(h=>ce(void 0,null,(function*(){const O=z(c,S,D),P=z(g,S,(()=>[0])),x=L(h,O,P);j(O)&&(b(a,void 0,S,1),yield((t,n,a)=>ce(void 0,null,(function*(){return u(yield null==o?void 0:o(n),(n=>{t[0]=1,t[1]=s(n)?n[0]:n;const o=L("S",a,t);t[2]=((t,n,o,r,a,d,c,y,g={})=>{let h,b=0,S=0,m=0;const O=D(),P=()=>oe(11),L=(e,t,l,o)=>{S++,n(e,t,l,o)},j=(e,t,n,o)=>de(void 0,null,(function*(){return new l(((l,r)=>{const i=o+"."+oe(4),u=((e,t=0)=>setTimeout(e,1e3*t))((()=>{H(O,i),r(`No response from ${null!=e?e:"anyone"} to ${i}, `+t)}),a);k(O,i,[e,(e,t)=>{clearTimeout(u),H(O,i),l([e,t,o])}]),L(e,i,t,n)}))})),x=(e,[t,n])=>{A(t,(([t,n],l)=>{const o=M(e[0],l,W);A(t,(([e,t],n)=>{const l=M(o[0],n,W);A(e,(([e,t],n)=>l[0][n]=F(e,t))),l[1]=U(l[1],t)})),o[1]=U(o[1],n)})),e[1]=U(e[1],n)},T=(...n)=>de(void 0,[...n],(function*(n=null,l,o=P()){try{i(l)&&([l,n,o]=yield j(null,1,e,o));const[r,a]=l,[u,s]=t.getMergeableContentHashes();let d=W();if(u!=r){const[e,l]=(yield j(n,4,t.getMergeableTableHashes(),o))[0];if(d=e,!C(l)){const[e,r]=(yield j(n,5,t.getMergeableRowHashes(l),o))[0];if(x(d,e),!C(r)){const e=(yield j(n,6,t.getMergeableCellHashes(r),o))[0];x(d,e)}}}return[d,s==a?W():(yield j(n,7,t.getMergeableValueHashes(),o))[0],1]}catch(e){null==y||y(e)}})),E=((e,t,n,l,o,r,a,u={},d=0,c=[])=>{let y,g,h,b=0,S=0,m=0;z(ee,c,(()=>0)),z(te,c,(()=>[]));const A=D(),[M,O,P,L,j]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!C(e)||!C(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!C(e)||!C(t),t.setContent]:v("Store type not supported by this Persister"))(a,e,d),[x,T,H]=G((()=>U)),E=e=>{e!=b&&(b=e,T(A,void 0,b))},N=t=>{(M&&s(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},R=e=>_(void 0,null,(function*(){return 2!=b&&(E(1),S++,yield F((()=>_(void 0,null,(function*(){try{const n=yield t();s(n)?N(n):e?j(e):v("Content is not an array: "+n)}catch(t){null==r||r(t),e&&j(e)}E(0)}))))),U})),V=()=>(g&&(o(g),g=void 0),U),J=e=>_(void 0,null,(function*(){return 1!=b&&(E(2),m++,yield F((()=>_(void 0,null,(function*(){try{yield n(O,e)}catch(e){null==r||r(e)}E(0)}))))),U})),$=()=>(h&&(e.delListener(h),h=void 0),U),F=(...e)=>_(void 0,null,(function*(){return f(I(te,c),...e),yield _(void 0,null,(function*(){if(!I(ee,c)){for(k(ee,c,1);!i(y=p(I(te,c)));)try{yield y()}catch(e){null==r||r(e)}k(ee,c,0)}})),U})),U=((e,t)=>{for(var n in t||(t={}))X.call(t,n)&&Z(e,n,t[n]);if(Q)for(var n of Q(t))Y.call(t,n)&&Z(e,n,t[n]);return e})({load:R,startAutoLoad:e=>_(void 0,null,(function*(){V(),yield R(e);try{g=yield l(((e,t)=>_(void 0,null,(function*(){t||e?2!=b&&(E(1),S++,N(null!=t?t:e),E(0)):yield R()}))))}catch(e){null==r||r(e)}return U})),stopAutoLoad:V,isAutoLoading:()=>!i(g),save:J,startAutoSave:()=>_(void 0,null,(function*(){return $(),yield J(),h=e.addDidFinishTransactionListener((()=>{const e=P();L(e)&&J(e)})),U})),stopAutoSave:$,isAutoSaving:()=>!i(h),getStatus:()=>b,addStatusListener:e=>x(e,A),delListener:t=>(H(t),e),schedule:F,getStore:()=>e,destroy:()=>(I(te,c).splice(0,void 0),V().stopAutoSave()),getStats:()=>({loads:S,saves:m})},u);return w(U)})(t,(()=>de(void 0,null,(function*(){const e=yield T();return!e||C(e[0][0])&&C(e[1][0])?void 0:e}))),((e,n)=>de(void 0,null,(function*(){return n?L(null,P(),3,n):L(null,P(),2,t.getMergeableContentHashes())}))),(e=>h=e),(()=>h=void 0),y,2,((e,t)=>{for(var n in t||(t={}))ie.call(t,n)&&se(e,n,t[n]);if(ae)for(var n of ae(t))ue.call(t,n)&&se(e,n,t[n]);return e})({startSync:e=>de(void 0,null,(function*(){return b=1,yield(yield E.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(b=0,E.stopAutoLoad().stopAutoSave()),destroy:()=>E.stopSync(),getSynchronizerStats:()=>({sends:S,receives:m})},g),1);return o(((e,n,l,o)=>{const r=b||E.isAutoLoading();m++,0==l?u(I(O,n),(([t,n])=>i(t)||t==e?n(o,e):0)):2==l&&r?T(e,o,null!=n?n:void 0).then((e=>{null==h||h(void 0,e)})).catch(y):3==l&&r?null==h||h(void 0,o):u(1==l&&(b||E.isAutoSaving())?t.getMergeableContentHashes():4==l?t.getMergeableTableDiff(o):5==l?t.getMergeableRowDiff(o):6==l?t.getMergeableCellDiff(o):7==l?t.getMergeableValueDiff(o):void 0,(t=>{L(e,n,0,t)}))})),E})(t[1].getStore(),((t,n,l,r)=>o(((t,...n)=>$(null!=t?t:e,R(n,((e,t)=>void 0===t?"￼":t))))(t,n,l,r))),(e=>t[3]=t=>((e,t)=>J(e,((e,n)=>{return t(e,...(l=n,V(l,((e,t)=>"￼"===t?void 0:t))));var l})))(t,e)),0,1,0,0,r),t[4]=[],t[5]=s(n)?n[1]:e=>0}))})))(P,S,O)),k(O,h,n),b(d,[S],h,1),n.on("message",(e=>{const t=e.toString("utf8");0==P[0]?x(t):f(P[4],t)})),1==P[0]&&(yield(e=>ce(void 0,null,(function*(){e[0]=2,yield e[1].schedule(e[1].startAutoLoad,e[1].startAutoSave,e[2].startSync),e[5](e[1].getStore()),e[0]=0})))(P),y(P[4],x),P[4]=[]),n.on("close",(()=>{H(O,h),b(d,[S],h,-1),j(O)&&(m(P),H(g,S),H(c,S),b(a,void 0,S,-1))})),r&&n.on(t,r)}))))));var S,O})),r&&n.on(t,r);const x={getWebSocketServer:()=>n,getPathIds:()=>E(c),getClientIds:e=>E(I(c,e)),addPathIdsListener:e=>h(e,a),addClientIdsListener:(e,t)=>h(t,d,[e]),delListener:e=>(S(e),x),getStats:()=>({paths:O(c),clients:P(c)}),destroy:()=>{c.clear(),T(g,m),n.close()}};return w(x)};export{ye as createWsServer};
