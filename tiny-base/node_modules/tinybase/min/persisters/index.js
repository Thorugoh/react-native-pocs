const a=a=>typeof a,t="tinybase",e="",n=",",s=a(e),i=Promise,r=clearInterval,o=a=>null==a,c=(a,t,e)=>o(a)?e?.():t(a),l=t=>a(t)==s,E=a=>Array.isArray(a),w=(a,t,e)=>a.slice(t,e),y=a=>a.length,d=async a=>i.all(a),u=a=>{throw Error(a)},R=(a,t)=>a.forEach(t),A=(a,t="")=>a.join(t),T=(a,t)=>a.map(t),N=a=>0==y(a),g=(a,t)=>a.filter(t),O=(a,...t)=>a.push(...t),$=a=>a.shift(),p=Object,m=a=>p.getPrototypeOf(a),v=p.entries,C=p.keys,L=p.freeze,I=(a=[])=>p.fromEntries(a),S=(...a)=>p.assign({},...a),_=(a,t)=>(delete a[t],a),h=(a,t)=>T(v(a),(([a,e])=>t(e,a))),b=(a,t)=>I(h(a,((a,e)=>[e,t(a,e)]))),f=a=>p.values(a),D=a=>y(C(a)),M=a=>(a=>!o(a)&&c(m(a),(a=>a==p.prototype||o(m(a))),(()=>!0)))(a)&&0==D(a),P=(a,t)=>a?.has(t)??!1,F=a=>o(a)||0==(a=>a?.size??0)(a),U=a=>[...a?.values()??[]],G=(a,t)=>a?.forEach(t),B=(a,t)=>a?.delete(t),j=a=>new Map(a),Y=(a,t)=>a?.get(t),x=(a,t)=>T([...a?.entries()??[]],(([a,e])=>t(e,a))),H=(a,t,e)=>o(e)?(B(a,t),a):a?.set(t,e),X=(a,t,e,n)=>(P(a,t)?n?.(Y(a,t)):H(a,t,e()),Y(a,t)),J=(a,t,e,n,s=0)=>c((e?X:Y)(a,t[s],s>y(t)-2?e:j),(i=>{if(s>y(t)-2)return n?.(i)&&H(a,t[s]),i;const r=J(i,t,e,n,s+1);return F(i)&&H(a,t[s]),r})),W=a=>new Set(E(a)||o(a)?a:[a]),k=(a,t)=>a?.add(t),q=/^\d+$/,z={Idle:0,Loading:1,Saving:2},K={StoreOnly:1,MergeableStoreOnly:2,StoreOrMergeableStore:3},V=j(),Q=j(),Z=(a,t,n,s,i,r,l,w={},d=0,A=[])=>{let T,N,g,p=0,m=0,v=0;X(V,A,(()=>0)),X(Q,A,(()=>[]));const C=j(),[I,S,_,h,b]=((a=1,t,e)=>1!=a&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!e),([[a],[t]])=>!M(a)||!M(t),t.setDefaultContent]:2!=a?[0,t.getContent,t.getTransactionChanges,([a,t])=>!M(a)||!M(t),t.setContent]:u("Store type not supported by this Persister"))(l,a,d),[f,D,P]=(()=>{let a;const[t,n]=(()=>{const a=[];let t=0;return[n=>(n?$(a):null)??e+t++,t=>{q.test(t)&&y(a)<1e3&&O(a,t)}]})(),s=j();return[(n,i,r,o=[],c=()=>[])=>{a??=ea;const l=t(1);return H(s,l,[n,i,r,o,c]),k(J(i,r??[e],W),l),l},(t,n,...i)=>R(((a,t=[e])=>{const n=[],s=(a,e)=>e==y(t)?O(n,a):null===t[e]?G(a,(a=>s(a,e+1))):R([t[e],null],(t=>s(Y(a,t),e+1)));return s(a,0),n})(t,n),(t=>G(t,(t=>Y(s,t)[0](a,...n??[],...i))))),a=>c(Y(s,a),(([,t,i])=>(J(t,i??[e],void 0,(t=>(B(t,a),F(t)?1:0))),H(s,a),n(a),i))),t=>c(Y(s,t),(([t,,e=[],n,s])=>{const i=(...r)=>{const c=y(r);c==y(e)?t(a,...r,...s(r)):o(e[c])?R(n[c]?.(...r)??[],(a=>i(...r,a))):i(...r,e[c])};i()}))]})(),U=a=>{a!=p&&(p=a,D(C,void 0,p))},x=t=>{(I&&E(t?.[0])?1===t?.[2]?a.applyMergeableChanges:a.setMergeableContent:1===t?.[2]?a.applyChanges:a.setContent)(t)},z=async a=>(2!=p&&(U(1),m++,await ta((async()=>{try{const e=await t();E(e)?x(e):a?b(a):u("Content is not an array: "+e)}catch(t){r?.(t),a&&b(a)}U(0)}))),ea),K=()=>(N&&(i(N),N=void 0),ea),Z=async a=>(1!=p&&(U(2),v++,await ta((async()=>{try{await n(S,a)}catch(a){r?.(a)}U(0)}))),ea),aa=()=>(g&&(a.delListener(g),g=void 0),ea),ta=async(...a)=>(O(Y(Q,A),...a),await(async()=>{if(!Y(V,A)){for(H(V,A,1);!o(T=$(Y(Q,A)));)try{await T()}catch(a){r?.(a)}H(V,A,0)}})(),ea),ea={load:z,startAutoLoad:async a=>{K(),await z(a);try{N=await s((async(a,t)=>{t||a?2!=p&&(U(1),m++,x(t??a),U(0)):await z()}))}catch(a){r?.(a)}return ea},stopAutoLoad:K,isAutoLoading:()=>!o(N),save:Z,startAutoSave:async()=>(aa(),await Z(),g=a.addDidFinishTransactionListener((()=>{const a=_();h(a)&&Z(a)})),ea),stopAutoSave:aa,isAutoSaving:()=>!o(g),getStatus:()=>p,addStatusListener:a=>f(a,C),delListener:t=>(P(t),a),schedule:ta,getStore:()=>a,destroy:()=>(Y(Q,A).splice(0,void 0),K().stopAutoSave()),getStats:()=>({loads:m,saves:v}),...w};return L(ea)},aa="_",ta="_id",ea="SELECT",na="WHERE",sa="TABLE",ia="ALTER "+sa,ra="DELETE FROM",oa=ea+"*FROM",ca="pragma_",la="data_version",Ea="schema_version",wa="pragma_table_",ya=(a,t)=>t?async(e,n)=>(t(e,n),await a(e,n)):a,da=a=>`"${a.replace(/"/g,'""')}"`,ua=(a,t=[1])=>A(T(a,(()=>"$"+t[0]++)),n),Ra=JSON.stringify,Aa=JSON.parse,Ta=(a,t,e,s,i,r=Na,c,l)=>{const E=j();return[async()=>{E.clear(),T(await e(a,t),(({tn:a,cn:t})=>k(X(E,a,W),t)))},async(t,e)=>((a,t)=>P(Y(E,a),t))(t,e)?I(g(T(await a(oa+da(t)),(a=>[a[e],l?b(_(a,e),l):_(a,e)])),(([a,t])=>!o(a)&&!M(t)))):{},async(t,e,s,l,w,y=!1)=>{const u=W();b(s??{},(a=>T(C(a??{}),(a=>k(u,a)))));const R=U(u);if(!y&&w&&N(R)&&P(E,t))return await a("DROP "+sa+da(t)),void H(E,t);const $=Y(E,t),p=W(U($));if(N(R)||(P(E,t)?await d(T([e,...R],(async(n,s)=>{B(p,n)||(await a(ia+da(t)+"ADD"+da(n)+i),0==s&&await a("CREATE UNIQUE INDEX pk ON "+da(t)+`(${da(e)})`),k($,n))}))):(await a("CREATE "+sa+da(t)+`(${da(e)}${i} PRIMARY KEY${A(T(R,(a=>n+da(a)+i)))});`),H(E,t,W([e,...R])))),await d([...!y&&l?T(U(p),(async n=>{n!=e&&(await a(ia+da(t)+"DROP"+da(n)),B($,n))})):[]]),y)o(s)?await a(ra+da(t)+na+" true"):await d(h(s,(async(n,s)=>{o(n)?await a(ra+da(t)+na+da(e)+"=$1",[s]):N(R)||await r(a,t,e,C(n),{[s]:c?T(f(n),c):f(n)},$)})));else if(N(R))P(E,t)&&await a(ra+da(t)+na+" true");else{const n=g(U(Y(E,t)),(a=>a!=e)),i={},o=[];b(s??{},((a,t)=>{i[t]=T(n,(t=>c?c(a?.[t]):a?.[t])),O(o,t)})),await r(a,t,e,n,i),await a(ra+da(t)+na+da(e)+`NOT IN(${ua(o)})`,o)}},async t=>{let e;await a("BEGIN");try{e=await t()}catch(a){s?.(a)}return await a("END"),e}]},Na=async(a,t,e,s,i)=>{const r=[1];await a("INSERT INTO"+da(t)+"("+((...a)=>A(T(a,da),n))(e,...s)+")VALUES"+A(h(i,(a=>"($"+r[0]+++","+ua(a,r)+")")),n)+"ON CONFLICT("+da(e)+")DO UPDATE SET"+A(T(s,(a=>da(a)+"=excluded."+da(a))),n),h(i,((a,t)=>[t,...T(a,(a=>a??null))])).flat())},ga=(a,t,e,n,s,i,r,[o,c,l],E,w,y,d,u,R)=>{const[A,T,N,g]=Ta(t,E,w,s,u,R),O=Z(a,(async()=>await g((async()=>{return await A(),a=(await T(o,c))[aa]?.[l]??"null",Aa(a,((a,t)=>"ï¿¼"===t?void 0:t));var a}))),(async a=>await g((async()=>{var t;await A(),await N(o,c,{[aa]:{[l]:(t=a()??null,Ra(t,((a,t)=>void 0===t?"ï¿¼":t)))}},!0,!0)}))),e,n,s,r,{[d]:()=>y,destroy:()=>(O.stopAutoLoad().stopAutoSave(),i(),O)},0,y);return O},Oa=(a,t,e,n,s,i,r,[c,l,[E,w,y]],u,R,A,T,N,O,$,p)=>{const[m,v,C,L]=Ta(t,u,R,s,N,O,$,p),S=async(a,t)=>await d(x(l,(async([e,n,s,i],r)=>{t&&!(r in a)||await C(e,n,a[r],s,i,t)}))),_=async(a,t)=>w?await C(y,ta,{[aa]:a},!0,!0,t):null,h=Z(a,(async()=>await L((async()=>{await m();const a=await(async()=>I(g(await d(x(c,(async([a,t],e)=>[a,await v(e,t)]))),(a=>!M(a[1])))))(),t=await(async()=>E?(await v(y,ta))[aa]:{})();return M(a)&&o(t)?void 0:[a,t]}))),(async(a,t)=>await L((async()=>{if(await m(),o(t)){const[t,e]=a();await S(t),await _(e)}else await S(t[0],!0),await _(t[1],!0)}))),e,n,s,r,{[T]:()=>A,destroy:()=>(h.stopAutoLoad().stopAutoSave(),i(),h)},0,A);return h},$a="ColumnName",pa="store",ma="json",va=pa+"TableName",Ca=pa+"Id"+$a,La=pa+$a,Ia="autoLoadIntervalSeconds",Sa="rowId"+$a,_a="tableId",ha="tableName",ba="deleteEmptyColumns",fa="deleteEmptyTable",Da={mode:ma,[Ia]:1},Ma={load:0,save:0,[ha]:t+"_values"},Pa=(a,t,e,n,s)=>{const i=j();return b(a,((a,r)=>{const c=w(f(S(t,l(a)?{[e]:a}:a)),0,D(t));o(c[0])||n(r,c[0])||(s(r,c[0]),H(i,r,c))})),i},Fa=a=>{const e=(a=>S(Da,l(a)?{[va]:a}:a??{}))(a),n=e[Ia];if(e.mode==ma){const a=e[va]??t;return[1,n,[a,e[Ca]??ta,e[La]??pa],W(a)]}const{tables:{load:s={},save:i={}}={},values:r={}}=e,o=w(f(S(Ma,r)),0,D(Ma)),c=o[2],E=W(c),y=W(c);return[0,n,[Pa(s,{[_a]:null,[Sa]:ta},_a,(a=>P(y,a)),(a=>k(E,a))),Pa(i,{[ha]:null,[Sa]:ta,[ba]:0,[fa]:0},ha,((a,t)=>P(y,t)),((a,t)=>k(E,t))),o],E]},Ua=(a,t,n,s,i,o,c,l,E,w,y="getDb",d)=>{let u,R,A;const T=ya(n,o),[N,g,O,$]=Fa(t);return(N?ga:Oa)(a,T,(a=>{let t;const e=()=>t=setInterval((async()=>{try{const[{d:t,s:e,c:n}]=await T(`${ea} ${la} d,${Ea} s,TOTAL_CHANGES() c FROM ${ca}${la} JOIN ${ca}${Ea}`);t==u&&e==R&&n==A||(null!=u&&a(),u=t,R=e,A=n)}catch{}}),1e3*g),n=()=>{u=R=A=null,r(t)},o=s((t=>{$.has(t)&&(n(),a(),e())}));return e(),()=>{n(),i(o)}}),(a=>a()),c,l,E,O,U($),(async(a,t)=>await a(`${ea} t.name tn,c.name cn FROM ${wa}list()t,${wa}info(t.name)c ${na} t.schema='main'AND t.type IN('table','view')AND t.name IN(${ua(t)})ORDER BY t.name,c.name`,t)),w,y,e,d,(a=>!0===a?1:!1===a?0:a),void 0)},Ga=t,Ba=/^([cd]:)(.+)/,ja=t+"_data",Ya=t+"_table",xa=(a,t,e,n,s,i,r,o,l,E,w="getDb")=>{const y=ya(e,i),[u,,R,A]=Fa(t),N=async a=>{await y(`CREATE OR REPLACE TRIGGER ${da(ja+"_"+a)} AFTER INSERT OR UPDATE OR DELETE ON ${da(a)} EXECUTE FUNCTION ${ja}()`)};return(u?ga:Oa)(a,y,(async a=>{await y(`CREATE OR REPLACE FUNCTION ${Ya}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${Ga}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{await y(`CREATE EVENT TRIGGER ${Ya} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${Ya}();`)}catch{}return await y(`CREATE OR REPLACE FUNCTION ${ja}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${Ga}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),await d(T(U(A),(async a=>{await y(`CREATE TABLE IF NOT EXISTS ${da(a)}("_id"text PRIMARY KEY)`),await N(a)}))),await n(Ga,(async t=>{return await c((e=t,n=Ba,e?.match(n)),(async([,t,e])=>{P(A,e)&&("c:"==t&&await N(e),a())}));var e,n}))}),s,r,o,l,R,U(A),(async(a,t)=>await a(`${ea} table_name tn,column_name cn FROM information_schema.columns ${na} table_schema='public'AND table_name IN(${ua(t)})`,t)),E,w,"text",void 0,(a=>Ra(a)),(a=>Aa(a)))};export{K as Persists,z as Status,Z as createCustomPersister,xa as createCustomPostgreSqlPersister,Ua as createCustomSqlitePersister};
