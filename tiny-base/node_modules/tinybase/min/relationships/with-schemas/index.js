const e=e=>typeof e,t="",n=e(t),r=e=>null==e,s=(e,t,n)=>r(e)?n?.():t(e),o=e=>Array.isArray(e),a=e=>e.length,i=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),l=Object.freeze,c=e=>t=>{return n=(t,n)=>t+e(n),L(t).reduce(n,0);var n},u=e=>e?.size??0,R=c(u),h=c(R),w=(e,t)=>e?.has(t)??!1,f=e=>r(e)||0==u(e),L=e=>[...e?.values()??[]],I=e=>e.clear(),g=(e,t)=>e?.forEach(t),p=(e,t)=>e?.delete(t),v=e=>new Map(e),y=(e,t)=>e?.get(t),b=(e,t)=>g(e,((e,n)=>t(n,e))),k=(e,t,n)=>r(n)?(p(e,t),e):e?.set(t,n),m=(e,t,n,r)=>(w(e,t)?r?.(y(e,t)):k(e,t,n()),y(e,t)),E=(e,t,n,r,o=0)=>s((n?m:y)(e,t[o],o>a(t)-2?n:v),(s=>{if(o>a(t)-2)return r?.(s)&&k(e,t[o]),s;const i=E(s,t,n,r,o+1);return f(s)&&k(e,t[o]),i})),T=e=>new Set(o(e)||r(e)?e:[e]),S=(e,t)=>e?.add(t),z=/^\d+$/,A=(()=>{const c=new WeakMap;return u=>(c.has(u)||c.set(u,(c=>{const u=v(),R=v(),A=v(),D=v(),[M,j,x]=(()=>{let e;const[n,o]=(()=>{const e=[];let n=0;return[r=>(r?e.shift():null)??t+n++,t=>{z.test(t)&&a(e)<1e3&&d(e,t)}]})(),l=v();return[(r,s,o,a=[],i=()=>[])=>{e??=Q;const d=n(1);return k(l,d,[r,s,o,a,i]),S(E(s,o??[t],T),d),d},(n,r,...s)=>i(((e,n=[t])=>{const r=[],s=(e,t)=>t==a(n)?d(r,e):null===n[t]?g(e,(e=>s(e,t+1))):i([n[t],null],(n=>s(y(e,n),t+1)));return s(e,0),r})(n,r),(t=>g(t,(t=>y(l,t)[0](e,...r??[],...s))))),e=>s(y(l,e),(([,n,r])=>(E(n,r??[t],void 0,(t=>(p(t,e),f(t)?1:0))),k(l,e),o(e),r))),t=>s(y(l,t),(([t,,n=[],s,o])=>{const d=(...l)=>{const c=a(l);c==a(n)?t(e,...l,...o(l)):r(n[c])?i(s[c]?.(...l)??[],(e=>d(...l,e))):d(...l,n[c])};d()}))]})(),[C,O,W,$,q,B,,,F,G,H,J]=((e,n,d,l,c)=>{const u=e.hasRow,R=v(),h=v(),E=v(),z=v(),A=v(),D=v(),M=(t,n,...r)=>{const s=m(D,t,T);return i(r,(t=>S(s,t)&&n&&e.callListener(t))),r},j=(t,...n)=>s(y(D,t),(r=>{i(0==a(n)?L(r):n,(t=>{e.delListener(t),p(r,t)})),f(r)&&k(D,t)})),x=(e,t)=>{k(R,e,t),w(h,e)||(k(h,e,[v(),v(),v(),v()]),k(z,e,v()),k(A,e,v()),c(E))},C=e=>{k(R,e),k(h,e),k(z,e),k(A,e),j(e),c(E)};return[()=>e,()=>{return e=R,[...e?.keys()??[]];var e},e=>b(h,e),e=>w(h,e),e=>y(R,e),e=>y(h,e),(e,t)=>k(h,e,t),x,(n,s,d,l,c)=>{x(n,s);const R=v(),h=v(),f=y(z,n),L=y(A,n),p=n=>{const i=t=>e.getCell(s,n,t),d=y(f,n),w=u(s,n)?(I=l(i,n),r(I)?void 0:I+t):void 0;var I,g,p,v;if(d===w||o(d)&&o(w)&&(p=w,a(g=d)===a(p)&&(v=(e,t)=>p[t]===e,g.every(v)))||k(R,n,[d,w]),!r(c)){const e=y(L,n),t=u(s,n)?c(i,n):void 0;e!=t&&k(h,n,t)}},m=e=>{d((()=>{g(R,(([,e],t)=>k(f,t,e))),g(h,((e,t)=>k(L,t,e)))}),R,h,f,L,e),I(R),I(h)};b(f,p),e.hasTable(s)&&i(e.getRowIds(s),(e=>{w(f,e)||p(e)})),m(!0),j(n),M(n,0,e.addRowListener(s,null,((e,t,n)=>p(n))),e.addTableListener(s,(()=>m())))},C,e=>l(e,E),()=>b(D,C),M,j]})(c,0,0,M,j),K=(e,t,n)=>s(B(e),(([s,,o])=>{if(!w(o,t)){const a=T();if(q(e)!=P(e))S(a,t);else{let e=t;for(;!r(e)&&!w(a,e);)S(a,e),e=y(s,e)}if(n)return a;k(o,t,a)}return y(o,t)})),N=(e,t)=>s(B(e),(([,,e])=>k(e,t))),P=e=>y(u,e),Q={setRelationshipDefinition:(o,a,i,d)=>{return k(u,o,i),F(o,a,((e,t)=>{const n=T(),a=T(),i=T(),[d,l]=B(o);g(t,(([e,t],c)=>{r(e)||(S(a,e),s(y(l,e),(t=>{p(t,c),f(t)&&k(l,e)}))),r(t)||(S(a,t),w(l,t)||k(l,t,T()),S(y(l,t),c)),S(n,c),k(d,c,t),b(y(D,o),(e=>{w(K(o,e),c)&&S(i,e)}))})),e(),g(n,(e=>j(R,[o,e]))),g(a,(e=>j(A,[o,e]))),g(i,(e=>{N(o,e),j(D,[o,e])}))}),e(l=d)==n?e=>e(l):l??(()=>t)),Q;var l},delRelationshipDefinition:e=>(k(u,e),G(e),Q),getStore:C,getRelationshipIds:O,forEachRelationship:e=>W((t=>e(t,(e=>c.forEachRow(q(t),e))))),hasRelationship:$,getLocalTableId:q,getRemoteTableId:P,getRemoteRowId:(e,t)=>y(B(e)?.[0],t),getLocalRowIds:(e,t)=>L(y(B(e)?.[1],t)),getLinkedRowIds:(e,t)=>r(B(e))?[t]:L(K(e,t,!0)),addRelationshipIdsListener:H,addRemoteRowIdListener:(e,t,n)=>M(n,R,[e,t]),addLocalRowIdsListener:(e,t,n)=>M(n,A,[e,t]),addLinkedRowIdsListener:(e,t,n)=>(K(e,t),M(n,D,[e,t])),delListener:e=>(N(...x(e)??[]),Q),destroy:J,getListenerStats:()=>({remoteRowId:h(R),localRowIds:h(A),linkedRowIds:h(D)})};return l(Q)})(u)),c.get(u))})();export{A as createRelationships};
