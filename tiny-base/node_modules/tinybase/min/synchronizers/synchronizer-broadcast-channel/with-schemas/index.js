const t=(t,e="",a)=>t.split(e,a),e=Promise,a=globalThis,n=Math,s=n.floor,o=t=>null==t,r=(t,e,a)=>o(t)?a?.():e(t),i=t=>Array.isArray(t),c=t=>t.length,l=t=>{throw Error(t)},g=(t,e)=>t.forEach(e),u=(t,...e)=>t.push(...e),d=t=>t.shift(),y=Object,h=t=>y.getPrototypeOf(t),p=y.entries,w=y.keys,v=y.freeze,f=(t,e)=>g(p(t),(([t,a])=>e(a,t))),b=t=>(t=>!o(t)&&r(h(t),(t=>t==y.prototype||o(h(t))),(()=>!0)))(t)&&0==(t=>c(w(t)))(t),M=(t,e,a)=>(((t,e)=>e in t)(t,e)||(t[e]=a()),t[e]),C=t=>o(t)||0==(t=>t?.size??0)(t),S=(t,e)=>t?.forEach(e),A=(t,e)=>t?.delete(e),m=t=>new Map(t),L=(t,e)=>t?.get(e),T=(t,e,a)=>o(a)?(A(t,e),t):t?.set(e,a),H=(t,e,a,n)=>{var s,o;return s=t,o=e,s?.has(o)?n?.(L(t,e)):T(t,e,a()),L(t,e)},D=(t,e,a,n,s=0)=>r((a?H:L)(t,e[s],s>c(e)-2?a:m),(o=>{if(s>c(e)-2)return n?.(o)&&T(t,e[s]),o;const r=D(o,e,a,n,s+1);return C(o)&&T(t,e[s]),r})),E=(t,e)=>e?[t,e]:[t],z=(t,e)=>((t??"")>(e??"")?t:e)??"",P=(t="")=>E(((t=[])=>y.fromEntries(t))(),t),R=t=>new Set(i(t)||o(t)?t:[t]),V=/^\d+$/,N=m(),O=m(),$=(t,e,a,n,s,y,h,p={},w=0,f=[])=>{let M,E,z,P=0,$=0,j=0;H(N,f,(()=>0)),H(O,f,(()=>[]));const k=m(),[x,B,F,U,q]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!b(t)||!b(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!b(t)||!b(e),e.setContent]:l("Store type not supported by this Persister"))(h,t,w),[G,I,J]=(()=>{let t;const[e,a]=(()=>{const t=[];let e=0;return[a=>(a?d(t):null)??""+e++,e=>{V.test(e)&&c(t)<1e3&&u(t,e)}]})(),n=m();return[(a,s,o,r=[],i=()=>[])=>{t??=tt;const c=e(1);var l,g;return T(n,c,[a,s,o,r,i]),l=D(s,o??[""],R),g=c,l?.add(g),c},(e,a,...s)=>g(((t,e=[""])=>{const a=[],n=(t,s)=>s==c(e)?u(a,t):null===e[s]?S(t,(t=>n(t,s+1))):g([e[s],null],(e=>n(L(t,e),s+1)));return n(t,0),a})(e,a),(e=>S(e,(e=>L(n,e)[0](t,...a??[],...s))))),t=>r(L(n,t),(([,e,s])=>(D(e,s??[""],void 0,(e=>(A(e,t),C(e)?1:0))),T(n,t),a(t),s))),e=>r(L(n,e),(([e,,a=[],n,s])=>{const r=(...i)=>{const l=c(i);l==c(a)?e(t,...i,...s(i)):o(a[l])?g(n[l]?.(...i)??[],(t=>r(...i,t))):r(...i,a[l])};r()}))]})(),K=t=>{t!=P&&(P=t,I(k,void 0,P))},Q=e=>{(x&&i(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},W=async t=>(2!=P&&(K(1),$++,await _((async()=>{try{const a=await e();i(a)?Q(a):t?q(t):l("Content is not an array: "+a)}catch(e){y?.(e),t&&q(t)}K(0)}))),tt),X=()=>(E&&(s(E),E=void 0),tt),Y=async t=>(1!=P&&(K(2),j++,await _((async()=>{try{await a(B,t)}catch(t){y?.(t)}K(0)}))),tt),Z=()=>(z&&(t.delListener(z),z=void 0),tt),_=async(...t)=>(u(L(O,f),...t),await(async()=>{if(!L(N,f)){for(T(N,f,1);!o(M=d(L(O,f)));)try{await M()}catch(t){y?.(t)}T(N,f,0)}})(),tt),tt={load:W,startAutoLoad:async t=>{X(),await W(t);try{E=await n((async(t,e)=>{e||t?2!=P&&(K(1),$++,Q(e??t),K(0)):await W()}))}catch(t){y?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!o(E),save:Y,startAutoSave:async()=>(Z(),await Y(),z=t.addDidFinishTransactionListener((()=>{const t=F();U(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!o(z),getStatus:()=>P,addStatusListener:t=>G(t,k),delListener:e=>(J(e),t),schedule:_,getStore:()=>t,destroy:()=>(L(O,f).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:$,saves:j}),...p};return v(tt)},j=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),k=a.crypto?t=>a.crypto.getRandomValues(t):t=>(t=>t.map((()=>s(256*n.random()))))(t),x=(t=16)=>{return e=(t,e)=>t+j[63&e],k(new Uint8Array(t)).reduce(e,"");var e},B=(t,a,n,s,i)=>{const c=x(),l=new BroadcastChannel(a);return((t,a,n,s,i,c,l,g,u={})=>{let d,y=0,h=0,p=0;const w=m(),v=()=>x(11),C=(t,e,n,s)=>{h++,c?.(t,e,n,s),a(t,e,n,s)},S=async(t,a,n,s)=>new e(((e,o)=>{const r=s+"."+x(4),c=((t,e=0)=>setTimeout(t,1e3*e))((()=>{A(w,r),o(`No response from ${t??"anyone"} to ${r}, `+a)}),i);T(w,r,[t,(t,a)=>{clearTimeout(c),A(w,r),e([t,a,s])}]),C(t,r,a,n)})),H=(t,[e,a])=>{f(e,(([e,a],n)=>{const s=M(t[0],n,P);f(e,(([t,e],a)=>{const n=M(s[0],a,P);f(t,(([t,e],a)=>n[0][a]=E(t,e))),n[1]=z(n[1],e)})),s[1]=z(s[1],a)})),t[1]=z(t[1],a)},D=async(e=null,a,n=v())=>{try{o(a)&&([a,e,n]=await S(null,1,"",n));const[s,r]=a,[i,c]=t.getMergeableContentHashes();let l=P();if(i!=s){const[a,s]=(await S(e,4,t.getMergeableTableHashes(),n))[0];if(l=a,!b(s)){const[a,o]=(await S(e,5,t.getMergeableRowHashes(s),n))[0];if(H(l,a),!b(o)){const a=(await S(e,6,t.getMergeableCellHashes(o),n))[0];H(l,a)}}}return[l,c==r?P():(await S(e,7,t.getMergeableValueHashes(),n))[0],1]}catch(t){g?.(t)}},R=$(t,(async()=>{const t=await D();return!t||b(t[0][0])&&b(t[1][0])?void 0:t}),(async(e,a)=>a?C(null,v(),3,a):C(null,v(),2,t.getMergeableContentHashes())),(t=>d=t),(()=>d=void 0),g,2,{startSync:async t=>(y=1,await(await R.startAutoLoad(t)).startAutoSave()),stopSync:()=>(y=0,R.stopAutoLoad().stopAutoSave()),destroy:()=>(s(),R.stopSync()),getSynchronizerStats:()=>({sends:h,receives:p}),...u},1);return n(((e,a,n,s)=>{const i=y||R.isAutoLoading();p++,l?.(e,a,n,s),0==n?r(L(w,a),(([t,a])=>o(t)||t==e?a(s,e):0)):2==n&&i?D(e,s,a??void 0).then((t=>{d?.(void 0,t)})).catch(g):3==n&&i?d?.(void 0,s):r(1==n&&(y||R.isAutoSaving())?t.getMergeableContentHashes():4==n?t.getMergeableTableDiff(s):5==n?t.getMergeableRowDiff(s):6==n?t.getMergeableCellDiff(s):7==n?t.getMergeableValueDiff(s):void 0,(t=>{C(e,a,0,t)}))})),R})(t,((t,e,a,n)=>l.postMessage([c,t,e,a,n])),(t=>{l.onmessage=({data:[e,a,n,s,r]})=>o(a)||a==c?t(e,n,s,r):0}),(()=>{l.close()}),.01,n,s,i,{getChannelName:()=>a})};export{B as createBroadcastChannelSynchronizer};
