const t=(t,e="",a)=>t.split(e,a),e=Promise,a=globalThis,n=Math,s=n.floor,o=t=>null==t,r=(t,e,a)=>o(t)?a?.():e(t),i=t=>Array.isArray(t),l=t=>t.length,c=t=>{throw Error(t)},g=(t,e)=>t.forEach(e),u=(t,...e)=>t.push(...e),y=t=>t.shift(),d=Object,f=t=>d.getPrototypeOf(t),h=d.entries,p=d.keys,w=d.freeze,v=(t,e)=>g(h(t),(([t,a])=>e(a,t))),b=t=>(t=>!o(t)&&r(f(t),(t=>t==d.prototype||o(f(t))),(()=>!0)))(t)&&0==(t=>l(p(t)))(t),C=(t,e,a)=>(((t,e)=>e in t)(t,e)||(t[e]=a()),t[e]),M=t=>o(t)||0==(t=>t?.size??0)(t),S=(t,e)=>t?.forEach(e),A=(t,e)=>t?.delete(e),D=t=>new Map(t),L=(t,e)=>t?.get(e),H=(t,e,a)=>o(a)?(A(t,e),t):t?.set(e,a),T=(t,e,a,n)=>{var s,o;return s=t,o=e,s?.has(o)?n?.(L(t,e)):H(t,e,a()),L(t,e)},m=(t,e,a,n,s=0)=>r((a?T:L)(t,e[s],s>l(e)-2?a:D),(o=>{if(s>l(e)-2)return n?.(o)&&H(t,e[s]),o;const r=m(o,e,a,n,s+1);return M(o)&&H(t,e[s]),r})),G=(t,e)=>e?[t,e]:[t],R=(t,e)=>((t??"")>(e??"")?t:e)??"",E=(t="")=>G(((t=[])=>d.fromEntries(t))(),t),V=t=>new Set(i(t)||o(t)?t:[t]),z=/^\d+$/,P=D(),O=D(),$=(t,e,a,n,s,d,f,h={},p=0,v=[])=>{let C,G,R,E=0,$=0,j=0;T(P,v,(()=>0)),T(O,v,(()=>[]));const k=D(),[x,F,N,U,q]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!b(t)||!b(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!b(t)||!b(e),e.setContent]:c("Store type not supported by this Persister"))(f,t,p),[B,I,J]=(()=>{let t;const[e,a]=(()=>{const t=[];let e=0;return[a=>(a?y(t):null)??""+e++,e=>{z.test(e)&&l(t)<1e3&&u(t,e)}]})(),n=D();return[(a,s,o,r=[],i=()=>[])=>{t??=tt;const l=e(1);var c,g;return H(n,l,[a,s,o,r,i]),c=m(s,o??[""],V),g=l,c?.add(g),l},(e,a,...s)=>g(((t,e=[""])=>{const a=[],n=(t,s)=>s==l(e)?u(a,t):null===e[s]?S(t,(t=>n(t,s+1))):g([e[s],null],(e=>n(L(t,e),s+1)));return n(t,0),a})(e,a),(e=>S(e,(e=>L(n,e)[0](t,...a??[],...s))))),t=>r(L(n,t),(([,e,s])=>(m(e,s??[""],void 0,(e=>(A(e,t),M(e)?1:0))),H(n,t),a(t),s))),e=>r(L(n,e),(([e,,a=[],n,s])=>{const r=(...i)=>{const c=l(i);c==l(a)?e(t,...i,...s(i)):o(a[c])?g(n[c]?.(...i)??[],(t=>r(...i,t))):r(...i,a[c])};r()}))]})(),K=t=>{t!=E&&(E=t,I(k,void 0,E))},Q=e=>{(x&&i(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},W=async t=>(2!=E&&(K(1),$++,await _((async()=>{try{const a=await e();i(a)?Q(a):t?q(t):c("Content is not an array: "+a)}catch(e){d?.(e),t&&q(t)}K(0)}))),tt),X=()=>(G&&(s(G),G=void 0),tt),Y=async t=>(1!=E&&(K(2),j++,await _((async()=>{try{await a(F,t)}catch(t){d?.(t)}K(0)}))),tt),Z=()=>(R&&(t.delListener(R),R=void 0),tt),_=async(...t)=>(u(L(O,v),...t),await(async()=>{if(!L(P,v)){for(H(P,v,1);!o(C=y(L(O,v)));)try{await C()}catch(t){d?.(t)}H(P,v,0)}})(),tt),tt={load:W,startAutoLoad:async t=>{X(),await W(t);try{G=await n((async(t,e)=>{e||t?2!=E&&(K(1),$++,Q(e??t),K(0)):await W()}))}catch(t){d?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!o(G),save:Y,startAutoSave:async()=>(Z(),await Y(),R=t.addDidFinishTransactionListener((()=>{const t=N();U(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!o(R),getStatus:()=>E,addStatusListener:t=>B(t,k),delListener:e=>(J(e),t),schedule:_,getStore:()=>t,destroy:()=>(L(O,v).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:$,saves:j}),...h};return w(tt)},j=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),k=a.crypto?t=>a.crypto.getRandomValues(t):t=>(t=>t.map((()=>s(256*n.random()))))(t),x=(t=16)=>{return e=(t,e)=>t+j[63&e],k(new Uint8Array(t)).reduce(e,"");var e},F={Response:0,GetContentHashes:1,ContentHashes:2,ContentDiff:3,GetTableDiff:4,GetRowDiff:5,GetCellDiff:6,GetValueDiff:7},N=(t,a,n,s,i,l,c,g,u={})=>{let y,d=0,f=0,h=0;const p=D(),w=()=>x(11),M=(t,e,n,s)=>{f++,l?.(t,e,n,s),a(t,e,n,s)},S=async(t,a,n,s)=>new e(((e,o)=>{const r=s+"."+x(4),l=((t,e=0)=>setTimeout(t,1e3*e))((()=>{A(p,r),o(`No response from ${t??"anyone"} to ${r}, `+a)}),i);H(p,r,[t,(t,a)=>{clearTimeout(l),A(p,r),e([t,a,s])}]),M(t,r,a,n)})),T=(t,[e,a])=>{v(e,(([e,a],n)=>{const s=C(t[0],n,E);v(e,(([t,e],a)=>{const n=C(s[0],a,E);v(t,(([t,e],a)=>n[0][a]=G(t,e))),n[1]=R(n[1],e)})),s[1]=R(s[1],a)})),t[1]=R(t[1],a)},m=async(e=null,a,n=w())=>{try{o(a)&&([a,e,n]=await S(null,1,"",n));const[s,r]=a,[i,l]=t.getMergeableContentHashes();let c=E();if(i!=s){const[a,s]=(await S(e,4,t.getMergeableTableHashes(),n))[0];if(c=a,!b(s)){const[a,o]=(await S(e,5,t.getMergeableRowHashes(s),n))[0];if(T(c,a),!b(o)){const a=(await S(e,6,t.getMergeableCellHashes(o),n))[0];T(c,a)}}}return[c,l==r?E():(await S(e,7,t.getMergeableValueHashes(),n))[0],1]}catch(t){g?.(t)}},V=$(t,(async()=>{const t=await m();return!t||b(t[0][0])&&b(t[1][0])?void 0:t}),(async(e,a)=>a?M(null,w(),3,a):M(null,w(),2,t.getMergeableContentHashes())),(t=>y=t),(()=>y=void 0),g,2,{startSync:async t=>(d=1,await(await V.startAutoLoad(t)).startAutoSave()),stopSync:()=>(d=0,V.stopAutoLoad().stopAutoSave()),destroy:()=>(s(),V.stopSync()),getSynchronizerStats:()=>({sends:f,receives:h}),...u},1);return n(((e,a,n,s)=>{const i=d||V.isAutoLoading();h++,c?.(e,a,n,s),0==n?r(L(p,a),(([t,a])=>o(t)||t==e?a(s,e):0)):2==n&&i?m(e,s,a??void 0).then((t=>{y?.(void 0,t)})).catch(g):3==n&&i?y?.(void 0,s):r(1==n&&(d||V.isAutoSaving())?t.getMergeableContentHashes():4==n?t.getMergeableTableDiff(s):5==n?t.getMergeableRowDiff(s):6==n?t.getMergeableCellDiff(s):7==n?t.getMergeableValueDiff(s):void 0,(t=>{M(e,a,0,t)}))})),V};export{F as Message,N as createCustomSynchronizer};
