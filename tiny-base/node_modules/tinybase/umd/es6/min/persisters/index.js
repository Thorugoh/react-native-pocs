var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="tinybase",l="",o=",",r=t(l),i=Promise,u=clearInterval,d=e=>null==e,a=(e,t,n)=>d(e)?null==n?void 0:n():t(e),s=e=>t(e)==r,c=e=>Array.isArray(e),v=(e,t,n)=>e.slice(t,n),y=e=>e.length,E=e=>{return t=function*(){return i.all(e)},new Promise(((e,n)=>{var l=e=>{try{r(t.next(e))}catch(e){n(e)}},o=e=>{try{r(t.throw(e))}catch(e){n(e)}},r=t=>t.done?e(t.value):Promise.resolve(t.value).then(l,o);r((t=t.apply(void 0,null)).next())}));var t},f=e=>{throw Error(e)},p=(e,t)=>e.forEach(t),h=(e,t="")=>e.join(t),m=(e,t)=>e.map(t),T=e=>0==y(e),R=(e,t)=>e.filter(t),A=(e,...t)=>e.push(...t),N=e=>e.shift(),g=Object,O=e=>g.getPrototypeOf(e),P=g.entries,$=g.keys,C=g.freeze,b=(e=[])=>g.fromEntries(e),S=(...e)=>g.assign({},...e),I=(e,t)=>(delete e[t],e),L=(e,t)=>m(P(e),(([e,n])=>t(n,e))),_=(e,t)=>b(L(e,((e,n)=>[n,t(e,n)]))),w=e=>g.values(e),D=e=>y($(e)),x=e=>(e=>!d(e)&&a(O(e),(e=>e==g.prototype||d(O(e))),(()=>!0)))(e)&&0==D(e),M=(e,t)=>{var n;return null!=(n=null==e?void 0:e.has(t))&&n},F=e=>d(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),U=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},G=(e,t)=>null==e?void 0:e.forEach(t),j=(e,t)=>null==e?void 0:e.delete(t),B=e=>new Map(e),Y=(e,t)=>null==e?void 0:e.get(t),q=(e,t)=>{var n;return m([...null!=(n=null==e?void 0:e.entries())?n:[]],(([e,n])=>t(n,e)))},H=(e,t,n)=>d(n)?(j(e,t),e):null==e?void 0:e.set(t,n),X=(e,t,n,l)=>(M(e,t)?null==l||l(Y(e,t)):H(e,t,n()),Y(e,t)),J=(e,t,n,l,o=0)=>a((n?X:Y)(e,t[o],o>y(t)-2?n:B),(r=>{if(o>y(t)-2)return(null==l?void 0:l(r))&&H(e,t[o]),r;const i=J(r,t,n,l,o+1);return F(r)&&H(e,t[o]),i})),W=e=>new Set(c(e)||d(e)?e:[e]),k=(e,t)=>null==e?void 0:e.add(t),z=/^\d+$/;var K=Object.defineProperty,V=Object.getOwnPropertySymbols,Q=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable,ee=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,te=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const ne=B(),le=B(),oe=(e,t,n,o,r,i,u,s={},v=0,E=[])=>{let h,m,T,R=0,g=0,O=0;X(ne,E,(()=>0)),X(le,E,(()=>[]));const P=B(),[$,b,S,I,L]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!x(e)||!x(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!x(e)||!x(t),t.setContent]:f("Store type not supported by this Persister"))(u,e,v),[_,w,D]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var o;return null!=(o=n?N(e):null)?o:l+t++},t=>{z.test(t)&&y(e)<1e3&&A(e,t)}]})(),o=B();return[(n,r,i,u=[],d=()=>[])=>{null!=e||(e=ue);const a=t(1);return H(o,a,[n,r,i,u,d]),k(J(r,null!=i?i:[l],W),a),a},(t,n,...r)=>p(((e,t=[l])=>{const n=[],o=(e,l)=>l==y(t)?A(n,e):null===t[l]?G(e,(e=>o(e,l+1))):p([t[l],null],(t=>o(Y(e,t),l+1)));return o(e,0),n})(t,n),(t=>G(t,(t=>Y(o,t)[0](e,...null!=n?n:[],...r))))),e=>a(Y(o,e),(([,t,r])=>(J(t,null!=r?r:[l],void 0,(t=>(j(t,e),F(t)?1:0))),H(o,e),n(e),r))),t=>a(Y(o,t),(([t,,n=[],l,o])=>{const r=(...i)=>{var u,a;const s=y(i);s==y(n)?t(e,...i,...o(i)):d(n[s])?p(null!=(a=null==(u=l[s])?void 0:u.call(l,...i))?a:[],(e=>r(...i,e))):r(...i,n[s])};r()}))]})(),M=e=>{e!=R&&(R=e,w(P,void 0,R))},U=t=>{($&&c(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},q=e=>te(void 0,null,(function*(){return 2!=R&&(M(1),g++,yield ie((()=>te(void 0,null,(function*(){try{const n=yield t();c(n)?U(n):e?L(e):f("Content is not an array: "+n)}catch(t){null==i||i(t),e&&L(e)}M(0)}))))),ue})),K=()=>(m&&(r(m),m=void 0),ue),oe=e=>te(void 0,null,(function*(){return 1!=R&&(M(2),O++,yield ie((()=>te(void 0,null,(function*(){try{yield n(b,e)}catch(e){null==i||i(e)}M(0)}))))),ue})),re=()=>(T&&(e.delListener(T),T=void 0),ue),ie=(...e)=>te(void 0,null,(function*(){return A(Y(le,E),...e),yield te(void 0,null,(function*(){if(!Y(ne,E)){for(H(ne,E,1);!d(h=N(Y(le,E)));)try{yield h()}catch(e){null==i||i(e)}H(ne,E,0)}})),ue})),ue=((e,t)=>{for(var n in t||(t={}))Q.call(t,n)&&ee(e,n,t[n]);if(V)for(var n of V(t))Z.call(t,n)&&ee(e,n,t[n]);return e})({load:q,startAutoLoad:e=>te(void 0,null,(function*(){K(),yield q(e);try{m=yield o(((e,t)=>te(void 0,null,(function*(){t||e?2!=R&&(M(1),g++,U(null!=t?t:e),M(0)):yield q()}))))}catch(e){null==i||i(e)}return ue})),stopAutoLoad:K,isAutoLoading:()=>!d(m),save:oe,startAutoSave:()=>te(void 0,null,(function*(){return re(),yield oe(),T=e.addDidFinishTransactionListener((()=>{const e=S();I(e)&&oe(e)})),ue})),stopAutoSave:re,isAutoSaving:()=>!d(T),getStatus:()=>R,addStatusListener:e=>_(e,P),delListener:t=>(D(t),e),schedule:ie,getStore:()=>e,destroy:()=>(Y(le,E).splice(0,void 0),K().stopAutoSave()),getStats:()=>({loads:g,saves:O})},s);return C(ue)},re="_",ie="_id",ue="SELECT",de="WHERE",ae="TABLE",se="ALTER "+ae,ce="DELETE FROM",ve=ue+"*FROM",ye="pragma_",Ee="data_version",fe="schema_version",pe="pragma_table_",he=(e,t)=>t?(n,l)=>{return o=function*(){return t(n,l),yield e(n,l)},new Promise(((e,t)=>{var n=e=>{try{r(o.next(e))}catch(e){t(e)}},l=e=>{try{r(o.throw(e))}catch(e){t(e)}},r=t=>t.done?e(t.value):Promise.resolve(t.value).then(n,l);r((o=o.apply(void 0,null)).next())}));var o}:e,me=e=>`"${e.replace(/"/g,'""')}"`,Te=(e,t=[1])=>h(m(e,(()=>"$"+t[0]++)),o),Re=JSON.stringify,Ae=JSON.parse;var Ne=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const ge=(e,t,n,l,r,i=Oe,u,a)=>{const s=B();return[()=>Ne(void 0,null,(function*(){s.clear(),m(yield n(e,t),(({tn:e,cn:t})=>k(X(s,e,W),t)))})),(t,n)=>Ne(void 0,null,(function*(){return((e,t)=>M(Y(s,e),t))(t,n)?b(R(m(yield e(ve+me(t)),(e=>[e[n],a?_(I(e,n),a):I(e,n)])),(([e,t])=>!d(e)&&!x(t)))):{}})),(t,n,l,a,c,v=!1)=>Ne(void 0,null,(function*(){const y=W();_(null!=l?l:{},(e=>m($(null!=e?e:{}),(e=>k(y,e)))));const f=U(y);if(!v&&c&&T(f)&&M(s,t))return yield e("DROP "+ae+me(t)),void H(s,t);const p=Y(s,t),N=W(U(p));if(T(f)||(M(s,t)?yield E(m([n,...f],((l,o)=>Ne(void 0,null,(function*(){j(N,l)||(yield e(se+me(t)+"ADD"+me(l)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+me(t)+`(${me(n)})`)),k(p,l))}))))):(yield e("CREATE "+ae+me(t)+`(${me(n)}${r} PRIMARY KEY${h(m(f,(e=>o+me(e)+r)))});`),H(s,t,W([n,...f])))),yield E([...!v&&a?m(U(N),(l=>Ne(void 0,null,(function*(){l!=n&&(yield e(se+me(t)+"DROP"+me(l)),j(p,l))})))):[]]),v)d(l)?yield e(ce+me(t)+de+" true"):yield E(L(l,((l,o)=>Ne(void 0,null,(function*(){d(l)?yield e(ce+me(t)+de+me(n)+"=$1",[o]):T(f)||(yield i(e,t,n,$(l),{[o]:u?m(w(l),u):w(l)},p))})))));else if(T(f))M(s,t)&&(yield e(ce+me(t)+de+" true"));else{const o=R(U(Y(s,t)),(e=>e!=n)),r={},d=[];_(null!=l?l:{},((e,t)=>{r[t]=m(o,(t=>u?u(null==e?void 0:e[t]):null==e?void 0:e[t])),A(d,t)})),yield i(e,t,n,o,r),yield e(ce+me(t)+de+me(n)+`NOT IN(${Te(d)})`,d)}})),t=>Ne(void 0,null,(function*(){let n;yield e("BEGIN");try{n=yield t()}catch(e){null==l||l(e)}return yield e("END"),n}))]},Oe=(e,t,n,l,r)=>Ne(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+me(t)+"("+((...e)=>h(m(e,me),o))(n,...l)+")VALUES"+h(L(r,(e=>"($"+i[0]+++","+Te(e,i)+")")),o)+"ON CONFLICT("+me(n)+")DO UPDATE SET"+h(m(l,(e=>me(e)+"=excluded."+me(e))),o),L(r,((e,t)=>[t,...m(e,(e=>null!=e?e:null))])).flat())}));var Pe=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const $e=(e,t,n,l,o,r,i,[u,d,a],s,c,v,y,E,f)=>{const[p,h,m,T]=ge(t,s,c,o,E,f),R=oe(e,(()=>Pe(void 0,null,(function*(){return yield T((()=>Pe(void 0,null,(function*(){var e,t,n;return yield p(),n=null!=(t=null==(e=(yield h(u,d))[re])?void 0:e[a])?t:"null",Ae(n,((e,t)=>"￼"===t?void 0:t))}))))}))),(e=>Pe(void 0,null,(function*(){return yield T((()=>Pe(void 0,null,(function*(){var t,n;yield p(),yield m(u,d,{[re]:{[a]:(n=null!=(t=e())?t:null,Re(n,((e,t)=>void 0===t?"￼":t)))}},!0,!0)}))))}))),n,l,o,i,{[y]:()=>v,destroy:()=>(R.stopAutoLoad().stopAutoSave(),r(),R)},0,v);return R};var Ce=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const be=(e,t,n,l,o,r,i,[u,a,[s,c,v]],y,f,p,h,m,T,A,N)=>{const[g,O,P,$]=ge(t,y,f,o,m,T,A,N),C=(e,t)=>Ce(void 0,null,(function*(){return yield E(q(a,((n,l)=>Ce(void 0,[n,l],(function*([n,l,o,r],i){t&&!(i in e)||(yield P(n,l,e[i],o,r,t))})))))})),S=(e,t)=>Ce(void 0,null,(function*(){return c?yield P(v,ie,{[re]:e},!0,!0,t):null})),I=oe(e,(()=>Ce(void 0,null,(function*(){return yield $((()=>Ce(void 0,null,(function*(){yield g();const e=yield Ce(void 0,null,(function*(){return b(R(yield E(q(u,((e,t)=>Ce(void 0,[e,t],(function*([e,t],n){return[e,yield O(n,t)]}))))),(e=>!x(e[1]))))})),t=yield Ce(void 0,null,(function*(){return s?(yield O(v,ie))[re]:{}}));return x(e)&&d(t)?void 0:[e,t]}))))}))),((e,t)=>Ce(void 0,null,(function*(){return yield $((()=>Ce(void 0,null,(function*(){if(yield g(),d(t)){const[t,n]=e();yield C(t),yield S(n)}else yield C(t[0],!0),yield S(t[1],!0)}))))}))),n,l,o,i,{[h]:()=>p,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,p);return I},Se="ColumnName",Ie="store",Le="json",_e=Ie+"TableName",we=Ie+"Id"+Se,De=Ie+Se,xe="autoLoadIntervalSeconds",Me="rowId"+Se,Fe="tableId",Ue="tableName",Ge="deleteEmptyColumns",je="deleteEmptyTable",Be={mode:Le,[xe]:1},Ye={load:0,save:0,[Ue]:n+"_values"},qe=(e,t,n,l,o)=>{const r=B();return _(e,((e,i)=>{const u=v(w(S(t,s(e)?{[n]:e}:e)),0,D(t));d(u[0])||l(i,u[0])||(o(i,u[0]),H(r,i,u))})),r},He=e=>{var t,l,o;const r=(e=>S(Be,s(e)?{[_e]:e}:null!=e?e:{}))(e),i=r[xe];if(r.mode==Le){const e=null!=(t=r[_e])?t:n;return[1,i,[e,null!=(l=r[we])?l:ie,null!=(o=r[De])?o:Ie],W(e)]}const{tables:{load:u={},save:d={}}={},values:a={}}=r,c=v(w(S(Ye,a)),0,D(Ye)),y=c[2],E=W(y),f=W(y);return[0,i,[qe(u,{[Fe]:null,[Me]:ie},Fe,(e=>M(f,e)),(e=>k(E,e))),qe(d,{[Ue]:null,[Me]:ie,[Ge]:0,[je]:0},Ue,((e,t)=>M(f,t)),((e,t)=>k(E,t))),c],E]};var Xe=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())})),Je=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const We=n,ke=/^([cd]:)(.+)/,ze=n+"_data",Ke=n+"_table";e.Persists={StoreOnly:1,MergeableStoreOnly:2,StoreOrMergeableStore:3},e.Status={Idle:0,Loading:1,Saving:2},e.createCustomPersister=oe,e.createCustomPostgreSqlPersister=(e,t,n,l,o,r,i,u,d,s,c="getDb")=>{const v=he(n,r),[y,,f,p]=He(t),h=e=>Je(void 0,null,(function*(){yield v(`CREATE OR REPLACE TRIGGER ${me(ze+"_"+e)} AFTER INSERT OR UPDATE OR DELETE ON ${me(e)} EXECUTE FUNCTION ${ze}()`)}));return(y?$e:be)(e,v,(e=>Je(void 0,null,(function*(){yield v(`CREATE OR REPLACE FUNCTION ${Ke}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${We}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{yield v(`CREATE EVENT TRIGGER ${Ke} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${Ke}();`)}catch(e){}return yield v(`CREATE OR REPLACE FUNCTION ${ze}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${We}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),yield E(m(U(p),(e=>Je(void 0,null,(function*(){yield v(`CREATE TABLE IF NOT EXISTS ${me(e)}("_id"text PRIMARY KEY)`),yield h(e)}))))),yield l(We,(t=>Je(void 0,null,(function*(){return yield a((n=t,l=ke,null==n?void 0:n.match(l)),(t=>Je(void 0,[t],(function*([,t,n]){M(p,n)&&("c:"==t&&(yield h(n)),e())}))));var n,l}))))}))),o,i,u,d,f,U(p),((e,t)=>Je(void 0,null,(function*(){return yield e(`${ue} table_name tn,column_name cn FROM information_schema.columns ${de} table_schema='public'AND table_name IN(${Te(t)})`,t)}))),s,c,"text",void 0,(e=>Re(e)),(e=>Ae(e)))},e.createCustomSqlitePersister=(e,t,n,o,r,i,d,a,s,c,v="getDb",y)=>{let E,f,p;const h=he(n,i),[m,T,R,A]=He(t);return(m?$e:be)(e,h,(e=>{let t;const n=()=>t=setInterval((()=>Xe(void 0,null,(function*(){try{const[{d:t,s:n,c:l}]=yield h(`${ue} ${Ee} d,${fe} s,TOTAL_CHANGES() c FROM ${ye}${Ee} JOIN ${ye}${fe}`);t==E&&n==f&&l==p||(null!=E&&e(),E=t,f=n,p=l)}catch(e){}}))),1e3*T),l=()=>{E=f=p=null,u(t)},i=o((t=>{A.has(t)&&(l(),e(),n())}));return n(),()=>{l(),r(i)}}),(e=>e()),d,a,s,R,U(A),((e,t)=>Xe(void 0,null,(function*(){return yield e(`${ue} t.name tn,c.name cn FROM ${pe}list()t,${pe}info(t.name)c ${de} t.schema='main'AND t.type IN('table','view')AND t.name IN(${Te(t)})ORDER BY t.name,c.name`,t)}))),c,v,l,y,(e=>!0===e?1:!1===e?0:e),void 0)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisters={});
