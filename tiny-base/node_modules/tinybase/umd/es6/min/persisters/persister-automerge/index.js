var e,t;e=this,t=function(e){"use strict";const t=e=>null==e,n=(e,n,l)=>t(e)?null==l?void 0:l():n(e),l=e=>Array.isArray(e),o=e=>e.length,r=e=>{throw Error(e)},i=(e,t)=>e.forEach(t),u=(e,...t)=>e.push(...t),a=e=>e.shift(),s=Object,d=e=>s.getPrototypeOf(e),c=s.entries,v=s.keys,y=s.freeze,f=(e=[])=>s.fromEntries(e),p=(e,t)=>n(e,(e=>e[t])),h=(e,t)=>t in e,g=(e,t)=>(delete e[t],e),b=(e,t)=>f(((e,t)=>((e,t)=>e.map(t))(c(e),(([e,n])=>t(n,e))))(e,((e,n)=>[n,t(e,n)]))),m=e=>o(v(e)),A=e=>(e=>!t(e)&&n(d(e),(e=>e==s.prototype||t(d(e))),(()=>!0)))(e)&&0==m(e),C=(e,t,n)=>(h(e,t)||(e[t]=n()),e[t]),P=e=>t(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),S=(e,t)=>null==e?void 0:e.forEach(t),w=(e,t)=>null==e?void 0:e.delete(t),L=e=>new Map(e),O=(e,t)=>null==e?void 0:e.get(t),x=(e,n,l)=>t(l)?(w(e,n),e):null==e?void 0:e.set(n,l),j=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(O(e,t)):x(e,t,n()),O(e,t)},M=(e,t,l,r,i=0)=>n((l?j:O)(e,t[i],i>o(t)-2?l:L),(n=>{if(i>o(t)-2)return(null==r?void 0:r(n))&&x(e,t[i]),n;const u=M(n,t,l,r,i+1);return P(n)&&x(e,t[i]),u})),T=e=>new Set(l(e)||t(e)?e:[e]),E=/^\d+$/;var D=Object.defineProperty,z=Object.getOwnPropertySymbols,k=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable,F=(e,t,n)=>t in e?D(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,H=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const I=L(),$=L(),q=(e,s,d,c,v,f,p,h={},g=0,b=[])=>{let m,C,D,q=0,G=0,J=0;j(I,b,(()=>0)),j($,b,(()=>[]));const K=L(),[N,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!A(e)||!A(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!A(e)||!A(t),t.setContent]:r("Store type not supported by this Persister"))(p,e,g),[W,X,Y]=(()=>{let e;const[l,r]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?a(e):null)?l:""+t++},t=>{E.test(t)&&o(e)<1e3&&u(e,t)}]})(),s=L();return[(t,n,o,r=[],i=()=>[])=>{null!=e||(e=re);const u=l(1);var a,d;return x(s,u,[t,n,o,r,i]),d=u,null==(a=M(n,null!=o?o:[""],T))||a.add(d),u},(t,n,...l)=>i(((e,t=[""])=>{const n=[],l=(e,r)=>r==o(t)?u(n,e):null===t[r]?S(e,(e=>l(e,r+1))):i([t[r],null],(t=>l(O(e,t),r+1)));return l(e,0),n})(t,n),(t=>S(t,(t=>O(s,t)[0](e,...null!=n?n:[],...l))))),e=>n(O(s,e),(([,t,n])=>(M(t,null!=n?n:[""],void 0,(t=>(w(t,e),P(t)?1:0))),x(s,e),r(e),n))),l=>n(O(s,l),(([n,,l=[],r,u])=>{const a=(...s)=>{var d,c;const v=o(s);v==o(l)?n(e,...s,...u(s)):t(l[v])?i(null!=(c=null==(d=r[v])?void 0:d.call(r,...s))?c:[],(e=>a(...s,e))):a(...s,l[v])};a()}))]})(),Z=e=>{e!=q&&(q=e,X(K,void 0,q))},_=t=>{(N&&l(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>H(void 0,null,(function*(){return 2!=q&&(Z(1),G++,yield oe((()=>H(void 0,null,(function*(){try{const t=yield s();l(t)?_(t):e?V(e):r("Content is not an array: "+t)}catch(t){null==f||f(t),e&&V(e)}Z(0)}))))),re})),te=()=>(C&&(v(C),C=void 0),re),ne=e=>H(void 0,null,(function*(){return 1!=q&&(Z(2),J++,yield oe((()=>H(void 0,null,(function*(){try{yield d(Q,e)}catch(e){null==f||f(e)}Z(0)}))))),re})),le=()=>(D&&(e.delListener(D),D=void 0),re),oe=(...e)=>H(void 0,null,(function*(){return u(O($,b),...e),yield H(void 0,null,(function*(){if(!O(I,b)){for(x(I,b,1);!t(m=a(O($,b)));)try{yield m()}catch(e){null==f||f(e)}x(I,b,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))k.call(t,n)&&F(e,n,t[n]);if(z)for(var n of z(t))B.call(t,n)&&F(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>H(void 0,null,(function*(){te(),yield ee(e);try{C=yield c(((e,t)=>H(void 0,null,(function*(){t||e?2!=q&&(Z(1),G++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==f||f(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!t(C),save:ne,startAutoSave:()=>H(void 0,null,(function*(){return le(),yield ne(),D=e.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!t(D),getStatus:()=>q,addStatusListener:e=>W(e,K),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(O($,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:G,saves:J})},h);return y(re)};var G=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const J=(e,t)=>[e[t].t,e[t].v],K=(e,n,l,o)=>{const r=t(n)?e:C(e,n,(()=>({})));let i;return b(l,((e,t)=>{o(r,t,e)&&(i=1)})),b(r,((e,t)=>{h(l,t)||(g(r,t),i=1)})),!t(n)&&A(r)&&g(e,n),i};e.createAutomergePersister=(e,l,o="tinybase",r)=>(l.change((e=>C(e,o,f))),q(e,(()=>G(void 0,null,(function*(){const e=yield l.doc();return 2==m(null==e?void 0:e[o])?J(e,o):void 0}))),((e,r)=>G(void 0,null,(function*(){return l.change((l=>((e,l,o,r)=>{((e,t)=>{A(e[t])&&(e[t]={t:{},v:{}})})(e,l);const[i,u]=J(e,l),a=()=>{s=1};let s=1;if(n(r,(([e,l])=>{s=0,b(e,((e,l)=>s?0:t(e)?g(i,l):n(i[l],(l=>b(e,((e,o)=>s?0:t(e)?g(l,o):n(p(l,o),(n=>b(e,((e,l)=>t(e)?g(n,l):n[l]=e))),a)))),a))),b(l,((e,n)=>s?0:t(e)?g(u,n):u[n]=e))})),s){const[e,t]=o();K(i,void 0,e,((e,t,n)=>K(i,t,n,((e,t,n)=>K(e,t,n,((e,t,n)=>{if(p(e,t)!==n)return e[t]=n,1})))))),K(u,void 0,t,((e,t,n)=>{p(u,t)!==n&&(u[t]=n)}))}})(l,o,e,r)))}))),(e=>{const t=({doc:t})=>e(J(t,o));return l.on("change",t),t}),(e=>{l.removeListener("change",e)}),r,1,{getDocHandle:()=>l}))},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterAutomerge={});
