var e,t;e=this,t=function(e){"use strict";const t=globalThis.window,n=e=>null==e,r=(e,t,r)=>n(e)?null==r?void 0:r():t(e),l=e=>Array.isArray(e),o=e=>e.length,i=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),s=(e,...t)=>e.push(...t),u=e=>e.shift(),d=Object,c=e=>d.getPrototypeOf(e),v=d.keys,y=d.freeze,f=e=>(e=>!n(e)&&r(c(e),(e=>e==d.prototype||n(c(e))),(()=>!0)))(e)&&0==(e=>o(v(e)))(e),p=JSON.stringify,g=JSON.parse,h=e=>n(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),b=(e,t)=>null==e?void 0:e.forEach(t),S=(e,t)=>null==e?void 0:e.delete(t),w=e=>new Map(e),m=(e,t)=>null==e?void 0:e.get(t),P=(e,t,r)=>n(r)?(S(e,t),e):null==e?void 0:e.set(t,r),C=(e,t,n,r)=>{var l,o,i;return o=t,null!=(i=null==(l=e)?void 0:l.has(o))&&i?null==r||r(m(e,t)):P(e,t,n()),m(e,t)},A=(e,t,n,l,i=0)=>r((n?C:m)(e,t[i],i>o(t)-2?n:w),(r=>{if(i>o(t)-2)return(null==l?void 0:l(r))&&P(e,t[i]),r;const a=A(r,t,n,l,i+1);return h(r)&&P(e,t[i]),a})),L=e=>new Set(l(e)||n(e)?e:[e]),O=/^\d+$/;var x=Object.defineProperty,T=Object.getOwnPropertySymbols,j=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,M=(e,t,n)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,I=(e,t,n)=>new Promise(((r,l)=>{var o=e=>{try{a(n.next(e))}catch(e){l(e)}},i=e=>{try{a(n.throw(e))}catch(e){l(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,i);a((n=n.apply(e,t)).next())}));const N=w(),k=w(),z=(e,t,d,c,v,p,g,x={},z=0,B=[])=>{let D,J,F,V=0,$=0,q=0;C(N,B,(()=>0)),C(k,B,(()=>[]));const G=w(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!f(e)||!f(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!f(e)||!f(t),t.setContent]:i("Store type not supported by this Persister"))(g,e,z),[W,X,Y]=(()=>{let e;const[t,l]=(()=>{const e=[];let t=0;return[n=>{var r;return null!=(r=n?u(e):null)?r:""+t++},t=>{O.test(t)&&o(e)<1e3&&s(e,t)}]})(),i=w();return[(n,r,l,o=[],a=()=>[])=>{null!=e||(e=oe);const s=t(1);var u,d;return P(i,s,[n,r,l,o,a]),d=s,null==(u=A(r,null!=l?l:[""],L))||u.add(d),s},(t,n,...r)=>a(((e,t=[""])=>{const n=[],r=(e,l)=>l==o(t)?s(n,e):null===t[l]?b(e,(e=>r(e,l+1))):a([t[l],null],(t=>r(m(e,t),l+1)));return r(e,0),n})(t,n),(t=>b(t,(t=>m(i,t)[0](e,...null!=n?n:[],...r))))),e=>r(m(i,e),(([,t,n])=>(A(t,null!=n?n:[""],void 0,(t=>(S(t,e),h(t)?1:0))),P(i,e),l(e),n))),t=>r(m(i,t),(([t,,r=[],l,i])=>{const s=(...u)=>{var d,c;const v=o(u);v==o(r)?t(e,...u,...i(u)):n(r[v])?a(null!=(c=null==(d=l[v])?void 0:d.call(l,...u))?c:[],(e=>s(...u,e))):s(...u,r[v])};s()}))]})(),Z=e=>{e!=V&&(V=e,X(G,void 0,V))},_=t=>{(H&&l(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>I(void 0,null,(function*(){return 2!=V&&(Z(1),$++,yield le((()=>I(void 0,null,(function*(){try{const n=yield t();l(n)?_(n):e?U(e):i("Content is not an array: "+n)}catch(t){null==p||p(t),e&&U(e)}Z(0)}))))),oe})),te=()=>(J&&(v(J),J=void 0),oe),ne=e=>I(void 0,null,(function*(){return 1!=V&&(Z(2),q++,yield le((()=>I(void 0,null,(function*(){try{yield d(K,e)}catch(e){null==p||p(e)}Z(0)}))))),oe})),re=()=>(F&&(e.delListener(F),F=void 0),oe),le=(...e)=>I(void 0,null,(function*(){return s(m(k,B),...e),yield I(void 0,null,(function*(){if(!m(N,B)){for(P(N,B,1);!n(D=u(m(k,B)));)try{yield D()}catch(e){null==p||p(e)}P(N,B,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))j.call(t,n)&&M(e,n,t[n]);if(T)for(var n of T(t))E.call(t,n)&&M(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>I(void 0,null,(function*(){te(),yield ee(e);try{J=yield c(((e,t)=>I(void 0,null,(function*(){t||e?2!=V&&(Z(1),$++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==p||p(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!n(J),save:ne,startAutoSave:()=>I(void 0,null,(function*(){return re(),yield ne(),F=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),oe})),stopAutoSave:re,isAutoSaving:()=>!n(F),getStatus:()=>V,addStatusListener:e=>W(e,G),delListener:t=>(Y(t),e),schedule:le,getStore:()=>e,destroy:()=>(m(k,B).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:$,saves:q})},x);return y(oe)};var B=(e,t,n)=>new Promise(((r,l)=>{var o=e=>{try{a(n.next(e))}catch(e){l(e)}},i=e=>{try{a(n.throw(e))}catch(e){l(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,i);a((n=n.apply(e,t)).next())}));const D="storage",J=(e,n,r,l)=>z(e,(()=>B(void 0,null,(function*(){return e=r.getItem(n),g(e,((e,t)=>"￼"===t?void 0:t));var e}))),(e=>B(void 0,null,(function*(){return r.setItem(n,(t=e(),p(t,((e,t)=>void 0===t?"￼":t))));var t}))),(e=>{const l=t=>{if(t.storageArea===r&&t.key===n)try{e(g(t.newValue))}catch(t){e()}};return t.addEventListener(D,l),l}),(e=>t.removeEventListener(D,e)),l,3,{getStorageName:()=>n});e.createLocalPersister=(e,t,n)=>J(e,t,localStorage,n),e.createSessionPersister=(e,t,n)=>J(e,t,sessionStorage,n)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
