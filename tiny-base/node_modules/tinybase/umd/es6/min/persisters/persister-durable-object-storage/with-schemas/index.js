var e,t;e=this,t=function(e){"use strict";const t="t",n="v",l=e=>null==e,o=(e,t,n)=>l(e)?null==n?void 0:n():t(e),r=e=>Array.isArray(e),i=(e,t,n)=>e.slice(t,n),u=e=>e.length,s=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),c=(e,...t)=>e.push(...t),d=e=>e.shift(),v=Object,y=e=>v.getPrototypeOf(e),f=v.entries,p=v.keys,h=v.freeze,g=(e,t)=>a(f(e),(([e,n])=>t(n,e))),b=e=>(e=>!l(e)&&o(y(e),(e=>e==v.prototype||l(y(e))),(()=>!0)))(e)&&0==(e=>u(p(e)))(e),S=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),O=e=>l(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),C=(e,t)=>null==e?void 0:e.forEach(t),P=(e,t)=>null==e?void 0:e.delete(t),w=e=>new Map(e),m=(e,t)=>null==e?void 0:e.get(t),A=(e,t,n)=>l(n)?(P(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(m(e,t)):A(e,t,n()),m(e,t)},x=(e,t,n,l,r=0)=>o((n?j:m)(e,t[r],r>u(t)-2?n:w),(o=>{if(r>u(t)-2)return(null==l?void 0:l(o))&&A(e,t[r]),o;const i=x(o,t,n,l,r+1);return O(o)&&A(e,t[r]),i})),L=(e,t,n)=>{t>e[1]&&(e[1]=t),e[2]=n>>>0},M=e=>new Set(r(e)||l(e)?e:[e]),T=/^\d+$/;var E=Object.defineProperty,D=Object.getOwnPropertySymbols,z=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,N=(e,t,n)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,k=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const B=w(),F=w(),I=(e,t,n,i,v,y,f,p={},g=0,S=[])=>{let L,E,I,W=0,$=0,q=0;j(B,S,(()=>0)),j(F,S,(()=>[]));const G=w(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!b(e)||!b(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!b(e)||!b(t),t.setContent]:s("Store type not supported by this Persister"))(f,e,g),[V,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?d(e):null)?l:""+t++},t=>{T.test(t)&&u(e)<1e3&&c(e,t)}]})(),r=w();return[(n,l,o,i=[],u=()=>[])=>{null!=e||(e=re);const s=t(1);var a,c;return A(r,s,[n,l,o,i,u]),c=s,null==(a=x(l,null!=o?o:[""],M))||a.add(c),s},(t,n,...l)=>a(((e,t=[""])=>{const n=[],l=(e,o)=>o==u(t)?c(n,e):null===t[o]?C(e,(e=>l(e,o+1))):a([t[o],null],(t=>l(m(e,t),o+1)));return l(e,0),n})(t,n),(t=>C(t,(t=>m(r,t)[0](e,...null!=n?n:[],...l))))),e=>o(m(r,e),(([,t,l])=>(x(t,null!=l?l:[""],void 0,(t=>(P(t,e),O(t)?1:0))),A(r,e),n(e),l))),t=>o(m(r,t),(([t,,n=[],o,r])=>{const i=(...s)=>{var c,d;const v=u(s);v==u(n)?t(e,...s,...r(s)):l(n[v])?a(null!=(d=null==(c=o[v])?void 0:c.call(o,...s))?d:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),Z=e=>{e!=W&&(W=e,X(G,void 0,W))},_=t=>{(H&&r(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>k(void 0,null,(function*(){return 2!=W&&(Z(1),$++,yield oe((()=>k(void 0,null,(function*(){try{const n=yield t();r(n)?_(n):e?U(e):s("Content is not an array: "+n)}catch(t){null==y||y(t),e&&U(e)}Z(0)}))))),re})),te=()=>(E&&(E=void 0),re),ne=e=>k(void 0,null,(function*(){return 1!=W&&(Z(2),q++,yield oe((()=>k(void 0,null,(function*(){try{yield n(K,e)}catch(e){null==y||y(e)}Z(0)}))))),re})),le=()=>(I&&(e.delListener(I),I=void 0),re),oe=(...e)=>k(void 0,null,(function*(){return c(m(F,S),...e),yield k(void 0,null,(function*(){if(!m(B,S)){for(A(B,S,1);!l(L=d(m(F,S)));)try{yield L()}catch(e){null==y||y(e)}A(B,S,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))z.call(t,n)&&N(e,n,t[n]);if(D)for(var n of D(t))J.call(t,n)&&N(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>k(void 0,null,(function*(){te(),yield ee(e);try{E=yield i(((e,t)=>k(void 0,null,(function*(){t||e?2!=W&&(Z(1),$++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==y||y(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!l(E),save:ne,startAutoSave:()=>k(void 0,null,(function*(){return le(),yield ne(),I=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!l(I),getStatus:()=>W,addStatusListener:e=>V(e,G),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(m(F,S).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:$,saves:q})},p);return h(re)},W=JSON.stringify;var $=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const q=()=>[{},"",0];e.createDurableObjectStoragePersister=(e,l,r="",u)=>{const s=(e,...t)=>r+e+i(W(t,((e,t)=>void 0===t?"ï¿¼":t)),1,-1);return I(e,(()=>$(void 0,null,(function*(){const e=[{},"",0],u=[{},"",0];return(yield l.list({prefix:r})).forEach(((l,s)=>$(void 0,[l,s],(function*([l,s,a],c){return o((e=>{if(l=r,e.startsWith(l)){const l=i(e,r.length,1);return l==t||l==n?[l,...JSON.parse("["+i(e,r.length+1)+"]")]:void 0}var l})(c),(([r,...i])=>r==t?o(i[0],(t=>{const n=S(e[0],t,q);o(i[1],(e=>{const t=S(n[0],e,q);o(i[2],(e=>t[0][e]=[l,s,a]),(()=>L(t,s,a)))}),(()=>L(n,s,a)))}),(()=>L(e,s,a))):r==n?o(i[0],(e=>u[0][e]=[l,s,a]),(()=>L(u,s,a))):0))})))),[e,u]}))),((e,...o)=>$(void 0,[e,...o],(function*(e,[[o,r,i],[u,a,c]]=e()){const d=w();A(d,s(t),[0,r,i]),g(o,(([e,n,l],o)=>{A(d,s(t,o),[0,n,l]),g(e,(([e,n,l],r)=>{A(d,s(t,o,r),[0,n,l]),g(e,((e,n)=>A(d,s(t,o,r,n),e)))}))})),A(d,s(n),[0,a,c]),g(u,((e,t)=>A(d,s(n,t),e))),yield l.put((e=>{const t={};return C(e,((e,n)=>{{const l=e;t[n]=l}})),t})(d))}))),(()=>{}),0,u,2,{getStorage:()=>l})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterDurableObjectStorage={});
