var e,n;e=this,n=function(e,n){"use strict";const t=e=>typeof e,l="tinybase",o="",r=",",i=t(o),u=Promise,a=clearInterval,d=e=>null==e,s=(e,n,t)=>d(e)?null==t?void 0:t():n(e),c=e=>t(e)==i,v=e=>Array.isArray(e),y=(e,n,t)=>e.slice(n,t),f=e=>e.length,p=e=>{return n=function*(){return u.all(e)},new Promise(((e,t)=>{var l=e=>{try{r(n.next(e))}catch(e){t(e)}},o=e=>{try{r(n.throw(e))}catch(e){t(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,o);r((n=n.apply(void 0,null)).next())}));var n},h=e=>{throw Error(e)},m=(e,n)=>e.forEach(n),g=(e,n="")=>e.join(n),E=(e,n)=>e.map(n),b=e=>0==f(e),P=(e,n)=>e.filter(n),A=(e,...n)=>e.push(...n),x=e=>e.shift(),O="_",w="_id",N="SELECT",S="WHERE",T="TABLE",$="ALTER "+T,C="DELETE FROM",I=N+"*FROM",L="pragma_",D="data_version",R="schema_version",M="pragma_table_",_=e=>`"${e.replace(/"/g,'""')}"`,j=(e,n=[1])=>g(E(e,(()=>"$"+n[0]++)),r),q=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},F=e=>d(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),B=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},U=(e,n)=>null==e?void 0:e.forEach(n),J=(e,n)=>null==e?void 0:e.delete(n),Y=Object,k=e=>Y.getPrototypeOf(e),z=Y.entries,G=Y.keys,H=Y.freeze,K=(e=[])=>Y.fromEntries(e),Q=(...e)=>Y.assign({},...e),V=(e,n)=>(delete e[n],e),W=(e,n)=>E(z(e),(([e,t])=>n(t,e))),X=(e,n)=>K(W(e,((e,t)=>[t,n(e,t)]))),Z=e=>Y.values(e),ee=e=>f(G(e)),ne=e=>(e=>!d(e)&&s(k(e),(e=>e==Y.prototype||d(k(e))),(()=>!0)))(e)&&0==ee(e),te=JSON.stringify,le=JSON.parse,oe=e=>new Map(e),re=(e,n)=>null==e?void 0:e.get(n),ie=(e,n)=>{var t;return E([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},ue=(e,n,t)=>d(t)?(J(e,n),e):null==e?void 0:e.set(n,t),ae=(e,n,t,l)=>(q(e,n)?null==l||l(re(e,n)):ue(e,n,t()),re(e,n)),de=(e,n,t,l,o=0)=>s((t?ae:re)(e,n[o],o>f(n)-2?t:oe),(r=>{if(o>f(n)-2)return(null==l?void 0:l(r))&&ue(e,n[o]),r;const i=de(r,n,t,l,o+1);return F(r)&&ue(e,n[o]),i})),se=e=>new Set(v(e)||d(e)?e:[e]),ce=(e,n)=>null==e?void 0:e.add(n),ve=/^\d+$/;var ye=Object.defineProperty,fe=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable,me=(e,n,t)=>n in e?ye(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,ge=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Ee=oe(),be=oe(),Pe=(e,n,t,l,r,i,u,a={},c=0,y=[])=>{let p,g,E,b=0,P=0,O=0;ae(Ee,y,(()=>0)),ae(be,y,(()=>[]));const w=oe(),[N,S,T,$,C]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!ne(e)||!ne(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!ne(e)||!ne(n),n.setContent]:h("Store type not supported by this Persister"))(u,e,c),[I,L,D]=(()=>{let e;const[n,t]=(()=>{const e=[];let n=0;return[t=>{var l;return null!=(l=t?x(e):null)?l:o+n++},n=>{ve.test(n)&&f(e)<1e3&&A(e,n)}]})(),l=oe();return[(t,r,i,u=[],a=()=>[])=>{null!=e||(e=k);const d=n(1);return ue(l,d,[t,r,i,u,a]),ce(de(r,null!=i?i:[o],se),d),d},(n,t,...r)=>m(((e,n=[o])=>{const t=[],l=(e,o)=>o==f(n)?A(t,e):null===n[o]?U(e,(e=>l(e,o+1))):m([n[o],null],(n=>l(re(e,n),o+1)));return l(e,0),t})(n,t),(n=>U(n,(n=>re(l,n)[0](e,...null!=t?t:[],...r))))),e=>s(re(l,e),(([,n,r])=>(de(n,null!=r?r:[o],void 0,(n=>(J(n,e),F(n)?1:0))),ue(l,e),t(e),r))),n=>s(re(l,n),(([n,,t=[],l,o])=>{const r=(...i)=>{var u,a;const s=f(i);s==f(t)?n(e,...i,...o(i)):d(t[s])?m(null!=(a=null==(u=l[s])?void 0:u.call(l,...i))?a:[],(e=>r(...i,e))):r(...i,t[s])};r()}))]})(),R=e=>{e!=b&&(b=e,L(w,void 0,b))},M=n=>{(N&&v(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},_=e=>ge(void 0,null,(function*(){return 2!=b&&(R(1),P++,yield Y((()=>ge(void 0,null,(function*(){try{const t=yield n();v(t)?M(t):e?C(e):h("Content is not an array: "+t)}catch(n){null==i||i(n),e&&C(e)}R(0)}))))),k})),j=()=>(g&&(r(g),g=void 0),k),q=e=>ge(void 0,null,(function*(){return 1!=b&&(R(2),O++,yield Y((()=>ge(void 0,null,(function*(){try{yield t(S,e)}catch(e){null==i||i(e)}R(0)}))))),k})),B=()=>(E&&(e.delListener(E),E=void 0),k),Y=(...e)=>ge(void 0,null,(function*(){return A(re(be,y),...e),yield ge(void 0,null,(function*(){if(!re(Ee,y)){for(ue(Ee,y,1);!d(p=x(re(be,y)));)try{yield p()}catch(e){null==i||i(e)}ue(Ee,y,0)}})),k})),k=((e,n)=>{for(var t in n||(n={}))pe.call(n,t)&&me(e,t,n[t]);if(fe)for(var t of fe(n))he.call(n,t)&&me(e,t,n[t]);return e})({load:_,startAutoLoad:e=>ge(void 0,null,(function*(){j(),yield _(e);try{g=yield l(((e,n)=>ge(void 0,null,(function*(){n||e?2!=b&&(R(1),P++,M(null!=n?n:e),R(0)):yield _()}))))}catch(e){null==i||i(e)}return k})),stopAutoLoad:j,isAutoLoading:()=>!d(g),save:q,startAutoSave:()=>ge(void 0,null,(function*(){return B(),yield q(),E=e.addDidFinishTransactionListener((()=>{const e=T();$(e)&&q(e)})),k})),stopAutoSave:B,isAutoSaving:()=>!d(E),getStatus:()=>b,addStatusListener:e=>I(e,w),delListener:n=>(D(n),e),schedule:Y,getStore:()=>e,destroy:()=>(re(be,y).splice(0,void 0),j().stopAutoSave()),getStats:()=>({loads:P,saves:O})},a);return H(k)};var Ae=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const xe=(e,n,t,l,o,i=Oe,u,a)=>{const s=oe();return[()=>Ae(void 0,null,(function*(){s.clear(),E(yield t(e,n),(({tn:e,cn:n})=>ce(ae(s,e,se),n)))})),(n,t)=>Ae(void 0,null,(function*(){return((e,n)=>q(re(s,e),n))(n,t)?K(P(E(yield e(I+_(n)),(e=>[e[t],a?X(V(e,t),a):V(e,t)])),(([e,n])=>!d(e)&&!ne(n)))):{}})),(n,t,l,a,c,v=!1)=>Ae(void 0,null,(function*(){const y=se();X(null!=l?l:{},(e=>E(G(null!=e?e:{}),(e=>ce(y,e)))));const f=B(y);if(!v&&c&&b(f)&&q(s,n))return yield e("DROP "+T+_(n)),void ue(s,n);const h=re(s,n),m=se(B(h));if(b(f)||(q(s,n)?yield p(E([t,...f],((l,r)=>Ae(void 0,null,(function*(){J(m,l)||(yield e($+_(n)+"ADD"+_(l)+o),0==r&&(yield e("CREATE UNIQUE INDEX pk ON "+_(n)+`(${_(t)})`)),ce(h,l))}))))):(yield e("CREATE "+T+_(n)+`(${_(t)}${o} PRIMARY KEY${g(E(f,(e=>r+_(e)+o)))});`),ue(s,n,se([t,...f])))),yield p([...!v&&a?E(B(m),(l=>Ae(void 0,null,(function*(){l!=t&&(yield e($+_(n)+"DROP"+_(l)),J(h,l))})))):[]]),v)d(l)?yield e(C+_(n)+S+" true"):yield p(W(l,((l,o)=>Ae(void 0,null,(function*(){d(l)?yield e(C+_(n)+S+_(t)+"=$1",[o]):b(f)||(yield i(e,n,t,G(l),{[o]:u?E(Z(l),u):Z(l)},h))})))));else if(b(f))q(s,n)&&(yield e(C+_(n)+S+" true"));else{const o=P(B(re(s,n)),(e=>e!=t)),r={},a=[];X(null!=l?l:{},((e,n)=>{r[n]=E(o,(n=>u?u(null==e?void 0:e[n]):null==e?void 0:e[n])),A(a,n)})),yield i(e,n,t,o,r),yield e(C+_(n)+S+_(t)+`NOT IN(${j(a)})`,a)}})),n=>Ae(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==l||l(e)}return yield e("END"),t}))]},Oe=(e,n,t,l,o)=>Ae(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+_(n)+"("+((...e)=>g(E(e,_),r))(t,...l)+")VALUES"+g(W(o,(e=>"($"+i[0]+++","+j(e,i)+")")),r)+"ON CONFLICT("+_(t)+")DO UPDATE SET"+g(E(l,(e=>_(e)+"=excluded."+_(e))),r),W(o,((e,n)=>[n,...E(e,(e=>null!=e?e:null))])).flat())}));var we=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Ne=(e,n,t,l,o,r,i,[u,a,d],s,c,v,y,f,p)=>{const[h,m,g,E]=xe(n,s,c,o,f,p),b=Pe(e,(()=>we(void 0,null,(function*(){return yield E((()=>we(void 0,null,(function*(){var e,n,t;return yield h(),t=null!=(n=null==(e=(yield m(u,a))[O])?void 0:e[d])?n:"null",le(t,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>we(void 0,null,(function*(){return yield E((()=>we(void 0,null,(function*(){var n,t;yield h(),yield g(u,a,{[O]:{[d]:(t=null!=(n=e())?n:null,te(t,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),t,l,o,i,{[y]:()=>v,destroy:()=>(b.stopAutoLoad().stopAutoSave(),r(),b)},0,v);return b};var Se=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Te=(e,n,t,l,o,r,i,[u,a,[s,c,v]],y,f,h,m,g,E,b,A)=>{const[x,N,S,T]=xe(n,y,f,o,g,E,b,A),$=(e,n)=>Se(void 0,null,(function*(){return yield p(ie(a,((t,l)=>Se(void 0,[t,l],(function*([t,l,o,r],i){n&&!(i in e)||(yield S(t,l,e[i],o,r,n))})))))})),C=(e,n)=>Se(void 0,null,(function*(){return c?yield S(v,w,{[O]:e},!0,!0,n):null})),I=Pe(e,(()=>Se(void 0,null,(function*(){return yield T((()=>Se(void 0,null,(function*(){yield x();const e=yield Se(void 0,null,(function*(){return K(P(yield p(ie(u,((e,n)=>Se(void 0,[e,n],(function*([e,n],t){return[e,yield N(t,n)]}))))),(e=>!ne(e[1]))))})),n=yield Se(void 0,null,(function*(){return s?(yield N(v,w))[O]:{}}));return ne(e)&&d(n)?void 0:[e,n]}))))}))),((e,n)=>Se(void 0,null,(function*(){return yield T((()=>Se(void 0,null,(function*(){if(yield x(),d(n)){const[n,t]=e();yield $(n),yield C(t)}else yield $(n[0],!0),yield C(n[1],!0)}))))}))),t,l,o,i,{[m]:()=>h,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,h);return I},$e="ColumnName",Ce="store",Ie="json",Le=Ce+"TableName",De=Ce+"Id"+$e,Re=Ce+$e,Me="autoLoadIntervalSeconds",_e="rowId"+$e,je="tableId",qe="tableName",Fe="deleteEmptyColumns",Be="deleteEmptyTable",Ue={mode:Ie,[Me]:1},Je={load:0,save:0,[qe]:l+"_values"},Ye=(e,n,t,l,o)=>{const r=oe();return X(e,((e,i)=>{const u=y(Z(Q(n,c(e)?{[t]:e}:e)),0,ee(n));d(u[0])||l(i,u[0])||(o(i,u[0]),ue(r,i,u))})),r};var ke=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const ze=(e,n,t,r,i,u,d,s,v,f,p="getDb",h)=>{let m,g,E;const b=((e,n)=>n?(t,l)=>{return o=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{r(o.next(e))}catch(e){n(e)}},l=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);r((o=o.apply(void 0,null)).next())}));var o}:e)(t,u),[P,A,x,O]=(e=>{var n,t,o;const r=(e=>Q(Ue,c(e)?{[Le]:e}:null!=e?e:{}))(e),i=r[Me];if(r.mode==Ie){const e=null!=(n=r[Le])?n:l;return[1,i,[e,null!=(t=r[De])?t:w,null!=(o=r[Re])?o:Ce],se(e)]}const{tables:{load:u={},save:a={}}={},values:d={}}=r,s=y(Z(Q(Je,d)),0,ee(Je)),v=s[2],f=se(v),p=se(v);return[0,i,[Ye(u,{[je]:null,[_e]:w},je,(e=>q(p,e)),(e=>ce(f,e))),Ye(a,{[qe]:null,[_e]:w,[Fe]:0,[Be]:0},qe,((e,n)=>q(p,n)),((e,n)=>ce(f,n))),s],f]})(n);return(P?Ne:Te)(e,b,(e=>{let n;const t=()=>n=setInterval((()=>ke(void 0,null,(function*(){try{const[{d:n,s:t,c:l}]=yield b(`${N} ${D} d,${R} s,TOTAL_CHANGES() c FROM ${L}${D} JOIN ${L}${R}`);n==m&&t==g&&l==E||(null!=m&&e(),m=n,g=t,E=l)}catch(e){}}))),1e3*A),l=()=>{m=g=E=null,a(n)},o=r((n=>{O.has(n)&&(l(),e(),t())}));return t(),()=>{l(),i(o)}}),(e=>e()),d,s,v,x,B(O),((e,n)=>ke(void 0,null,(function*(){return yield e(`${N} t.name tn,c.name cn FROM ${M}list()t,${M}info(t.name)c ${S} t.schema='main'AND t.type IN('table','view')AND t.name IN(${j(n)})ORDER BY t.name,c.name`,n)}))),f,p,o,h,(e=>!0===e?1:!1===e?0:e),void 0)};e.createExpoSqlitePersister=(e,t,l,o,r)=>ze(e,l,((e,...n)=>{return l=[e,...n],o=function*(e,n=[]){return yield t.getAllAsync(e,n)},new Promise(((e,n)=>{var t=e=>{try{i(o.next(e))}catch(e){n(e)}},r=e=>{try{i(o.throw(e))}catch(e){n(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,r);i((o=o.apply(void 0,l)).next())}));var l,o}),(e=>n.addDatabaseChangeListener((({tableName:n})=>e(n)))),(e=>e.remove()),o,r,(()=>0),3,t)},"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("expo-sqlite")):"function"==typeof define&&define.amd?define(["exports","expo-sqlite"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterExpoSqlite={},e["expo-sqlite"]);
