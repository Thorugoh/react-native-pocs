var e,t;e=this,t=function(e,t,n){"use strict";const l="utf8",r=e=>null==e,o=(e,t,n)=>r(e)?null==n?void 0:n():t(e),i=e=>Array.isArray(e),u=e=>e.length,s=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),c=e=>e.shift(),v=Object,y=e=>v.getPrototypeOf(e),f=v.keys,p=v.freeze,h=e=>(e=>!r(e)&&o(y(e),(e=>e==v.prototype||r(y(e))),(()=>!0)))(e)&&0==(e=>u(f(e)))(e),g=JSON.stringify,b=JSON.parse,S=e=>r(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),w=(e,t)=>null==e?void 0:e.forEach(t),m=(e,t)=>null==e?void 0:e.delete(t),P=e=>new Map(e),C=(e,t)=>null==e?void 0:e.get(t),O=(e,t,n)=>r(n)?(m(e,t),e):null==e?void 0:e.set(t,n),A=(e,t,n,l)=>{var r,o,i;return o=t,null!=(i=null==(r=e)?void 0:r.has(o))&&i?null==l||l(C(e,t)):O(e,t,n()),C(e,t)},x=(e,t,n,l,r=0)=>o((n?A:C)(e,t[r],r>u(t)-2?n:P),(o=>{if(r>u(t)-2)return(null==l?void 0:l(o))&&O(e,t[r]),o;const i=x(o,t,n,l,r+1);return S(o)&&O(e,t[r]),i})),F=e=>new Set(i(e)||r(e)?e:[e]),L=/^\d+$/;var j=Object.defineProperty,M=Object.getOwnPropertySymbols,T=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,q=(e,t,n)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,z=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));const D=P(),J=P(),N=(e,t,n,l,v,y,f,g={},b=0,j=[])=>{let N,k,B,I=0,$=0,G=0;A(D,j,(()=>0)),A(J,j,(()=>[]));const H=P(),[K,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!h(e)||!h(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!h(e)||!h(t),t.setContent]:s("Store type not supported by this Persister"))(f,e,b),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?c(e):null)?l:""+t++},t=>{L.test(t)&&u(e)<1e3&&d(e,t)}]})(),l=P();return[(n,r,o,i=[],u=()=>[])=>{null!=e||(e=oe);const s=t(1);var a,d;return O(l,s,[n,r,o,i,u]),d=s,null==(a=x(r,null!=o?o:[""],F))||a.add(d),s},(t,n,...r)=>a(((e,t=[""])=>{const n=[],l=(e,r)=>r==u(t)?d(n,e):null===t[r]?w(e,(e=>l(e,r+1))):a([t[r],null],(t=>l(C(e,t),r+1)));return l(e,0),n})(t,n),(t=>w(t,(t=>C(l,t)[0](e,...null!=n?n:[],...r))))),e=>o(C(l,e),(([,t,r])=>(x(t,null!=r?r:[""],void 0,(t=>(m(t,e),S(t)?1:0))),O(l,e),n(e),r))),t=>o(C(l,t),(([t,,n=[],l,o])=>{const i=(...s)=>{var d,c;const v=u(s);v==u(n)?t(e,...s,...o(s)):r(n[v])?a(null!=(c=null==(d=l[v])?void 0:d.call(l,...s))?c:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),Z=e=>{e!=I&&(I=e,X(H,void 0,I))},_=t=>{(K&&i(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>z(void 0,null,(function*(){return 2!=I&&(Z(1),$++,yield re((()=>z(void 0,null,(function*(){try{const n=yield t();i(n)?_(n):e?V(e):s("Content is not an array: "+n)}catch(t){null==y||y(t),e&&V(e)}Z(0)}))))),oe})),te=()=>(k&&(v(k),k=void 0),oe),ne=e=>z(void 0,null,(function*(){return 1!=I&&(Z(2),G++,yield re((()=>z(void 0,null,(function*(){try{yield n(Q,e)}catch(e){null==y||y(e)}Z(0)}))))),oe})),le=()=>(B&&(e.delListener(B),B=void 0),oe),re=(...e)=>z(void 0,null,(function*(){return d(C(J,j),...e),yield z(void 0,null,(function*(){if(!C(D,j)){for(O(D,j,1);!r(N=c(C(J,j)));)try{yield N()}catch(e){null==y||y(e)}O(D,j,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))T.call(t,n)&&q(e,n,t[n]);if(M)for(var n of M(t))E.call(t,n)&&q(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>z(void 0,null,(function*(){te(),yield ee(e);try{k=yield l(((e,t)=>z(void 0,null,(function*(){t||e?2!=I&&(Z(1),$++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==y||y(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!r(k),save:ne,startAutoSave:()=>z(void 0,null,(function*(){return le(),yield ne(),B=e.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!r(B),getStatus:()=>I,addStatusListener:e=>W(e,H),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(C(J,j).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:$,saves:G})},g);return p(oe)};var k=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));e.createFilePersister=(e,r,o)=>N(e,(()=>k(void 0,null,(function*(){return e=yield n.readFile(r,l),b(e,((e,t)=>"￼"===t?void 0:t));var e}))),(e=>k(void 0,null,(function*(){return yield n.writeFile(r,(t=e(),g(t,((e,t)=>void 0===t?"￼":t))),l);var t}))),(e=>(t.existsSync(r)||t.writeFileSync(r,"",l),t.watch(r,(()=>e())))),(e=>null==e?void 0:e.close()),o,3,{getFilePath:()=>r})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterFile={},e.fs,e["fs/promises"]);
