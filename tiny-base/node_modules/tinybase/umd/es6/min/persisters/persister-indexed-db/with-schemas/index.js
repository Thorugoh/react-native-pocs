var e,t;e=this,t=function(e){"use strict";const t=Promise,n=globalThis.window,l=clearInterval,r=e=>null==e,o=(e,t,n)=>r(e)?null==n?void 0:n():t(e),i=e=>Array.isArray(e),u=e=>e.length,s=e=>new t(e),a=e=>{return n=function*(){return t.all(e)},new Promise(((e,t)=>{var l=e=>{try{o(n.next(e))}catch(e){t(e)}},r=e=>{try{o(n.throw(e))}catch(e){t(e)}},o=t=>t.done?e(t.value):Promise.resolve(t.value).then(l,r);o((n=n.apply(void 0,null)).next())}));var n},d=e=>{throw Error(e)},c=(e,t)=>e.forEach(t),v=(e,t)=>e.map(t),y=(e,...t)=>e.push(...t),f=e=>e.shift(),p=Object,h=e=>p.getPrototypeOf(e),g=p.entries,b=p.keys,w=p.freeze,m=e=>(e=>!r(e)&&o(h(e),(e=>e==p.prototype||r(h(e))),(()=>!0)))(e)&&0==(e=>u(b(e)))(e),P=e=>r(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),S=(e,t)=>null==e?void 0:e.forEach(t),x=(e,t)=>null==e?void 0:e.delete(t),A=e=>new Map(e),C=(e,t)=>null==e?void 0:e.get(t),j=(e,t,n)=>r(n)?(x(e,t),e):null==e?void 0:e.set(t,n),O=(e,t,n,l)=>{var r,o,i;return o=t,null!=(i=null==(r=e)?void 0:r.has(o))&&i?null==l||l(C(e,t)):j(e,t,n()),C(e,t)},D=(e,t,n,l,r=0)=>o((n?O:C)(e,t[r],r>u(t)-2?n:A),(o=>{if(r>u(t)-2)return(null==l?void 0:l(o))&&j(e,t[r]),o;const i=D(o,t,n,l,r+1);return P(o)&&j(e,t[r]),i})),L=e=>new Set(i(e)||r(e)?e:[e]),M=/^\d+$/;var T=Object.defineProperty,k=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,B=(e,t,n)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,z=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));const $=A(),F=A(),K=(e,t,n,l,s,a,v,p={},h=0,g=[])=>{let b,T,K,N=0,q=0,G=0;O($,g,(()=>0)),O(F,g,(()=>[]));const H=A(),[J,Q,R,U,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!m(e)||!m(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!m(e)||!m(t),t.setContent]:d("Store type not supported by this Persister"))(v,e,h),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?f(e):null)?l:""+t++},t=>{M.test(t)&&u(e)<1e3&&y(e,t)}]})(),l=A();return[(n,r,o,i=[],u=()=>[])=>{null!=e||(e=oe);const s=t(1);var a,d;return j(l,s,[n,r,o,i,u]),d=s,null==(a=D(r,null!=o?o:[""],L))||a.add(d),s},(t,n,...r)=>c(((e,t=[""])=>{const n=[],l=(e,r)=>r==u(t)?y(n,e):null===t[r]?S(e,(e=>l(e,r+1))):c([t[r],null],(t=>l(C(e,t),r+1)));return l(e,0),n})(t,n),(t=>S(t,(t=>C(l,t)[0](e,...null!=n?n:[],...r))))),e=>o(C(l,e),(([,t,r])=>(D(t,null!=r?r:[""],void 0,(t=>(x(t,e),P(t)?1:0))),j(l,e),n(e),r))),t=>o(C(l,t),(([t,,n=[],l,o])=>{const i=(...s)=>{var a,d;const v=u(s);v==u(n)?t(e,...s,...o(s)):r(n[v])?c(null!=(d=null==(a=l[v])?void 0:a.call(l,...s))?d:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),Z=e=>{e!=N&&(N=e,X(H,void 0,N))},_=t=>{(J&&i(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>z(void 0,null,(function*(){return 2!=N&&(Z(1),q++,yield re((()=>z(void 0,null,(function*(){try{const n=yield t();i(n)?_(n):e?V(e):d("Content is not an array: "+n)}catch(t){null==a||a(t),e&&V(e)}Z(0)}))))),oe})),te=()=>(T&&(s(T),T=void 0),oe),ne=e=>z(void 0,null,(function*(){return 1!=N&&(Z(2),G++,yield re((()=>z(void 0,null,(function*(){try{yield n(Q,e)}catch(e){null==a||a(e)}Z(0)}))))),oe})),le=()=>(K&&(e.delListener(K),K=void 0),oe),re=(...e)=>z(void 0,null,(function*(){return y(C(F,g),...e),yield z(void 0,null,(function*(){if(!C($,g)){for(j($,g,1);!r(b=f(C(F,g)));)try{yield b()}catch(e){null==a||a(e)}j($,g,0)}})),oe})),oe=((e,t)=>{for(var n in t||(t={}))E.call(t,n)&&B(e,n,t[n]);if(k)for(var n of k(t))I.call(t,n)&&B(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>z(void 0,null,(function*(){te(),yield ee(e);try{T=yield l(((e,t)=>z(void 0,null,(function*(){t||e?2!=N&&(Z(1),q++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==a||a(e)}return oe})),stopAutoLoad:te,isAutoLoading:()=>!r(T),save:ne,startAutoSave:()=>z(void 0,null,(function*(){return le(),yield ne(),K=e.addDidFinishTransactionListener((()=>{const e=R();U(e)&&ne(e)})),oe})),stopAutoSave:le,isAutoSaving:()=>!r(K),getStatus:()=>N,addStatusListener:e=>W(e,H),delListener:t=>(Y(t),e),schedule:re,getStore:()=>e,destroy:()=>(C(F,g).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:q,saves:G})},p);return w(oe)};var N=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{u(n.next(e))}catch(e){r(e)}},i=e=>{try{u(n.throw(e))}catch(e){r(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,i);u((n=n.apply(e,t)).next())}));const q=["t","v"],G={keyPath:"k"},H=(e,t)=>N(void 0,null,(function*(){const n=(t=>v(g(t),(([t,n])=>J(e,"put",{k:t,v:n}))))(t);v(yield J(e,"getAllKeys"),(l=>((e,t)=>t in e)(t,l)?0:y(n,J(e,"delete",l)))),yield a(n)})),J=(e,t,n)=>N(void 0,null,(function*(){return s(((l,r)=>{const o=e[t](n);o.onsuccess=()=>l(o.result),o.onerror=()=>r(`objectStore.${t} error`)}))}));e.createIndexedDbPersister=(e,t,r=1,o)=>{const i=(e,...l)=>N(void 0,[e,...l],(function*(e,l=[],r=0){return s(((o,i)=>{const u=(n?n.indexedDB:indexedDB).open(t,r?2:void 0);u.onupgradeneeded=()=>r&&v(q,(e=>{try{u.result.createObjectStore(e,G)}catch(e){}})),u.onsuccess=()=>N(void 0,null,(function*(){try{const t=u.result.transaction(q,"readwrite"),n=yield a(v(q,((n,r)=>N(void 0,null,(function*(){return yield e(t.objectStore(n),l[r])})))));u.result.close(),o(n)}catch(e){u.result.close(),i(e)}})),u.onerror=()=>i("indexedDB.open error")}))}));return K(e,(()=>N(void 0,null,(function*(){return yield i((e=>N(void 0,null,(function*(){return((e=[])=>p.fromEntries(e))(v(yield J(e,"getAll"),(({k:e,v:t})=>[e,t])))}))))}))),(e=>N(void 0,null,(function*(){return yield i(((e,t)=>N(void 0,null,(function*(){return yield H(e,t)}))),e(),1)}))),(e=>setInterval(e,1e3*r)),(e=>l(e)),o,1,{getDbName:()=>t})},e.objectStoreMatch=H},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterIndexedDb={});
