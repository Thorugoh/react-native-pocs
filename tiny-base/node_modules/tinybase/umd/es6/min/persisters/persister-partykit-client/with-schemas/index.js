var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n="",r=t(n),o="message",l=e=>null==e,i=(e,t,n)=>l(e)?null==n?void 0:n():t(e),s=e=>t(e)==r,a=e=>Array.isArray(e),u=e=>e.length,d=e=>{throw Error(e)},c=(e,t)=>e.forEach(t),v=(e,...t)=>e.push(...t),y=e=>e.shift(),p=Object,f=e=>p.getPrototypeOf(e),h=p.keys,g=p.freeze,b=e=>(e=>!l(e)&&i(f(e),(e=>e==p.prototype||l(f(e))),(()=>!0)))(e)&&0==(e=>u(h(e)))(e),P=JSON.stringify,m=JSON.parse,O=e=>P(e,((e,t)=>t instanceof Map?p.fromEntries([...t]):t)),S="/store",w=e=>l(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),j=(e,t)=>null==e?void 0:e.forEach(t),C=(e,t)=>null==e?void 0:e.delete(t),A=e=>new Map(e),L=(e,t)=>null==e?void 0:e.get(t),x=(e,t,n)=>l(n)?(C(e,t),e):null==e?void 0:e.set(t,n),E=(e,t,n,r)=>{var o,l,i;return l=t,null!=(i=null==(o=e)?void 0:o.has(l))&&i?null==r||r(L(e,t)):x(e,t,n()),L(e,t)},M=(e,t,n,r,o=0)=>i((n?E:L)(e,t[o],o>u(t)-2?n:A),(l=>{if(o>u(t)-2)return(null==r?void 0:r(l))&&x(e,t[o]),l;const i=M(l,t,n,r,o+1);return w(l)&&x(e,t[o]),i})),T=e=>new Set(a(e)||l(e)?e:[e]),D=/^\d+$/;var k=Object.defineProperty,z=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable,K=(e,t,n)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,N=(e,t,n)=>new Promise(((r,o)=>{var l=e=>{try{s(n.next(e))}catch(e){o(e)}},i=e=>{try{s(n.throw(e))}catch(e){o(e)}},s=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,i);s((n=n.apply(e,t)).next())}));const B=A(),F=A(),U=(e,t,r,o,s,p,f,h={},P=0,m=[])=>{let O,S,k,U=0,W=0,$=0;E(B,m,(()=>0)),E(F,m,(()=>[]));const q=A(),[G,H,Q,R,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!b(e)||!b(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!b(e)||!b(t),t.setContent]:d("Store type not supported by this Persister"))(f,e,P),[X,Y,Z]=(()=>{let e;const[t,r]=(()=>{const e=[];let t=0;return[r=>{var o;return null!=(o=r?y(e):null)?o:n+t++},t=>{D.test(t)&&u(e)<1e3&&v(e,t)}]})(),o=A();return[(r,l,i,s=[],a=()=>[])=>{null!=e||(e=ie);const u=t(1);var d,c;return x(o,u,[r,l,i,s,a]),c=u,null==(d=M(l,null!=i?i:[n],T))||d.add(c),u},(t,r,...l)=>c(((e,t=[n])=>{const r=[],o=(e,n)=>n==u(t)?v(r,e):null===t[n]?j(e,(e=>o(e,n+1))):c([t[n],null],(t=>o(L(e,t),n+1)));return o(e,0),r})(t,r),(t=>j(t,(t=>L(o,t)[0](e,...null!=r?r:[],...l))))),e=>i(L(o,e),(([,t,l])=>(M(t,null!=l?l:[n],void 0,(t=>(C(t,e),w(t)?1:0))),x(o,e),r(e),l))),t=>i(L(o,t),(([t,,n=[],r,o])=>{const i=(...s)=>{var a,d;const v=u(s);v==u(n)?t(e,...s,...o(s)):l(n[v])?c(null!=(d=null==(a=r[v])?void 0:a.call(r,...s))?d:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),_=e=>{e!=U&&(U=e,Y(q,void 0,U))},ee=t=>{(G&&a(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},te=e=>N(void 0,null,(function*(){return 2!=U&&(_(1),W++,yield le((()=>N(void 0,null,(function*(){try{const n=yield t();a(n)?ee(n):e?V(e):d("Content is not an array: "+n)}catch(t){null==p||p(t),e&&V(e)}_(0)}))))),ie})),ne=()=>(S&&(s(S),S=void 0),ie),re=e=>N(void 0,null,(function*(){return 1!=U&&(_(2),$++,yield le((()=>N(void 0,null,(function*(){try{yield r(H,e)}catch(e){null==p||p(e)}_(0)}))))),ie})),oe=()=>(k&&(e.delListener(k),k=void 0),ie),le=(...e)=>N(void 0,null,(function*(){return v(L(F,m),...e),yield N(void 0,null,(function*(){if(!L(B,m)){for(x(B,m,1);!l(O=y(L(F,m)));)try{yield O()}catch(e){null==p||p(e)}x(B,m,0)}})),ie})),ie=((e,t)=>{for(var n in t||(t={}))I.call(t,n)&&K(e,n,t[n]);if(z)for(var n of z(t))J.call(t,n)&&K(e,n,t[n]);return e})({load:te,startAutoLoad:e=>N(void 0,null,(function*(){ne(),yield te(e);try{S=yield o(((e,t)=>N(void 0,null,(function*(){t||e?2!=U&&(_(1),W++,ee(null!=t?t:e),_(0)):yield te()}))))}catch(e){null==p||p(e)}return ie})),stopAutoLoad:ne,isAutoLoading:()=>!l(S),save:re,startAutoSave:()=>N(void 0,null,(function*(){return oe(),yield re(),k=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&re(e)})),ie})),stopAutoSave:oe,isAutoSaving:()=>!l(k),getStatus:()=>U,addStatusListener:e=>X(e,q),delListener:t=>(Z(t),e),schedule:le,getStore:()=>e,destroy:()=>(L(F,m).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:W,saves:$})},h);return g(ie)};var W=Object.defineProperty,$=Object.defineProperties,q=Object.getOwnPropertyDescriptors,G=Object.getOwnPropertySymbols,H=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable,R=(e,t,n)=>t in e?W(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,V=(e,t)=>{for(var n in t||(t={}))H.call(t,n)&&R(e,n,t[n]);if(G)for(var n of G(t))Q.call(t,n)&&R(e,n,t[n]);return e},X=(e,t,n)=>new Promise(((r,o)=>{var l=e=>{try{s(n.next(e))}catch(e){o(e)}},i=e=>{try{s(n.throw(e))}catch(e){o(e)}},s=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,i);s((n=n.apply(e,t)).next())}));e.createPartyKitPersister=(e,t,r,l)=>{const{host:a,room:d}=t.partySocketOptions,{storeProtocol:c="https",storePath:v=S,messagePrefix:y=n}=V({},s(r)?{storeProtocol:r}:r),p=c+"://"+a+"/parties/"+t.name+"/"+d+v,f=e=>X(void 0,null,(function*(){return yield(yield fetch(p,(t=V({},e?{method:"PUT",body:O(e)}:{}),n={mode:"cors",cache:"no-store"},$(t,q(n))))).json();var t,n}));return U(e,(()=>X(void 0,null,(function*(){return yield f()}))),((e,n)=>X(void 0,null,(function*(){var r;n?t.send(y+"s"+(s(r=n)?r:O(r))):yield f(e())}))),(e=>{const n=t=>i(((e,t)=>{const n=u(e);return((e,t)=>e.startsWith(t))(t,e)?[t[n],m((r=t,o=n+1,r.slice(o,void 0)))]:void 0;var r,o})(y,t.data),(([t,n])=>{"s"==t&&e(void 0,n)}));return t.addEventListener(o,n),n}),(e=>{t.removeEventListener(o,e)}),l,1,{getConnection:()=>t})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPartyKitClient={});
