var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,n=t(""),r="t",i=(e,t)=>e.startsWith(t),l=Promise,o=e=>null==e,s=(e,t,n)=>o(e)?null==n?void 0:n():t(e),u=(e,t,n)=>e.slice(t,n),a=e=>e.length,c=e=>{return t=function*(){return l.all(e)},new Promise(((e,n)=>{var r=e=>{try{l(t.next(e))}catch(e){n(e)}},i=e=>{try{l(t.throw(e))}catch(e){n(e)}},l=t=>t.done?e(t.value):Promise.resolve(t.value).then(r,i);l((t=t.apply(void 0,null)).next())}));var t},d=(e,t)=>e.map(t),f=(e,...t)=>e.push(...t),h=Object,y=h.entries,g=(e=[])=>h.fromEntries(e),v=(e,t)=>d(y(e),(([e,n])=>t(n,e))),p=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),P=JSON.stringify,m=JSON.parse,S=e=>P(e,((e,t)=>t instanceof Map?h.fromEntries([...t]):t)),x=(e,r,i)=>e+r+(t(i)==n?i:S(i)),b=(e,t,n)=>{const r=a(e);return i(t,e)?[t[r],(n?m:String)(u(t,r+1))]:void 0},w=(e,t)=>((e,t)=>null==e?void 0:e.forEach(t))(e,((e,n)=>t(n,e)));var T=Object.defineProperty,D=(e,t,n)=>new Promise(((r,i)=>{var l=e=>{try{s(n.next(e))}catch(e){i(e)}},o=e=>{try{s(n.throw(e))}catch(e){i(e)}},s=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,o);s((n=n.apply(e,t)).next())}));const R="hasStore",C=g(d(["Origin","Methods","Headers"],(e=>["Access-Control-Allow-"+e,"*"]))),O=(e,...t)=>D(void 0,[e,...t],(function*(e,t=""){return!!(yield e.get(t+R))})),H=(e,...t)=>D(void 0,[e,...t],(function*(e,t=""){const n={},i={};return w(yield e.list(),((e,l)=>s(b(t,e),(([e,t])=>{if(e==r){const[e,r,i]=m("["+t+"]");p(p(n,e,g),r,g)[i]=l}else"v"==e&&(i[t]=l)})))),[n,i]})),V=(e,t,n)=>D(void 0,null,(function*(){return e.party.broadcast(x(e.config.messagePrefix,"s",t),n)})),j=(e,t,n,l)=>D(void 0,null,(function*(){const s=e.party.storage,u=e.config.storagePrefix,d={[u+R]:1},h=[],y=[];yield c(v(t[0],((t,i)=>D(void 0,null,(function*(){return o(t)?!n&&(yield e.canDelTable(i,l))&&((e,...t)=>e.unshift(...t))(y,E(u,r,i)):(yield e.canSetTable(i,n,l))&&(yield c(v(t,((t,a)=>D(void 0,null,(function*(){return o(t)?!n&&(yield e.canDelRow(i,a,l))&&f(y,E(u,r,i,a)):(yield e.canSetRow(i,a,n,l))&&(yield c(v(t,((t,c)=>D(void 0,null,(function*(){const y=[i,a,c],g=E(u,r,...y);o(t)?!n&&(yield e.canDelCell(...y,l))&&f(h,g):(yield e.canSetCell(...y,t,n,l,yield s.get(g)))&&(d[g]=t)}))))))}))))))}))))),yield c(v(t[1],((t,r)=>D(void 0,null,(function*(){const i=u+"v"+r;o(t)?!n&&(yield e.canDelValue(r,l))&&f(h,i):(yield e.canSetValue(r,t,n,l,yield s.get(i)))&&(d[i]=t)}))))),0!=a(y)&&w(yield s.list(),(e=>y.every((t=>!i(e,t)||f(h,e)&&0)))),yield s.delete(h),yield s.put(d)})),E=(e,t,...n)=>x(e,t,u(S(n),1,-1)),M=(e,t,n=null)=>D(void 0,null,(function*(){return new Response(n,{status:t,headers:e.config.responseHeaders})}));e.TinyBasePartyKitServer=class{constructor(e){var t,n,r,i,l,o,s;this.party=e,s={},(o="config")in(l=this)?T(l,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[o]=s,null!=(t=this.config).storePath||(t.storePath="/store"),null!=(n=this.config).messagePrefix||(n.messagePrefix=""),null!=(r=this.config).storagePrefix||(r.storagePrefix=""),null!=(i=this.config).responseHeaders||(i.responseHeaders=C)}onRequest(e){return D(this,null,(function*(){const{party:{storage:t},config:{storePath:n,storagePrefix:r}}=this;if(new URL(e.url).pathname.endsWith(n)){const n=yield O(t,r),i=yield e.text();return"PUT"==e.method?n?M(this,205):(yield j(this,m(i),!0,e),M(this,201)):M(this,200,n?S(yield H(t,r)):"")}return M(this,404)}))}onMessage(e,t){return D(this,null,(function*(){const{config:{messagePrefix:n,storagePrefix:r}}=this;yield s(b(n,e,1),(e=>D(this,[e],(function*([e,n]){"s"==e&&(yield O(this.party.storage,r))&&(yield j(this,n,!1,t),V(this,n,[t.id]))}))))}))}canSetTable(e,t,n){return D(this,null,(function*(){return!0}))}canDelTable(e,t){return D(this,null,(function*(){return!0}))}canSetRow(e,t,n,r){return D(this,null,(function*(){return!0}))}canDelRow(e,t,n){return D(this,null,(function*(){return!0}))}canSetCell(e,t,n,r,i,l,o){return D(this,null,(function*(){return!0}))}canDelCell(e,t,n,r){return D(this,null,(function*(){return!0}))}canSetValue(e,t,n,r,i){return D(this,null,(function*(){return!0}))}canDelValue(e,t){return D(this,null,(function*(){return!0}))}},e.broadcastChanges=V,e.hasStoreInStorage=O,e.loadStoreFromStorage=H},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPartyKitServer={});
