var e,n;e=this,n=function(e){"use strict";const n=e=>typeof e,l="tinybase",t=",",o=n(""),r=Promise,i=e=>null==e,u=(e,n,l)=>i(e)?null==l?void 0:l():n(e),d=e=>n(e)==o,a=e=>Array.isArray(e),c=(e,n,l)=>e.slice(n,l),s=e=>e.length,v=e=>{return n=function*(){return r.all(e)},new Promise(((e,l)=>{var t=e=>{try{r(n.next(e))}catch(e){l(e)}},o=e=>{try{r(n.throw(e))}catch(e){l(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);r((n=n.apply(void 0,null)).next())}));var n},y=e=>{throw Error(e)},E=(e,n)=>e.forEach(n),f=(e,n="")=>e.join(n),p=(e,n)=>e.map(n),h=e=>0==s(e),T=(e,n)=>e.filter(n),R=(e,...n)=>e.push(...n),A=e=>e.shift(),m="_",N="_id",g="SELECT",O="WHERE",P="TABLE",C="ALTER "+P,b="DELETE FROM",L=g+"*FROM",$=e=>`"${e.replace(/"/g,'""')}"`,S=(e,n=[1])=>f(p(e,(()=>"$"+n[0]++)),t),I=(e,n)=>{var l;return null!=(l=null==e?void 0:e.has(n))&&l},_=e=>i(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),w=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},x=(e,n)=>null==e?void 0:e.forEach(n),D=(e,n)=>null==e?void 0:e.delete(n),U=Object,F=e=>U.getPrototypeOf(e),M=U.entries,G=U.keys,j=U.freeze,B=(e=[])=>U.fromEntries(e),X=(...e)=>U.assign({},...e),Y=(e,n)=>(delete e[n],e),q=(e,n)=>p(M(e),(([e,l])=>n(l,e))),H=(e,n)=>B(q(e,((e,l)=>[l,n(e,l)]))),W=e=>U.values(e),k=e=>s(G(e)),z=e=>(e=>!i(e)&&u(F(e),(e=>e==U.prototype||i(F(e))),(()=>!0)))(e)&&0==k(e),J=JSON.stringify,K=JSON.parse,V=e=>new Map(e),Q=(e,n)=>null==e?void 0:e.get(n),Z=(e,n)=>{var l;return p([...null!=(l=null==e?void 0:e.entries())?l:[]],(([e,l])=>n(l,e)))},ee=(e,n,l)=>i(l)?(D(e,n),e):null==e?void 0:e.set(n,l),ne=(e,n,l,t)=>(I(e,n)?null==t||t(Q(e,n)):ee(e,n,l()),Q(e,n)),le=(e,n,l,t,o=0)=>u((l?ne:Q)(e,n[o],o>s(n)-2?l:V),(r=>{if(o>s(n)-2)return(null==t?void 0:t(r))&&ee(e,n[o]),r;const i=le(r,n,l,t,o+1);return _(r)&&ee(e,n[o]),i})),te=e=>new Set(a(e)||i(e)?e:[e]),oe=(e,n)=>null==e?void 0:e.add(n),re=/^\d+$/;var ie=Object.defineProperty,ue=Object.getOwnPropertySymbols,de=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable,ce=(e,n,l)=>n in e?ie(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l,se=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const ve=V(),ye=V(),Ee=(e,n,l,t,o,r,d,c={},v=0,f=[])=>{let p,h,T,m=0,N=0,g=0;ne(ve,f,(()=>0)),ne(ye,f,(()=>[]));const O=V(),[P,C,b,L,$]=((e=1,n,l)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!l),([[e],[n]])=>!z(e)||!z(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!z(e)||!z(n),n.setContent]:y("Store type not supported by this Persister"))(d,e,v),[S,I,w]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var t;return null!=(t=l?A(e):null)?t:""+n++},n=>{re.test(n)&&s(e)<1e3&&R(e,n)}]})(),t=V();return[(l,o,r,i=[],u=()=>[])=>{null!=e||(e=q);const d=n(1);return ee(t,d,[l,o,r,i,u]),oe(le(o,null!=r?r:[""],te),d),d},(n,l,...o)=>E(((e,n=[""])=>{const l=[],t=(e,o)=>o==s(n)?R(l,e):null===n[o]?x(e,(e=>t(e,o+1))):E([n[o],null],(n=>t(Q(e,n),o+1)));return t(e,0),l})(n,l),(n=>x(n,(n=>Q(t,n)[0](e,...null!=l?l:[],...o))))),e=>u(Q(t,e),(([,n,o])=>(le(n,null!=o?o:[""],void 0,(n=>(D(n,e),_(n)?1:0))),ee(t,e),l(e),o))),n=>u(Q(t,n),(([n,,l=[],t,o])=>{const r=(...u)=>{var d,a;const c=s(u);c==s(l)?n(e,...u,...o(u)):i(l[c])?E(null!=(a=null==(d=t[c])?void 0:d.call(t,...u))?a:[],(e=>r(...u,e))):r(...u,l[c])};r()}))]})(),U=e=>{e!=m&&(m=e,I(O,void 0,m))},F=n=>{(P&&a(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},M=e=>se(void 0,null,(function*(){return 2!=m&&(U(1),N++,yield Y((()=>se(void 0,null,(function*(){try{const l=yield n();a(l)?F(l):e?$(e):y("Content is not an array: "+l)}catch(n){null==r||r(n),e&&$(e)}U(0)}))))),q})),G=()=>(h&&(o(h),h=void 0),q),B=e=>se(void 0,null,(function*(){return 1!=m&&(U(2),g++,yield Y((()=>se(void 0,null,(function*(){try{yield l(C,e)}catch(e){null==r||r(e)}U(0)}))))),q})),X=()=>(T&&(e.delListener(T),T=void 0),q),Y=(...e)=>se(void 0,null,(function*(){return R(Q(ye,f),...e),yield se(void 0,null,(function*(){if(!Q(ve,f)){for(ee(ve,f,1);!i(p=A(Q(ye,f)));)try{yield p()}catch(e){null==r||r(e)}ee(ve,f,0)}})),q})),q=((e,n)=>{for(var l in n||(n={}))de.call(n,l)&&ce(e,l,n[l]);if(ue)for(var l of ue(n))ae.call(n,l)&&ce(e,l,n[l]);return e})({load:M,startAutoLoad:e=>se(void 0,null,(function*(){G(),yield M(e);try{h=yield t(((e,n)=>se(void 0,null,(function*(){n||e?2!=m&&(U(1),N++,F(null!=n?n:e),U(0)):yield M()}))))}catch(e){null==r||r(e)}return q})),stopAutoLoad:G,isAutoLoading:()=>!i(h),save:B,startAutoSave:()=>se(void 0,null,(function*(){return X(),yield B(),T=e.addDidFinishTransactionListener((()=>{const e=b();L(e)&&B(e)})),q})),stopAutoSave:X,isAutoSaving:()=>!i(T),getStatus:()=>m,addStatusListener:e=>S(e,O),delListener:n=>(w(n),e),schedule:Y,getStore:()=>e,destroy:()=>(Q(ye,f).splice(0,void 0),G().stopAutoSave()),getStats:()=>({loads:N,saves:g})},c);return j(q)};var fe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const pe=(e,n,l,o,r,u=he,d,a)=>{const c=V();return[()=>fe(void 0,null,(function*(){c.clear(),p(yield l(e,n),(({tn:e,cn:n})=>oe(ne(c,e,te),n)))})),(n,l)=>fe(void 0,null,(function*(){return((e,n)=>I(Q(c,e),n))(n,l)?B(T(p(yield e(L+$(n)),(e=>[e[l],a?H(Y(e,l),a):Y(e,l)])),(([e,n])=>!i(e)&&!z(n)))):{}})),(n,l,o,a,s,y=!1)=>fe(void 0,null,(function*(){const E=te();H(null!=o?o:{},(e=>p(G(null!=e?e:{}),(e=>oe(E,e)))));const A=w(E);if(!y&&s&&h(A)&&I(c,n))return yield e("DROP "+P+$(n)),void ee(c,n);const m=Q(c,n),N=te(w(m));if(h(A)||(I(c,n)?yield v(p([l,...A],((t,o)=>fe(void 0,null,(function*(){D(N,t)||(yield e(C+$(n)+"ADD"+$(t)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+$(n)+`(${$(l)})`)),oe(m,t))}))))):(yield e("CREATE "+P+$(n)+`(${$(l)}${r} PRIMARY KEY${f(p(A,(e=>t+$(e)+r)))});`),ee(c,n,te([l,...A])))),yield v([...!y&&a?p(w(N),(t=>fe(void 0,null,(function*(){t!=l&&(yield e(C+$(n)+"DROP"+$(t)),D(m,t))})))):[]]),y)i(o)?yield e(b+$(n)+O+" true"):yield v(q(o,((t,o)=>fe(void 0,null,(function*(){i(t)?yield e(b+$(n)+O+$(l)+"=$1",[o]):h(A)||(yield u(e,n,l,G(t),{[o]:d?p(W(t),d):W(t)},m))})))));else if(h(A))I(c,n)&&(yield e(b+$(n)+O+" true"));else{const t=T(w(Q(c,n)),(e=>e!=l)),r={},i=[];H(null!=o?o:{},((e,n)=>{r[n]=p(t,(n=>d?d(null==e?void 0:e[n]):null==e?void 0:e[n])),R(i,n)})),yield u(e,n,l,t,r),yield e(b+$(n)+O+$(l)+`NOT IN(${S(i)})`,i)}})),n=>fe(void 0,null,(function*(){let l;yield e("BEGIN");try{l=yield n()}catch(e){null==o||o(e)}return yield e("END"),l}))]},he=(e,n,l,o,r)=>fe(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+$(n)+"("+((...e)=>f(p(e,$),t))(l,...o)+")VALUES"+f(q(r,(e=>"($"+i[0]+++","+S(e,i)+")")),t)+"ON CONFLICT("+$(l)+")DO UPDATE SET"+f(p(o,(e=>$(e)+"=excluded."+$(e))),t),q(r,((e,n)=>[n,...p(e,(e=>null!=e?e:null))])).flat())}));var Te=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Re=(e,n,l,t,o,r,i,[u,d,a],c,s,v,y,E,f)=>{const[p,h,T,R]=pe(n,c,s,o,E,f),A=Ee(e,(()=>Te(void 0,null,(function*(){return yield R((()=>Te(void 0,null,(function*(){var e,n,l;return yield p(),l=null!=(n=null==(e=(yield h(u,d))[m])?void 0:e[a])?n:"null",K(l,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>Te(void 0,null,(function*(){return yield R((()=>Te(void 0,null,(function*(){var n,l;yield p(),yield T(u,d,{[m]:{[a]:(l=null!=(n=e())?n:null,J(l,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),l,t,o,i,{[y]:()=>v,destroy:()=>(A.stopAutoLoad().stopAutoSave(),r(),A)},0,v);return A};var Ae=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const me=(e,n,l,t,o,r,u,[d,a,[c,s,y]],E,f,p,h,R,A,g,O)=>{const[P,C,b,L]=pe(n,E,f,o,R,A,g,O),$=(e,n)=>Ae(void 0,null,(function*(){return yield v(Z(a,((l,t)=>Ae(void 0,[l,t],(function*([l,t,o,r],i){n&&!(i in e)||(yield b(l,t,e[i],o,r,n))})))))})),S=(e,n)=>Ae(void 0,null,(function*(){return s?yield b(y,N,{[m]:e},!0,!0,n):null})),I=Ee(e,(()=>Ae(void 0,null,(function*(){return yield L((()=>Ae(void 0,null,(function*(){yield P();const e=yield Ae(void 0,null,(function*(){return B(T(yield v(Z(d,((e,n)=>Ae(void 0,[e,n],(function*([e,n],l){return[e,yield C(l,n)]}))))),(e=>!z(e[1]))))})),n=yield Ae(void 0,null,(function*(){return c?(yield C(y,N))[m]:{}}));return z(e)&&i(n)?void 0:[e,n]}))))}))),((e,n)=>Ae(void 0,null,(function*(){return yield L((()=>Ae(void 0,null,(function*(){if(yield P(),i(n)){const[n,l]=e();yield $(n),yield S(l)}else yield $(n[0],!0),yield S(n[1],!0)}))))}))),l,t,o,u,{[h]:()=>p,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,p);return I},Ne="ColumnName",ge="store",Oe="json",Pe=ge+"TableName",Ce=ge+"Id"+Ne,be=ge+Ne,Le="autoLoadIntervalSeconds",$e="rowId"+Ne,Se="tableId",Ie="tableName",_e="deleteEmptyColumns",we="deleteEmptyTable",xe={mode:Oe,[Le]:1},De={load:0,save:0,[Ie]:l+"_values"},Ue=(e,n,l,t,o)=>{const r=V();return H(e,((e,u)=>{const a=c(W(X(n,d(e)?{[l]:e}:e)),0,k(n));i(a[0])||t(u,a[0])||(o(u,a[0]),ee(r,u,a))})),r};var Fe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Me=l,Ge=/^([cd]:)(.+)/,je=l+"_data",Be=l+"_table";var Xe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));e.createPostgresPersister=(e,n,t,o,r)=>Xe(void 0,null,(function*(){var i;const a=yield null==(i=n.reserve)?void 0:i.call(n);return((e,n,t,o,r,i,a,s,y,E,f="getDb")=>{const h=((e,n)=>n?(l,t)=>{return o=function*(){return n(l,t),yield e(l,t)},new Promise(((e,n)=>{var l=e=>{try{r(o.next(e))}catch(e){n(e)}},t=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,t);r((o=o.apply(void 0,null)).next())}));var o}:e)(t,i),[T,,R,A]=(e=>{var n,t,o;const r=(e=>X(xe,d(e)?{[Pe]:e}:null!=e?e:{}))(e),i=r[Le];if(r.mode==Oe){const e=null!=(n=r[Pe])?n:l;return[1,i,[e,null!=(t=r[Ce])?t:N,null!=(o=r[be])?o:ge],te(e)]}const{tables:{load:u={},save:a={}}={},values:s={}}=r,v=c(W(X(De,s)),0,k(De)),y=v[2],E=te(y),f=te(y);return[0,i,[Ue(u,{[Se]:null,[$e]:N},Se,(e=>I(f,e)),(e=>oe(E,e))),Ue(a,{[Ie]:null,[$e]:N,[_e]:0,[we]:0},Ie,((e,n)=>I(f,n)),((e,n)=>oe(E,n))),v],E]})(n),m=e=>Fe(void 0,null,(function*(){yield h(`CREATE OR REPLACE TRIGGER ${$(je+"_"+e)} AFTER INSERT OR UPDATE OR DELETE ON ${$(e)} EXECUTE FUNCTION ${je}()`)}));return(T?Re:me)(e,h,(e=>Fe(void 0,null,(function*(){yield h(`CREATE OR REPLACE FUNCTION ${Be}()RETURNS event_trigger AS $t2$ DECLARE row record; BEGIN FOR row IN SELECT object_identity FROM pg_event_trigger_ddl_commands()WHERE command_tag='CREATE TABLE' LOOP PERFORM pg_notify('${Me}','c:'||SPLIT_PART(row.object_identity,'.',2));END LOOP;END;$t2$ LANGUAGE plpgsql;`);try{yield h(`CREATE EVENT TRIGGER ${Be} ON ddl_command_end WHEN TAG IN('CREATE TABLE')EXECUTE FUNCTION ${Be}();`)}catch(e){}return yield h(`CREATE OR REPLACE FUNCTION ${je}()RETURNS trigger AS $t1$ BEGIN PERFORM pg_notify('${Me}','d:'||TG_TABLE_NAME);RETURN NULL;END;$t1$ LANGUAGE plpgsql;`),yield v(p(w(A),(e=>Fe(void 0,null,(function*(){yield h(`CREATE TABLE IF NOT EXISTS ${$(e)}("_id"text PRIMARY KEY)`),yield m(e)}))))),yield o(Me,(n=>Fe(void 0,null,(function*(){return yield u((l=n,t=Ge,null==l?void 0:l.match(t)),(n=>Fe(void 0,[n],(function*([,n,l]){I(A,l)&&("c:"==n&&(yield m(l)),e())}))));var l,t}))))}))),r,a,s,y,R,w(A),((e,n)=>Fe(void 0,null,(function*(){return yield e(`${g} table_name tn,column_name cn FROM information_schema.columns ${O} table_schema='public'AND table_name IN(${S(n)})`,n)}))),E,f,"text",void 0,(e=>J(e)),(e=>K(e)))})(e,t,null==a?void 0:a.unsafe,((e,l)=>Xe(void 0,null,(function*(){return n.listen(e,l)}))),(e=>Xe(void 0,null,(function*(){try{yield e.unlisten()}catch(e){null==r||r(e)}}))),o,r,(()=>{var e;return null==(e=null==a?void 0:a.release)?void 0:e.call(a)}),3,n,"getSql")}))},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPostgres={});
