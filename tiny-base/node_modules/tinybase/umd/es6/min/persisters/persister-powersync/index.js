var e,n;e=this,n=function(e){"use strict";const n=e=>typeof e,l="tinybase",t="",o=",",r=n(t),i=Promise,u=clearInterval,a=e=>null==e,d=(e,n,l)=>a(e)?null==l?void 0:l():n(e),s=e=>n(e)==r,c=e=>Array.isArray(e),v=(e,n,l)=>e.slice(n,l),y=e=>e.length,f=e=>{return n=function*(){return i.all(e)},new Promise(((e,l)=>{var t=e=>{try{r(n.next(e))}catch(e){l(e)}},o=e=>{try{r(n.throw(e))}catch(e){l(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,o);r((n=n.apply(void 0,null)).next())}));var n},h=e=>{throw Error(e)},p=(e,n)=>e.forEach(n),m=(e,n="")=>e.join(n),E=(e,n)=>e.map(n),g=e=>0==y(e),b=(e,n)=>e.filter(n),P=(e,...n)=>e.push(...n),w=e=>e.shift(),S=Object,A=e=>S.getPrototypeOf(e),O=S.entries,T=S.keys,N=S.freeze,x=(e=[])=>S.fromEntries(e),C=(...e)=>S.assign({},...e),$=(e,n)=>(delete e[n],e),I=(e,n)=>E(O(e),(([e,l])=>n(l,e))),L=(e,n)=>x(I(e,((e,l)=>[l,n(e,l)]))),R=e=>S.values(e),D=e=>y(T(e)),M=e=>(e=>!a(e)&&d(A(e),(e=>e==S.prototype||a(A(e))),(()=>!0)))(e)&&0==D(e),_=e=>new Set(c(e)||a(e)?e:[e]),j=(e,n)=>null==e?void 0:e.add(n),F="_",U="_id",B="SELECT",H="WHERE",J="TABLE",Y="ALTER "+J,k="DELETE FROM",z=B+"*FROM",G="pragma_",V="data_version",W="schema_version",K="pragma_table_",Q=e=>`"${e.replace(/"/g,'""')}"`,X=(...e)=>m(E(e,Q),o),q=(e,n=[1])=>m(E(e,(()=>"$"+n[0]++)),o),Z=(e,n)=>{var l;return null!=(l=null==e?void 0:e.has(n))&&l},ee=e=>a(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),ne=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},le=(e,n)=>null==e?void 0:e.forEach(n),te=(e,n)=>null==e?void 0:e.delete(n),oe=JSON.stringify,re=JSON.parse,ie=e=>new Map(e),ue=(e,n)=>null==e?void 0:e.get(n),ae=(e,n)=>{var l;return E([...null!=(l=null==e?void 0:e.entries())?l:[]],(([e,l])=>n(l,e)))},de=(e,n,l)=>a(l)?(te(e,n),e):null==e?void 0:e.set(n,l),se=(e,n,l,t)=>(Z(e,n)?null==t||t(ue(e,n)):de(e,n,l()),ue(e,n)),ce=(e,n,l,t,o=0)=>d((l?se:ue)(e,n[o],o>y(n)-2?l:ie),(r=>{if(o>y(n)-2)return(null==t?void 0:t(r))&&de(e,n[o]),r;const i=ce(r,n,l,t,o+1);return ee(r)&&de(e,n[o]),i})),ve=/^\d+$/;var ye=Object.defineProperty,fe=Object.getOwnPropertySymbols,he=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable,me=(e,n,l)=>n in e?ye(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l,Ee=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const ge=ie(),be=ie(),Pe=(e,n,l,o,r,i,u,s={},v=0,f=[])=>{let m,E,g,b=0,S=0,A=0;se(ge,f,(()=>0)),se(be,f,(()=>[]));const O=ie(),[T,x,C,$,I]=((e=1,n,l)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!l),([[e],[n]])=>!M(e)||!M(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!M(e)||!M(n),n.setContent]:h("Store type not supported by this Persister"))(u,e,v),[L,R,D]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var o;return null!=(o=l?w(e):null)?o:t+n++},n=>{ve.test(n)&&y(e)<1e3&&P(e,n)}]})(),o=ie();return[(l,r,i,u=[],a=()=>[])=>{null!=e||(e=z);const d=n(1);return de(o,d,[l,r,i,u,a]),j(ce(r,null!=i?i:[t],_),d),d},(n,l,...r)=>p(((e,n=[t])=>{const l=[],o=(e,t)=>t==y(n)?P(l,e):null===n[t]?le(e,(e=>o(e,t+1))):p([n[t],null],(n=>o(ue(e,n),t+1)));return o(e,0),l})(n,l),(n=>le(n,(n=>ue(o,n)[0](e,...null!=l?l:[],...r))))),e=>d(ue(o,e),(([,n,r])=>(ce(n,null!=r?r:[t],void 0,(n=>(te(n,e),ee(n)?1:0))),de(o,e),l(e),r))),n=>d(ue(o,n),(([n,,l=[],t,o])=>{const r=(...i)=>{var u,d;const s=y(i);s==y(l)?n(e,...i,...o(i)):a(l[s])?p(null!=(d=null==(u=t[s])?void 0:u.call(t,...i))?d:[],(e=>r(...i,e))):r(...i,l[s])};r()}))]})(),F=e=>{e!=b&&(b=e,R(O,void 0,b))},U=n=>{(T&&c(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},B=e=>Ee(void 0,null,(function*(){return 2!=b&&(F(1),S++,yield k((()=>Ee(void 0,null,(function*(){try{const l=yield n();c(l)?U(l):e?I(e):h("Content is not an array: "+l)}catch(n){null==i||i(n),e&&I(e)}F(0)}))))),z})),H=()=>(E&&(r(E),E=void 0),z),J=e=>Ee(void 0,null,(function*(){return 1!=b&&(F(2),A++,yield k((()=>Ee(void 0,null,(function*(){try{yield l(x,e)}catch(e){null==i||i(e)}F(0)}))))),z})),Y=()=>(g&&(e.delListener(g),g=void 0),z),k=(...e)=>Ee(void 0,null,(function*(){return P(ue(be,f),...e),yield Ee(void 0,null,(function*(){if(!ue(ge,f)){for(de(ge,f,1);!a(m=w(ue(be,f)));)try{yield m()}catch(e){null==i||i(e)}de(ge,f,0)}})),z})),z=((e,n)=>{for(var l in n||(n={}))he.call(n,l)&&me(e,l,n[l]);if(fe)for(var l of fe(n))pe.call(n,l)&&me(e,l,n[l]);return e})({load:B,startAutoLoad:e=>Ee(void 0,null,(function*(){H(),yield B(e);try{E=yield o(((e,n)=>Ee(void 0,null,(function*(){n||e?2!=b&&(F(1),S++,U(null!=n?n:e),F(0)):yield B()}))))}catch(e){null==i||i(e)}return z})),stopAutoLoad:H,isAutoLoading:()=>!a(E),save:J,startAutoSave:()=>Ee(void 0,null,(function*(){return Y(),yield J(),g=e.addDidFinishTransactionListener((()=>{const e=C();$(e)&&J(e)})),z})),stopAutoSave:Y,isAutoSaving:()=>!a(g),getStatus:()=>b,addStatusListener:e=>L(e,O),delListener:n=>(D(n),e),schedule:k,getStore:()=>e,destroy:()=>(ue(be,f).splice(0,void 0),H().stopAutoSave()),getStats:()=>({loads:S,saves:A})},s);return N(z)};var we=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Se=(e,n,l,t,r,i=Ae,u,d)=>{const s=ie();return[()=>we(void 0,null,(function*(){s.clear(),E(yield l(e,n),(({tn:e,cn:n})=>j(se(s,e,_),n)))})),(n,l)=>we(void 0,null,(function*(){return((e,n)=>Z(ue(s,e),n))(n,l)?x(b(E(yield e(z+Q(n)),(e=>[e[l],d?L($(e,l),d):$(e,l)])),(([e,n])=>!a(e)&&!M(n)))):{}})),(n,l,t,d,c,v=!1)=>we(void 0,null,(function*(){const y=_();L(null!=t?t:{},(e=>E(T(null!=e?e:{}),(e=>j(y,e)))));const h=ne(y);if(!v&&c&&g(h)&&Z(s,n))return yield e("DROP "+J+Q(n)),void de(s,n);const p=ue(s,n),w=_(ne(p));if(g(h)||(Z(s,n)?yield f(E([l,...h],((t,o)=>we(void 0,null,(function*(){te(w,t)||(yield e(Y+Q(n)+"ADD"+Q(t)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+Q(n)+`(${Q(l)})`)),j(p,t))}))))):(yield e("CREATE "+J+Q(n)+`(${Q(l)}${r} PRIMARY KEY${m(E(h,(e=>o+Q(e)+r)))});`),de(s,n,_([l,...h])))),yield f([...!v&&d?E(ne(w),(t=>we(void 0,null,(function*(){t!=l&&(yield e(Y+Q(n)+"DROP"+Q(t)),te(p,t))})))):[]]),v)a(t)?yield e(k+Q(n)+H+" true"):yield f(I(t,((t,o)=>we(void 0,null,(function*(){a(t)?yield e(k+Q(n)+H+Q(l)+"=$1",[o]):g(h)||(yield i(e,n,l,T(t),{[o]:u?E(R(t),u):R(t)},p))})))));else if(g(h))Z(s,n)&&(yield e(k+Q(n)+H+" true"));else{const o=b(ne(ue(s,n)),(e=>e!=l)),r={},a=[];L(null!=t?t:{},((e,n)=>{r[n]=E(o,(n=>u?u(null==e?void 0:e[n]):null==e?void 0:e[n])),P(a,n)})),yield i(e,n,l,o,r),yield e(k+Q(n)+H+Q(l)+`NOT IN(${q(a)})`,a)}})),n=>we(void 0,null,(function*(){let l;yield e("BEGIN");try{l=yield n()}catch(e){null==t||t(e)}return yield e("END"),l}))]},Ae=(e,n,l,t,r)=>we(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+Q(n)+"("+X(l,...t)+")VALUES"+m(I(r,(e=>"($"+i[0]+++","+q(e,i)+")")),o)+"ON CONFLICT("+Q(l)+")DO UPDATE SET"+m(E(t,(e=>Q(e)+"=excluded."+Q(e))),o),I(r,((e,n)=>[n,...E(e,(e=>null!=e?e:null))])).flat())}));var Oe=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const Te=(e,n,l,t,o,r,i,[u,a,d],s,c,v,y,f,h)=>{const[p,m,E,g]=Se(n,s,c,o,f,h),b=Pe(e,(()=>Oe(void 0,null,(function*(){return yield g((()=>Oe(void 0,null,(function*(){var e,n,l;return yield p(),l=null!=(n=null==(e=(yield m(u,a))[F])?void 0:e[d])?n:"null",re(l,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>Oe(void 0,null,(function*(){return yield g((()=>Oe(void 0,null,(function*(){var n,l;yield p(),yield E(u,a,{[F]:{[d]:(l=null!=(n=e())?n:null,oe(l,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),l,t,o,i,{[y]:()=>v,destroy:()=>(b.stopAutoLoad().stopAutoSave(),r(),b)},0,v);return b};var Ne=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const xe=(e,n,l,t,o,r,i,[u,d,[s,c,v]],y,h,p,m,E,g,P,w)=>{const[S,A,O,T]=Se(n,y,h,o,E,g,P,w),N=(e,n)=>Ne(void 0,null,(function*(){return yield f(ae(d,((l,t)=>Ne(void 0,[l,t],(function*([l,t,o,r],i){n&&!(i in e)||(yield O(l,t,e[i],o,r,n))})))))})),C=(e,n)=>Ne(void 0,null,(function*(){return c?yield O(v,U,{[F]:e},!0,!0,n):null})),$=Pe(e,(()=>Ne(void 0,null,(function*(){return yield T((()=>Ne(void 0,null,(function*(){yield S();const e=yield Ne(void 0,null,(function*(){return x(b(yield f(ae(u,((e,n)=>Ne(void 0,[e,n],(function*([e,n],l){return[e,yield A(l,n)]}))))),(e=>!M(e[1]))))})),n=yield Ne(void 0,null,(function*(){return s?(yield A(v,U))[F]:{}}));return M(e)&&a(n)?void 0:[e,n]}))))}))),((e,n)=>Ne(void 0,null,(function*(){return yield T((()=>Ne(void 0,null,(function*(){if(yield S(),a(n)){const[n,l]=e();yield N(n),yield C(l)}else yield N(n[0],!0),yield C(n[1],!0)}))))}))),l,t,o,i,{[m]:()=>p,destroy:()=>($.stopAutoLoad().stopAutoSave(),r(),$)},0,p);return $},Ce="ColumnName",$e="store",Ie="json",Le=$e+"TableName",Re=$e+"Id"+Ce,De=$e+Ce,Me="autoLoadIntervalSeconds",_e="rowId"+Ce,je="tableId",Fe="tableName",Ue="deleteEmptyColumns",Be="deleteEmptyTable",He={mode:Ie,[Me]:1},Je={load:0,save:0,[Fe]:l+"_values"},Ye=(e,n,l,t,o)=>{const r=ie();return L(e,((e,i)=>{const u=v(R(C(n,s(e)?{[l]:e}:e)),0,D(n));a(u[0])||t(i,u[0])||(o(i,u[0]),de(r,i,u))})),r};var ke=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const ze=(e,n,o,r,i,a,d,c,y,f,h="getDb",p)=>{let m,E,g;const b=((e,n)=>n?(l,t)=>{return o=function*(){return n(l,t),yield e(l,t)},new Promise(((e,n)=>{var l=e=>{try{r(o.next(e))}catch(e){n(e)}},t=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,t);r((o=o.apply(void 0,null)).next())}));var o}:e)(o,a),[P,w,S,A]=(e=>{var n,t,o;const r=(e=>C(He,s(e)?{[Le]:e}:null!=e?e:{}))(e),i=r[Me];if(r.mode==Ie){const e=null!=(n=r[Le])?n:l;return[1,i,[e,null!=(t=r[Re])?t:U,null!=(o=r[De])?o:$e],_(e)]}const{tables:{load:u={},save:a={}}={},values:d={}}=r,c=v(R(C(Je,d)),0,D(Je)),y=c[2],f=_(y),h=_(y);return[0,i,[Ye(u,{[je]:null,[_e]:U},je,(e=>Z(h,e)),(e=>j(f,e))),Ye(a,{[Fe]:null,[_e]:U,[Ue]:0,[Be]:0},Fe,((e,n)=>Z(h,n)),((e,n)=>j(f,n))),c],f]})(n);return(P?Te:xe)(e,b,(e=>{let n;const l=()=>n=setInterval((()=>ke(void 0,null,(function*(){try{const[{d:n,s:l,c:t}]=yield b(`${B} ${V} d,${W} s,TOTAL_CHANGES() c FROM ${G}${V} JOIN ${G}${W}`);n==m&&l==E&&t==g||(null!=m&&e(),m=n,E=l,g=t)}catch(e){}}))),1e3*w),t=()=>{m=E=g=null,u(n)},o=r((n=>{A.has(n)&&(t(),e(),l())}));return l(),()=>{t(),i(o)}}),(e=>e()),d,c,y,S,ne(A),((e,n)=>ke(void 0,null,(function*(){return yield e(`${B} t.name tn,c.name cn FROM ${K}list()t,${K}info(t.name)c ${H} t.schema='main'AND t.type IN('table','view')AND t.name IN(${q(n)})ORDER BY t.name,c.name`,n)}))),f,h,t,p,(e=>!0===e?1:!1===e?0:e),void 0)};var Ge=(e,n)=>(n=Symbol[e])?n:Symbol.for("Symbol."+e),Ve=(e,n,l)=>new Promise(((t,o)=>{var r=e=>{try{u(l.next(e))}catch(e){o(e)}},i=e=>{try{u(l.throw(e))}catch(e){o(e)}},u=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,i);u((l=l.apply(e,n)).next())}));const We=(e,n,l,t,r,i)=>Ve(void 0,null,(function*(){const u=[1],a=_(t),d=i?b([...i],(e=>e!=l&&!Z(a,e))):[];if(!g(d)){const t=T(r),o=x(E(yield e("SELECT"+X(l,...d)+"FROM"+Q(n)+"WHERE"+Q(l)+"IN("+q(t)+")",t),(e=>[e[l],e])));p(t,(e=>P(r[e],...E(d,(n=>{var l,t;return null!=(t=null==(l=null==o?void 0:o[e])?void 0:l[n])?t:null})))))}yield e("INSERT OR REPLACE INTO"+Q(n)+"("+X(l,...t,...d)+")VALUES"+m(I(r,(e=>"($"+u[0]+++","+q(e,u)+")")),o),I(r,((e,n)=>[n,...E(e,(e=>null!=e?e:null))])).flat())}));e.createPowerSyncPersister=(e,n,l,t,o)=>{let r;return ze(e,l,((e,...l)=>Ve(void 0,[e,...l],(function*(e,l=[]){return n.execute(e,l).then((e=>{var n,l;return null!=(l=null==(n=e.rows)?void 0:n._array)?l:[]}))}))),(e=>{const l=new AbortController,t=n.onChange({rawTableNames:!0,signal:l.signal});return Ve(void 0,null,(function*(){try{for(var e,n,l,o=((e,n,l)=>(n=e[Ge("asyncIterator")])?n.call(e):(e=e[Ge("iterator")](),n={},(l=(l,t)=>(t=e[l])&&(n[l]=n=>new Promise(((l,o,r)=>(n=t.call(e,n),r=n.done,Promise.resolve(n.value).then((e=>l({value:e,done:r})),o))))))("next"),l("return"),n))(t);e=!(n=yield o.next()).done;e=!1){const e=n.value;r&&E(e.changedTables,r)}}catch(n){l=[n]}finally{try{e&&(n=o.return)&&(yield n.call(o))}finally{if(l)throw l[0]}}})),r=e,l}),(e=>{r=void 0,e.abort()}),t,o,(()=>0),1,n,"getPowerSync",We)}},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPowersync={});
