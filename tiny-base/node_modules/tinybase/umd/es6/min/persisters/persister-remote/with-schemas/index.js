var e,t;e=this,t=function(e){"use strict";const t=clearInterval,n=e=>null==e,l=(e,t,l)=>n(e)?null==l?void 0:l():t(e),o=e=>Array.isArray(e),r=e=>e.length,i=e=>{throw Error(e)},u=(e,t)=>e.forEach(t),a=(e,...t)=>e.push(...t),s=e=>e.shift(),d=Object,c=e=>d.getPrototypeOf(e),v=d.keys,y=d.freeze,f=e=>(e=>!n(e)&&l(c(e),(e=>e==d.prototype||n(c(e))),(()=>!0)))(e)&&0==(e=>r(v(e)))(e),p=JSON.stringify,h=JSON.parse,g=e=>n(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),b=(e,t)=>null==e?void 0:e.forEach(t),m=(e,t)=>null==e?void 0:e.delete(t),S=e=>new Map(e),C=(e,t)=>null==e?void 0:e.get(t),P=(e,t,l)=>n(l)?(m(e,t),e):null==e?void 0:e.set(t,l),O=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(C(e,t)):P(e,t,n()),C(e,t)},w=(e,t,n,o,i=0)=>l((n?O:C)(e,t[i],i>r(t)-2?n:S),(l=>{if(i>r(t)-2)return(null==o?void 0:o(l))&&P(e,t[i]),l;const u=w(l,t,n,o,i+1);return g(l)&&P(e,t[i]),u})),A=e=>new Set(o(e)||n(e)?e:[e]),T=/^\d+$/;var x=Object.defineProperty,j=Object.getOwnPropertySymbols,E=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable,M=(e,t,n)=>t in e?x(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,D=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const I=S(),z=S(),J=(e,t,d,c,v,p,h,x={},J=0,N=[])=>{let R,k,B,F=0,H=0,U=0;O(I,N,(()=>0)),O(z,N,(()=>[]));const $=S(),[q,G,K,Q,V]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!f(e)||!f(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!f(e)||!f(t),t.setContent]:i("Store type not supported by this Persister"))(h,e,J),[W,X,Y]=(()=>{let e;const[t,o]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?s(e):null)?l:""+t++},t=>{T.test(t)&&r(e)<1e3&&a(e,t)}]})(),i=S();return[(n,l,o,r=[],u=()=>[])=>{null!=e||(e=re);const a=t(1);var s,d;return P(i,a,[n,l,o,r,u]),d=a,null==(s=w(l,null!=o?o:[""],A))||s.add(d),a},(t,n,...l)=>u(((e,t=[""])=>{const n=[],l=(e,o)=>o==r(t)?a(n,e):null===t[o]?b(e,(e=>l(e,o+1))):u([t[o],null],(t=>l(C(e,t),o+1)));return l(e,0),n})(t,n),(t=>b(t,(t=>C(i,t)[0](e,...null!=n?n:[],...l))))),e=>l(C(i,e),(([,t,n])=>(w(t,null!=n?n:[""],void 0,(t=>(m(t,e),g(t)?1:0))),P(i,e),o(e),n))),t=>l(C(i,t),(([t,,l=[],o,i])=>{const a=(...s)=>{var d,c;const v=r(s);v==r(l)?t(e,...s,...i(s)):n(l[v])?u(null!=(c=null==(d=o[v])?void 0:d.call(o,...s))?c:[],(e=>a(...s,e))):a(...s,l[v])};a()}))]})(),Z=e=>{e!=F&&(F=e,X($,void 0,F))},_=t=>{(q&&o(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>D(void 0,null,(function*(){return 2!=F&&(Z(1),H++,yield oe((()=>D(void 0,null,(function*(){try{const n=yield t();o(n)?_(n):e?V(e):i("Content is not an array: "+n)}catch(t){null==p||p(t),e&&V(e)}Z(0)}))))),re})),te=()=>(k&&(v(k),k=void 0),re),ne=e=>D(void 0,null,(function*(){return 1!=F&&(Z(2),U++,yield oe((()=>D(void 0,null,(function*(){try{yield d(G,e)}catch(e){null==p||p(e)}Z(0)}))))),re})),le=()=>(B&&(e.delListener(B),B=void 0),re),oe=(...e)=>D(void 0,null,(function*(){return a(C(z,N),...e),yield D(void 0,null,(function*(){if(!C(I,N)){for(P(I,N,1);!n(R=s(C(z,N)));)try{yield R()}catch(e){null==p||p(e)}P(I,N,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))E.call(t,n)&&M(e,n,t[n]);if(j)for(var n of j(t))L.call(t,n)&&M(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>D(void 0,null,(function*(){te(),yield ee(e);try{k=yield c(((e,t)=>D(void 0,null,(function*(){t||e?2!=F&&(Z(1),H++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==p||p(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!n(k),save:ne,startAutoSave:()=>D(void 0,null,(function*(){return le(),yield ne(),B=e.addDidFinishTransactionListener((()=>{const e=K();Q(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!n(B),getStatus:()=>F,addStatusListener:e=>W(e,$),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(C(z,N).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:H,saves:U})},x);return y(re)};var N=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const R=e=>e.headers.get("ETag");e.createRemotePersister=(e,l,o,r=5,i)=>{let u;return J(e,(()=>N(void 0,null,(function*(){const e=yield fetch(l);return u=R(e),h(yield e.text())}))),(e=>N(void 0,null,(function*(){return yield fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:(t=e(),p(t,((e,t)=>t instanceof Map?d.fromEntries([...t]):t)))});var t}))),(e=>setInterval((()=>N(void 0,null,(function*(){const t=yield fetch(l,{method:"HEAD"}),o=R(t);n(u)||n(o)||o==u||(u=o,e())}))),1e3*r)),(e=>t(e)),i,1,{getUrls:()=>[l,o]})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterRemote={});
