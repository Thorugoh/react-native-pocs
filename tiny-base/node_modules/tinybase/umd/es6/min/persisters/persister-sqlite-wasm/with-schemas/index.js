var e,n;e=this,n=function(e){"use strict";const n=e=>typeof e,t="tinybase",l="",o=",",r=n(l),i=Promise,u=clearInterval,a=e=>null==e,d=(e,n,t)=>a(e)?null==t?void 0:t():n(e),s=e=>n(e)==r,c=e=>Array.isArray(e),v=(e,n,t)=>e.slice(n,t),y=e=>e.length,f=e=>{return n=function*(){return i.all(e)},new Promise(((e,t)=>{var l=e=>{try{r(n.next(e))}catch(e){t(e)}},o=e=>{try{r(n.throw(e))}catch(e){t(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(l,o);r((n=n.apply(void 0,null)).next())}));var n},p=e=>{throw Error(e)},h=(e,n)=>e.forEach(n),m=(e,n="")=>e.join(n),b=(e,n)=>e.map(n),g=e=>0==y(e),E=(e,n)=>e.filter(n),O=(e,...n)=>e.push(...n),P=e=>e.shift(),w="_",A="_id",S="SELECT",N="WHERE",T="TABLE",$="ALTER "+T,x="DELETE FROM",C=S+"*FROM",I="pragma_",L="data_version",R="schema_version",D="pragma_table_",j=e=>`"${e.replace(/"/g,'""')}"`,_=(e,n=[1])=>m(b(e,(()=>"$"+n[0]++)),o),M=(e,n)=>{var t;return null!=(t=null==e?void 0:e.has(n))&&t},F=e=>a(e)||0==(e=>{var n;return null!=(n=null==e?void 0:e.size)?n:0})(e),k=e=>{var n;return[...null!=(n=null==e?void 0:e.values())?n:[]]},q=(e,n)=>null==e?void 0:e.forEach(n),B=(e,n)=>null==e?void 0:e.delete(n),U=Object,J=e=>U.getPrototypeOf(e),W=U.entries,Y=U.keys,z=U.freeze,G=(e=[])=>U.fromEntries(e),H=(...e)=>U.assign({},...e),V=(e,n)=>(delete e[n],e),K=(e,n)=>b(W(e),(([e,t])=>n(t,e))),Q=(e,n)=>G(K(e,((e,t)=>[t,n(e,t)]))),X=e=>U.values(e),Z=e=>y(Y(e)),ee=e=>(e=>!a(e)&&d(J(e),(e=>e==U.prototype||a(J(e))),(()=>!0)))(e)&&0==Z(e),ne=JSON.stringify,te=JSON.parse,le=e=>new Map(e),oe=(e,n)=>null==e?void 0:e.get(n),re=(e,n)=>{var t;return b([...null!=(t=null==e?void 0:e.entries())?t:[]],(([e,t])=>n(t,e)))},ie=(e,n,t)=>a(t)?(B(e,n),e):null==e?void 0:e.set(n,t),ue=(e,n,t,l)=>(M(e,n)?null==l||l(oe(e,n)):ie(e,n,t()),oe(e,n)),ae=(e,n,t,l,o=0)=>d((t?ue:oe)(e,n[o],o>y(n)-2?t:le),(r=>{if(o>y(n)-2)return(null==l?void 0:l(r))&&ie(e,n[o]),r;const i=ae(r,n,t,l,o+1);return F(r)&&ie(e,n[o]),i})),de=e=>new Set(c(e)||a(e)?e:[e]),se=(e,n)=>null==e?void 0:e.add(n),ce=/^\d+$/;var ve=Object.defineProperty,ye=Object.getOwnPropertySymbols,fe=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable,he=(e,n,t)=>n in e?ve(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,me=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const be=le(),ge=le(),Ee=(e,n,t,o,r,i,u,s={},v=0,f=[])=>{let m,b,g,E=0,w=0,A=0;ue(be,f,(()=>0)),ue(ge,f,(()=>[]));const S=le(),[N,T,$,x,C]=((e=1,n,t)=>1!=e&&n.isMergeable()?[1,n.getMergeableContent,()=>n.getTransactionMergeableChanges(!t),([[e],[n]])=>!ee(e)||!ee(n),n.setDefaultContent]:2!=e?[0,n.getContent,n.getTransactionChanges,([e,n])=>!ee(e)||!ee(n),n.setContent]:p("Store type not supported by this Persister"))(u,e,v),[I,L,R]=(()=>{let e;const[n,t]=(()=>{const e=[];let n=0;return[t=>{var o;return null!=(o=t?P(e):null)?o:l+n++},n=>{ce.test(n)&&y(e)<1e3&&O(e,n)}]})(),o=le();return[(t,r,i,u=[],a=()=>[])=>{null!=e||(e=W);const d=n(1);return ie(o,d,[t,r,i,u,a]),se(ae(r,null!=i?i:[l],de),d),d},(n,t,...r)=>h(((e,n=[l])=>{const t=[],o=(e,l)=>l==y(n)?O(t,e):null===n[l]?q(e,(e=>o(e,l+1))):h([n[l],null],(n=>o(oe(e,n),l+1)));return o(e,0),t})(n,t),(n=>q(n,(n=>oe(o,n)[0](e,...null!=t?t:[],...r))))),e=>d(oe(o,e),(([,n,r])=>(ae(n,null!=r?r:[l],void 0,(n=>(B(n,e),F(n)?1:0))),ie(o,e),t(e),r))),n=>d(oe(o,n),(([n,,t=[],l,o])=>{const r=(...i)=>{var u,d;const s=y(i);s==y(t)?n(e,...i,...o(i)):a(t[s])?h(null!=(d=null==(u=l[s])?void 0:u.call(l,...i))?d:[],(e=>r(...i,e))):r(...i,t[s])};r()}))]})(),D=e=>{e!=E&&(E=e,L(S,void 0,E))},j=n=>{(N&&c(null==n?void 0:n[0])?1===(null==n?void 0:n[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==n?void 0:n[2])?e.applyChanges:e.setContent)(n)},_=e=>me(void 0,null,(function*(){return 2!=E&&(D(1),w++,yield J((()=>me(void 0,null,(function*(){try{const t=yield n();c(t)?j(t):e?C(e):p("Content is not an array: "+t)}catch(n){null==i||i(n),e&&C(e)}D(0)}))))),W})),M=()=>(b&&(r(b),b=void 0),W),k=e=>me(void 0,null,(function*(){return 1!=E&&(D(2),A++,yield J((()=>me(void 0,null,(function*(){try{yield t(T,e)}catch(e){null==i||i(e)}D(0)}))))),W})),U=()=>(g&&(e.delListener(g),g=void 0),W),J=(...e)=>me(void 0,null,(function*(){return O(oe(ge,f),...e),yield me(void 0,null,(function*(){if(!oe(be,f)){for(ie(be,f,1);!a(m=P(oe(ge,f)));)try{yield m()}catch(e){null==i||i(e)}ie(be,f,0)}})),W})),W=((e,n)=>{for(var t in n||(n={}))fe.call(n,t)&&he(e,t,n[t]);if(ye)for(var t of ye(n))pe.call(n,t)&&he(e,t,n[t]);return e})({load:_,startAutoLoad:e=>me(void 0,null,(function*(){M(),yield _(e);try{b=yield o(((e,n)=>me(void 0,null,(function*(){n||e?2!=E&&(D(1),w++,j(null!=n?n:e),D(0)):yield _()}))))}catch(e){null==i||i(e)}return W})),stopAutoLoad:M,isAutoLoading:()=>!a(b),save:k,startAutoSave:()=>me(void 0,null,(function*(){return U(),yield k(),g=e.addDidFinishTransactionListener((()=>{const e=$();x(e)&&k(e)})),W})),stopAutoSave:U,isAutoSaving:()=>!a(g),getStatus:()=>E,addStatusListener:e=>I(e,S),delListener:n=>(R(n),e),schedule:J,getStore:()=>e,destroy:()=>(oe(ge,f).splice(0,void 0),M().stopAutoSave()),getStats:()=>({loads:w,saves:A})},s);return z(W)};var Oe=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Pe=(e,n,t,l,r,i=we,u,d)=>{const s=le();return[()=>Oe(void 0,null,(function*(){s.clear(),b(yield t(e,n),(({tn:e,cn:n})=>se(ue(s,e,de),n)))})),(n,t)=>Oe(void 0,null,(function*(){return((e,n)=>M(oe(s,e),n))(n,t)?G(E(b(yield e(C+j(n)),(e=>[e[t],d?Q(V(e,t),d):V(e,t)])),(([e,n])=>!a(e)&&!ee(n)))):{}})),(n,t,l,d,c,v=!1)=>Oe(void 0,null,(function*(){const y=de();Q(null!=l?l:{},(e=>b(Y(null!=e?e:{}),(e=>se(y,e)))));const p=k(y);if(!v&&c&&g(p)&&M(s,n))return yield e("DROP "+T+j(n)),void ie(s,n);const h=oe(s,n),P=de(k(h));if(g(p)||(M(s,n)?yield f(b([t,...p],((l,o)=>Oe(void 0,null,(function*(){B(P,l)||(yield e($+j(n)+"ADD"+j(l)+r),0==o&&(yield e("CREATE UNIQUE INDEX pk ON "+j(n)+`(${j(t)})`)),se(h,l))}))))):(yield e("CREATE "+T+j(n)+`(${j(t)}${r} PRIMARY KEY${m(b(p,(e=>o+j(e)+r)))});`),ie(s,n,de([t,...p])))),yield f([...!v&&d?b(k(P),(l=>Oe(void 0,null,(function*(){l!=t&&(yield e($+j(n)+"DROP"+j(l)),B(h,l))})))):[]]),v)a(l)?yield e(x+j(n)+N+" true"):yield f(K(l,((l,o)=>Oe(void 0,null,(function*(){a(l)?yield e(x+j(n)+N+j(t)+"=$1",[o]):g(p)||(yield i(e,n,t,Y(l),{[o]:u?b(X(l),u):X(l)},h))})))));else if(g(p))M(s,n)&&(yield e(x+j(n)+N+" true"));else{const o=E(k(oe(s,n)),(e=>e!=t)),r={},a=[];Q(null!=l?l:{},((e,n)=>{r[n]=b(o,(n=>u?u(null==e?void 0:e[n]):null==e?void 0:e[n])),O(a,n)})),yield i(e,n,t,o,r),yield e(x+j(n)+N+j(t)+`NOT IN(${_(a)})`,a)}})),n=>Oe(void 0,null,(function*(){let t;yield e("BEGIN");try{t=yield n()}catch(e){null==l||l(e)}return yield e("END"),t}))]},we=(e,n,t,l,r)=>Oe(void 0,null,(function*(){const i=[1];yield e("INSERT INTO"+j(n)+"("+((...e)=>m(b(e,j),o))(t,...l)+")VALUES"+m(K(r,(e=>"($"+i[0]+++","+_(e,i)+")")),o)+"ON CONFLICT("+j(t)+")DO UPDATE SET"+m(b(l,(e=>j(e)+"=excluded."+j(e))),o),K(r,((e,n)=>[n,...b(e,(e=>null!=e?e:null))])).flat())}));var Ae=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Se=(e,n,t,l,o,r,i,[u,a,d],s,c,v,y,f,p)=>{const[h,m,b,g]=Pe(n,s,c,o,f,p),E=Ee(e,(()=>Ae(void 0,null,(function*(){return yield g((()=>Ae(void 0,null,(function*(){var e,n,t;return yield h(),t=null!=(n=null==(e=(yield m(u,a))[w])?void 0:e[d])?n:"null",te(t,((e,n)=>"￼"===n?void 0:n))}))))}))),(e=>Ae(void 0,null,(function*(){return yield g((()=>Ae(void 0,null,(function*(){var n,t;yield h(),yield b(u,a,{[w]:{[d]:(t=null!=(n=e())?n:null,ne(t,((e,n)=>void 0===n?"￼":n)))}},!0,!0)}))))}))),t,l,o,i,{[y]:()=>v,destroy:()=>(E.stopAutoLoad().stopAutoSave(),r(),E)},0,v);return E};var Ne=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const Te=(e,n,t,l,o,r,i,[u,d,[s,c,v]],y,p,h,m,b,g,O,P)=>{const[S,N,T,$]=Pe(n,y,p,o,b,g,O,P),x=(e,n)=>Ne(void 0,null,(function*(){return yield f(re(d,((t,l)=>Ne(void 0,[t,l],(function*([t,l,o,r],i){n&&!(i in e)||(yield T(t,l,e[i],o,r,n))})))))})),C=(e,n)=>Ne(void 0,null,(function*(){return c?yield T(v,A,{[w]:e},!0,!0,n):null})),I=Ee(e,(()=>Ne(void 0,null,(function*(){return yield $((()=>Ne(void 0,null,(function*(){yield S();const e=yield Ne(void 0,null,(function*(){return G(E(yield f(re(u,((e,n)=>Ne(void 0,[e,n],(function*([e,n],t){return[e,yield N(t,n)]}))))),(e=>!ee(e[1]))))})),n=yield Ne(void 0,null,(function*(){return s?(yield N(v,A))[w]:{}}));return ee(e)&&a(n)?void 0:[e,n]}))))}))),((e,n)=>Ne(void 0,null,(function*(){return yield $((()=>Ne(void 0,null,(function*(){if(yield S(),a(n)){const[n,t]=e();yield x(n),yield C(t)}else yield x(n[0],!0),yield C(n[1],!0)}))))}))),t,l,o,i,{[m]:()=>h,destroy:()=>(I.stopAutoLoad().stopAutoSave(),r(),I)},0,h);return I},$e="ColumnName",xe="store",Ce="json",Ie=xe+"TableName",Le=xe+"Id"+$e,Re=xe+$e,De="autoLoadIntervalSeconds",je="rowId"+$e,_e="tableId",Me="tableName",Fe="deleteEmptyColumns",ke="deleteEmptyTable",qe={mode:Ce,[De]:1},Be={load:0,save:0,[Me]:t+"_values"},Ue=(e,n,t,l,o)=>{const r=le();return Q(e,((e,i)=>{const u=v(X(H(n,s(e)?{[t]:e}:e)),0,Z(n));a(u[0])||l(i,u[0])||(o(i,u[0]),ie(r,i,u))})),r};var Je=(e,n,t)=>new Promise(((l,o)=>{var r=e=>{try{u(t.next(e))}catch(e){o(e)}},i=e=>{try{u(t.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((t=t.apply(e,n)).next())}));const We=(e,n,o,r,i,a,d,c,y,f,p="getDb",h)=>{let m,b,g;const E=((e,n)=>n?(t,l)=>{return o=function*(){return n(t,l),yield e(t,l)},new Promise(((e,n)=>{var t=e=>{try{r(o.next(e))}catch(e){n(e)}},l=e=>{try{r(o.throw(e))}catch(e){n(e)}},r=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,l);r((o=o.apply(void 0,null)).next())}));var o}:e)(o,a),[O,P,w,T]=(e=>{var n,l,o;const r=(e=>H(qe,s(e)?{[Ie]:e}:null!=e?e:{}))(e),i=r[De];if(r.mode==Ce){const e=null!=(n=r[Ie])?n:t;return[1,i,[e,null!=(l=r[Le])?l:A,null!=(o=r[Re])?o:xe],de(e)]}const{tables:{load:u={},save:a={}}={},values:d={}}=r,c=v(X(H(Be,d)),0,Z(Be)),y=c[2],f=de(y),p=de(y);return[0,i,[Ue(u,{[_e]:null,[je]:A},_e,(e=>M(p,e)),(e=>se(f,e))),Ue(a,{[Me]:null,[je]:A,[Fe]:0,[ke]:0},Me,((e,n)=>M(p,n)),((e,n)=>se(f,n))),c],f]})(n);return(O?Se:Te)(e,E,(e=>{let n;const t=()=>n=setInterval((()=>Je(void 0,null,(function*(){try{const[{d:n,s:t,c:l}]=yield E(`${S} ${L} d,${R} s,TOTAL_CHANGES() c FROM ${I}${L} JOIN ${I}${R}`);n==m&&t==b&&l==g||(null!=m&&e(),m=n,b=t,g=l)}catch(e){}}))),1e3*P),l=()=>{m=b=g=null,u(n)},o=r((n=>{T.has(n)&&(l(),e(),t())}));return t(),()=>{l(),i(o)}}),(e=>e()),d,c,y,w,k(T),((e,n)=>Je(void 0,null,(function*(){return yield e(`${S} t.name tn,c.name cn FROM ${D}list()t,${D}info(t.name)c ${N} t.schema='main'AND t.type IN('table','view')AND t.name IN(${_(n)})ORDER BY t.name,c.name`,n)}))),f,p,l,h,(e=>!0===e?1:!1===e?0:e),void 0)};var Ye=Object.defineProperty,ze=Object.getOwnPropertySymbols,Ge=Object.prototype.hasOwnProperty,He=Object.prototype.propertyIsEnumerable,Ve=(e,n,t)=>n in e?Ye(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;e.createSqliteWasmPersister=(e,n,t,l,o,r)=>We(e,l,((e,...n)=>{return l=[e,...n],o=function*(e,n=[]){return t.exec(e,{bind:n,rowMode:"object",returnValue:"resultRows"}).map((e=>((e,n)=>{for(var t in n||(n={}))Ge.call(n,t)&&Ve(e,t,n[t]);if(ze)for(var t of ze(n))He.call(n,t)&&Ve(e,t,n[t]);return e})({},e)))},new Promise(((e,n)=>{var t=e=>{try{i(o.next(e))}catch(e){n(e)}},r=e=>{try{i(o.throw(e))}catch(e){n(e)}},i=n=>n.done?e(n.value):Promise.resolve(n.value).then(t,r);i((o=o.apply(void 0,l)).next())}));var l,o}),(e=>n.capi.sqlite3_update_hook(t,((n,t,l,o)=>e(o)),0)),(()=>n.capi.sqlite3_update_hook(t,(()=>0),0)),o,r,(()=>0),3,t)},"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterSqliteWasm={});
