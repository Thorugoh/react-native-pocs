var e,t;e=this,t=function(e,t){"use strict";const n="t",l="v",o=e=>null==e,r=(e,t,n)=>o(e)?null==n?void 0:n():t(e),i=e=>Array.isArray(e),u=e=>e.length,s=e=>{throw Error(e)},a=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),c=e=>e.shift(),v=Object,y=e=>v.getPrototypeOf(e),g=v.entries,p=v.keys,f=v.freeze,h=(e=[])=>v.fromEntries(e),b=(e,t)=>t in e,S=(e,t)=>h(((e,t)=>((e,t)=>e.map(t))(g(e),(([e,n])=>t(n,e))))(e,((e,n)=>[n,t(e,n)]))),O=e=>(e=>!o(e)&&r(y(e),(e=>e==v.prototype||o(y(e))),(()=>!0)))(e)&&0==(e=>u(p(e)))(e),w=(e,t,n)=>(b(e,t)||(e[t]=n()),e[t]),j=e=>o(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),m=(e,t)=>null==e?void 0:e.forEach(t),C=(e,t)=>null==e?void 0:e.delete(t),P=e=>new Map(e),M=(e,t)=>null==e?void 0:e.get(t),A=(e,t)=>m(e,((e,n)=>t(n,e))),x=(e,t,n)=>o(n)?(C(e,t),e):null==e?void 0:e.set(t,n),L=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(M(e,t)):x(e,t,n()),M(e,t)},E=(e,t,n,l,o=0)=>r((n?L:M)(e,t[o],o>u(t)-2?n:P),(r=>{if(o>u(t)-2)return(null==l?void 0:l(r))&&x(e,t[o]),r;const i=E(r,t,n,l,o+1);return j(r)&&x(e,t[o]),i})),J=e=>new Set(i(e)||o(e)?e:[e]),N=/^\d+$/;var T=Object.defineProperty,z=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,k=(e,t,n)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,q=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const B=P(),F=P(),I=(e,t,n,l,v,y,g,p={},h=0,b=[])=>{let S,w,A,T=0,I=0,$=0;L(B,b,(()=>0)),L(F,b,(()=>[]));const G=P(),[H,K,Q,R,U]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!O(e)||!O(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!O(e)||!O(t),t.setContent]:s("Store type not supported by this Persister"))(g,e,h),[V,W,X]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?c(e):null)?l:""+t++},t=>{N.test(t)&&u(e)<1e3&&d(e,t)}]})(),l=P();return[(n,o,r,i=[],u=()=>[])=>{null!=e||(e=re);const s=t(1);var a,d;return x(l,s,[n,o,r,i,u]),d=s,null==(a=E(o,null!=r?r:[""],J))||a.add(d),s},(t,n,...o)=>a(((e,t=[""])=>{const n=[],l=(e,o)=>o==u(t)?d(n,e):null===t[o]?m(e,(e=>l(e,o+1))):a([t[o],null],(t=>l(M(e,t),o+1)));return l(e,0),n})(t,n),(t=>m(t,(t=>M(l,t)[0](e,...null!=n?n:[],...o))))),e=>r(M(l,e),(([,t,o])=>(E(t,null!=o?o:[""],void 0,(t=>(C(t,e),j(t)?1:0))),x(l,e),n(e),o))),t=>r(M(l,t),(([t,,n=[],l,r])=>{const i=(...s)=>{var d,c;const v=u(s);v==u(n)?t(e,...s,...r(s)):o(n[v])?a(null!=(c=null==(d=l[v])?void 0:d.call(l,...s))?c:[],(e=>i(...s,e))):i(...s,n[v])};i()}))]})(),Z=e=>{e!=T&&(T=e,W(G,void 0,T))},_=t=>{(H&&i(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>q(void 0,null,(function*(){return 2!=T&&(Z(1),I++,yield oe((()=>q(void 0,null,(function*(){try{const n=yield t();i(n)?_(n):e?U(e):s("Content is not an array: "+n)}catch(t){null==y||y(t),e&&U(e)}Z(0)}))))),re})),te=()=>(w&&(v(w),w=void 0),re),ne=e=>q(void 0,null,(function*(){return 1!=T&&(Z(2),$++,yield oe((()=>q(void 0,null,(function*(){try{yield n(K,e)}catch(e){null==y||y(e)}Z(0)}))))),re})),le=()=>(A&&(e.delListener(A),A=void 0),re),oe=(...e)=>q(void 0,null,(function*(){return d(M(F,b),...e),yield q(void 0,null,(function*(){if(!M(B,b)){for(x(B,b,1);!o(S=c(M(F,b)));)try{yield S()}catch(e){null==y||y(e)}x(B,b,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))D.call(t,n)&&k(e,n,t[n]);if(z)for(var n of z(t))Y.call(t,n)&&k(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>q(void 0,null,(function*(){te(),yield ee(e);try{w=yield l(((e,t)=>q(void 0,null,(function*(){t||e?2!=T&&(Z(1),I++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==y||y(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!o(w),save:ne,startAutoSave:()=>q(void 0,null,(function*(){return le(),yield ne(),A=e.addDidFinishTransactionListener((()=>{const e=Q();R(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!o(A),getStatus:()=>T,addStatusListener:e=>V(e,G),delListener:t=>(X(t),e),schedule:oe,getStore:()=>e,destroy:()=>(M(F,b).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:I,saves:$})},p);return f(re)};var $=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{u(n.next(e))}catch(e){o(e)}},i=e=>{try{u(n.throw(e))}catch(e){o(e)}},u=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);u((n=n.apply(e,t)).next())}));const G="delete",H=e=>[e.get(n),e.get(l)],K=(e,n,l,r)=>{var i;const u=o(n)?e:null!=(i=e.get(n))?i:e.set(n,new t.Map);let s;return S(l,((e,t)=>{r(u,t,e)&&(s=1)})),u.forEach(((e,t)=>{b(l,t)||(u.delete(t),s=1)})),o(n)||u.size||e.delete(n),s};e.createYjsPersister=(e,i,s="tinybase",d)=>{const v=i.getMap(s);return I(e,(()=>$(void 0,null,(function*(){return v.size?[v.get(n).toJSON(),v.get(l).toJSON()]:void 0}))),((e,u)=>$(void 0,null,(function*(){return i.transact((()=>((e,i,u)=>{e.size||(e.set(n,new t.Map),e.set(l,new t.Map));const[s,a]=H(e),d=()=>{c=1};let c=1;if(r(u,(([e,t])=>{c=0,S(e,((e,t)=>c?0:o(e)?s.delete(t):r(s.get(t),(t=>S(e,((e,n)=>c?0:o(e)?t.delete(n):r(t.get(n),(t=>S(e,((e,n)=>o(e)?t.delete(n):t.set(n,e)))),d)))),d))),S(t,((e,t)=>c?0:o(e)?a.delete(t):a.set(t,e)))})),c){const[e,t]=i();K(s,void 0,e,((e,t,n)=>K(s,t,n,((e,t,n)=>K(e,t,n,((e,t,n)=>{if(e.get(t)!==n)return e.set(t,n),1})))))),K(a,void 0,t,((e,t,n)=>{a.get(t)!==n&&a.set(t,n)}))}})(v,e,u)))}))),(e=>{const t=t=>e(void 0,((e,t)=>{if(1==u(t)&&(o=t[0].path,0==u(o)))return[e.get(n).toJSON(),e.get(l).toJSON(),1];var o;const[i,s]=H(e),d={},v={};return a(t,(({path:e,changes:{keys:t}})=>c(e)==n?r(c(e),(n=>{const l=w(d,n,h),o=i.get(n);r(c(e),(e=>{const n=w(l,e,h),r=o.get(e);A(t,((e,{action:t})=>n[e]=t==G?null:r.get(e)))}),(()=>A(t,((e,{action:t})=>{var n;return l[e]=t==G?null:null==(n=o.get(e))?void 0:n.toJSON()}))))}),(()=>A(t,((e,{action:t})=>{var n;return d[e]=t==G?null:null==(n=i.get(e))?void 0:n.toJSON()})))):A(t,((e,{action:t})=>v[e]=t==G?null:s.get(e))))),[d,v,1]})(v,t));return v.observeDeep(t),t}),(e=>{v.unobserveDeep(e)}),d,1,{getYDoc:()=>i})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("yjs")):"function"==typeof define&&define.amd?define(["exports","yjs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterYjs={},e.yjs);
