var e,t;e=this,t=function(e){"use strict";const t=(e,t="",n)=>e.split(t,n),n=Promise,l=globalThis,o=Math,r=o.floor,i=e=>null==e,a=(e,t,n)=>i(e)?null==n?void 0:n():t(e),u=e=>Array.isArray(e),s=e=>e.length,c=e=>{throw Error(e)},d=(e,t)=>e.forEach(t),f=(e,...t)=>e.push(...t),v=e=>e.shift(),y=Object,g=e=>y.getPrototypeOf(e),p=y.entries,h=y.keys,b=y.freeze,S=(e,t)=>d(p(e),(([e,n])=>t(n,e))),m=e=>(e=>!i(e)&&a(g(e),(e=>e==y.prototype||i(g(e))),(()=>!0)))(e)&&0==(e=>s(h(e)))(e),C=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),M=e=>i(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),w=(e,t)=>null==e?void 0:e.forEach(t),A=(e,t)=>null==e?void 0:e.delete(t),O=e=>new Map(e),P=(e,t)=>null==e?void 0:e.get(t),T=(e,t,n)=>i(n)?(A(e,t),e):null==e?void 0:e.set(t,n),D=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(P(e,t)):T(e,t,n()),P(e,t)},j=(e,t,n,l,o=0)=>a((n?D:P)(e,t[o],o>s(t)-2?n:O),(r=>{if(o>s(t)-2)return(null==l?void 0:l(r))&&T(e,t[o]),r;const i=j(r,t,n,l,o+1);return M(r)&&T(e,t[o]),i})),L=(e,t)=>t?[e,t]:[e],H=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},x=(e="")=>L(((e=[])=>y.fromEntries(e))(),e),E=e=>new Set(u(e)||i(e)?e:[e]),z=/^\d+$/;var G=Object.defineProperty,R=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,$=(e,t,n)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,k=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));const B=O(),F=O(),N=(e,t,n,l,o,r,y,g={},p=0,h=[])=>{let S,C,L,H=0,x=0,G=0;D(B,h,(()=>0)),D(F,h,(()=>[]));const N=O(),[U,q,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!m(e)||!m(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!m(e)||!m(t),t.setContent]:c("Store type not supported by this Persister"))(y,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?v(e):null)?l:""+t++},t=>{z.test(t)&&s(e)<1e3&&f(e,t)}]})(),l=O();return[(n,o,r,i=[],a=()=>[])=>{null!=e||(e=re);const u=t(1);var s,c;return T(l,u,[n,o,r,i,a]),c=u,null==(s=j(o,null!=r?r:[""],E))||s.add(c),u},(t,n,...o)=>d(((e,t=[""])=>{const n=[],l=(e,o)=>o==s(t)?f(n,e):null===t[o]?w(e,(e=>l(e,o+1))):d([t[o],null],(t=>l(P(e,t),o+1)));return l(e,0),n})(t,n),(t=>w(t,(t=>P(l,t)[0](e,...null!=n?n:[],...o))))),e=>a(P(l,e),(([,t,o])=>(j(t,null!=o?o:[""],void 0,(t=>(A(t,e),M(t)?1:0))),T(l,e),n(e),o))),t=>a(P(l,t),(([t,,n=[],l,o])=>{const r=(...a)=>{var u,c;const f=s(a);f==s(n)?t(e,...a,...o(a)):i(n[f])?d(null!=(c=null==(u=l[f])?void 0:u.call(l,...a))?c:[],(e=>r(...a,e))):r(...a,n[f])};r()}))]})(),Z=e=>{e!=H&&(H=e,X(N,void 0,H))},_=t=>{(U&&u(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>k(void 0,null,(function*(){return 2!=H&&(Z(1),x++,yield oe((()=>k(void 0,null,(function*(){try{const n=yield t();u(n)?_(n):e?Q(e):c("Content is not an array: "+n)}catch(t){null==r||r(t),e&&Q(e)}Z(0)}))))),re})),te=()=>(C&&(o(C),C=void 0),re),ne=e=>k(void 0,null,(function*(){return 1!=H&&(Z(2),G++,yield oe((()=>k(void 0,null,(function*(){try{yield n(q,e)}catch(e){null==r||r(e)}Z(0)}))))),re})),le=()=>(L&&(e.delListener(L),L=void 0),re),oe=(...e)=>k(void 0,null,(function*(){return f(P(F,h),...e),yield k(void 0,null,(function*(){if(!P(B,h)){for(T(B,h,1);!i(S=v(P(F,h)));)try{yield S()}catch(e){null==r||r(e)}T(B,h,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))V.call(t,n)&&$(e,n,t[n]);if(R)for(var n of R(t))I.call(t,n)&&$(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>k(void 0,null,(function*(){te(),yield ee(e);try{C=yield l(((e,t)=>k(void 0,null,(function*(){t||e?2!=H&&(Z(1),x++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==r||r(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!i(C),save:ne,startAutoSave:()=>k(void 0,null,(function*(){return le(),yield ne(),L=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!i(L),getStatus:()=>H,addStatusListener:e=>W(e,N),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(P(F,h).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:x,saves:G})},g);return b(re)},U=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),q=l.crypto?e=>l.crypto.getRandomValues(e):e=>(e=>e.map((()=>r(256*o.random()))))(e),J=(e=16)=>{return t=(e,t)=>e+U[63&t],q(new Uint8Array(e)).reduce(t,"");var t};var K=Object.defineProperty,Q=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable,Y=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Z=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));e.Message={Response:0,GetContentHashes:1,ContentHashes:2,ContentDiff:3,GetTableDiff:4,GetRowDiff:5,GetCellDiff:6,GetValueDiff:7},e.createCustomSynchronizer=(e,t,l,o,r,u,s,c,d={})=>{let f,v=0,y=0,g=0;const p=O(),h=()=>J(11),b=(e,n,l,o)=>{y++,null==u||u(e,n,l,o),t(e,n,l,o)},M=(e,t,l,o)=>Z(void 0,null,(function*(){return new n(((n,i)=>{const a=o+"."+J(4),u=((e,t=0)=>setTimeout(e,1e3*t))((()=>{A(p,a),i(`No response from ${null!=e?e:"anyone"} to ${a}, `+t)}),r);T(p,a,[e,(e,t)=>{clearTimeout(u),A(p,a),n([e,t,o])}]),b(e,a,t,l)}))})),w=(e,[t,n])=>{S(t,(([t,n],l)=>{const o=C(e[0],l,x);S(t,(([e,t],n)=>{const l=C(o[0],n,x);S(e,(([e,t],n)=>l[0][n]=L(e,t))),l[1]=H(l[1],t)})),o[1]=H(o[1],n)})),e[1]=H(e[1],n)},D=(...t)=>Z(void 0,[...t],(function*(t=null,n,l=h()){try{i(n)&&([n,t,l]=yield M(null,1,"",l));const[o,r]=n,[a,u]=e.getMergeableContentHashes();let s=x();if(a!=o){const[n,o]=(yield M(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!m(o)){const[n,r]=(yield M(t,5,e.getMergeableRowHashes(o),l))[0];if(w(s,n),!m(r)){const n=(yield M(t,6,e.getMergeableCellHashes(r),l))[0];w(s,n)}}}return[s,u==r?x():(yield M(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==c||c(e)}})),j=N(e,(()=>Z(void 0,null,(function*(){const e=yield D();return!e||m(e[0][0])&&m(e[1][0])?void 0:e}))),((t,n)=>Z(void 0,null,(function*(){return n?b(null,h(),3,n):b(null,h(),2,e.getMergeableContentHashes())}))),(e=>f=e),(()=>f=void 0),c,2,((e,t)=>{for(var n in t||(t={}))W.call(t,n)&&Y(e,n,t[n]);if(Q)for(var n of Q(t))X.call(t,n)&&Y(e,n,t[n]);return e})({startSync:e=>Z(void 0,null,(function*(){return v=1,yield(yield j.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(v=0,j.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),j.stopSync()),getSynchronizerStats:()=>({sends:y,receives:g})},d),1);return l(((t,n,l,o)=>{const r=v||j.isAutoLoading();g++,null==s||s(t,n,l,o),0==l?a(P(p,n),(([e,n])=>i(e)||e==t?n(o,t):0)):2==l&&r?D(t,o,null!=n?n:void 0).then((e=>{null==f||f(void 0,e)})).catch(c):3==l&&r?null==f||f(void 0,o):a(1==l&&(v||j.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{b(t,n,0,e)}))})),j}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizers={});
