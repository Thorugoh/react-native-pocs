var e,t;e=this,t=function(e){"use strict";const t=(e,t="",n)=>e.split(t,n),n=Promise,l=globalThis,o=Math,r=o.floor,a=e=>null==e,i=(e,t,n)=>a(e)?null==n?void 0:n():t(e),u=e=>Array.isArray(e),s=e=>e.length,c=e=>{throw Error(e)},d=(e,t)=>e.forEach(t),v=(e,...t)=>e.push(...t),y=e=>e.shift(),f=Object,g=e=>f.getPrototypeOf(e),p=f.entries,h=f.keys,b=f.freeze,m=(e,t)=>d(p(e),(([e,n])=>t(n,e))),S=e=>(e=>!a(e)&&i(g(e),(e=>e==f.prototype||a(g(e))),(()=>!0)))(e)&&0==(e=>s(h(e)))(e),C=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),M=e=>a(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),w=(e,t)=>null==e?void 0:e.forEach(t),A=(e,t)=>null==e?void 0:e.delete(t),O=e=>new Map(e),P=(e,t)=>null==e?void 0:e.get(t),T=(e,t,n)=>a(n)?(A(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,l)=>{var o,r,a;return r=t,null!=(a=null==(o=e)?void 0:o.has(r))&&a?null==l||l(P(e,t)):T(e,t,n()),P(e,t)},L=(e,t,n,l,o=0)=>i((n?j:P)(e,t[o],o>s(t)-2?n:O),(r=>{if(o>s(t)-2)return(null==l?void 0:l(r))&&T(e,t[o]),r;const a=L(r,t,n,l,o+1);return M(r)&&T(e,t[o]),a})),x=(e,t)=>t?[e,t]:[e],H=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},D=(e="")=>x(((e=[])=>f.fromEntries(e))(),e),E=e=>new Set(u(e)||a(e)?e:[e]),z=/^\d+$/;var B=Object.defineProperty,R=Object.getOwnPropertySymbols,V=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,N=(e,t,n)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,$=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));const k=O(),F=O(),U=(e,t,n,l,o,r,f,g={},p=0,h=[])=>{let m,C,x,H=0,D=0,B=0;j(k,h,(()=>0)),j(F,h,(()=>[]));const U=O(),[q,G,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!S(e)||!S(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!S(e)||!S(t),t.setContent]:c("Store type not supported by this Persister"))(f,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?y(e):null)?l:""+t++},t=>{z.test(t)&&s(e)<1e3&&v(e,t)}]})(),l=O();return[(n,o,r,a=[],i=()=>[])=>{null!=e||(e=re);const u=t(1);var s,c;return T(l,u,[n,o,r,a,i]),c=u,null==(s=L(o,null!=r?r:[""],E))||s.add(c),u},(t,n,...o)=>d(((e,t=[""])=>{const n=[],l=(e,o)=>o==s(t)?v(n,e):null===t[o]?w(e,(e=>l(e,o+1))):d([t[o],null],(t=>l(P(e,t),o+1)));return l(e,0),n})(t,n),(t=>w(t,(t=>P(l,t)[0](e,...null!=n?n:[],...o))))),e=>i(P(l,e),(([,t,o])=>(L(t,null!=o?o:[""],void 0,(t=>(A(t,e),M(t)?1:0))),T(l,e),n(e),o))),t=>i(P(l,t),(([t,,n=[],l,o])=>{const r=(...i)=>{var u,c;const v=s(i);v==s(n)?t(e,...i,...o(i)):a(n[v])?d(null!=(c=null==(u=l[v])?void 0:u.call(l,...i))?c:[],(e=>r(...i,e))):r(...i,n[v])};r()}))]})(),Z=e=>{e!=H&&(H=e,X(U,void 0,H))},_=t=>{(q&&u(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>$(void 0,null,(function*(){return 2!=H&&(Z(1),D++,yield oe((()=>$(void 0,null,(function*(){try{const n=yield t();u(n)?_(n):e?Q(e):c("Content is not an array: "+n)}catch(t){null==r||r(t),e&&Q(e)}Z(0)}))))),re})),te=()=>(C&&(o(C),C=void 0),re),ne=e=>$(void 0,null,(function*(){return 1!=H&&(Z(2),B++,yield oe((()=>$(void 0,null,(function*(){try{yield n(G,e)}catch(e){null==r||r(e)}Z(0)}))))),re})),le=()=>(x&&(e.delListener(x),x=void 0),re),oe=(...e)=>$(void 0,null,(function*(){return v(P(F,h),...e),yield $(void 0,null,(function*(){if(!P(k,h)){for(T(k,h,1);!a(m=y(P(F,h)));)try{yield m()}catch(e){null==r||r(e)}T(k,h,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))V.call(t,n)&&N(e,n,t[n]);if(R)for(var n of R(t))I.call(t,n)&&N(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>$(void 0,null,(function*(){te(),yield ee(e);try{C=yield l(((e,t)=>$(void 0,null,(function*(){t||e?2!=H&&(Z(1),D++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==r||r(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!a(C),save:ne,startAutoSave:()=>$(void 0,null,(function*(){return le(),yield ne(),x=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!a(x),getStatus:()=>H,addStatusListener:e=>W(e,U),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(P(F,h).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:D,saves:B})},g);return b(re)},q=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),G=l.crypto?e=>l.crypto.getRandomValues(e):e=>(e=>e.map((()=>r(256*o.random()))))(e),J=(e=16)=>{return t=(e,t)=>e+q[63&t],G(new Uint8Array(e)).reduce(t,"");var t};var K=Object.defineProperty,Q=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable,Y=(e,t,n)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Z=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{i(n.next(e))}catch(e){o(e)}},a=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,t)).next())}));e.createBroadcastChannelSynchronizer=(e,t,l,o,r)=>{const u=J(),s=new BroadcastChannel(t);return((e,t,l,o,r,u,s,c,d={})=>{let v,y=0,f=0,g=0;const p=O(),h=()=>J(11),b=(e,n,l,o)=>{f++,null==u||u(e,n,l,o),t(e,n,l,o)},M=(e,t,l,o)=>Z(void 0,null,(function*(){return new n(((n,a)=>{const i=o+"."+J(4),u=((e,t=0)=>setTimeout(e,1e3*t))((()=>{A(p,i),a(`No response from ${null!=e?e:"anyone"} to ${i}, `+t)}),r);T(p,i,[e,(e,t)=>{clearTimeout(u),A(p,i),n([e,t,o])}]),b(e,i,t,l)}))})),w=(e,[t,n])=>{m(t,(([t,n],l)=>{const o=C(e[0],l,D);m(t,(([e,t],n)=>{const l=C(o[0],n,D);m(e,(([e,t],n)=>l[0][n]=x(e,t))),l[1]=H(l[1],t)})),o[1]=H(o[1],n)})),e[1]=H(e[1],n)},j=(...t)=>Z(void 0,[...t],(function*(t=null,n,l=h()){try{a(n)&&([n,t,l]=yield M(null,1,"",l));const[o,r]=n,[i,u]=e.getMergeableContentHashes();let s=D();if(i!=o){const[n,o]=(yield M(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!S(o)){const[n,r]=(yield M(t,5,e.getMergeableRowHashes(o),l))[0];if(w(s,n),!S(r)){const n=(yield M(t,6,e.getMergeableCellHashes(r),l))[0];w(s,n)}}}return[s,u==r?D():(yield M(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==c||c(e)}})),L=U(e,(()=>Z(void 0,null,(function*(){const e=yield j();return!e||S(e[0][0])&&S(e[1][0])?void 0:e}))),((t,n)=>Z(void 0,null,(function*(){return n?b(null,h(),3,n):b(null,h(),2,e.getMergeableContentHashes())}))),(e=>v=e),(()=>v=void 0),c,2,((e,t)=>{for(var n in t||(t={}))W.call(t,n)&&Y(e,n,t[n]);if(Q)for(var n of Q(t))X.call(t,n)&&Y(e,n,t[n]);return e})({startSync:e=>Z(void 0,null,(function*(){return y=1,yield(yield L.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(y=0,L.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),L.stopSync()),getSynchronizerStats:()=>({sends:f,receives:g})},d),1);return l(((t,n,l,o)=>{const r=y||L.isAutoLoading();g++,null==s||s(t,n,l,o),0==l?i(P(p,n),(([e,n])=>a(e)||e==t?n(o,t):0)):2==l&&r?j(t,o,null!=n?n:void 0).then((e=>{null==v||v(void 0,e)})).catch(c):3==l&&r?null==v||v(void 0,o):i(1==l&&(y||L.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{b(t,n,0,e)}))})),L})(e,((e,t,n,l)=>s.postMessage([u,e,t,n,l])),(e=>{s.onmessage=({data:[t,n,l,o,r]})=>a(n)||n==u?e(t,l,o,r):0}),(()=>{s.close()}),.01,l,o,r,{getChannelName:()=>t})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerBroadcastChannel={});
