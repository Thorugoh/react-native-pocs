var e,t;e=this,t=function(e){"use strict";const t=(e,t="",n)=>e.split(t,n),n=Promise,l=globalThis,o=(e,t=0)=>setTimeout(e,1e3*t),r=Math,i=r.floor,a=e=>null==e,u=(e,t,n)=>a(e)?null==n?void 0:n():t(e),s=e=>Array.isArray(e),c=e=>e.length,d=e=>{throw Error(e)},v=(e,t)=>e.forEach(t),y=(e,...t)=>e.push(...t),f=e=>e.shift(),g=Object,p=e=>g.getPrototypeOf(e),h=g.entries,b=g.keys,S=g.freeze,m=(e,t)=>v(h(e),(([e,n])=>t(n,e))),M=e=>(e=>!a(e)&&u(p(e),(e=>e==g.prototype||a(p(e))),(()=>!0)))(e)&&0==(e=>c(b(e)))(e),w=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),A=e=>a(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),C=(e,t)=>null==e?void 0:e.forEach(t),O=(e,t)=>null==e?void 0:e.delete(t),P=e=>new Map(e),L=(e,t)=>null==e?void 0:e.get(t),T=(e,t,n)=>a(n)?(O(e,t),e):null==e?void 0:e.set(t,n),j=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(L(e,t)):T(e,t,n()),L(e,t)},x=(e,t,n,l,o=0)=>u((n?j:L)(e,t[o],o>c(t)-2?n:P),(r=>{if(o>c(t)-2)return(null==l?void 0:l(r))&&T(e,t[o]),r;const i=x(r,t,n,l,o+1);return A(r)&&T(e,t[o]),i})),H=(e,t)=>t?[e,t]:[e],D=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},E=(e="")=>H(((e=[])=>g.fromEntries(e))(),e),z=e=>new Set(s(e)||a(e)?e:[e]),R=/^\d+$/;var V=Object.defineProperty,I=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable,B=(e,t,n)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));const N=P(),U=P(),q=(e,t,n,l,o,r,i,g={},p=0,h=[])=>{let b,m,w,H=0,D=0,E=0;j(N,h,(()=>0)),j(U,h,(()=>[]));const V=P(),[q,G,J,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!M(e)||!M(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!M(e)||!M(t),t.setContent]:d("Store type not supported by this Persister"))(i,e,p),[W,X,Y]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>{var l;return null!=(l=n?f(e):null)?l:""+t++},t=>{R.test(t)&&c(e)<1e3&&y(e,t)}]})(),l=P();return[(n,o,r,i=[],a=()=>[])=>{null!=e||(e=re);const u=t(1);var s,c;return T(l,u,[n,o,r,i,a]),c=u,null==(s=x(o,null!=r?r:[""],z))||s.add(c),u},(t,n,...o)=>v(((e,t=[""])=>{const n=[],l=(e,o)=>o==c(t)?y(n,e):null===t[o]?C(e,(e=>l(e,o+1))):v([t[o],null],(t=>l(L(e,t),o+1)));return l(e,0),n})(t,n),(t=>C(t,(t=>L(l,t)[0](e,...null!=n?n:[],...o))))),e=>u(L(l,e),(([,t,o])=>(x(t,null!=o?o:[""],void 0,(t=>(O(t,e),A(t)?1:0))),T(l,e),n(e),o))),t=>u(L(l,t),(([t,,n=[],l,o])=>{const r=(...i)=>{var u,s;const d=c(i);d==c(n)?t(e,...i,...o(i)):a(n[d])?v(null!=(s=null==(u=l[d])?void 0:u.call(l,...i))?s:[],(e=>r(...i,e))):r(...i,n[d])};r()}))]})(),Z=e=>{e!=H&&(H=e,X(V,void 0,H))},_=t=>{(q&&s(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},ee=e=>F(void 0,null,(function*(){return 2!=H&&(Z(1),D++,yield oe((()=>F(void 0,null,(function*(){try{const n=yield t();s(n)?_(n):e?Q(e):d("Content is not an array: "+n)}catch(t){null==r||r(t),e&&Q(e)}Z(0)}))))),re})),te=()=>(m&&(o(m),m=void 0),re),ne=e=>F(void 0,null,(function*(){return 1!=H&&(Z(2),E++,yield oe((()=>F(void 0,null,(function*(){try{yield n(G,e)}catch(e){null==r||r(e)}Z(0)}))))),re})),le=()=>(w&&(e.delListener(w),w=void 0),re),oe=(...e)=>F(void 0,null,(function*(){return y(L(U,h),...e),yield F(void 0,null,(function*(){if(!L(N,h)){for(T(N,h,1);!a(b=f(L(U,h)));)try{yield b()}catch(e){null==r||r(e)}T(N,h,0)}})),re})),re=((e,t)=>{for(var n in t||(t={}))$.call(t,n)&&B(e,n,t[n]);if(I)for(var n of I(t))k.call(t,n)&&B(e,n,t[n]);return e})({load:ee,startAutoLoad:e=>F(void 0,null,(function*(){te(),yield ee(e);try{m=yield l(((e,t)=>F(void 0,null,(function*(){t||e?2!=H&&(Z(1),D++,_(null!=t?t:e),Z(0)):yield ee()}))))}catch(e){null==r||r(e)}return re})),stopAutoLoad:te,isAutoLoading:()=>!a(m),save:ne,startAutoSave:()=>F(void 0,null,(function*(){return le(),yield ne(),w=e.addDidFinishTransactionListener((()=>{const e=J();K(e)&&ne(e)})),re})),stopAutoSave:le,isAutoSaving:()=>!a(w),getStatus:()=>H,addStatusListener:e=>W(e,V),delListener:t=>(Y(t),e),schedule:oe,getStore:()=>e,destroy:()=>(L(U,h).splice(0,void 0),te().stopAutoSave()),getStats:()=>({loads:D,saves:E})},g);return S(re)},G=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),J=l.crypto?e=>l.crypto.getRandomValues(e):e=>(e=>e.map((()=>i(256*r.random()))))(e),K=(e=16)=>{return t=(e,t)=>e+G[63&t],J(new Uint8Array(e)).reduce(t,"");var t};var Q=Object.defineProperty,W=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,Z=(e,t,n)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));const ee=P();e.createLocalSynchronizer=(e,t,l,r)=>{const i=K();return((e,t,l,r,i,s,c,d,v={})=>{let y,f=0,g=0,p=0;const h=P(),b=()=>K(11),S=(e,n,l,o)=>{g++,null==s||s(e,n,l,o),t(e,n,l,o)},A=(e,t,l,r)=>_(void 0,null,(function*(){return new n(((n,a)=>{const u=r+"."+K(4),s=o((()=>{O(h,u),a(`No response from ${null!=e?e:"anyone"} to ${u}, `+t)}),i);T(h,u,[e,(e,t)=>{clearTimeout(s),O(h,u),n([e,t,r])}]),S(e,u,t,l)}))})),C=(e,[t,n])=>{m(t,(([t,n],l)=>{const o=w(e[0],l,E);m(t,(([e,t],n)=>{const l=w(o[0],n,E);m(e,(([e,t],n)=>l[0][n]=H(e,t))),l[1]=D(l[1],t)})),o[1]=D(o[1],n)})),e[1]=D(e[1],n)},j=(...t)=>_(void 0,[...t],(function*(t=null,n,l=b()){try{a(n)&&([n,t,l]=yield A(null,1,"",l));const[o,r]=n,[i,u]=e.getMergeableContentHashes();let s=E();if(i!=o){const[n,o]=(yield A(t,4,e.getMergeableTableHashes(),l))[0];if(s=n,!M(o)){const[n,r]=(yield A(t,5,e.getMergeableRowHashes(o),l))[0];if(C(s,n),!M(r)){const n=(yield A(t,6,e.getMergeableCellHashes(r),l))[0];C(s,n)}}}return[s,u==r?E():(yield A(t,7,e.getMergeableValueHashes(),l))[0],1]}catch(e){null==d||d(e)}})),x=q(e,(()=>_(void 0,null,(function*(){const e=yield j();return!e||M(e[0][0])&&M(e[1][0])?void 0:e}))),((t,n)=>_(void 0,null,(function*(){return n?S(null,b(),3,n):S(null,b(),2,e.getMergeableContentHashes())}))),(e=>y=e),(()=>y=void 0),d,2,((e,t)=>{for(var n in t||(t={}))X.call(t,n)&&Z(e,n,t[n]);if(W)for(var n of W(t))Y.call(t,n)&&Z(e,n,t[n]);return e})({startSync:e=>_(void 0,null,(function*(){return f=1,yield(yield x.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(f=0,x.stopAutoLoad().stopAutoSave()),destroy:()=>(r(),x.stopSync()),getSynchronizerStats:()=>({sends:g,receives:p})},v),1);return l(((t,n,l,o)=>{const r=f||x.isAutoLoading();p++,null==c||c(t,n,l,o),0==l?u(L(h,n),(([e,n])=>a(e)||e==t?n(o,t):0)):2==l&&r?j(t,o,null!=n?n:void 0).then((e=>{null==y||y(void 0,e)})).catch(d):3==l&&r?null==y||y(void 0,o):u(1==l&&(f||x.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{S(t,n,0,e)}))})),x})(e,((e,t,n,l)=>o((()=>{var o,r;return a(e)?(r=(e,o)=>e!=i?o(i,t,n,l):0,C(ee,((e,t)=>r(t,e)))):null==(o=L(ee,e))?void 0:o(i,t,n,l)}))),(e=>{T(ee,i,e)}),(()=>{O(ee,i)}),.01,t,l,r)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerLocal={});
