var e,t;e=this,t=function(e){"use strict";const t="",n=(e,t="",n)=>e.split(t,n),l=Promise,o=globalThis,r=Math,i=r.floor,a=e=>null==e,u=(e,t,n)=>a(e)?null==n?void 0:n():t(e),s=e=>Array.isArray(e),c=(e,t,n)=>e.slice(t,n),d=e=>e.length,v=e=>new l(e),y=e=>{throw Error(e)},f=(e,t)=>e.forEach(t),g=(e,...t)=>e.push(...t),p=e=>e.shift(),h=Object,b=e=>h.getPrototypeOf(e),S=h.entries,m=h.keys,w=h.freeze,M=(e,t)=>f(S(e),(([e,n])=>t(n,e))),O=e=>(e=>!a(e)&&u(b(e),(e=>e==h.prototype||a(b(e))),(()=>!0)))(e)&&0==(e=>d(m(e)))(e),C=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),A=JSON.stringify,P=JSON.parse,L=e=>a(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),T=(e,t)=>null==e?void 0:e.forEach(t),j=(e,t)=>null==e?void 0:e.delete(t),x=e=>new Map(e),E=(e,t)=>null==e?void 0:e.get(t),H=(e,t,n)=>a(n)?(j(e,t),e):null==e?void 0:e.set(t,n),D=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(E(e,t)):H(e,t,n()),E(e,t)},z=(e,t,n,l,o=0)=>u((n?D:E)(e,t[o],o>d(t)-2?n:x),(r=>{if(o>d(t)-2)return(null==l?void 0:l(r))&&H(e,t[o]),r;const i=z(r,t,n,l,o+1);return L(r)&&H(e,t[o]),i})),N=(e,t)=>t?[e,t]:[e],R=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},V=(e="")=>N(((e=[])=>h.fromEntries(e))(),e),W=e=>new Set(s(e)||a(e)?e:[e]),k=/^\d+$/;var I=Object.defineProperty,J=Object.getOwnPropertySymbols,$=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable,F=(e,t,n)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,U=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));const q=x(),G=x(),K=(e,n,l,o,r,i,c,v={},h=0,b=[])=>{let S,m,M,C=0,A=0,P=0;D(q,b,(()=>0)),D(G,b,(()=>[]));const N=x(),[R,V,I,K,Q]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!O(e)||!O(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!O(e)||!O(t),t.setContent]:y("Store type not supported by this Persister"))(c,e,h),[X,Y,Z]=(()=>{let e;const[n,l]=(()=>{const e=[];let n=0;return[l=>{var o;return null!=(o=l?p(e):null)?o:t+n++},t=>{k.test(t)&&d(e)<1e3&&g(e,t)}]})(),o=x();return[(l,r,i,a=[],u=()=>[])=>{null!=e||(e=ie);const s=n(1);var c,d;return H(o,s,[l,r,i,a,u]),d=s,null==(c=z(r,null!=i?i:[t],W))||c.add(d),s},(n,l,...r)=>f(((e,n=[t])=>{const l=[],o=(e,t)=>t==d(n)?g(l,e):null===n[t]?T(e,(e=>o(e,t+1))):f([n[t],null],(n=>o(E(e,n),t+1)));return o(e,0),l})(n,l),(t=>T(t,(t=>E(o,t)[0](e,...null!=l?l:[],...r))))),e=>u(E(o,e),(([,n,r])=>(z(n,null!=r?r:[t],void 0,(t=>(j(t,e),L(t)?1:0))),H(o,e),l(e),r))),t=>u(E(o,t),(([t,,n=[],l,o])=>{const r=(...i)=>{var u,s;const c=d(i);c==d(n)?t(e,...i,...o(i)):a(n[c])?f(null!=(s=null==(u=l[c])?void 0:u.call(l,...i))?s:[],(e=>r(...i,e))):r(...i,n[c])};r()}))]})(),_=e=>{e!=C&&(C=e,Y(N,void 0,C))},ee=t=>{(R&&s(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},te=e=>U(void 0,null,(function*(){return 2!=C&&(_(1),A++,yield re((()=>U(void 0,null,(function*(){try{const t=yield n();s(t)?ee(t):e?Q(e):y("Content is not an array: "+t)}catch(t){null==i||i(t),e&&Q(e)}_(0)}))))),ie})),ne=()=>(m&&(r(m),m=void 0),ie),le=e=>U(void 0,null,(function*(){return 1!=C&&(_(2),P++,yield re((()=>U(void 0,null,(function*(){try{yield l(V,e)}catch(e){null==i||i(e)}_(0)}))))),ie})),oe=()=>(M&&(e.delListener(M),M=void 0),ie),re=(...e)=>U(void 0,null,(function*(){return g(E(G,b),...e),yield U(void 0,null,(function*(){if(!E(q,b)){for(H(q,b,1);!a(S=p(E(G,b)));)try{yield S()}catch(e){null==i||i(e)}H(q,b,0)}})),ie})),ie=((e,t)=>{for(var n in t||(t={}))$.call(t,n)&&F(e,n,t[n]);if(J)for(var n of J(t))B.call(t,n)&&F(e,n,t[n]);return e})({load:te,startAutoLoad:e=>U(void 0,null,(function*(){ne(),yield te(e);try{m=yield o(((e,t)=>U(void 0,null,(function*(){t||e?2!=C&&(_(1),A++,ee(null!=t?t:e),_(0)):yield te()}))))}catch(e){null==i||i(e)}return ie})),stopAutoLoad:ne,isAutoLoading:()=>!a(m),save:le,startAutoSave:()=>U(void 0,null,(function*(){return oe(),yield le(),M=e.addDidFinishTransactionListener((()=>{const e=I();K(e)&&le(e)})),ie})),stopAutoSave:oe,isAutoSaving:()=>!a(M),getStatus:()=>C,addStatusListener:e=>X(e,N),delListener:t=>(Z(t),e),schedule:re,getStore:()=>e,destroy:()=>(E(G,b).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:A,saves:P})},v);return w(ie)},Q=n("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),X=o.crypto?e=>o.crypto.getRandomValues(e):e=>(e=>e.map((()=>i(256*r.random()))))(e),Y=(e=16)=>{return t=(e,t)=>e+Q[63&t],X(new Uint8Array(e)).reduce(t,"");var t};var Z=Object.defineProperty,_=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,ne=(e,t,n)=>t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,le=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));e.createWsSynchronizer=(e,n,l=1,o,r,i)=>{return s=function*(){const s=(e,t)=>(n.addEventListener(e,t),()=>n.removeEventListener(e,t)),d=((e,n,l,o,r,i,s,c,d={})=>{let y,f=0,g=0,p=0;const h=x(),b=()=>Y(11),S=(e,t,l,o)=>{g++,null==i||i(e,t,l,o),n(e,t,l,o)},m=(e,t,n,l)=>le(void 0,null,(function*(){return v(((o,i)=>{const a=l+"."+Y(4),u=((e,t=0)=>setTimeout(e,1e3*t))((()=>{j(h,a),i(`No response from ${null!=e?e:"anyone"} to ${a}, `+t)}),r);H(h,a,[e,(e,t)=>{clearTimeout(u),j(h,a),o([e,t,l])}]),S(e,a,t,n)}))})),w=(e,[t,n])=>{M(t,(([t,n],l)=>{const o=C(e[0],l,V);M(t,(([e,t],n)=>{const l=C(o[0],n,V);M(e,(([e,t],n)=>l[0][n]=N(e,t))),l[1]=R(l[1],t)})),o[1]=R(o[1],n)})),e[1]=R(e[1],n)},A=(...n)=>le(void 0,[...n],(function*(n=null,l,o=b()){try{a(l)&&([l,n,o]=yield m(null,1,t,o));const[r,i]=l,[u,s]=e.getMergeableContentHashes();let c=V();if(u!=r){const[t,l]=(yield m(n,4,e.getMergeableTableHashes(),o))[0];if(c=t,!O(l)){const[t,r]=(yield m(n,5,e.getMergeableRowHashes(l),o))[0];if(w(c,t),!O(r)){const t=(yield m(n,6,e.getMergeableCellHashes(r),o))[0];w(c,t)}}}return[c,s==i?V():(yield m(n,7,e.getMergeableValueHashes(),o))[0],1]}catch(e){null==c||c(e)}})),P=K(e,(()=>le(void 0,null,(function*(){const e=yield A();return!e||O(e[0][0])&&O(e[1][0])?void 0:e}))),((t,n)=>le(void 0,null,(function*(){return n?S(null,b(),3,n):S(null,b(),2,e.getMergeableContentHashes())}))),(e=>y=e),(()=>y=void 0),c,2,((e,t)=>{for(var n in t||(t={}))ee.call(t,n)&&ne(e,n,t[n]);if(_)for(var n of _(t))te.call(t,n)&&ne(e,n,t[n]);return e})({startSync:e=>le(void 0,null,(function*(){return f=1,yield(yield P.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(f=0,P.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),P.stopSync()),getSynchronizerStats:()=>({sends:g,receives:p})},d),1);return l(((t,n,l,o)=>{const r=f||P.isAutoLoading();p++,null==s||s(t,n,l,o),0==l?u(E(h,n),(([e,n])=>a(e)||e==t?n(o,t):0)):2==l&&r?A(t,o,null!=n?n:void 0).then((e=>{null==y||y(void 0,e)})).catch(c):3==l&&r?null==y||y(void 0,o):u(1==l&&(f||P.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{S(t,n,0,e)}))})),P})(e,((e,...l)=>n.send(((e,...n)=>{return l=null!=e?e:t,o=A(n,((e,t)=>void 0===t?"￼":t)),l+"\n"+o;var l,o})(e,...l))),(e=>s("message",(({data:t})=>((e,t)=>(e=>{const n=e.indexOf("\n");var l,o,r;-1!==n&&(l=c(e,0,n),o=c(e,n+1),t(l,...(r=o,P(r,((e,t)=>"￼"===t?void 0:t)))))})(e))(t.toString("utf8"),e)))),(()=>{n.close()}),l,o,r,i,{getWebSocket:()=>n});return v((e=>{if(n.readyState!=n.OPEN){const t=t=>{t&&(null==i||i(t)),n(),l(),e(d)},n=s("open",(()=>t())),l=s("error",t)}else e(d)}))},new Promise(((e,t)=>{var n=e=>{try{o(s.next(e))}catch(e){t(e)}},l=e=>{try{o(s.throw(e))}catch(e){t(e)}},o=t=>t.done?e(t.value):Promise.resolve(t.value).then(n,l);o((s=s.apply(void 0,null)).next())}));var s}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsClient={});
