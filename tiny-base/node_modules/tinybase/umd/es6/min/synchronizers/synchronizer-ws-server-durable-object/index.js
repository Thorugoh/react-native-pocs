var e,t;e=this,t=function(e,t){"use strict";const n="",l=(e,t="",n)=>e.split(t,n),r=Promise,o=globalThis,s=(e,t=0)=>setTimeout(e,1e3*t),i=Math,a=i.floor,u=e=>null==e,c=(e,t,n)=>u(e)?null==n?void 0:n():t(e),d=e=>Array.isArray(e),h=(e,t,n)=>e.slice(t,n),v=e=>e.length,y=e=>{throw Error(e)},g=(e,t)=>e.forEach(t),f=(e,t)=>e.map(t),p=(e,...t)=>e.push(...t),b=e=>e.shift(),S=Object,w=e=>S.getPrototypeOf(e),m=S.entries,C=S.keys,M=S.freeze,P=(e,t)=>g(m(e),(([e,n])=>t(n,e))),O=e=>(e=>!u(e)&&c(w(e),(e=>e==S.prototype||u(w(e))),(()=>!0)))(e)&&0==(e=>v(C(e)))(e),x=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),k=JSON.stringify,A=JSON.parse,T=(e,t)=>{const n=e.indexOf("\n");-1!==n&&t(h(e,0,n),h(e,n+1))},j=(e,...t)=>L(null!=e?e:n,k(t,((e,t)=>void 0===t?"￼":t))),L=(e,t)=>e+"\n"+t,D=e=>u(e)||0==(e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0})(e),I=(e,t)=>null==e?void 0:e.forEach(t),W=(e,t)=>null==e?void 0:e.delete(t),E=e=>new Map(e),H=(e,t)=>null==e?void 0:e.get(t),R=(e,t,n)=>u(n)?(W(e,t),e):null==e?void 0:e.set(t,n),z=(e,t,n,l)=>{var r,o,s;return o=t,null!=(s=null==(r=e)?void 0:r.has(o))&&s?null==l||l(H(e,t)):R(e,t,n()),H(e,t)},N=(e,t,n,l,r=0)=>c((n?z:H)(e,t[r],r>v(t)-2?n:E),(o=>{if(r>v(t)-2)return(null==l?void 0:l(o))&&R(e,t[r]),o;const s=N(o,t,n,l,r+1);return D(o)&&R(e,t[r]),s})),F=(e,t)=>t?[e,t]:[e],U=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},V=(e="")=>F(((e=[])=>S.fromEntries(e))(),e),q=e=>new Set(d(e)||u(e)?e:[e]),J=/^\d+$/;var $=Object.defineProperty,B=Object.getOwnPropertySymbols,G=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,Q=(e,t,n)=>t in e?$(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,X=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},s=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,s);i((n=n.apply(e,t)).next())}));const Y=E(),Z=E(),_=(e,t,l,r,o,s,i,a={},h=0,f=[])=>{let S,w,m,C=0,P=0,x=0;z(Y,f,(()=>0)),z(Z,f,(()=>[]));const k=E(),[A,T,j,L,F]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!O(e)||!O(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!O(e)||!O(t),t.setContent]:y("Store type not supported by this Persister"))(i,e,h),[U,V,$]=(()=>{let e;const[t,l]=(()=>{const e=[];let t=0;return[l=>{var r;return null!=(r=l?b(e):null)?r:n+t++},t=>{J.test(t)&&v(e)<1e3&&p(e,t)}]})(),r=E();return[(l,o,s,i=[],a=()=>[])=>{null!=e||(e=se);const u=t(1);var c,d;return R(r,u,[l,o,s,i,a]),d=u,null==(c=N(o,null!=s?s:[n],q))||c.add(d),u},(t,l,...o)=>g(((e,t=[n])=>{const l=[],r=(e,n)=>n==v(t)?p(l,e):null===t[n]?I(e,(e=>r(e,n+1))):g([t[n],null],(t=>r(H(e,t),n+1)));return r(e,0),l})(t,l),(t=>I(t,(t=>H(r,t)[0](e,...null!=l?l:[],...o))))),e=>c(H(r,e),(([,t,o])=>(N(t,null!=o?o:[n],void 0,(t=>(W(t,e),D(t)?1:0))),R(r,e),l(e),o))),t=>c(H(r,t),(([t,,n=[],l,r])=>{const o=(...s)=>{var i,a;const c=v(s);c==v(n)?t(e,...s,...r(s)):u(n[c])?g(null!=(a=null==(i=l[c])?void 0:i.call(l,...s))?a:[],(e=>o(...s,e))):o(...s,n[c])};o()}))]})(),_=e=>{e!=C&&(C=e,V(k,void 0,C))},ee=t=>{(A&&d(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},te=e=>X(void 0,null,(function*(){return 2!=C&&(_(1),P++,yield oe((()=>X(void 0,null,(function*(){try{const n=yield t();d(n)?ee(n):e?F(e):y("Content is not an array: "+n)}catch(t){e&&F(e)}_(0)}))))),se})),ne=()=>(w&&(o(w),w=void 0),se),le=e=>X(void 0,null,(function*(){return 1!=C&&(_(2),x++,yield oe((()=>X(void 0,null,(function*(){try{yield l(T,e)}catch(e){}_(0)}))))),se})),re=()=>(m&&(e.delListener(m),m=void 0),se),oe=(...e)=>X(void 0,null,(function*(){return p(H(Z,f),...e),yield X(void 0,null,(function*(){if(!H(Y,f)){for(R(Y,f,1);!u(S=b(H(Z,f)));)try{yield S()}catch(e){}R(Y,f,0)}})),se})),se=((e,t)=>{for(var n in t||(t={}))G.call(t,n)&&Q(e,n,t[n]);if(B)for(var n of B(t))K.call(t,n)&&Q(e,n,t[n]);return e})({load:te,startAutoLoad:e=>X(void 0,null,(function*(){ne(),yield te(e);try{w=yield r(((e,t)=>X(void 0,null,(function*(){t||e?2!=C&&(_(1),P++,ee(null!=t?t:e),_(0)):yield te()}))))}catch(e){}return se})),stopAutoLoad:ne,isAutoLoading:()=>!u(w),save:le,startAutoSave:()=>X(void 0,null,(function*(){return re(),yield le(),m=e.addDidFinishTransactionListener((()=>{const e=j();L(e)&&le(e)})),se})),stopAutoSave:re,isAutoSaving:()=>!u(m),getStatus:()=>C,addStatusListener:e=>U(e,k),delListener:t=>($(t),e),schedule:oe,getStore:()=>e,destroy:()=>(H(Z,f).splice(0,void 0),ne().stopAutoSave()),getStats:()=>({loads:P,saves:x})},a);return M(se)},ee=l("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),te=o.crypto?e=>o.crypto.getRandomValues(e):e=>f(e,(()=>a(256*i.random()))),ne=(e=16)=>{return t=(e,t)=>e+ee[63&t],te(new Uint8Array(e)).reduce(t,"");var t};var le,re,oe,se,ie=Object.defineProperty,ae=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,de=(e,t,n)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,he=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},s=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,s);i((n=n.apply(e,t)).next())})),ve=e=>{throw TypeError(e)},ye=(e,t,n)=>t.has(e)||ve("Cannot "+n),ge=(e,t,n)=>(ye(e,t,"read from private field"),n?n.call(e):t.get(e)),fe=(e,t,n)=>t.has(e)?ve("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),pe=(e,t,n)=>(ye(e,t,"access private method"),n),be=(e,t,n)=>new Promise(((l,r)=>{var o=e=>{try{i(n.next(e))}catch(e){r(e)}},s=e=>{try{i(n.throw(e))}catch(e){r(e)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(o,s);i((n=n.apply(e,t)).next())}));const Se=/\/([^?]*)/,we="S",me=e=>{var t,l,r,o;return null!=(l=null==(r=new URL(e.url).pathname,o=Se,t=null==r?void 0:r.match(o))?void 0:t[1])?l:n},Ce=e=>{var t;return"websocket"==(null==(t=e.headers.get("upgrade"))?void 0:t.toLowerCase())?e.headers.get("sec-websocket-key"):null},Me=(e,t=null,n=null)=>new Response(n,{status:e,webSocket:t}),Pe=()=>Me(426,null,"Upgrade required");class Oe extends t.DurableObject{constructor(e,t){super(e,t),fe(this,re),fe(this,le),this.ctx.blockConcurrencyWhile((()=>be(this,null,(function*(){return yield c(yield this.createPersister(),(e=>be(this,null,(function*(){const t=((e,t,l,o,i,a,d,h,v={})=>{let y,g=0,f=0,p=0;const b=E(),S=()=>ne(11),w=(e,n,l,r)=>{f++,t(e,n,l,r)},m=(e,t,n,l)=>he(void 0,null,(function*(){return new r(((r,o)=>{const a=l+"."+ne(4),u=s((()=>{W(b,a),o(`No response from ${null!=e?e:"anyone"} to ${a}, `+t)}),i);R(b,a,[e,(e,t)=>{clearTimeout(u),W(b,a),r([e,t,l])}]),w(e,a,t,n)}))})),C=(e,[t,n])=>{P(t,(([t,n],l)=>{const r=x(e[0],l,V);P(t,(([e,t],n)=>{const l=x(r[0],n,V);P(e,(([e,t],n)=>l[0][n]=F(e,t))),l[1]=U(l[1],t)})),r[1]=U(r[1],n)})),e[1]=U(e[1],n)},M=(...t)=>he(void 0,[...t],(function*(t=null,l,r=S()){try{u(l)&&([l,t,r]=yield m(null,1,n,r));const[o,s]=l,[i,a]=e.getMergeableContentHashes();let c=V();if(i!=o){const[n,l]=(yield m(t,4,e.getMergeableTableHashes(),r))[0];if(c=n,!O(l)){const[n,o]=(yield m(t,5,e.getMergeableRowHashes(l),r))[0];if(C(c,n),!O(o)){const n=(yield m(t,6,e.getMergeableCellHashes(o),r))[0];C(c,n)}}}return[c,a==s?V():(yield m(t,7,e.getMergeableValueHashes(),r))[0],1]}catch(e){}})),k=_(e,(()=>he(void 0,null,(function*(){const e=yield M();return!e||O(e[0][0])&&O(e[1][0])?void 0:e}))),((t,n)=>he(void 0,null,(function*(){return n?w(null,S(),3,n):w(null,S(),2,e.getMergeableContentHashes())}))),(e=>y=e),(()=>y=void 0),0,2,((e,t)=>{for(var n in t||(t={}))ue.call(t,n)&&de(e,n,t[n]);if(ae)for(var n of ae(t))ce.call(t,n)&&de(e,n,t[n]);return e})({startSync:e=>he(void 0,null,(function*(){return g=1,yield(yield k.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(g=0,k.stopAutoLoad().stopAutoSave()),destroy:()=>k.stopSync(),getSynchronizerStats:()=>({sends:f,receives:p})},v),1);return l(((t,n,l,r)=>{const o=g||k.isAutoLoading();p++,0==l?c(H(b,n),(([e,n])=>u(e)||e==t?n(r,t):0)):2==l&&o?M(t,r,null!=n?n:void 0).then((e=>{null==y||y(void 0,e)})).catch(h):3==l&&o?null==y||y(void 0,r):c(1==l&&(g||k.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(r):5==l?e.getMergeableRowDiff(r):6==l?e.getMergeableCellDiff(r):7==l?e.getMergeableValueDiff(r):void 0,(e=>{w(t,n,0,e)}))})),k})(e.getStore(),((e,t,n,l)=>pe(this,re,oe).call(this,we,j(e,t,n,l))),(e=>{return n=t=>((e,t)=>T(e,((e,n)=>{return t(e,...(l=n,A(l,((e,t)=>"￼"===t?void 0:t))));var l})))(t,e),ye(this,t=le,"write to private field"),t.set(this,n),n;var t,n}),0,1);yield e.load(),yield e.startAutoSave(),s(t.startSync)}))))}))))}fetch(e){const t=me(e);return c(Ce(e),(e=>{const[l,r]=(o=new WebSocketPair,S.values(o));var o,s;return s=pe(this,re,se).call(this),0==v(s)&&this.onPathId(t,1),this.ctx.acceptWebSocket(r,[e,t]),this.onClientId(t,e,1),r.send(j(we,null,1,n)),Me(101,l)}),Pe)}webSocketMessage(e,t){c(this.ctx.getTags(e)[0],(n=>pe(this,re,oe).call(this,n,t.toString(),e)))}webSocketClose(e){const[t,n]=this.ctx.getTags(e);this.onClientId(n,t,-1),1==v(pe(this,re,se).call(this))&&this.onPathId(n,-1)}createPersister(){}getPathId(){var e;return null==(e=this.ctx.getTags(pe(this,re,se).call(this)[0]))?void 0:e[1]}getClientIds(){return f(pe(this,re,se).call(this),(e=>this.ctx.getTags(e)[0]))}onPathId(e,t){}onClientId(e,t,n){}onMessage(e,t,n){}}le=new WeakMap,re=new WeakSet,oe=function(e,t,l){T(t.toString(),((t,r)=>{var o,s,i;const a=L(e,r);this.onMessage(e,t,r),t==n?(e!=we&&(null==(o=ge(this,le))||o.call(this,a)),g(pe(this,re,se).call(this),(e=>{e!=l&&e.send(a)}))):t==we?null==(s=ge(this,le))||s.call(this,a):t!=e&&(null==(i=pe(this,re,se).call(this,t)[0])||i.send(a))}))},se=function(e){return this.ctx.getWebSockets(e)},e.WsServerDurableObject=Oe,e.getWsServerDurableObjectFetch=e=>(t,n)=>Ce(t)?n[e].get(n[e].idFromName(me(t))).fetch(t):Pe()},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("cloudflare:workers")):"function"==typeof define&&define.amd?define(["exports","cloudflare:workers"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsServerDurableObject={},e["cloudflare:workers"]);
