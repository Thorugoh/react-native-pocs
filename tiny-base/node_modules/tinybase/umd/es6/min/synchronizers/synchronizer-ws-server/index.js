var e,t;e=this,t=function(e){"use strict";const t="",n="error",l=(e,t="",n)=>e.split(t,n),o=Promise,r=globalThis,i=Math,a=i.floor,s=e=>null==e,u=(e,t,n)=>s(e)?null==n?void 0:n():t(e),d=e=>Array.isArray(e),c=(e,t,n)=>e.slice(t,n),v=e=>e.length,y=e=>{throw Error(e)},f=(e,t)=>e.forEach(t),g=(e,t,n)=>e.reduce(t,n),p=(e,...t)=>e.push(...t),h=e=>e.shift(),b=Object,S=e=>b.getPrototypeOf(e),m=b.entries,w=b.keys,A=b.freeze,C=(e,t)=>f(m(e),(([e,n])=>t(n,e))),M=e=>(e=>!s(e)&&u(S(e),(e=>e==b.prototype||s(S(e))),(()=>!0)))(e)&&0==(e=>v(w(e)))(e),O=(e,t,n)=>(((e,t)=>t in e)(e,t)||(e[t]=n()),e[t]),P=e=>{var t;return null!=(t=null==e?void 0:e.size)?t:0},L=(T=P,e=>g(x(e),((e,t)=>e+T(t)),0));var T;const j=e=>s(e)||0==P(e),x=e=>{var t;return[...null!=(t=null==e?void 0:e.values())?t:[]]},H=(e,t)=>null==e?void 0:e.forEach(t),D=(e,t)=>null==e?void 0:e.delete(t),E=e=>new Map(e),I=e=>{var t;return[...null!=(t=null==e?void 0:e.keys())?t:[]]},k=(e,t)=>null==e?void 0:e.get(t),z=(e,t,n)=>s(n)?(D(e,t),e):null==e?void 0:e.set(t,n),N=(e,t,n,l)=>{var o,r,i;return r=t,null!=(i=null==(o=e)?void 0:o.has(r))&&i?null==l||l(k(e,t)):z(e,t,n()),k(e,t)},R=(e,t,n,l,o=0)=>u((n?N:k)(e,t[o],o>v(t)-2?n:E),(r=>{if(o>v(t)-2)return(null==l?void 0:l(r))&&z(e,t[o]),r;const i=R(r,t,n,l,o+1);return j(r)&&z(e,t[o]),i})),V=JSON.stringify,W=JSON.parse,J=(e,t)=>{const n=e.indexOf("\n");-1!==n&&t(c(e,0,n),c(e,n+1))},$=(e,t)=>e+"\n"+t,B=(e,t)=>t?[e,t]:[e],F=(e,t)=>{var n;return null!=(n=(null!=e?e:"")>(null!=t?t:"")?e:t)?n:""},U=(e="")=>B(((e=[])=>b.fromEntries(e))(),e),q=e=>new Set(d(e)||s(e)?e:[e]),G=/^\d+$/,K=e=>{let n;const[l,o]=(()=>{const e=[];let n=0;return[l=>{var o;return null!=(o=l?h(e):null)?o:t+n++},t=>{G.test(t)&&v(e)<1e3&&p(e,t)}]})(),r=E();return[(o,i,a,s=[],u=()=>[])=>{null!=n||(n=e());const d=l(1);var c,v;return z(r,d,[o,i,a,s,u]),v=d,null==(c=R(i,null!=a?a:[t],q))||c.add(v),d},(e,l,...o)=>f(((e,n=[t])=>{const l=[],o=(e,t)=>t==v(n)?p(l,e):null===n[t]?H(e,(e=>o(e,t+1))):f([n[t],null],(n=>o(k(e,n),t+1)));return o(e,0),l})(e,l),(e=>H(e,(e=>k(r,e)[0](n,...null!=l?l:[],...o))))),e=>u(k(r,e),(([,n,l])=>(R(n,null!=l?l:[t],void 0,(t=>(D(t,e),j(t)?1:0))),z(r,e),o(e),l))),e=>u(k(r,e),(([e,,t=[],l,o])=>{const r=(...i)=>{var a,u;const d=v(i);d==v(t)?e(n,...i,...o(i)):s(t[d])?f(null!=(u=null==(a=l[d])?void 0:a.call(l,...i))?u:[],(e=>r(...i,e))):r(...i,t[d])};r()}))]};var Q=Object.defineProperty,X=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable,_=(e,t,n)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ee=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));const te=E(),ne=E(),le=l("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),oe=r.crypto?e=>r.crypto.getRandomValues(e):e=>(e=>e.map((()=>a(256*i.random()))))(e),re=(e=16)=>g(oe(new Uint8Array(e)),((e,t)=>e+le[63&t]),"");var ie=Object.defineProperty,ae=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,ue=Object.prototype.propertyIsEnumerable,de=(e,t,n)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ce=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));var ve=(e,t,n)=>new Promise(((l,o)=>{var r=e=>{try{a(n.next(e))}catch(e){o(e)}},i=e=>{try{a(n.throw(e))}catch(e){o(e)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((n=n.apply(e,t)).next())}));const ye=/\/([^?]*)/;e.createWsServer=(e,l,r)=>{const i=E(),a=E(),c=E(),v=E(),[g,b,S]=K((()=>T)),m=e=>{var t,n;null==(t=e[1])||t.destroy(),null==(n=e[2])||n.destroy()},w=(e,n,l)=>o=>J(o,((o,r)=>{var i,a,s;const u=$(e,r);var d;o===t?("S"!==e&&(null==(i=l[3])||i.call(l,u)),d=(t,n)=>t!==e?n.send(u):0,H(n,((e,t)=>d(t,e)))):"S"===o?null==(a=l[3])||a.call(l,u):null==(s=k(n,o))||s.send(u)}));e.on("connection",((e,g)=>{return u((S=g.url,P=ye,null==S?void 0:S.match(P)),(([,S])=>u(g.headers["sec-websocket-key"],(g=>ve(void 0,null,(function*(){const P=N(c,S,E),L=N(v,S,(()=>[0])),T=w(g,P,L);j(P)&&(b(i,void 0,S,1),yield((e,n,i)=>ve(void 0,null,(function*(){return u(yield null==l?void 0:l(n),(n=>{e[0]=1,e[1]=d(n)?n[0]:n;const l=w("S",i,e);e[2]=((e,n,l,r,i,a,c,v,f={})=>{let g,b=0,S=0,m=0;const w=E(),P=()=>re(11),L=(e,t,l,o)=>{S++,n(e,t,l,o)},T=(e,t,n,l)=>ce(void 0,null,(function*(){return new o(((o,r)=>{const a=l+"."+re(4),s=((e,t=0)=>setTimeout(e,1e3*t))((()=>{D(w,a),r(`No response from ${null!=e?e:"anyone"} to ${a}, `+t)}),i);z(w,a,[e,(e,t)=>{clearTimeout(s),D(w,a),o([e,t,l])}]),L(e,a,t,n)}))})),j=(e,[t,n])=>{C(t,(([t,n],l)=>{const o=O(e[0],l,U);C(t,(([e,t],n)=>{const l=O(o[0],n,U);C(e,(([e,t],n)=>l[0][n]=B(e,t))),l[1]=F(l[1],t)})),o[1]=F(o[1],n)})),e[1]=F(e[1],n)},x=(...n)=>ce(void 0,[...n],(function*(n=null,l,o=P()){try{s(l)&&([l,n,o]=yield T(null,1,t,o));const[r,i]=l,[a,u]=e.getMergeableContentHashes();let d=U();if(a!=r){const[t,l]=(yield T(n,4,e.getMergeableTableHashes(),o))[0];if(d=t,!M(l)){const[t,r]=(yield T(n,5,e.getMergeableRowHashes(l),o))[0];if(j(d,t),!M(r)){const t=(yield T(n,6,e.getMergeableCellHashes(r),o))[0];j(d,t)}}}return[d,u==i?U():(yield T(n,7,e.getMergeableValueHashes(),o))[0],1]}catch(e){null==v||v(e)}})),H=((e,t,n,l,o,r,i,a={},u=0,c=[])=>{let v,f,g,b=0,S=0,m=0;N(te,c,(()=>0)),N(ne,c,(()=>[]));const w=E(),[C,O,P,L,T]=((e=1,t,n)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!n),([[e],[t]])=>!M(e)||!M(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!M(e)||!M(t),t.setContent]:y("Store type not supported by this Persister"))(i,e,u),[j,x,H]=K((()=>B)),D=e=>{e!=b&&(b=e,x(w,void 0,b))},I=t=>{(C&&d(null==t?void 0:t[0])?1===(null==t?void 0:t[2])?e.applyMergeableChanges:e.setMergeableContent:1===(null==t?void 0:t[2])?e.applyChanges:e.setContent)(t)},R=e=>ee(void 0,null,(function*(){return 2!=b&&(D(1),S++,yield $((()=>ee(void 0,null,(function*(){try{const n=yield t();d(n)?I(n):e?T(e):y("Content is not an array: "+n)}catch(t){null==r||r(t),e&&T(e)}D(0)}))))),B})),V=()=>(f&&(o(f),f=void 0),B),W=e=>ee(void 0,null,(function*(){return 1!=b&&(D(2),m++,yield $((()=>ee(void 0,null,(function*(){try{yield n(O,e)}catch(e){null==r||r(e)}D(0)}))))),B})),J=()=>(g&&(e.delListener(g),g=void 0),B),$=(...e)=>ee(void 0,null,(function*(){return p(k(ne,c),...e),yield ee(void 0,null,(function*(){if(!k(te,c)){for(z(te,c,1);!s(v=h(k(ne,c)));)try{yield v()}catch(e){null==r||r(e)}z(te,c,0)}})),B})),B=((e,t)=>{for(var n in t||(t={}))Y.call(t,n)&&_(e,n,t[n]);if(X)for(var n of X(t))Z.call(t,n)&&_(e,n,t[n]);return e})({load:R,startAutoLoad:e=>ee(void 0,null,(function*(){V(),yield R(e);try{f=yield l(((e,t)=>ee(void 0,null,(function*(){t||e?2!=b&&(D(1),S++,I(null!=t?t:e),D(0)):yield R()}))))}catch(e){null==r||r(e)}return B})),stopAutoLoad:V,isAutoLoading:()=>!s(f),save:W,startAutoSave:()=>ee(void 0,null,(function*(){return J(),yield W(),g=e.addDidFinishTransactionListener((()=>{const e=P();L(e)&&W(e)})),B})),stopAutoSave:J,isAutoSaving:()=>!s(g),getStatus:()=>b,addStatusListener:e=>j(e,w),delListener:t=>(H(t),e),schedule:$,getStore:()=>e,destroy:()=>(k(ne,c).splice(0,void 0),V().stopAutoSave()),getStats:()=>({loads:S,saves:m})},a);return A(B)})(e,(()=>ce(void 0,null,(function*(){const e=yield x();return!e||M(e[0][0])&&M(e[1][0])?void 0:e}))),((t,n)=>ce(void 0,null,(function*(){return n?L(null,P(),3,n):L(null,P(),2,e.getMergeableContentHashes())}))),(e=>g=e),(()=>g=void 0),v,2,((e,t)=>{for(var n in t||(t={}))se.call(t,n)&&de(e,n,t[n]);if(ae)for(var n of ae(t))ue.call(t,n)&&de(e,n,t[n]);return e})({startSync:e=>ce(void 0,null,(function*(){return b=1,yield(yield H.startAutoLoad(e)).startAutoSave()})),stopSync:()=>(b=0,H.stopAutoLoad().stopAutoSave()),destroy:()=>H.stopSync(),getSynchronizerStats:()=>({sends:S,receives:m})},f),1);return l(((t,n,l,o)=>{const r=b||H.isAutoLoading();m++,0==l?u(k(w,n),(([e,n])=>s(e)||e==t?n(o,t):0)):2==l&&r?x(t,o,null!=n?n:void 0).then((e=>{null==g||g(void 0,e)})).catch(v):3==l&&r?null==g||g(void 0,o):u(1==l&&(b||H.isAutoSaving())?e.getMergeableContentHashes():4==l?e.getMergeableTableDiff(o):5==l?e.getMergeableRowDiff(o):6==l?e.getMergeableCellDiff(o):7==l?e.getMergeableValueDiff(o):void 0,(e=>{L(t,n,0,e)}))})),H})(e[1].getStore(),((e,n,o,r)=>l(((e,...n)=>$(null!=e?e:t,V(n,((e,t)=>void 0===t?"￼":t))))(e,n,o,r))),(t=>e[3]=e=>((e,t)=>J(e,((e,n)=>{return t(e,...(l=n,W(l,((e,t)=>"￼"===t?void 0:t))));var l})))(e,t)),0,1,0,0,r),e[4]=[],e[5]=d(n)?n[1]:e=>0}))})))(L,S,P)),z(P,g,e),b(a,[S],g,1),e.on("message",(e=>{const t=e.toString("utf8");0==L[0]?T(t):p(L[4],t)})),1==L[0]&&(yield(e=>ve(void 0,null,(function*(){e[0]=2,yield e[1].schedule(e[1].startAutoLoad,e[1].startAutoSave,e[2].startSync),e[5](e[1].getStore()),e[0]=0})))(L),f(L[4],T),L[4]=[]),e.on("close",(()=>{D(P,g),b(a,[S],g,-1),j(P)&&(m(L),D(v,S),D(c,S),b(i,void 0,S,-1))})),r&&e.on(n,r)}))))));var S,P})),r&&e.on(n,r);const T={getWebSocketServer:()=>e,getPathIds:()=>I(c),getClientIds:e=>I(k(c,e)),addPathIdsListener:e=>g(e,i),addClientIdsListener:(e,t)=>g(t,a,[e]),delListener:e=>(S(e),T),getStats:()=>({paths:P(c),clients:L(c)}),destroy:()=>{c.clear(),H(v,m),e.close()}};return A(T)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsServer={});
