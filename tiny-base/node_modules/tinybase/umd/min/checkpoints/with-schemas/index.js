var e,t;e=this,t=function(e){"use strict";const t=e=>null==e,n=(e,n,r)=>t(e)?r?.():n(e),r=e=>e.length,s=(e,t)=>e.includes(t),o=(e,t)=>e.forEach(t),i=e=>0==r(e),l=(e,...t)=>e.push(...t),c=e=>e.pop(),d=e=>e.shift(),a=Object.freeze,u=e=>e?.size??0,h=(p=u,e=>{return t=(e,t)=>e+p(t),k(e).reduce(t,0);var t});var p;const f=(e,t)=>e?.has(t)??!1,g=e=>t(e)||0==u(e),k=e=>[...e?.values()??[]],C=(e,t)=>e?.forEach(t),v=(e,t)=>e?.delete(t),L=e=>new Map(e),y=(e,t)=>e?.get(t),w=(e,n,r)=>t(r)?(v(e,n),e):e?.set(n,r),b=(e,t,n,r)=>(f(e,t)?r?.(y(e,t)):w(e,t,n()),y(e,t)),S=(e,t,s,o,i=0)=>n((s?b:y)(e,t[i],i>r(t)-2?s:L),(n=>{if(i>r(t)-2)return o?.(n)&&w(e,t[i]),n;const l=S(n,t,s,o,i+1);return g(n)&&w(e,t[i]),l})),T=e=>new Set(Array.isArray(e)||t(e)?e:[e]),x=/^\d+$/,z=(()=>{const e=new WeakMap;return u=>{e.has(u)||e.set(u,(e=>{let u,p,k,z=100,E=L(),I=L(),V=1;const j=L(),m=L(),[A,B,F]=(()=>{let e;const[s,i]=(()=>{const e=[];let t=0;return[n=>(n?d(e):null)??""+t++,t=>{x.test(t)&&r(e)<1e3&&l(e,t)}]})(),c=L();return[(t,n,r,o=[],i=()=>[])=>{e??=ee;const l=s(1);var d,a;return w(c,l,[t,n,r,o,i]),d=S(n,r??[""],T),a=l,d?.add(a),l},(t,n,...s)=>o(((e,t=[""])=>{const n=[],s=(e,i)=>i==r(t)?l(n,e):null===t[i]?C(e,(e=>s(e,i+1))):o([t[i],null],(t=>s(y(e,t),i+1)));return s(e,0),n})(t,n),(t=>C(t,(t=>y(c,t)[0](e,...n??[],...s))))),e=>n(y(c,e),(([,t,n])=>(S(t,n??[""],void 0,(t=>(v(t,e),g(t)?1:0))),w(c,e),i(e),n))),s=>n(y(c,s),(([n,,s=[],i,l])=>{const c=(...d)=>{const a=r(d);a==r(s)?n(e,...d,...l(d)):t(s[a])?o(i[a]?.(...d)??[],(e=>c(...d,e))):c(...d,s[a])};c()}))]})(),M=L(),_=L(),O=[],W=[],$=(n,r)=>{V=0,e.transaction((()=>{const[s,o]=y(M,r);C(s,((r,s)=>C(r,((r,o)=>C(r,((r,i)=>((e,n,r,s,o)=>t(o)?e.delCell(n,r,s,!0):e.setCell(n,r,s,o))(e,s,o,i,r[n]))))))),C(o,((r,s)=>((e,n,r)=>t(r)?e.delValue(n):e.setValue(n,r))(e,s,r[n])))})),V=1},q=e=>{w(M,e),w(_,e),B(m,[e])},D=(e,t)=>o(((e,t)=>e.splice(0,t))(e,t??r(e)),q),G=()=>D(O,r(O)-z),H=()=>n(u,(()=>{l(O,u),G(),D(W),u=void 0,k=1})),J=()=>{u=c(O),k=1};let K,N;const P=(e="")=>(t(u)&&(u=""+p++,w(M,u,[E,I]),Y(u,e),E=L(),I=L(),k=1),u),Q=()=>{i(O)||(((e,...t)=>{e.unshift(...t)})(W,P()),$(0,u),u=c(O),k=1)},R=()=>{i(W)||(l(O,u),u=d(W),$(1,u),k=1)},U=()=>{k&&(B(j),k=0)},X=e=>{const t=P(e);return U(),t},Y=(e,t)=>(Z(e)&&y(_,e)!==t&&(w(_,e,t),B(m,[e])),ee),Z=e=>f(M,e),ee={setSize:e=>(z=e,G(),ee),addCheckpoint:X,setCheckpoint:Y,getStore:()=>e,getCheckpointIds:()=>[[...O],u,[...W]],forEachCheckpoint:e=>{return t=e,C(_,((e,n)=>t(n,e)));var t},hasCheckpoint:Z,getCheckpoint:e=>y(_,e),goBackward:()=>(Q(),U(),ee),goForward:()=>(R(),U(),ee),goTo:e=>{const n=s(O,e)?Q:s(W,e)?R:null;for(;!t(n)&&e!=u;)n();return U(),ee},addCheckpointIdsListener:e=>A(e,j),addCheckpointListener:(e,t)=>A(t,m,[e]),delListener:e=>(F(e),ee),clear:()=>(D(O),D(W),t(u)||q(u),u=void 0,p=0,X(),ee),clearForward:()=>(i(W)||(D(W),B(j)),ee),destroy:()=>{e.delListener(K),e.delListener(N)},getListenerStats:()=>({checkpointIds:h(j),checkpoint:h(m)}),_registerListeners:()=>{K=e.addCellListener(null,null,null,((e,t,n,r,s,o)=>{if(V){H();const e=b(E,t,L),i=b(e,n,L),l=b(i,r,(()=>[o,void 0]));l[1]=s,l[0]===s&&g(w(i,r))&&g(w(e,n))&&g(w(E,t))&&J(),U()}})),N=e.addValueListener(null,((e,t,n,r)=>{if(V){H();const e=b(I,t,(()=>[r,void 0]));e[1]=n,e[0]===n&&g(w(I,t))&&J(),U()}}))}};return a(ee.clear())})(u));const p=e.get(u);return p._registerListeners(),p}})();e.createCheckpoints=z},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseCheckpoints={});
