var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,r="",n=t(r),s=t(t),i=Math,o=i.max,c=i.min,a=isFinite,d=e=>null==e,l=(e,t,r)=>d(e)?r?.():t(e),u=e=>Array.isArray(e),f=e=>e.length,v=()=>{},h=(e,t)=>e.forEach(t),g=e=>M(e,((e,t)=>e+t),0),M=(e,t,r)=>e.reduce(t,r),p=(e,...t)=>e.push(...t),y=Object.freeze,m=e=>e?.size??0,L=(b=m,e=>M(x(e),((e,t)=>e+b(t)),0));var b;const w=(e,t)=>e?.has(t)??!1,T=e=>d(e)||0==m(e),x=e=>[...e?.values()??[]],I=e=>e.clear(),E=(e,t)=>e?.forEach(t),R=(e,t)=>e?.delete(t),S=e=>new Map(e),j=(e,t)=>e?.get(t),k=(e,t)=>E(e,((e,r)=>t(r,e))),z=(e,t,r)=>d(r)?(R(e,t),e):e?.set(t,r),A=(e,t,r,n)=>(w(e,t)?n?.(j(e,t)):z(e,t,r()),j(e,t)),D=(e,t,r,n,s=0)=>l((r?A:j)(e,t[s],s>f(t)-2?r:S),(i=>{if(s>f(t)-2)return n?.(i)&&z(e,t[s]),i;const o=D(i,t,r,n,s+1);return T(i)&&z(e,t[s]),o})),N=S([["avg",[(e,t)=>g(e)/t,(e,t,r)=>e+(t-e)/(r+1),(e,t,r)=>e+(e-t)/(r-1),(e,t,r,n)=>e+(t-r)/n]],["max",[e=>o(...e),(e,t)=>o(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:o(t,e)]],["min",[e=>c(...e),(e,t)=>c(t,e),(e,t)=>t==e?void 0:e,(e,t,r)=>r==e?void 0:c(t,e)]],["sum",[e=>g(e),(e,t)=>e+t,(e,t)=>e-t,(e,t,r)=>e-r+t]]]),B=e=>new Set(u(e)||d(e)?e:[e]),C=(e,t)=>e?.add(t),F=/^\d+$/,O=(()=>{const e=new WeakMap;return i=>(e.has(i)||e.set(i,(e=>{const i=S(),[o,c,g]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[n=>(n?e.shift():null)??r+t++,t=>{F.test(t)&&f(e)<1e3&&p(e,t)}]})(),s=S();return[(n,i,o,c=[],a=()=>[])=>{e??=Q;const d=t(1);return z(s,d,[n,i,o,c,a]),C(D(i,o??[r],B),d),d},(t,n,...i)=>h(((e,t=[r])=>{const n=[],s=(e,r)=>r==f(t)?p(n,e):null===t[r]?E(e,(e=>s(e,r+1))):h([t[r],null],(t=>s(j(e,t),r+1)));return s(e,0),n})(t,n),(t=>E(t,(t=>j(s,t)[0](e,...n??[],...i))))),e=>l(j(s,e),(([,t,i])=>(D(t,i??[r],void 0,(t=>(R(t,e),T(t)?1:0))),z(s,e),n(e),i))),t=>l(j(s,t),(([t,,r=[],n,s])=>{const i=(...o)=>{const c=f(o);c==f(r)?t(e,...o,...s(o)):d(r[c])?h(n[c]?.(...o)??[],(e=>i(...o,e))):i(...o,r[c])};i()}))]})(),[M,b,O,W,$,q,G,,H,J,K,P]=((e,t,n,s,i)=>{const o=e.hasRow,c=S(),a=S(),v=S(),g=S(),M=S(),p=S(),y=(t,r,...n)=>{const s=A(p,t,B);return h(n,(t=>C(s,t)&&r&&e.callListener(t))),n},m=(t,...r)=>l(j(p,t),(n=>{h(0==f(r)?x(n):r,(t=>{e.delListener(t),R(n,t)})),T(n)&&z(p,t)})),L=(e,r)=>{z(c,e,r),w(a,e)||(z(a,e,t()),z(g,e,S()),z(M,e,S()),i(v))},b=e=>{z(c,e),z(a,e),z(g,e),z(M,e),m(e),i(v)};return[()=>e,()=>{return e=c,[...e?.keys()??[]];var e},e=>k(a,e),e=>w(a,e),e=>j(c,e),e=>j(a,e),(e,t)=>z(a,e,t),L,(t,n,s,i,c)=>{L(t,n);const a=S(),l=S(),v=j(g,t),p=j(M,t),b=t=>{const s=r=>e.getCell(n,t,r),h=j(v,t),g=o(n,t)?(M=i(s,t),isNaN(M)||d(M)||!0===M||!1===M||M===r?void 0:1*M):void 0;var M,y,m,L;if(h===g||u(h)&&u(g)&&(m=g,f(y=h)===f(m)&&(L=(e,t)=>m[t]===e,y.every(L)))||z(a,t,[h,g]),!d(c)){const e=j(p,t),r=o(n,t)?c(s,t):void 0;e!=r&&z(l,t,r)}},T=e=>{s((()=>{E(a,(([,e],t)=>z(v,t,e))),E(l,((e,t)=>z(p,t,e)))}),a,l,v,p,e),I(a),I(l)};k(v,b),e.hasTable(n)&&h(e.getRowIds(n),(e=>{w(v,e)||b(e)})),T(!0),m(t),y(t,0,e.addRowListener(n,null,((e,t,r)=>b(r))),e.addTableListener(n,(()=>T())))},b,e=>s(e,v),()=>k(p,b),y,m]})(e,v,0,o,c),Q={setMetricDefinition:(e,r,o,l,u,f,v)=>{const h=t(o)==s?[o,u,f,v]:j(N,o)??j(N,"sum");return H(e,r,((t,r,n,s,o,l)=>{const u=q(e),f=m(s);l||=d(u),t();let v=((e,t,r,n,s,i=!1)=>{if(T(r))return;const[o,c,a,l]=s;return i||=d(e),E(n,(([r,n])=>{i||(e=d(r)?c?.(e,n,t++):d(n)?a?.(e,r,t--):l?.(e,n,r,t),i||=d(e))})),i?o(x(r),m(r)):e})(u,f,s,r,h,l);a(v)||(v=void 0),v!=u&&(G(e,v),c(i,[e],v,u))}),t(g=l)==n?e=>e(g):g??(()=>1)),Q;var g},delMetricDefinition:e=>(J(e),Q),getStore:M,getMetricIds:b,forEachMetric:O,hasMetric:W,getTableId:$,getMetric:q,addMetricIdsListener:K,addMetricListener:(e,t)=>o(t,i,[e]),delListener:e=>(g(e),Q),destroy:P,getListenerStats:()=>({metric:L(i)})};return y(Q)})(i)),e.get(i))})();e.createMetrics=O},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseMetrics={});
