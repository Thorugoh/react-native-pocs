var e,t;e=this,t=function(e){"use strict";const t=globalThis.window,a=e=>null==e,s=(e,t,s)=>a(e)?s?.():t(e),n=e=>Array.isArray(e),r=e=>e.length,o=e=>{throw Error(e)},i=(e,t)=>e.forEach(t),c=(e,...t)=>e.push(...t),l=e=>e.shift(),d=Object,u=e=>d.getPrototypeOf(e),y=d.keys,g=d.freeze,p=e=>(e=>!a(e)&&s(u(e),(e=>e==d.prototype||a(u(e))),(()=>!0)))(e)&&0==(e=>r(y(e)))(e),f=JSON.stringify,h=JSON.parse,v=e=>a(e)||0==(e=>e?.size??0)(e),w=(e,t)=>e?.forEach(t),S=(e,t)=>e?.delete(t),b=e=>new Map(e),C=(e,t)=>e?.get(t),A=(e,t,s)=>a(s)?(S(e,t),e):e?.set(t,s),L=(e,t,a,s)=>{var n,r;return n=e,r=t,n?.has(r)?s?.(C(e,t)):A(e,t,a()),C(e,t)},T=(e,t,a,n,o=0)=>s((a?L:C)(e,t[o],o>r(t)-2?a:b),(s=>{if(o>r(t)-2)return n?.(s)&&A(e,t[o]),s;const i=T(s,t,a,n,o+1);return v(s)&&A(e,t[o]),i})),m=e=>new Set(n(e)||a(e)?e:[e]),M=/^\d+$/,E=b(),P=b(),O=(e,t,d,u,y,f,h,O={},x=0,N=[])=>{let j,k,z,B=0,D=0,I=0;L(E,N,(()=>0)),L(P,N,(()=>[]));const J=b(),[F,V,$,q,G]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!p(e)||!p(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!p(e)||!p(t),t.setContent]:o("Store type not supported by this Persister"))(h,e,x),[H,K,Q]=(()=>{let e;const[t,n]=(()=>{const e=[];let t=0;return[a=>(a?l(e):null)??""+t++,t=>{M.test(t)&&r(e)<1e3&&c(e,t)}]})(),o=b();return[(a,s,n,r=[],i=()=>[])=>{e??=ee;const c=t(1);var l,d;return A(o,c,[a,s,n,r,i]),l=T(s,n??[""],m),d=c,l?.add(d),c},(t,a,...s)=>i(((e,t=[""])=>{const a=[],s=(e,n)=>n==r(t)?c(a,e):null===t[n]?w(e,(e=>s(e,n+1))):i([t[n],null],(t=>s(C(e,t),n+1)));return s(e,0),a})(t,a),(t=>w(t,(t=>C(o,t)[0](e,...a??[],...s))))),e=>s(C(o,e),(([,t,a])=>(T(t,a??[""],void 0,(t=>(S(t,e),v(t)?1:0))),A(o,e),n(e),a))),t=>s(C(o,t),(([t,,s=[],n,o])=>{const c=(...l)=>{const d=r(l);d==r(s)?t(e,...l,...o(l)):a(s[d])?i(n[d]?.(...l)??[],(e=>c(...l,e))):c(...l,s[d])};c()}))]})(),R=e=>{e!=B&&(B=e,K(J,void 0,B))},U=t=>{(F&&n(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},W=async e=>(2!=B&&(R(1),D++,await _((async()=>{try{const a=await t();n(a)?U(a):e?G(e):o("Content is not an array: "+a)}catch(t){f?.(t),e&&G(e)}R(0)}))),ee),X=()=>(k&&(y(k),k=void 0),ee),Y=async e=>(1!=B&&(R(2),I++,await _((async()=>{try{await d(V,e)}catch(e){f?.(e)}R(0)}))),ee),Z=()=>(z&&(e.delListener(z),z=void 0),ee),_=async(...e)=>(c(C(P,N),...e),await(async()=>{if(!C(E,N)){for(A(E,N,1);!a(j=l(C(P,N)));)try{await j()}catch(e){f?.(e)}A(E,N,0)}})(),ee),ee={load:W,startAutoLoad:async e=>{X(),await W(e);try{k=await u((async(e,t)=>{t||e?2!=B&&(R(1),D++,U(t??e),R(0)):await W()}))}catch(e){f?.(e)}return ee},stopAutoLoad:X,isAutoLoading:()=>!a(k),save:Y,startAutoSave:async()=>(Z(),await Y(),z=e.addDidFinishTransactionListener((()=>{const e=$();q(e)&&Y(e)})),ee),stopAutoSave:Z,isAutoSaving:()=>!a(z),getStatus:()=>B,addStatusListener:e=>H(e,J),delListener:t=>(Q(t),e),schedule:_,getStore:()=>e,destroy:()=>(C(P,N).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:D,saves:I}),...O};return g(ee)},x="storage",N=(e,a,s,n)=>O(e,(async()=>{return e=s.getItem(a),h(e,((e,t)=>"￼"===t?void 0:t));var e}),(async e=>{return s.setItem(a,(t=e(),f(t,((e,t)=>void 0===t?"￼":t))));var t}),(e=>{const n=t=>{if(t.storageArea===s&&t.key===a)try{e(h(t.newValue))}catch{e()}};return t.addEventListener(x,n),n}),(e=>t.removeEventListener(x,e)),n,3,{getStorageName:()=>a});e.createLocalPersister=(e,t,a)=>N(e,t,localStorage,a),e.createSessionPersister=(e,t,a)=>N(e,t,sessionStorage,a)},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterBrowser={});
