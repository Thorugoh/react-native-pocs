var t,a;t=this,a=function(t){"use strict";const a=t=>typeof t,e="tinybase",n="",s=",",i=a(n),o=Promise,r=clearInterval,c=t=>null==t,l=(t,a,e)=>c(t)?e?.():a(t),y=t=>a(t)==i,u=t=>Array.isArray(t),d=(t,a,e)=>t.slice(a,e),w=t=>t.length,p=async t=>o.all(t),v=t=>{throw Error(t)},f=(t,a)=>t.forEach(a),E=(t,a="")=>t.join(a),g=(t,a)=>t.map(a),m=t=>0==w(t),h=(t,a)=>t.filter(a),A=(t,...a)=>t.push(...a),N=t=>t.shift(),S="_",T="_id",$="SELECT",C="WHERE",O="TABLE",b="ALTER "+O,I="DELETE FROM",L=$+"*FROM",D="pragma_",R="data_version",M="schema_version",P="pragma_table_",_=t=>`"${t.replace(/"/g,'""')}"`,F=(t,a=[1])=>E(g(t,(()=>"$"+a[0]++)),s),x=(t,a)=>t?.has(a)??!1,U=t=>c(t)||0==(t=>t?.size??0)(t),j=t=>[...t?.values()??[]],B=(t,a)=>t?.forEach(a),J=(t,a)=>t?.delete(a),W=Object,Y=t=>W.getPrototypeOf(t),k=W.entries,q=W.keys,z=W.freeze,G=(t=[])=>W.fromEntries(t),H=(...t)=>W.assign({},...t),K=(t,a)=>(delete t[a],t),Q=(t,a)=>g(k(t),(([t,e])=>a(e,t))),V=(t,a)=>G(Q(t,((t,e)=>[e,a(t,e)]))),X=t=>W.values(t),Z=t=>w(q(t)),tt=t=>(t=>!c(t)&&l(Y(t),(t=>t==W.prototype||c(Y(t))),(()=>!0)))(t)&&0==Z(t),at=JSON.stringify,et=JSON.parse,nt=t=>new Map(t),st=(t,a)=>t?.get(a),it=(t,a)=>g([...t?.entries()??[]],(([t,e])=>a(e,t))),ot=(t,a,e)=>c(e)?(J(t,a),t):t?.set(a,e),rt=(t,a,e,n)=>(x(t,a)?n?.(st(t,a)):ot(t,a,e()),st(t,a)),ct=(t,a,e,n,s=0)=>l((e?rt:st)(t,a[s],s>w(a)-2?e:nt),(i=>{if(s>w(a)-2)return n?.(i)&&ot(t,a[s]),i;const o=ct(i,a,e,n,s+1);return U(i)&&ot(t,a[s]),o})),lt=t=>new Set(u(t)||c(t)?t:[t]),yt=(t,a)=>t?.add(a),ut=/^\d+$/,dt=nt(),wt=nt(),pt=(t,a,e,s,i,o,r,y={},d=0,p=[])=>{let E,g,m,h=0,S=0,T=0;rt(dt,p,(()=>0)),rt(wt,p,(()=>[]));const $=nt(),[C,O,b,I,L]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!tt(t)||!tt(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!tt(t)||!tt(a),a.setContent]:v("Store type not supported by this Persister"))(r,t,d),[D,R,M]=(()=>{let t;const[a,e]=(()=>{const t=[];let a=0;return[e=>(e?N(t):null)??n+a++,a=>{ut.test(a)&&w(t)<1e3&&A(t,a)}]})(),s=nt();return[(e,i,o,r=[],c=()=>[])=>{t??=k;const l=a(1);return ot(s,l,[e,i,o,r,c]),yt(ct(i,o??[n],lt),l),l},(a,e,...i)=>f(((t,a=[n])=>{const e=[],s=(t,n)=>n==w(a)?A(e,t):null===a[n]?B(t,(t=>s(t,n+1))):f([a[n],null],(a=>s(st(t,a),n+1)));return s(t,0),e})(a,e),(a=>B(a,(a=>st(s,a)[0](t,...e??[],...i))))),t=>l(st(s,t),(([,a,i])=>(ct(a,i??[n],void 0,(a=>(J(a,t),U(a)?1:0))),ot(s,t),e(t),i))),a=>l(st(s,a),(([a,,e=[],n,s])=>{const i=(...o)=>{const r=w(o);r==w(e)?a(t,...o,...s(o)):c(e[r])?f(n[r]?.(...o)??[],(t=>i(...o,t))):i(...o,e[r])};i()}))]})(),P=t=>{t!=h&&(h=t,R($,void 0,h))},_=a=>{(C&&u(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},F=async t=>(2!=h&&(P(1),S++,await Y((async()=>{try{const e=await a();u(e)?_(e):t?L(t):v("Content is not an array: "+e)}catch(a){o?.(a),t&&L(t)}P(0)}))),k),x=()=>(g&&(i(g),g=void 0),k),j=async t=>(1!=h&&(P(2),T++,await Y((async()=>{try{await e(O,t)}catch(t){o?.(t)}P(0)}))),k),W=()=>(m&&(t.delListener(m),m=void 0),k),Y=async(...t)=>(A(st(wt,p),...t),await(async()=>{if(!st(dt,p)){for(ot(dt,p,1);!c(E=N(st(wt,p)));)try{await E()}catch(t){o?.(t)}ot(dt,p,0)}})(),k),k={load:F,startAutoLoad:async t=>{x(),await F(t);try{g=await s((async(t,a)=>{a||t?2!=h&&(P(1),S++,_(a??t),P(0)):await F()}))}catch(t){o?.(t)}return k},stopAutoLoad:x,isAutoLoading:()=>!c(g),save:j,startAutoSave:async()=>(W(),await j(),m=t.addDidFinishTransactionListener((()=>{const t=b();I(t)&&j(t)})),k),stopAutoSave:W,isAutoSaving:()=>!c(m),getStatus:()=>h,addStatusListener:t=>D(t,$),delListener:a=>(M(a),t),schedule:Y,getStore:()=>t,destroy:()=>(st(wt,p).splice(0,void 0),x().stopAutoSave()),getStats:()=>({loads:S,saves:T}),...y};return z(k)},vt=(t,a,e,n,i,o=ft,r,l)=>{const y=nt();return[async()=>{y.clear(),g(await e(t,a),(({tn:t,cn:a})=>yt(rt(y,t,lt),a)))},async(a,e)=>((t,a)=>x(st(y,t),a))(a,e)?G(h(g(await t(L+_(a)),(t=>[t[e],l?V(K(t,e),l):K(t,e)])),(([t,a])=>!c(t)&&!tt(a)))):{},async(a,e,n,l,u,d=!1)=>{const w=lt();V(n??{},(t=>g(q(t??{}),(t=>yt(w,t)))));const v=j(w);if(!d&&u&&m(v)&&x(y,a))return await t("DROP "+O+_(a)),void ot(y,a);const f=st(y,a),N=lt(j(f));if(m(v)||(x(y,a)?await p(g([e,...v],(async(n,s)=>{J(N,n)||(await t(b+_(a)+"ADD"+_(n)+i),0==s&&await t("CREATE UNIQUE INDEX pk ON "+_(a)+`(${_(e)})`),yt(f,n))}))):(await t("CREATE "+O+_(a)+`(${_(e)}${i} PRIMARY KEY${E(g(v,(t=>s+_(t)+i)))});`),ot(y,a,lt([e,...v])))),await p([...!d&&l?g(j(N),(async n=>{n!=e&&(await t(b+_(a)+"DROP"+_(n)),J(f,n))})):[]]),d)c(n)?await t(I+_(a)+C+" true"):await p(Q(n,(async(n,s)=>{c(n)?await t(I+_(a)+C+_(e)+"=$1",[s]):m(v)||await o(t,a,e,q(n),{[s]:r?g(X(n),r):X(n)},f)})));else if(m(v))x(y,a)&&await t(I+_(a)+C+" true");else{const s=h(j(st(y,a)),(t=>t!=e)),i={},c=[];V(n??{},((t,a)=>{i[a]=g(s,(a=>r?r(t?.[a]):t?.[a])),A(c,a)})),await o(t,a,e,s,i),await t(I+_(a)+C+_(e)+`NOT IN(${F(c)})`,c)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){n?.(t)}return await t("END"),e}]},ft=async(t,a,e,n,i)=>{const o=[1];await t("INSERT INTO"+_(a)+"("+((...t)=>E(g(t,_),s))(e,...n)+")VALUES"+E(Q(i,(t=>"($"+o[0]+++","+F(t,o)+")")),s)+"ON CONFLICT("+_(e)+")DO UPDATE SET"+E(g(n,(t=>_(t)+"=excluded."+_(t))),s),Q(i,((t,a)=>[a,...g(t,(t=>t??null))])).flat())},Et=(t,a,e,n,s,i,o,[r,c,l],y,u,d,w,p,v)=>{const[f,E,g,m]=vt(a,y,u,s,p,v),h=pt(t,(async()=>await m((async()=>{return await f(),t=(await E(r,c))[S]?.[l]??"null",et(t,((t,a)=>"￼"===a?void 0:a));var t}))),(async t=>await m((async()=>{var a;await f(),await g(r,c,{[S]:{[l]:(a=t()??null,at(a,((t,a)=>void 0===a?"￼":a)))}},!0,!0)}))),e,n,s,o,{[w]:()=>d,destroy:()=>(h.stopAutoLoad().stopAutoSave(),i(),h)},0,d);return h},gt=(t,a,e,n,s,i,o,[r,l,[y,u,d]],w,v,f,E,g,m,A,N)=>{const[$,C,O,b]=vt(a,w,v,s,g,m,A,N),I=async(t,a)=>await p(it(l,(async([e,n,s,i],o)=>{a&&!(o in t)||await O(e,n,t[o],s,i,a)}))),L=async(t,a)=>u?await O(d,T,{[S]:t},!0,!0,a):null,D=pt(t,(async()=>await b((async()=>{await $();const t=await(async()=>G(h(await p(it(r,(async([t,a],e)=>[t,await C(e,a)]))),(t=>!tt(t[1])))))(),a=await(async()=>y?(await C(d,T))[S]:{})();return tt(t)&&c(a)?void 0:[t,a]}))),(async(t,a)=>await b((async()=>{if(await $(),c(a)){const[a,e]=t();await I(a),await L(e)}else await I(a[0],!0),await L(a[1],!0)}))),e,n,s,o,{[E]:()=>f,destroy:()=>(D.stopAutoLoad().stopAutoSave(),i(),D)},0,f);return D},mt="ColumnName",ht="store",At="json",Nt=ht+"TableName",St=ht+"Id"+mt,Tt=ht+mt,$t="autoLoadIntervalSeconds",Ct="rowId"+mt,Ot="tableId",bt="tableName",It="deleteEmptyColumns",Lt="deleteEmptyTable",Dt={mode:At,[$t]:1},Rt={load:0,save:0,[bt]:e+"_values"},Mt=(t,a,e,n,s)=>{const i=nt();return V(t,((t,o)=>{const r=d(X(H(a,y(t)?{[e]:t}:t)),0,Z(a));c(r[0])||n(o,r[0])||(s(o,r[0]),ot(i,o,r))})),i},Pt=(t,a,s,i,o,c,l,u,w,p,v="getDb",f)=>{let E,g,m;const h=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(s,c),[A,N,S,O]=(t=>{const a=(t=>H(Dt,y(t)?{[Nt]:t}:t??{}))(t),n=a[$t];if(a.mode==At){const t=a[Nt]??e;return[1,n,[t,a[St]??T,a[Tt]??ht],lt(t)]}const{tables:{load:s={},save:i={}}={},values:o={}}=a,r=d(X(H(Rt,o)),0,Z(Rt)),c=r[2],l=lt(c),u=lt(c);return[0,n,[Mt(s,{[Ot]:null,[Ct]:T},Ot,(t=>x(u,t)),(t=>yt(l,t))),Mt(i,{[bt]:null,[Ct]:T,[It]:0,[Lt]:0},bt,((t,a)=>x(u,a)),((t,a)=>yt(l,a))),r],l]})(a);return(A?Et:gt)(t,h,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await h(`${$} ${R} d,${M} s,TOTAL_CHANGES() c FROM ${D}${R} JOIN ${D}${M}`);a==E&&e==g&&n==m||(null!=E&&t(),E=a,g=e,m=n)}catch{}}),1e3*N),n=()=>{E=g=m=null,r(a)},s=i((a=>{O.has(a)&&(n(),t(),e())}));return e(),()=>{n(),o(s)}}),(t=>t()),l,u,w,S,j(O),(async(t,a)=>await t(`${$} t.name tn,c.name cn FROM ${P}list()t,${P}info(t.name)c ${C} t.schema='main'AND t.type IN('table','view')AND t.name IN(${F(a)})ORDER BY t.name,c.name`,a)),p,v,n,f,(t=>!0===t?1:!1===t?0:t),void 0)};t.createCrSqliteWasmPersister=(t,a,e,n,s)=>Pt(t,e,(async(t,e=[])=>await a.execO(t,e)),(t=>a.onUpdate(((a,e,n)=>t(n)))),(t=>t()),n,s,(()=>0),1,a)},"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterCrSqliteWasm={});
