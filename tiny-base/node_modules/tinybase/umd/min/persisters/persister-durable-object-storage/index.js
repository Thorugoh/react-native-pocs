var t,e;t=this,e=function(t){"use strict";const e="t",a="v",n=t=>null==t,s=(t,e,a)=>n(t)?a?.():e(t),r=t=>Array.isArray(t),o=(t,e,a)=>t.slice(e,a),i=t=>t.length,c=t=>{throw Error(t)},l=(t,e)=>t.forEach(e),u=(t,...e)=>t.push(...e),d=t=>t.shift(),y=Object,g=t=>y.getPrototypeOf(t),p=y.entries,f=y.keys,h=y.freeze,v=(t,e)=>l(p(t),(([t,a])=>e(a,t))),w=t=>(t=>!n(t)&&s(g(t),(t=>t==y.prototype||n(g(t))),(()=>!0)))(t)&&0==(t=>i(f(t)))(t),S=(t,e,a)=>(((t,e)=>e in t)(t,e)||(t[e]=a()),t[e]),b=t=>n(t)||0==(t=>t?.size??0)(t),C=(t,e)=>t?.forEach(e),A=(t,e)=>t?.delete(e),L=t=>new Map(t),M=(t,e)=>t?.get(e),O=(t,e,a)=>n(a)?(A(t,e),t):t?.set(e,a),T=(t,e,a,n)=>{var s,r;return s=t,r=e,s?.has(r)?n?.(M(t,e)):O(t,e,a()),M(t,e)},j=(t,e,a,n,r=0)=>s((a?T:M)(t,e[r],r>i(e)-2?a:L),(s=>{if(r>i(e)-2)return n?.(s)&&O(t,e[r]),s;const o=j(s,e,a,n,r+1);return b(s)&&O(t,e[r]),o})),x=(t,e,a)=>{e>t[1]&&(t[1]=e),t[2]=a>>>0},D=t=>new Set(r(t)||n(t)?t:[t]),E=/^\d+$/,P=L(),m=L(),z=(t,e,a,o,y,g,p,f={},v=0,S=[])=>{let x,z,J,N=0,k=0,B=0;T(P,S,(()=>0)),T(m,S,(()=>[]));const F=L(),[W,$,q,G,H]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!w(t)||!w(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!w(t)||!w(e),e.setContent]:c("Store type not supported by this Persister"))(p,t,v),[I,K,Q]=(()=>{let t;const[e,a]=(()=>{const t=[];let e=0;return[a=>(a?d(t):null)??""+e++,e=>{E.test(e)&&i(t)<1e3&&u(t,e)}]})(),r=L();return[(a,n,s,o=[],i=()=>[])=>{t??=tt;const c=e(1);var l,u;return O(r,c,[a,n,s,o,i]),l=j(n,s??[""],D),u=c,l?.add(u),c},(e,a,...n)=>l(((t,e=[""])=>{const a=[],n=(t,s)=>s==i(e)?u(a,t):null===e[s]?C(t,(t=>n(t,s+1))):l([e[s],null],(e=>n(M(t,e),s+1)));return n(t,0),a})(e,a),(e=>C(e,(e=>M(r,e)[0](t,...a??[],...n))))),t=>s(M(r,t),(([,e,n])=>(j(e,n??[""],void 0,(e=>(A(e,t),b(e)?1:0))),O(r,t),a(t),n))),e=>s(M(r,e),(([e,,a=[],s,r])=>{const o=(...c)=>{const u=i(c);u==i(a)?e(t,...c,...r(c)):n(a[u])?l(s[u]?.(...c)??[],(t=>o(...c,t))):o(...c,a[u])};o()}))]})(),R=t=>{t!=N&&(N=t,K(F,void 0,N))},U=e=>{(W&&r(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},V=async t=>(2!=N&&(R(1),k++,await _((async()=>{try{const a=await e();r(a)?U(a):t?H(t):c("Content is not an array: "+a)}catch(e){g?.(e),t&&H(t)}R(0)}))),tt),X=()=>(z&&(z=void 0),tt),Y=async t=>(1!=N&&(R(2),B++,await _((async()=>{try{await a($,t)}catch(t){g?.(t)}R(0)}))),tt),Z=()=>(J&&(t.delListener(J),J=void 0),tt),_=async(...t)=>(u(M(m,S),...t),await(async()=>{if(!M(P,S)){for(O(P,S,1);!n(x=d(M(m,S)));)try{await x()}catch(t){g?.(t)}O(P,S,0)}})(),tt),tt={load:V,startAutoLoad:async t=>{X(),await V(t);try{z=await o((async(t,e)=>{e||t?2!=N&&(R(1),k++,U(e??t),R(0)):await V()}))}catch(t){g?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!n(z),save:Y,startAutoSave:async()=>(Z(),await Y(),J=t.addDidFinishTransactionListener((()=>{const t=q();G(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!n(J),getStatus:()=>N,addStatusListener:t=>I(t,F),delListener:e=>(Q(e),t),schedule:_,getStore:()=>t,destroy:()=>(M(m,S).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:k,saves:B}),...f};return h(tt)},J=JSON.stringify,N=()=>[{},"",0];t.createDurableObjectStoragePersister=(t,n,r="",i)=>{const c=(t,...e)=>r+t+o(J(e,((t,e)=>void 0===e?"ï¿¼":e)),1,-1);return z(t,(async()=>{const t=[{},"",0],i=[{},"",0];return(await n.list({prefix:r})).forEach((async([n,c,l],u)=>s((t=>{if(n=r,t.startsWith(n)){const n=o(t,r.length,1);return n==e||n==a?[n,...JSON.parse("["+o(t,r.length+1)+"]")]:void 0}var n})(u),(([r,...o])=>r==e?s(o[0],(e=>{const a=S(t[0],e,N);s(o[1],(t=>{const e=S(a[0],t,N);s(o[2],(t=>e[0][t]=[n,c,l]),(()=>x(e,c,l)))}),(()=>x(a,c,l)))}),(()=>x(t,c,l))):r==a?s(o[0],(t=>i[0][t]=[n,c,l]),(()=>x(i,c,l))):0)))),[t,i]}),(async(t,[[s,r,o],[i,l,u]]=t())=>{const d=L();O(d,c(e),[0,r,o]),v(s,(([t,a,n],s)=>{O(d,c(e,s),[0,a,n]),v(t,(([t,a,n],r)=>{O(d,c(e,s,r),[0,a,n]),v(t,((t,a)=>O(d,c(e,s,r,a),t)))}))})),O(d,c(a),[0,l,u]),v(i,((t,e)=>O(d,c(a,e),t))),await n.put((t=>{const e={};return C(t,((t,a)=>{{const n=t;e[a]=n}})),e})(d))}),(()=>{}),0,i,2,{getStorage:()=>n})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterDurableObjectStorage={});
