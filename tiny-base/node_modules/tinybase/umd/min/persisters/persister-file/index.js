var t,e;t=this,e=function(t,e,s){"use strict";const a="utf8",n=t=>null==t,r=(t,e,s)=>n(t)?s?.():e(t),o=t=>Array.isArray(t),i=t=>t.length,c=t=>{throw Error(t)},l=(t,e)=>t.forEach(e),u=(t,...e)=>t.push(...e),d=t=>t.shift(),y=Object,f=t=>y.getPrototypeOf(t),p=y.keys,g=y.freeze,h=t=>(t=>!n(t)&&r(f(t),(t=>t==y.prototype||n(f(t))),(()=>!0)))(t)&&0==(t=>i(p(t)))(t),v=JSON.stringify,w=JSON.parse,S=t=>n(t)||0==(t=>t?.size??0)(t),C=(t,e)=>t?.forEach(e),b=(t,e)=>t?.delete(e),A=t=>new Map(t),F=(t,e)=>t?.get(e),L=(t,e,s)=>n(s)?(b(t,e),t):t?.set(e,s),M=(t,e,s,a)=>{var n,r;return n=t,r=e,n?.has(r)?a?.(F(t,e)):L(t,e,s()),F(t,e)},T=(t,e,s,a,n=0)=>r((s?M:F)(t,e[n],n>i(e)-2?s:A),(r=>{if(n>i(e)-2)return a?.(r)&&L(t,e[n]),r;const o=T(r,e,s,a,n+1);return S(r)&&L(t,e[n]),o})),m=t=>new Set(o(t)||n(t)?t:[t]),P=/^\d+$/,x=A(),O=A(),E=(t,e,s,a,y,f,p,v={},w=0,E=[])=>{let j,q,z,D=0,J=0,N=0;M(x,E,(()=>0)),M(O,E,(()=>[]));const k=A(),[B,$,G,H,I]=((t=1,e,s)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!s),([[t],[e]])=>!h(t)||!h(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!h(t)||!h(e),e.setContent]:c("Store type not supported by this Persister"))(p,t,w),[K,Q,R]=(()=>{let t;const[e,s]=(()=>{const t=[];let e=0;return[s=>(s?d(t):null)??""+e++,e=>{P.test(e)&&i(t)<1e3&&u(t,e)}]})(),a=A();return[(s,n,r,o=[],i=()=>[])=>{t??=tt;const c=e(1);var l,u;return L(a,c,[s,n,r,o,i]),l=T(n,r??[""],m),u=c,l?.add(u),c},(e,s,...n)=>l(((t,e=[""])=>{const s=[],a=(t,n)=>n==i(e)?u(s,t):null===e[n]?C(t,(t=>a(t,n+1))):l([e[n],null],(e=>a(F(t,e),n+1)));return a(t,0),s})(e,s),(e=>C(e,(e=>F(a,e)[0](t,...s??[],...n))))),t=>r(F(a,t),(([,e,n])=>(T(e,n??[""],void 0,(e=>(b(e,t),S(e)?1:0))),L(a,t),s(t),n))),e=>r(F(a,e),(([e,,s=[],a,r])=>{const o=(...c)=>{const u=i(c);u==i(s)?e(t,...c,...r(c)):n(s[u])?l(a[u]?.(...c)??[],(t=>o(...c,t))):o(...c,s[u])};o()}))]})(),U=t=>{t!=D&&(D=t,Q(k,void 0,D))},V=e=>{(B&&o(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},W=async t=>(2!=D&&(U(1),J++,await _((async()=>{try{const s=await e();o(s)?V(s):t?I(t):c("Content is not an array: "+s)}catch(e){f?.(e),t&&I(t)}U(0)}))),tt),X=()=>(q&&(y(q),q=void 0),tt),Y=async t=>(1!=D&&(U(2),N++,await _((async()=>{try{await s($,t)}catch(t){f?.(t)}U(0)}))),tt),Z=()=>(z&&(t.delListener(z),z=void 0),tt),_=async(...t)=>(u(F(O,E),...t),await(async()=>{if(!F(x,E)){for(L(x,E,1);!n(j=d(F(O,E)));)try{await j()}catch(t){f?.(t)}L(x,E,0)}})(),tt),tt={load:W,startAutoLoad:async t=>{X(),await W(t);try{q=await a((async(t,e)=>{e||t?2!=D&&(U(1),J++,V(e??t),U(0)):await W()}))}catch(t){f?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!n(q),save:Y,startAutoSave:async()=>(Z(),await Y(),z=t.addDidFinishTransactionListener((()=>{const t=G();H(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!n(z),getStatus:()=>D,addStatusListener:t=>K(t,k),delListener:e=>(R(e),t),schedule:_,getStore:()=>t,destroy:()=>(F(O,E).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:J,saves:N}),...v};return g(tt)};t.createFilePersister=(t,n,r)=>E(t,(async()=>{return t=await s.readFile(n,a),w(t,((t,e)=>"￼"===e?void 0:e));var t}),(async t=>{return await s.writeFile(n,(e=t(),v(e,((t,e)=>void 0===e?"￼":e))),a);var e}),(t=>(e.existsSync(n)||e.writeFileSync(n,"",a),e.watch(n,(()=>t())))),(t=>t?.close()),r,3,{getFilePath:()=>n})},"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("fs"),require("fs/promises")):"function"==typeof define&&define.amd?define(["exports","fs","fs/promises"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterFile={},t.fs,t["fs/promises"]);
