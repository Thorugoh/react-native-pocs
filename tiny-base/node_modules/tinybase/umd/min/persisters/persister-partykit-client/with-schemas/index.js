var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a="",s=e(a),n="message",o=t=>null==t,r=(t,e,a)=>o(t)?a?.():e(t),i=t=>e(t)==s,c=t=>Array.isArray(t),d=t=>t.length,y=t=>{throw Error(t)},l=(t,e)=>t.forEach(e),u=(t,...e)=>t.push(...e),p=t=>t.shift(),h=Object,f=t=>h.getPrototypeOf(t),g=h.keys,v=h.freeze,w=t=>(t=>!o(t)&&r(f(t),(t=>t==h.prototype||o(f(t))),(()=>!0)))(t)&&0==(t=>d(g(t)))(t),C=JSON.stringify,S=JSON.parse,b=t=>C(t,((t,e)=>e instanceof Map?h.fromEntries([...e]):e)),P="/store",m=t=>o(t)||0==(t=>t?.size??0)(t),A=(t,e)=>t?.forEach(e),L=(t,e)=>t?.delete(e),M=t=>new Map(t),T=(t,e)=>t?.get(e),E=(t,e,a)=>o(a)?(L(t,e),t):t?.set(e,a),O=(t,e,a,s)=>{var n,o;return n=t,o=e,n?.has(o)?s?.(T(t,e)):E(t,e,a()),T(t,e)},x=(t,e,a,s,n=0)=>r((a?O:T)(t,e[n],n>d(e)-2?a:M),(o=>{if(n>d(e)-2)return s?.(o)&&E(t,e[n]),o;const r=x(o,e,a,s,n+1);return m(o)&&E(t,e[n]),r})),j=t=>new Set(c(t)||o(t)?t:[t]),k=/^\d+$/,z=M(),D=M(),J=(t,e,s,n,i,h,f,g={},C=0,S=[])=>{let b,P,J,K=0,N=0,B=0;O(z,S,(()=>0)),O(D,S,(()=>[]));const F=M(),[U,W,$,q,G]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!w(t)||!w(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!w(t)||!w(e),e.setContent]:y("Store type not supported by this Persister"))(f,t,C),[H,I,Q]=(()=>{let t;const[e,s]=(()=>{const t=[];let e=0;return[s=>(s?p(t):null)??a+e++,e=>{k.test(e)&&d(t)<1e3&&u(t,e)}]})(),n=M();return[(s,o,r,i=[],c=()=>[])=>{t??=et;const d=e(1);var y,l;return E(n,d,[s,o,r,i,c]),y=x(o,r??[a],j),l=d,y?.add(l),d},(e,s,...o)=>l(((t,e=[a])=>{const s=[],n=(t,a)=>a==d(e)?u(s,t):null===e[a]?A(t,(t=>n(t,a+1))):l([e[a],null],(e=>n(T(t,e),a+1)));return n(t,0),s})(e,s),(e=>A(e,(e=>T(n,e)[0](t,...s??[],...o))))),t=>r(T(n,t),(([,e,o])=>(x(e,o??[a],void 0,(e=>(L(e,t),m(e)?1:0))),E(n,t),s(t),o))),e=>r(T(n,e),(([e,,a=[],s,n])=>{const r=(...i)=>{const c=d(i);c==d(a)?e(t,...i,...n(i)):o(a[c])?l(s[c]?.(...i)??[],(t=>r(...i,t))):r(...i,a[c])};r()}))]})(),R=t=>{t!=K&&(K=t,I(F,void 0,K))},V=e=>{(U&&c(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},X=async t=>(2!=K&&(R(1),N++,await tt((async()=>{try{const a=await e();c(a)?V(a):t?G(t):y("Content is not an array: "+a)}catch(e){h?.(e),t&&G(t)}R(0)}))),et),Y=()=>(P&&(i(P),P=void 0),et),Z=async t=>(1!=K&&(R(2),B++,await tt((async()=>{try{await s(W,t)}catch(t){h?.(t)}R(0)}))),et),_=()=>(J&&(t.delListener(J),J=void 0),et),tt=async(...t)=>(u(T(D,S),...t),await(async()=>{if(!T(z,S)){for(E(z,S,1);!o(b=p(T(D,S)));)try{await b()}catch(t){h?.(t)}E(z,S,0)}})(),et),et={load:X,startAutoLoad:async t=>{Y(),await X(t);try{P=await n((async(t,e)=>{e||t?2!=K&&(R(1),N++,V(e??t),R(0)):await X()}))}catch(t){h?.(t)}return et},stopAutoLoad:Y,isAutoLoading:()=>!o(P),save:Z,startAutoSave:async()=>(_(),await Z(),J=t.addDidFinishTransactionListener((()=>{const t=$();q(t)&&Z(t)})),et),stopAutoSave:_,isAutoSaving:()=>!o(J),getStatus:()=>K,addStatusListener:t=>H(t,F),delListener:e=>(Q(e),t),schedule:tt,getStore:()=>t,destroy:()=>(T(D,S).splice(0,void 0),Y().stopAutoSave()),getStats:()=>({loads:N,saves:B}),...g};return v(et)};t.createPartyKitPersister=(t,e,s,o)=>{const{host:c,room:y}=e.partySocketOptions,{storeProtocol:l="https",storePath:u=P,messagePrefix:p=a}={...i(s)?{storeProtocol:s}:s},h=l+"://"+c+"/parties/"+e.name+"/"+y+u,f=async t=>await(await fetch(h,{...t?{method:"PUT",body:b(t)}:{},mode:"cors",cache:"no-store"})).json();return J(t,(async()=>await f()),(async(t,a)=>{var s;a?e.send(p+"s"+(i(s=a)?s:b(s))):await f(t())}),(t=>{const a=e=>r(((t,e)=>{const a=d(t);return((t,e)=>t.startsWith(e))(e,t)?[e[a],S((s=e,n=a+1,s.slice(n,void 0)))]:void 0;var s,n})(p,e.data),(([e,a])=>{"s"==e&&t(void 0,a)}));return e.addEventListener(n,a),a}),(t=>{e.removeEventListener(n,t)}),o,1,{getConnection:()=>e})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitClient={});
