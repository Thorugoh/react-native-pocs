var a,t;a=this,t=function(a){"use strict";const t=a=>typeof a,e=t(""),s="t",n=(a,t)=>a.startsWith(t),i=Promise,r=a=>null==a,o=(a,t,e)=>r(a)?e?.():t(a),c=(a,t,e)=>a.slice(t,e),l=a=>a.length,f=async a=>i.all(a),y=(a,t)=>a.map(t),g=(a,...t)=>a.push(...t),h=Object,w=h.entries,u=(a=[])=>h.fromEntries(a),d=(a,t)=>y(w(a),(([a,e])=>t(e,a))),p=(a,t,e)=>(((a,t)=>t in a)(a,t)||(a[t]=e()),a[t]),S=JSON.stringify,P=JSON.parse,m=a=>S(a,((a,t)=>t instanceof Map?h.fromEntries([...t]):t)),x=(a,s,n)=>a+s+(t(n)==e?n:m(n)),b=(a,t,e)=>{const s=l(a);return n(t,a)?[t[s],(e?P:String)(c(t,s+1))]:void 0},T=(a,t)=>((a,t)=>a?.forEach(t))(a,((a,e)=>t(e,a))),D="hasStore",v=u(y(["Origin","Methods","Headers"],(a=>["Access-Control-Allow-"+a,"*"]))),R=async(a,t="")=>!!await a.get(t+D),C=async(a,t="")=>{const e={},n={};return T(await a.list(),((a,i)=>o(b(t,a),(([a,t])=>{if(a==s){const[a,s,n]=P("["+t+"]");p(p(e,a,u),s,u)[n]=i}else"v"==a&&(n[t]=i)})))),[e,n]},O=async(a,t,e)=>a.party.broadcast(x(a.config.messagePrefix,"s",t),e),V=async(a,t,e,i)=>{const o=a.party.storage,c=a.config.storagePrefix,y={[c+D]:1},h=[],w=[];await f(d(t[0],(async(t,n)=>r(t)?!e&&await a.canDelTable(n,i)&&((a,...t)=>a.unshift(...t))(w,E(c,s,n)):await a.canSetTable(n,e,i)&&await f(d(t,(async(t,l)=>r(t)?!e&&await a.canDelRow(n,l,i)&&g(w,E(c,s,n,l)):await a.canSetRow(n,l,e,i)&&await f(d(t,(async(t,f)=>{const w=[n,l,f],u=E(c,s,...w);r(t)?!e&&await a.canDelCell(...w,i)&&g(h,u):await a.canSetCell(...w,t,e,i,await o.get(u))&&(y[u]=t)}))))))))),await f(d(t[1],(async(t,s)=>{const n=c+"v"+s;r(t)?!e&&await a.canDelValue(s,i)&&g(h,n):await a.canSetValue(s,t,e,i,await o.get(n))&&(y[n]=t)}))),0!=l(w)&&T(await o.list(),(a=>w.every((t=>!n(a,t)||g(h,a)&&0)))),await o.delete(h),await o.put(y)},E=(a,t,...e)=>x(a,t,c(m(e),1,-1)),H=async(a,t,e=null)=>new Response(e,{status:t,headers:a.config.responseHeaders});a.TinyBasePartyKitServer=class{constructor(a){this.party=a,this.config.storePath??="/store",this.config.messagePrefix??="",this.config.storagePrefix??="",this.config.responseHeaders??=v}config={};async onRequest(a){const{party:{storage:t},config:{storePath:e,storagePrefix:s}}=this;if(new URL(a.url).pathname.endsWith(e)){const e=await R(t,s),n=await a.text();return"PUT"==a.method?e?H(this,205):(await V(this,P(n),!0,a),H(this,201)):H(this,200,e?m(await C(t,s)):"")}return H(this,404)}async onMessage(a,t){const{config:{messagePrefix:e,storagePrefix:s}}=this;await o(b(e,a,1),(async([a,e])=>{"s"==a&&await R(this.party.storage,s)&&(await V(this,e,!1,t),O(this,e,[t.id]))}))}async canSetTable(a,t,e){return!0}async canDelTable(a,t){return!0}async canSetRow(a,t,e,s){return!0}async canDelRow(a,t,e){return!0}async canSetCell(a,t,e,s,n,i,r){return!0}async canDelCell(a,t,e,s){return!0}async canSetValue(a,t,e,s,n){return!0}async canDelValue(a,t){return!0}},a.broadcastChanges=O,a.hasStoreInStorage=R,a.loadStoreFromStorage=C},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((a="undefined"!=typeof globalThis?globalThis:a||self).TinyBasePersisterPartyKitServer={});
