var t,a;t=this,a=function(t){"use strict";const a=t=>typeof t,e="tinybase",n="",s=",",o=a(n),i=Promise,r=clearInterval,c=t=>null==t,l=(t,a,e)=>c(t)?e?.():a(t),y=t=>a(t)==o,u=t=>Array.isArray(t),w=(t,a,e)=>t.slice(a,e),d=t=>t.length,E=async t=>i.all(t),p=t=>{throw Error(t)},f=(t,a)=>t.forEach(a),g=(t,a="")=>t.join(a),v=(t,a)=>t.map(a),h=t=>0==d(t),A=(t,a)=>t.filter(a),T=(t,...a)=>t.push(...a),m=t=>t.shift(),N=Object,S=t=>N.getPrototypeOf(t),b=N.entries,C=N.keys,$=N.freeze,O=(t=[])=>N.fromEntries(t),I=(...t)=>N.assign({},...t),L=(t,a)=>(delete t[a],t),R=(t,a)=>v(b(t),(([t,e])=>a(e,t))),D=(t,a)=>O(R(t,((t,e)=>[e,a(t,e)]))),P=t=>N.values(t),M=t=>d(C(t)),_=t=>(t=>!c(t)&&l(S(t),(t=>t==N.prototype||c(S(t))),(()=>!0)))(t)&&0==M(t),F=t=>new Set(u(t)||c(t)?t:[t]),x=(t,a)=>t?.add(a),U="_",j="_id",B="SELECT",H="WHERE",J="TABLE",Y="ALTER "+J,k="DELETE FROM",z=B+"*FROM",G="pragma_",V="data_version",W="schema_version",K="pragma_table_",Q=t=>`"${t.replace(/"/g,'""')}"`,X=(...t)=>g(v(t,Q),s),q=(t,a=[1])=>g(v(t,(()=>"$"+a[0]++)),s),Z=(t,a)=>t?.has(a)??!1,tt=t=>c(t)||0==(t=>t?.size??0)(t),at=t=>[...t?.values()??[]],et=(t,a)=>t?.forEach(a),nt=(t,a)=>t?.delete(a),st=JSON.stringify,ot=JSON.parse,it=t=>new Map(t),rt=(t,a)=>t?.get(a),ct=(t,a)=>v([...t?.entries()??[]],(([t,e])=>a(e,t))),lt=(t,a,e)=>c(e)?(nt(t,a),t):t?.set(a,e),yt=(t,a,e,n)=>(Z(t,a)?n?.(rt(t,a)):lt(t,a,e()),rt(t,a)),ut=(t,a,e,n,s=0)=>l((e?yt:rt)(t,a[s],s>d(a)-2?e:it),(o=>{if(s>d(a)-2)return n?.(o)&&lt(t,a[s]),o;const i=ut(o,a,e,n,s+1);return tt(o)&&lt(t,a[s]),i})),wt=/^\d+$/,dt=it(),Et=it(),pt=(t,a,e,s,o,i,r,y={},w=0,E=[])=>{let g,v,h,A=0,N=0,S=0;yt(dt,E,(()=>0)),yt(Et,E,(()=>[]));const b=it(),[C,O,I,L,R]=((t=1,a,e)=>1!=t&&a.isMergeable()?[1,a.getMergeableContent,()=>a.getTransactionMergeableChanges(!e),([[t],[a]])=>!_(t)||!_(a),a.setDefaultContent]:2!=t?[0,a.getContent,a.getTransactionChanges,([t,a])=>!_(t)||!_(a),a.setContent]:p("Store type not supported by this Persister"))(r,t,w),[D,P,M]=(()=>{let t;const[a,e]=(()=>{const t=[];let a=0;return[e=>(e?m(t):null)??n+a++,a=>{wt.test(a)&&d(t)<1e3&&T(t,a)}]})(),s=it();return[(e,o,i,r=[],c=()=>[])=>{t??=z;const l=a(1);return lt(s,l,[e,o,i,r,c]),x(ut(o,i??[n],F),l),l},(a,e,...o)=>f(((t,a=[n])=>{const e=[],s=(t,n)=>n==d(a)?T(e,t):null===a[n]?et(t,(t=>s(t,n+1))):f([a[n],null],(a=>s(rt(t,a),n+1)));return s(t,0),e})(a,e),(a=>et(a,(a=>rt(s,a)[0](t,...e??[],...o))))),t=>l(rt(s,t),(([,a,o])=>(ut(a,o??[n],void 0,(a=>(nt(a,t),tt(a)?1:0))),lt(s,t),e(t),o))),a=>l(rt(s,a),(([a,,e=[],n,s])=>{const o=(...i)=>{const r=d(i);r==d(e)?a(t,...i,...s(i)):c(e[r])?f(n[r]?.(...i)??[],(t=>o(...i,t))):o(...i,e[r])};o()}))]})(),U=t=>{t!=A&&(A=t,P(b,void 0,A))},j=a=>{(C&&u(a?.[0])?1===a?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===a?.[2]?t.applyChanges:t.setContent)(a)},B=async t=>(2!=A&&(U(1),N++,await k((async()=>{try{const e=await a();u(e)?j(e):t?R(t):p("Content is not an array: "+e)}catch(a){i?.(a),t&&R(t)}U(0)}))),z),H=()=>(v&&(o(v),v=void 0),z),J=async t=>(1!=A&&(U(2),S++,await k((async()=>{try{await e(O,t)}catch(t){i?.(t)}U(0)}))),z),Y=()=>(h&&(t.delListener(h),h=void 0),z),k=async(...t)=>(T(rt(Et,E),...t),await(async()=>{if(!rt(dt,E)){for(lt(dt,E,1);!c(g=m(rt(Et,E)));)try{await g()}catch(t){i?.(t)}lt(dt,E,0)}})(),z),z={load:B,startAutoLoad:async t=>{H(),await B(t);try{v=await s((async(t,a)=>{a||t?2!=A&&(U(1),N++,j(a??t),U(0)):await B()}))}catch(t){i?.(t)}return z},stopAutoLoad:H,isAutoLoading:()=>!c(v),save:J,startAutoSave:async()=>(Y(),await J(),h=t.addDidFinishTransactionListener((()=>{const t=I();L(t)&&J(t)})),z),stopAutoSave:Y,isAutoSaving:()=>!c(h),getStatus:()=>A,addStatusListener:t=>D(t,b),delListener:a=>(M(a),t),schedule:k,getStore:()=>t,destroy:()=>(rt(Et,E).splice(0,void 0),H().stopAutoSave()),getStats:()=>({loads:N,saves:S}),...y};return $(z)},ft=(t,a,e,n,o,i=gt,r,l)=>{const y=it();return[async()=>{y.clear(),v(await e(t,a),(({tn:t,cn:a})=>x(yt(y,t,F),a)))},async(a,e)=>((t,a)=>Z(rt(y,t),a))(a,e)?O(A(v(await t(z+Q(a)),(t=>[t[e],l?D(L(t,e),l):L(t,e)])),(([t,a])=>!c(t)&&!_(a)))):{},async(a,e,n,l,u,w=!1)=>{const d=F();D(n??{},(t=>v(C(t??{}),(t=>x(d,t)))));const p=at(d);if(!w&&u&&h(p)&&Z(y,a))return await t("DROP "+J+Q(a)),void lt(y,a);const f=rt(y,a),m=F(at(f));if(h(p)||(Z(y,a)?await E(v([e,...p],(async(n,s)=>{nt(m,n)||(await t(Y+Q(a)+"ADD"+Q(n)+o),0==s&&await t("CREATE UNIQUE INDEX pk ON "+Q(a)+`(${Q(e)})`),x(f,n))}))):(await t("CREATE "+J+Q(a)+`(${Q(e)}${o} PRIMARY KEY${g(v(p,(t=>s+Q(t)+o)))});`),lt(y,a,F([e,...p])))),await E([...!w&&l?v(at(m),(async n=>{n!=e&&(await t(Y+Q(a)+"DROP"+Q(n)),nt(f,n))})):[]]),w)c(n)?await t(k+Q(a)+H+" true"):await E(R(n,(async(n,s)=>{c(n)?await t(k+Q(a)+H+Q(e)+"=$1",[s]):h(p)||await i(t,a,e,C(n),{[s]:r?v(P(n),r):P(n)},f)})));else if(h(p))Z(y,a)&&await t(k+Q(a)+H+" true");else{const s=A(at(rt(y,a)),(t=>t!=e)),o={},c=[];D(n??{},((t,a)=>{o[a]=v(s,(a=>r?r(t?.[a]):t?.[a])),T(c,a)})),await i(t,a,e,s,o),await t(k+Q(a)+H+Q(e)+`NOT IN(${q(c)})`,c)}},async a=>{let e;await t("BEGIN");try{e=await a()}catch(t){n?.(t)}return await t("END"),e}]},gt=async(t,a,e,n,o)=>{const i=[1];await t("INSERT INTO"+Q(a)+"("+X(e,...n)+")VALUES"+g(R(o,(t=>"($"+i[0]+++","+q(t,i)+")")),s)+"ON CONFLICT("+Q(e)+")DO UPDATE SET"+g(v(n,(t=>Q(t)+"=excluded."+Q(t))),s),R(o,((t,a)=>[a,...v(t,(t=>t??null))])).flat())},vt=(t,a,e,n,s,o,i,[r,c,l],y,u,w,d,E,p)=>{const[f,g,v,h]=ft(a,y,u,s,E,p),A=pt(t,(async()=>await h((async()=>{return await f(),t=(await g(r,c))[U]?.[l]??"null",ot(t,((t,a)=>"￼"===a?void 0:a));var t}))),(async t=>await h((async()=>{var a;await f(),await v(r,c,{[U]:{[l]:(a=t()??null,st(a,((t,a)=>void 0===a?"￼":a)))}},!0,!0)}))),e,n,s,i,{[d]:()=>w,destroy:()=>(A.stopAutoLoad().stopAutoSave(),o(),A)},0,w);return A},ht=(t,a,e,n,s,o,i,[r,l,[y,u,w]],d,p,f,g,v,h,T,m)=>{const[N,S,b,C]=ft(a,d,p,s,v,h,T,m),$=async(t,a)=>await E(ct(l,(async([e,n,s,o],i)=>{a&&!(i in t)||await b(e,n,t[i],s,o,a)}))),I=async(t,a)=>u?await b(w,j,{[U]:t},!0,!0,a):null,L=pt(t,(async()=>await C((async()=>{await N();const t=await(async()=>O(A(await E(ct(r,(async([t,a],e)=>[t,await S(e,a)]))),(t=>!_(t[1])))))(),a=await(async()=>y?(await S(w,j))[U]:{})();return _(t)&&c(a)?void 0:[t,a]}))),(async(t,a)=>await C((async()=>{if(await N(),c(a)){const[a,e]=t();await $(a),await I(e)}else await $(a[0],!0),await I(a[1],!0)}))),e,n,s,i,{[g]:()=>f,destroy:()=>(L.stopAutoLoad().stopAutoSave(),o(),L)},0,f);return L},At="ColumnName",Tt="store",mt="json",Nt=Tt+"TableName",St=Tt+"Id"+At,bt=Tt+At,Ct="autoLoadIntervalSeconds",$t="rowId"+At,Ot="tableId",It="tableName",Lt="deleteEmptyColumns",Rt="deleteEmptyTable",Dt={mode:mt,[Ct]:1},Pt={load:0,save:0,[It]:e+"_values"},Mt=(t,a,e,n,s)=>{const o=it();return D(t,((t,i)=>{const r=w(P(I(a,y(t)?{[e]:t}:t)),0,M(a));c(r[0])||n(i,r[0])||(s(i,r[0]),lt(o,i,r))})),o},_t=(t,a,s,o,i,c,l,u,d,E,p="getDb",f)=>{let g,v,h;const A=((t,a)=>a?async(e,n)=>(a(e,n),await t(e,n)):t)(s,c),[T,m,N,S]=(t=>{const a=(t=>I(Dt,y(t)?{[Nt]:t}:t??{}))(t),n=a[Ct];if(a.mode==mt){const t=a[Nt]??e;return[1,n,[t,a[St]??j,a[bt]??Tt],F(t)]}const{tables:{load:s={},save:o={}}={},values:i={}}=a,r=w(P(I(Pt,i)),0,M(Pt)),c=r[2],l=F(c),u=F(c);return[0,n,[Mt(s,{[Ot]:null,[$t]:j},Ot,(t=>Z(u,t)),(t=>x(l,t))),Mt(o,{[It]:null,[$t]:j,[Lt]:0,[Rt]:0},It,((t,a)=>Z(u,a)),((t,a)=>x(l,a))),r],l]})(a);return(T?vt:ht)(t,A,(t=>{let a;const e=()=>a=setInterval((async()=>{try{const[{d:a,s:e,c:n}]=await A(`${B} ${V} d,${W} s,TOTAL_CHANGES() c FROM ${G}${V} JOIN ${G}${W}`);a==g&&e==v&&n==h||(null!=g&&t(),g=a,v=e,h=n)}catch{}}),1e3*m),n=()=>{g=v=h=null,r(a)},s=o((a=>{S.has(a)&&(n(),t(),e())}));return e(),()=>{n(),i(s)}}),(t=>t()),l,u,d,N,at(S),(async(t,a)=>await t(`${B} t.name tn,c.name cn FROM ${K}list()t,${K}info(t.name)c ${H} t.schema='main'AND t.type IN('table','view')AND t.name IN(${q(a)})ORDER BY t.name,c.name`,a)),E,p,n,f,(t=>!0===t?1:!1===t?0:t),void 0)},Ft=async(t,a,e,n,o,i)=>{const r=[1],c=F(n),l=i?A([...i],(t=>t!=e&&!Z(c,t))):[];if(!h(l)){const n=C(o),s=O(v(await t("SELECT"+X(e,...l)+"FROM"+Q(a)+"WHERE"+Q(e)+"IN("+q(n)+")",n),(t=>[t[e],t])));f(n,(t=>T(o[t],...v(l,(a=>s?.[t]?.[a]??null)))))}await t("INSERT OR REPLACE INTO"+Q(a)+"("+X(e,...n,...l)+")VALUES"+g(R(o,(t=>"($"+r[0]+++","+q(t,r)+")")),s),R(o,((t,a)=>[a,...v(t,(t=>t??null))])).flat())};t.createPowerSyncPersister=(t,a,e,n,s)=>{let o;return _t(t,e,(async(t,e=[])=>a.execute(t,e).then((t=>t.rows?._array??[]))),(t=>{const e=new AbortController,n=a.onChange({rawTableNames:!0,signal:e.signal});return(async()=>{for await(const t of n)o&&v(t.changedTables,o)})(),o=t,e}),(t=>{o=void 0,t.abort()}),n,s,(()=>0),1,a,"getPowerSync",Ft)}},"object"==typeof exports&&"undefined"!=typeof module?a(exports):"function"==typeof define&&define.amd?define(["exports"],a):a((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPowersync={});
