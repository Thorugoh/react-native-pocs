var t,e;t=this,e=function(t){"use strict";const e=clearInterval,a=t=>null==t,n=(t,e,n)=>a(t)?n?.():e(t),s=t=>Array.isArray(t),r=t=>t.length,o=t=>{throw Error(t)},i=(t,e)=>t.forEach(e),c=(t,...e)=>t.push(...e),l=t=>t.shift(),d=Object,u=t=>d.getPrototypeOf(t),y=d.keys,h=d.freeze,p=t=>(t=>!a(t)&&n(u(t),(t=>t==d.prototype||a(u(t))),(()=>!0)))(t)&&0==(t=>r(y(t)))(t),f=JSON.stringify,g=JSON.parse,v=t=>a(t)||0==(t=>t?.size??0)(t),w=(t,e)=>t?.forEach(e),S=(t,e)=>t?.delete(e),C=t=>new Map(t),b=(t,e)=>t?.get(e),A=(t,e,n)=>a(n)?(S(t,e),t):t?.set(e,n),T=(t,e,a,n)=>{var s,r;return s=t,r=e,s?.has(r)?n?.(b(t,e)):A(t,e,a()),b(t,e)},m=(t,e,a,s,o=0)=>n((a?T:b)(t,e[o],o>r(e)-2?a:C),(n=>{if(o>r(e)-2)return s?.(n)&&A(t,e[o]),n;const i=m(n,e,a,s,o+1);return v(n)&&A(t,e[o]),i})),L=t=>new Set(s(t)||a(t)?t:[t]),M=/^\d+$/,E=C(),O=C(),P=(t,e,d,u,y,f,g,P={},x=0,j=[])=>{let D,z,I,J=0,N=0,R=0;T(E,j,(()=>0)),T(O,j,(()=>[]));const k=C(),[B,F,H,U,$]=((t=1,e,a)=>1!=t&&e.isMergeable()?[1,e.getMergeableContent,()=>e.getTransactionMergeableChanges(!a),([[t],[e]])=>!p(t)||!p(e),e.setDefaultContent]:2!=t?[0,e.getContent,e.getTransactionChanges,([t,e])=>!p(t)||!p(e),e.setContent]:o("Store type not supported by this Persister"))(g,t,x),[q,G,K]=(()=>{let t;const[e,s]=(()=>{const t=[];let e=0;return[a=>(a?l(t):null)??""+e++,e=>{M.test(e)&&r(t)<1e3&&c(t,e)}]})(),o=C();return[(a,n,s,r=[],i=()=>[])=>{t??=tt;const c=e(1);var l,d;return A(o,c,[a,n,s,r,i]),l=m(n,s??[""],L),d=c,l?.add(d),c},(e,a,...n)=>i(((t,e=[""])=>{const a=[],n=(t,s)=>s==r(e)?c(a,t):null===e[s]?w(t,(t=>n(t,s+1))):i([e[s],null],(e=>n(b(t,e),s+1)));return n(t,0),a})(e,a),(e=>w(e,(e=>b(o,e)[0](t,...a??[],...n))))),t=>n(b(o,t),(([,e,a])=>(m(e,a??[""],void 0,(e=>(S(e,t),v(e)?1:0))),A(o,t),s(t),a))),e=>n(b(o,e),(([e,,n=[],s,o])=>{const c=(...l)=>{const d=r(l);d==r(n)?e(t,...l,...o(l)):a(n[d])?i(s[d]?.(...l)??[],(t=>c(...l,t))):c(...l,n[d])};c()}))]})(),Q=t=>{t!=J&&(J=t,G(k,void 0,J))},V=e=>{(B&&s(e?.[0])?1===e?.[2]?t.applyMergeableChanges:t.setMergeableContent:1===e?.[2]?t.applyChanges:t.setContent)(e)},W=async t=>(2!=J&&(Q(1),N++,await _((async()=>{try{const a=await e();s(a)?V(a):t?$(t):o("Content is not an array: "+a)}catch(e){f?.(e),t&&$(t)}Q(0)}))),tt),X=()=>(z&&(y(z),z=void 0),tt),Y=async t=>(1!=J&&(Q(2),R++,await _((async()=>{try{await d(F,t)}catch(t){f?.(t)}Q(0)}))),tt),Z=()=>(I&&(t.delListener(I),I=void 0),tt),_=async(...t)=>(c(b(O,j),...t),await(async()=>{if(!b(E,j)){for(A(E,j,1);!a(D=l(b(O,j)));)try{await D()}catch(t){f?.(t)}A(E,j,0)}})(),tt),tt={load:W,startAutoLoad:async t=>{X(),await W(t);try{z=await u((async(t,e)=>{e||t?2!=J&&(Q(1),N++,V(e??t),Q(0)):await W()}))}catch(t){f?.(t)}return tt},stopAutoLoad:X,isAutoLoading:()=>!a(z),save:Y,startAutoSave:async()=>(Z(),await Y(),I=t.addDidFinishTransactionListener((()=>{const t=H();U(t)&&Y(t)})),tt),stopAutoSave:Z,isAutoSaving:()=>!a(I),getStatus:()=>J,addStatusListener:t=>q(t,k),delListener:e=>(K(e),t),schedule:_,getStore:()=>t,destroy:()=>(b(O,j).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:N,saves:R}),...P};return h(tt)},x=t=>t.headers.get("ETag");t.createRemotePersister=(t,n,s,r=5,o)=>{let i;return P(t,(async()=>{const t=await fetch(n);return i=x(t),g(await t.text())}),(async t=>{return await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:(e=t(),f(e,((t,e)=>e instanceof Map?d.fromEntries([...e]):e)))});var e}),(t=>setInterval((async()=>{const e=await fetch(n,{method:"HEAD"}),s=x(e);a(i)||a(s)||s==i||(i=s,t())}),1e3*r)),(t=>e(t)),o,1,{getUrls:()=>[n,s]})}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterRemote={});
