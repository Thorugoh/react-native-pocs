var e,t;e=this,t=function(e){"use strict";const t=(e,t="",a)=>e.split(t,a),a=Promise,n=globalThis,s=Math,o=s.floor,r=e=>null==e,i=(e,t,a)=>r(e)?a?.():t(e),l=e=>Array.isArray(e),c=e=>e.length,u=e=>{throw Error(e)},g=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),y=e=>e.shift(),f=Object,h=e=>f.getPrototypeOf(e),p=f.entries,w=f.keys,b=f.freeze,v=(e,t)=>g(p(e),(([e,a])=>t(a,e))),C=e=>(e=>!r(e)&&i(h(e),(e=>e==f.prototype||r(h(e))),(()=>!0)))(e)&&0==(e=>c(w(e)))(e),S=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),M=e=>r(e)||0==(e=>e?.size??0)(e),A=(e,t)=>e?.forEach(t),T=(e,t)=>e?.delete(t),m=e=>new Map(e),D=(e,t)=>e?.get(t),L=(e,t,a)=>r(a)?(T(e,t),e):e?.set(t,a),H=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(D(e,t)):L(e,t,a()),D(e,t)},z=(e,t,a,n,s=0)=>i((a?H:D)(e,t[s],s>c(t)-2?a:m),(o=>{if(s>c(t)-2)return n?.(o)&&L(e,t[s]),o;const r=z(o,t,a,n,s+1);return M(o)&&L(e,t[s]),r})),G=(e,t)=>t?[e,t]:[e],R=(e,t)=>((e??"")>(t??"")?e:t)??"",E=(e="")=>G(((e=[])=>f.fromEntries(e))(),e),V=e=>new Set(l(e)||r(e)?e:[e]),x=/^\d+$/,P=m(),j=m(),O=(e,t,a,n,s,o,f,h={},p=0,w=[])=>{let v,S,G,R=0,E=0,O=0;H(P,w,(()=>0)),H(j,w,(()=>[]));const $=m(),[k,B,F,N,U]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!C(e)||!C(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!C(e)||!C(t),t.setContent]:u("Store type not supported by this Persister"))(f,e,p),[q,I,J]=(()=>{let e;const[t,a]=(()=>{const e=[];let t=0;return[a=>(a?y(e):null)??""+t++,t=>{x.test(t)&&c(e)<1e3&&d(e,t)}]})(),n=m();return[(a,s,o,r=[],i=()=>[])=>{e??=ee;const l=t(1);var c,u;return L(n,l,[a,s,o,r,i]),c=z(s,o??[""],V),u=l,c?.add(u),l},(t,a,...s)=>g(((e,t=[""])=>{const a=[],n=(e,s)=>s==c(t)?d(a,e):null===t[s]?A(e,(e=>n(e,s+1))):g([t[s],null],(t=>n(D(e,t),s+1)));return n(e,0),a})(t,a),(t=>A(t,(t=>D(n,t)[0](e,...a??[],...s))))),e=>i(D(n,e),(([,t,s])=>(z(t,s??[""],void 0,(t=>(T(t,e),M(t)?1:0))),L(n,e),a(e),s))),t=>i(D(n,t),(([t,,a=[],n,s])=>{const o=(...i)=>{const l=c(i);l==c(a)?t(e,...i,...s(i)):r(a[l])?g(n[l]?.(...i)??[],(e=>o(...i,e))):o(...i,a[l])};o()}))]})(),K=e=>{e!=R&&(R=e,I($,void 0,R))},Q=t=>{(k&&l(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},W=async e=>(2!=R&&(K(1),E++,await _((async()=>{try{const a=await t();l(a)?Q(a):e?U(e):u("Content is not an array: "+a)}catch(t){o?.(t),e&&U(e)}K(0)}))),ee),X=()=>(S&&(s(S),S=void 0),ee),Y=async e=>(1!=R&&(K(2),O++,await _((async()=>{try{await a(B,e)}catch(e){o?.(e)}K(0)}))),ee),Z=()=>(G&&(e.delListener(G),G=void 0),ee),_=async(...e)=>(d(D(j,w),...e),await(async()=>{if(!D(P,w)){for(L(P,w,1);!r(v=y(D(j,w)));)try{await v()}catch(e){o?.(e)}L(P,w,0)}})(),ee),ee={load:W,startAutoLoad:async e=>{X(),await W(e);try{S=await n((async(e,t)=>{t||e?2!=R&&(K(1),E++,Q(t??e),K(0)):await W()}))}catch(e){o?.(e)}return ee},stopAutoLoad:X,isAutoLoading:()=>!r(S),save:Y,startAutoSave:async()=>(Z(),await Y(),G=e.addDidFinishTransactionListener((()=>{const e=F();N(e)&&Y(e)})),ee),stopAutoSave:Z,isAutoSaving:()=>!r(G),getStatus:()=>R,addStatusListener:e=>q(e,$),delListener:t=>(J(t),e),schedule:_,getStore:()=>e,destroy:()=>(D(j,w).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:E,saves:O}),...h};return b(ee)},$=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),k=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>o(256*s.random()))))(e),B=(e=16)=>{return t=(e,t)=>e+$[63&t],k(new Uint8Array(e)).reduce(t,"");var t};e.Message={Response:0,GetContentHashes:1,ContentHashes:2,ContentDiff:3,GetTableDiff:4,GetRowDiff:5,GetCellDiff:6,GetValueDiff:7},e.createCustomSynchronizer=(e,t,n,s,o,l,c,u,g={})=>{let d,y=0,f=0,h=0;const p=m(),w=()=>B(11),b=(e,a,n,s)=>{f++,l?.(e,a,n,s),t(e,a,n,s)},M=async(e,t,n,s)=>new a(((a,r)=>{const i=s+"."+B(4),l=((e,t=0)=>setTimeout(e,1e3*t))((()=>{T(p,i),r(`No response from ${e??"anyone"} to ${i}, `+t)}),o);L(p,i,[e,(e,t)=>{clearTimeout(l),T(p,i),a([e,t,s])}]),b(e,i,t,n)})),A=(e,[t,a])=>{v(t,(([t,a],n)=>{const s=S(e[0],n,E);v(t,(([e,t],a)=>{const n=S(s[0],a,E);v(e,(([e,t],a)=>n[0][a]=G(e,t))),n[1]=R(n[1],t)})),s[1]=R(s[1],a)})),e[1]=R(e[1],a)},H=async(t=null,a,n=w())=>{try{r(a)&&([a,t,n]=await M(null,1,"",n));const[s,o]=a,[i,l]=e.getMergeableContentHashes();let c=E();if(i!=s){const[a,s]=(await M(t,4,e.getMergeableTableHashes(),n))[0];if(c=a,!C(s)){const[a,o]=(await M(t,5,e.getMergeableRowHashes(s),n))[0];if(A(c,a),!C(o)){const a=(await M(t,6,e.getMergeableCellHashes(o),n))[0];A(c,a)}}}return[c,l==o?E():(await M(t,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){u?.(e)}},z=O(e,(async()=>{const e=await H();return!e||C(e[0][0])&&C(e[1][0])?void 0:e}),(async(t,a)=>a?b(null,w(),3,a):b(null,w(),2,e.getMergeableContentHashes())),(e=>d=e),(()=>d=void 0),u,2,{startSync:async e=>(y=1,await(await z.startAutoLoad(e)).startAutoSave()),stopSync:()=>(y=0,z.stopAutoLoad().stopAutoSave()),destroy:()=>(s(),z.stopSync()),getSynchronizerStats:()=>({sends:f,receives:h}),...g},1);return n(((t,a,n,s)=>{const o=y||z.isAutoLoading();h++,c?.(t,a,n,s),0==n?i(D(p,a),(([e,a])=>r(e)||e==t?a(s,t):0)):2==n&&o?H(t,s,a??void 0).then((e=>{d?.(void 0,e)})).catch(u):3==n&&o?d?.(void 0,s):i(1==n&&(y||z.isAutoSaving())?e.getMergeableContentHashes():4==n?e.getMergeableTableDiff(s):5==n?e.getMergeableRowDiff(s):6==n?e.getMergeableCellDiff(s):7==n?e.getMergeableValueDiff(s):void 0,(e=>{b(t,a,0,e)}))})),z}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizers={});
