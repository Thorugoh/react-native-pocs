var e,t;e=this,t=function(e){"use strict";const t=(e,t="",a)=>e.split(t,a),a=Promise,n=globalThis,s=Math,o=s.floor,r=e=>null==e,i=(e,t,a)=>r(e)?a?.():t(e),c=e=>Array.isArray(e),l=e=>e.length,g=e=>{throw Error(e)},u=(e,t)=>e.forEach(t),d=(e,...t)=>e.push(...t),y=e=>e.shift(),h=Object,f=e=>h.getPrototypeOf(e),p=h.entries,w=h.keys,v=h.freeze,b=(e,t)=>u(p(e),(([e,a])=>t(a,e))),C=e=>(e=>!r(e)&&i(f(e),(e=>e==h.prototype||r(f(e))),(()=>!0)))(e)&&0==(e=>l(w(e)))(e),S=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),M=e=>r(e)||0==(e=>e?.size??0)(e),A=(e,t)=>e?.forEach(t),m=(e,t)=>e?.delete(t),T=e=>new Map(e),L=(e,t)=>e?.get(t),H=(e,t,a)=>r(a)?(m(e,t),e):e?.set(t,a),D=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(L(e,t)):H(e,t,a()),L(e,t)},z=(e,t,a,n,s=0)=>i((a?D:L)(e,t[s],s>l(t)-2?a:T),(o=>{if(s>l(t)-2)return n?.(o)&&H(e,t[s]),o;const r=z(o,t,a,n,s+1);return M(o)&&H(e,t[s]),r})),B=(e,t)=>t?[e,t]:[e],E=(e,t)=>((e??"")>(t??"")?e:t)??"",x=(e="")=>B(((e=[])=>h.fromEntries(e))(),e),P=e=>new Set(c(e)||r(e)?e:[e]),R=/^\d+$/,V=T(),j=T(),N=(e,t,a,n,s,o,h,f={},p=0,w=[])=>{let b,S,B,E=0,x=0,N=0;D(V,w,(()=>0)),D(j,w,(()=>[]));const O=T(),[$,k,F,U,q]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!C(e)||!C(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!C(e)||!C(t),t.setContent]:g("Store type not supported by this Persister"))(h,e,p),[G,I,J]=(()=>{let e;const[t,a]=(()=>{const e=[];let t=0;return[a=>(a?y(e):null)??""+t++,t=>{R.test(t)&&l(e)<1e3&&d(e,t)}]})(),n=T();return[(a,s,o,r=[],i=()=>[])=>{e??=ee;const c=t(1);var l,g;return H(n,c,[a,s,o,r,i]),l=z(s,o??[""],P),g=c,l?.add(g),c},(t,a,...s)=>u(((e,t=[""])=>{const a=[],n=(e,s)=>s==l(t)?d(a,e):null===t[s]?A(e,(e=>n(e,s+1))):u([t[s],null],(t=>n(L(e,t),s+1)));return n(e,0),a})(t,a),(t=>A(t,(t=>L(n,t)[0](e,...a??[],...s))))),e=>i(L(n,e),(([,t,s])=>(z(t,s??[""],void 0,(t=>(m(t,e),M(t)?1:0))),H(n,e),a(e),s))),t=>i(L(n,t),(([t,,a=[],n,s])=>{const o=(...i)=>{const c=l(i);c==l(a)?t(e,...i,...s(i)):r(a[c])?u(n[c]?.(...i)??[],(e=>o(...i,e))):o(...i,a[c])};o()}))]})(),K=e=>{e!=E&&(E=e,I(O,void 0,E))},Q=t=>{($&&c(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},W=async e=>(2!=E&&(K(1),x++,await _((async()=>{try{const a=await t();c(a)?Q(a):e?q(e):g("Content is not an array: "+a)}catch(t){o?.(t),e&&q(e)}K(0)}))),ee),X=()=>(S&&(s(S),S=void 0),ee),Y=async e=>(1!=E&&(K(2),N++,await _((async()=>{try{await a(k,e)}catch(e){o?.(e)}K(0)}))),ee),Z=()=>(B&&(e.delListener(B),B=void 0),ee),_=async(...e)=>(d(L(j,w),...e),await(async()=>{if(!L(V,w)){for(H(V,w,1);!r(b=y(L(j,w)));)try{await b()}catch(e){o?.(e)}H(V,w,0)}})(),ee),ee={load:W,startAutoLoad:async e=>{X(),await W(e);try{S=await n((async(e,t)=>{t||e?2!=E&&(K(1),x++,Q(t??e),K(0)):await W()}))}catch(e){o?.(e)}return ee},stopAutoLoad:X,isAutoLoading:()=>!r(S),save:Y,startAutoSave:async()=>(Z(),await Y(),B=e.addDidFinishTransactionListener((()=>{const e=F();U(e)&&Y(e)})),ee),stopAutoSave:Z,isAutoSaving:()=>!r(B),getStatus:()=>E,addStatusListener:e=>G(e,O),delListener:t=>(J(t),e),schedule:_,getStore:()=>e,destroy:()=>(L(j,w).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:x,saves:N}),...f};return v(ee)},O=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),$=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>o(256*s.random()))))(e),k=(e=16)=>{return t=(e,t)=>e+O[63&t],$(new Uint8Array(e)).reduce(t,"");var t};e.createBroadcastChannelSynchronizer=(e,t,n,s,o)=>{const c=k(),l=new BroadcastChannel(t);return((e,t,n,s,o,c,l,g,u={})=>{let d,y=0,h=0,f=0;const p=T(),w=()=>k(11),v=(e,a,n,s)=>{h++,c?.(e,a,n,s),t(e,a,n,s)},M=async(e,t,n,s)=>new a(((a,r)=>{const i=s+"."+k(4),c=((e,t=0)=>setTimeout(e,1e3*t))((()=>{m(p,i),r(`No response from ${e??"anyone"} to ${i}, `+t)}),o);H(p,i,[e,(e,t)=>{clearTimeout(c),m(p,i),a([e,t,s])}]),v(e,i,t,n)})),A=(e,[t,a])=>{b(t,(([t,a],n)=>{const s=S(e[0],n,x);b(t,(([e,t],a)=>{const n=S(s[0],a,x);b(e,(([e,t],a)=>n[0][a]=B(e,t))),n[1]=E(n[1],t)})),s[1]=E(s[1],a)})),e[1]=E(e[1],a)},D=async(t=null,a,n=w())=>{try{r(a)&&([a,t,n]=await M(null,1,"",n));const[s,o]=a,[i,c]=e.getMergeableContentHashes();let l=x();if(i!=s){const[a,s]=(await M(t,4,e.getMergeableTableHashes(),n))[0];if(l=a,!C(s)){const[a,o]=(await M(t,5,e.getMergeableRowHashes(s),n))[0];if(A(l,a),!C(o)){const a=(await M(t,6,e.getMergeableCellHashes(o),n))[0];A(l,a)}}}return[l,c==o?x():(await M(t,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){g?.(e)}},z=N(e,(async()=>{const e=await D();return!e||C(e[0][0])&&C(e[1][0])?void 0:e}),(async(t,a)=>a?v(null,w(),3,a):v(null,w(),2,e.getMergeableContentHashes())),(e=>d=e),(()=>d=void 0),g,2,{startSync:async e=>(y=1,await(await z.startAutoLoad(e)).startAutoSave()),stopSync:()=>(y=0,z.stopAutoLoad().stopAutoSave()),destroy:()=>(s(),z.stopSync()),getSynchronizerStats:()=>({sends:h,receives:f}),...u},1);return n(((t,a,n,s)=>{const o=y||z.isAutoLoading();f++,l?.(t,a,n,s),0==n?i(L(p,a),(([e,a])=>r(e)||e==t?a(s,t):0)):2==n&&o?D(t,s,a??void 0).then((e=>{d?.(void 0,e)})).catch(g):3==n&&o?d?.(void 0,s):i(1==n&&(y||z.isAutoSaving())?e.getMergeableContentHashes():4==n?e.getMergeableTableDiff(s):5==n?e.getMergeableRowDiff(s):6==n?e.getMergeableCellDiff(s):7==n?e.getMergeableValueDiff(s):void 0,(e=>{v(t,a,0,e)}))})),z})(e,((e,t,a,n)=>l.postMessage([c,e,t,a,n])),(e=>{l.onmessage=({data:[t,a,n,s,o]})=>r(a)||a==c?e(t,n,s,o):0}),(()=>{l.close()}),.01,n,s,o,{getChannelName:()=>t})}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerBroadcastChannel={});
