var e,t;e=this,t=function(e){"use strict";const t=(e,t="",a)=>e.split(t,a),a=Promise,n=globalThis,s=(e,t=0)=>setTimeout(e,1e3*t),o=Math,r=o.floor,i=e=>null==e,c=(e,t,a)=>i(e)?a?.():t(e),l=e=>Array.isArray(e),u=e=>e.length,g=e=>{throw Error(e)},d=(e,t)=>e.forEach(t),y=(e,...t)=>e.push(...t),h=e=>e.shift(),f=Object,p=e=>f.getPrototypeOf(e),v=f.entries,w=f.keys,b=f.freeze,S=(e,t)=>d(v(e),(([e,a])=>t(a,e))),M=e=>(e=>!i(e)&&c(p(e),(e=>e==f.prototype||i(p(e))),(()=>!0)))(e)&&0==(e=>u(w(e)))(e),A=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),C=e=>i(e)||0==(e=>e?.size??0)(e),L=(e,t)=>e?.forEach(t),T=(e,t)=>e?.delete(t),m=e=>new Map(e),H=(e,t)=>e?.get(t),D=(e,t,a)=>i(a)?(T(e,t),e):e?.set(t,a),z=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(H(e,t)):D(e,t,a()),H(e,t)},E=(e,t,a,n,s=0)=>c((a?z:H)(e,t[s],s>u(t)-2?a:m),(o=>{if(s>u(t)-2)return n?.(o)&&D(e,t[s]),o;const r=E(o,t,a,n,s+1);return C(o)&&D(e,t[s]),r})),x=(e,t)=>t?[e,t]:[e],P=(e,t)=>((e??"")>(t??"")?e:t)??"",R=(e="")=>x(((e=[])=>f.fromEntries(e))(),e),V=e=>new Set(l(e)||i(e)?e:[e]),j=/^\d+$/,O=m(),$=m(),k=(e,t,a,n,s,o,r,f={},p=0,v=[])=>{let w,S,A,x=0,P=0,R=0;z(O,v,(()=>0)),z($,v,(()=>[]));const k=m(),[B,F,N,U,q]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!M(e)||!M(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!M(e)||!M(t),t.setContent]:g("Store type not supported by this Persister"))(r,e,p),[G,I,J]=(()=>{let e;const[t,a]=(()=>{const e=[];let t=0;return[a=>(a?h(e):null)??""+t++,t=>{j.test(t)&&u(e)<1e3&&y(e,t)}]})(),n=m();return[(a,s,o,r=[],i=()=>[])=>{e??=ee;const c=t(1);var l,u;return D(n,c,[a,s,o,r,i]),l=E(s,o??[""],V),u=c,l?.add(u),c},(t,a,...s)=>d(((e,t=[""])=>{const a=[],n=(e,s)=>s==u(t)?y(a,e):null===t[s]?L(e,(e=>n(e,s+1))):d([t[s],null],(t=>n(H(e,t),s+1)));return n(e,0),a})(t,a),(t=>L(t,(t=>H(n,t)[0](e,...a??[],...s))))),e=>c(H(n,e),(([,t,s])=>(E(t,s??[""],void 0,(t=>(T(t,e),C(t)?1:0))),D(n,e),a(e),s))),t=>c(H(n,t),(([t,,a=[],n,s])=>{const o=(...r)=>{const c=u(r);c==u(a)?t(e,...r,...s(r)):i(a[c])?d(n[c]?.(...r)??[],(e=>o(...r,e))):o(...r,a[c])};o()}))]})(),K=e=>{e!=x&&(x=e,I(k,void 0,x))},Q=t=>{(B&&l(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},W=async e=>(2!=x&&(K(1),P++,await _((async()=>{try{const a=await t();l(a)?Q(a):e?q(e):g("Content is not an array: "+a)}catch(t){o?.(t),e&&q(e)}K(0)}))),ee),X=()=>(S&&(s(S),S=void 0),ee),Y=async e=>(1!=x&&(K(2),R++,await _((async()=>{try{await a(F,e)}catch(e){o?.(e)}K(0)}))),ee),Z=()=>(A&&(e.delListener(A),A=void 0),ee),_=async(...e)=>(y(H($,v),...e),await(async()=>{if(!H(O,v)){for(D(O,v,1);!i(w=h(H($,v)));)try{await w()}catch(e){o?.(e)}D(O,v,0)}})(),ee),ee={load:W,startAutoLoad:async e=>{X(),await W(e);try{S=await n((async(e,t)=>{t||e?2!=x&&(K(1),P++,Q(t??e),K(0)):await W()}))}catch(e){o?.(e)}return ee},stopAutoLoad:X,isAutoLoading:()=>!i(S),save:Y,startAutoSave:async()=>(Z(),await Y(),A=e.addDidFinishTransactionListener((()=>{const e=N();U(e)&&Y(e)})),ee),stopAutoSave:Z,isAutoSaving:()=>!i(A),getStatus:()=>x,addStatusListener:e=>G(e,k),delListener:t=>(J(t),e),schedule:_,getStore:()=>e,destroy:()=>(H($,v).splice(0,void 0),X().stopAutoSave()),getStats:()=>({loads:P,saves:R}),...f};return b(ee)},B=t("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),F=n.crypto?e=>n.crypto.getRandomValues(e):e=>(e=>e.map((()=>r(256*o.random()))))(e),N=(e=16)=>{return t=(e,t)=>e+B[63&t],F(new Uint8Array(e)).reduce(t,"");var t},U=m();e.createLocalSynchronizer=(e,t,n,o)=>{const r=N();return((e,t,n,o,r,l,u,g,d={})=>{let y,h=0,f=0,p=0;const v=m(),w=()=>N(11),b=(e,a,n,s)=>{f++,l?.(e,a,n,s),t(e,a,n,s)},C=async(e,t,n,o)=>new a(((a,i)=>{const c=o+"."+N(4),l=s((()=>{T(v,c),i(`No response from ${e??"anyone"} to ${c}, `+t)}),r);D(v,c,[e,(e,t)=>{clearTimeout(l),T(v,c),a([e,t,o])}]),b(e,c,t,n)})),L=(e,[t,a])=>{S(t,(([t,a],n)=>{const s=A(e[0],n,R);S(t,(([e,t],a)=>{const n=A(s[0],a,R);S(e,(([e,t],a)=>n[0][a]=x(e,t))),n[1]=P(n[1],t)})),s[1]=P(s[1],a)})),e[1]=P(e[1],a)},z=async(t=null,a,n=w())=>{try{i(a)&&([a,t,n]=await C(null,1,"",n));const[s,o]=a,[r,c]=e.getMergeableContentHashes();let l=R();if(r!=s){const[a,s]=(await C(t,4,e.getMergeableTableHashes(),n))[0];if(l=a,!M(s)){const[a,o]=(await C(t,5,e.getMergeableRowHashes(s),n))[0];if(L(l,a),!M(o)){const a=(await C(t,6,e.getMergeableCellHashes(o),n))[0];L(l,a)}}}return[l,c==o?R():(await C(t,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){g?.(e)}},E=k(e,(async()=>{const e=await z();return!e||M(e[0][0])&&M(e[1][0])?void 0:e}),(async(t,a)=>a?b(null,w(),3,a):b(null,w(),2,e.getMergeableContentHashes())),(e=>y=e),(()=>y=void 0),g,2,{startSync:async e=>(h=1,await(await E.startAutoLoad(e)).startAutoSave()),stopSync:()=>(h=0,E.stopAutoLoad().stopAutoSave()),destroy:()=>(o(),E.stopSync()),getSynchronizerStats:()=>({sends:f,receives:p}),...d},1);return n(((t,a,n,s)=>{const o=h||E.isAutoLoading();p++,u?.(t,a,n,s),0==n?c(H(v,a),(([e,a])=>i(e)||e==t?a(s,t):0)):2==n&&o?z(t,s,a??void 0).then((e=>{y?.(void 0,e)})).catch(g):3==n&&o?y?.(void 0,s):c(1==n&&(h||E.isAutoSaving())?e.getMergeableContentHashes():4==n?e.getMergeableTableDiff(s):5==n?e.getMergeableRowDiff(s):6==n?e.getMergeableCellDiff(s):7==n?e.getMergeableValueDiff(s):void 0,(e=>{b(t,a,0,e)}))})),E})(e,((e,t,a,n)=>s((()=>{return i(e)?(s=(e,s)=>e!=r?s(r,t,a,n):0,L(U,((e,t)=>s(t,e)))):H(U,e)?.(r,t,a,n);var s}))),(e=>{D(U,r,e)}),(()=>{T(U,r)}),.01,t,n,o)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerLocal={});
