var e,t;e=this,t=function(e){"use strict";const t="",a=(e,t="",a)=>e.split(t,a),n=Promise,s=globalThis,o=Math,r=o.floor,i=e=>null==e,c=(e,t,a)=>i(e)?a?.():t(e),l=e=>Array.isArray(e),d=(e,t,a)=>e.slice(t,a),u=e=>e.length,g=e=>new n(e),y=e=>{throw Error(e)},f=(e,t)=>e.forEach(t),h=(e,...t)=>e.push(...t),p=e=>e.shift(),v=Object,b=e=>v.getPrototypeOf(e),w=v.entries,S=v.keys,M=v.freeze,C=(e,t)=>f(w(e),(([e,a])=>t(a,e))),A=e=>(e=>!i(e)&&c(b(e),(e=>e==v.prototype||i(b(e))),(()=>!0)))(e)&&0==(e=>u(S(e)))(e),m=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),L=JSON.stringify,T=JSON.parse,E=e=>i(e)||0==(e=>e?.size??0)(e),H=(e,t)=>e?.forEach(t),D=(e,t)=>e?.delete(t),O=e=>new Map(e),z=(e,t)=>e?.get(t),x=(e,t,a)=>i(a)?(D(e,t),e):e?.set(t,a),N=(e,t,a,n)=>{var s,o;return s=e,o=t,s?.has(o)?n?.(z(e,t)):x(e,t,a()),z(e,t)},P=(e,t,a,n,s=0)=>c((a?N:z)(e,t[s],s>u(t)-2?a:O),(o=>{if(s>u(t)-2)return n?.(o)&&x(e,t[s]),o;const r=P(o,t,a,n,s+1);return E(o)&&x(e,t[s]),r})),R=(e,t)=>t?[e,t]:[e],V=(e,t)=>((e??"")>(t??"")?e:t)??"",W=(e="")=>R(((e=[])=>v.fromEntries(e))(),e),j=e=>new Set(l(e)||i(e)?e:[e]),k=/^\d+$/,J=O(),$=O(),B=(e,a,n,s,o,r,d,g={},v=0,b=[])=>{let w,S,C,m=0,L=0,T=0;N(J,b,(()=>0)),N($,b,(()=>[]));const R=O(),[V,W,B,F,U]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!A(e)||!A(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!A(e)||!A(t),t.setContent]:y("Store type not supported by this Persister"))(d,e,v),[q,G,I]=(()=>{let e;const[a,n]=(()=>{const e=[];let a=0;return[n=>(n?p(e):null)??t+a++,t=>{k.test(t)&&u(e)<1e3&&h(e,t)}]})(),s=O();return[(n,o,r,i=[],c=()=>[])=>{e??=te;const l=a(1);var d,u;return x(s,l,[n,o,r,i,c]),d=P(o,r??[t],j),u=l,d?.add(u),l},(a,n,...o)=>f(((e,a=[t])=>{const n=[],s=(e,t)=>t==u(a)?h(n,e):null===a[t]?H(e,(e=>s(e,t+1))):f([a[t],null],(a=>s(z(e,a),t+1)));return s(e,0),n})(a,n),(t=>H(t,(t=>z(s,t)[0](e,...n??[],...o))))),e=>c(z(s,e),(([,a,o])=>(P(a,o??[t],void 0,(t=>(D(t,e),E(t)?1:0))),x(s,e),n(e),o))),t=>c(z(s,t),(([t,,a=[],n,s])=>{const o=(...r)=>{const c=u(r);c==u(a)?t(e,...r,...s(r)):i(a[c])?f(n[c]?.(...r)??[],(e=>o(...r,e))):o(...r,a[c])};o()}))]})(),K=e=>{e!=m&&(m=e,G(R,void 0,m))},Q=t=>{(V&&l(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},X=async e=>(2!=m&&(K(1),L++,await ee((async()=>{try{const t=await a();l(t)?Q(t):e?U(e):y("Content is not an array: "+t)}catch(t){r?.(t),e&&U(e)}K(0)}))),te),Y=()=>(S&&(o(S),S=void 0),te),Z=async e=>(1!=m&&(K(2),T++,await ee((async()=>{try{await n(W,e)}catch(e){r?.(e)}K(0)}))),te),_=()=>(C&&(e.delListener(C),C=void 0),te),ee=async(...e)=>(h(z($,b),...e),await(async()=>{if(!z(J,b)){for(x(J,b,1);!i(w=p(z($,b)));)try{await w()}catch(e){r?.(e)}x(J,b,0)}})(),te),te={load:X,startAutoLoad:async e=>{Y(),await X(e);try{S=await s((async(e,t)=>{t||e?2!=m&&(K(1),L++,Q(t??e),K(0)):await X()}))}catch(e){r?.(e)}return te},stopAutoLoad:Y,isAutoLoading:()=>!i(S),save:Z,startAutoSave:async()=>(_(),await Z(),C=e.addDidFinishTransactionListener((()=>{const e=B();F(e)&&Z(e)})),te),stopAutoSave:_,isAutoSaving:()=>!i(C),getStatus:()=>m,addStatusListener:e=>q(e,R),delListener:t=>(I(t),e),schedule:ee,getStore:()=>e,destroy:()=>(z($,b).splice(0,void 0),Y().stopAutoSave()),getStats:()=>({loads:L,saves:T}),...g};return M(te)},F=a("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),U=s.crypto?e=>s.crypto.getRandomValues(e):e=>(e=>e.map((()=>r(256*o.random()))))(e),q=(e=16)=>{return t=(e,t)=>e+F[63&t],U(new Uint8Array(e)).reduce(t,"");var t};e.createWsSynchronizer=async(e,a,n=1,s,o,r)=>{const l=(e,t)=>(a.addEventListener(e,t),()=>a.removeEventListener(e,t)),u=((e,a,n,s,o,r,l,d,u={})=>{let y,f=0,h=0,p=0;const v=O(),b=()=>q(11),w=(e,t,n,s)=>{h++,r?.(e,t,n,s),a(e,t,n,s)},S=async(e,t,a,n)=>g(((s,r)=>{const i=n+"."+q(4),c=((e,t=0)=>setTimeout(e,1e3*t))((()=>{D(v,i),r(`No response from ${e??"anyone"} to ${i}, `+t)}),o);x(v,i,[e,(e,t)=>{clearTimeout(c),D(v,i),s([e,t,n])}]),w(e,i,t,a)})),M=(e,[t,a])=>{C(t,(([t,a],n)=>{const s=m(e[0],n,W);C(t,(([e,t],a)=>{const n=m(s[0],a,W);C(e,(([e,t],a)=>n[0][a]=R(e,t))),n[1]=V(n[1],t)})),s[1]=V(s[1],a)})),e[1]=V(e[1],a)},L=async(a=null,n,s=b())=>{try{i(n)&&([n,a,s]=await S(null,1,t,s));const[o,r]=n,[c,l]=e.getMergeableContentHashes();let d=W();if(c!=o){const[t,n]=(await S(a,4,e.getMergeableTableHashes(),s))[0];if(d=t,!A(n)){const[t,o]=(await S(a,5,e.getMergeableRowHashes(n),s))[0];if(M(d,t),!A(o)){const t=(await S(a,6,e.getMergeableCellHashes(o),s))[0];M(d,t)}}}return[d,l==r?W():(await S(a,7,e.getMergeableValueHashes(),s))[0],1]}catch(e){d?.(e)}},T=B(e,(async()=>{const e=await L();return!e||A(e[0][0])&&A(e[1][0])?void 0:e}),(async(t,a)=>a?w(null,b(),3,a):w(null,b(),2,e.getMergeableContentHashes())),(e=>y=e),(()=>y=void 0),d,2,{startSync:async e=>(f=1,await(await T.startAutoLoad(e)).startAutoSave()),stopSync:()=>(f=0,T.stopAutoLoad().stopAutoSave()),destroy:()=>(s(),T.stopSync()),getSynchronizerStats:()=>({sends:h,receives:p}),...u},1);return n(((t,a,n,s)=>{const o=f||T.isAutoLoading();p++,l?.(t,a,n,s),0==n?c(z(v,a),(([e,a])=>i(e)||e==t?a(s,t):0)):2==n&&o?L(t,s,a??void 0).then((e=>{y?.(void 0,e)})).catch(d):3==n&&o?y?.(void 0,s):c(1==n&&(f||T.isAutoSaving())?e.getMergeableContentHashes():4==n?e.getMergeableTableDiff(s):5==n?e.getMergeableRowDiff(s):6==n?e.getMergeableCellDiff(s):7==n?e.getMergeableValueDiff(s):void 0,(e=>{w(t,a,0,e)}))})),T})(e,((e,...n)=>a.send(((e,...a)=>{return n=e??t,s=L(a,((e,t)=>void 0===t?"￼":t)),n+"\n"+s;var n,s})(e,...n))),(e=>l("message",(({data:t})=>((e,t)=>(e=>{const a=e.indexOf("\n");var n,s,o;-1!==a&&(n=d(e,0,a),s=d(e,a+1),t(n,...(o=s,T(o,((e,t)=>"￼"===t?void 0:t)))))})(e))(t.toString("utf8"),e)))),(()=>{a.close()}),n,s,o,r,{getWebSocket:()=>a});return g((e=>{if(a.readyState!=a.OPEN){const t=t=>{t&&r?.(t),a(),n(),e(u)},a=l("open",(()=>t())),n=l("error",t)}else e(u)}))}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsClient={});
