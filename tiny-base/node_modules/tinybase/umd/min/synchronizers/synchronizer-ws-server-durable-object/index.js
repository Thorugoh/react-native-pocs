var e,t;e=this,t=function(e,t){"use strict";const s="",a=(e,t="",s)=>e.split(t,s),n=Promise,r=globalThis,o=(e,t=0)=>setTimeout(e,1e3*t),i=Math,c=i.floor,l=e=>null==e,g=(e,t,s)=>l(e)?s?.():t(e),u=e=>Array.isArray(e),d=(e,t,s)=>e.slice(t,s),h=e=>e.length,y=e=>{throw Error(e)},f=(e,t)=>e.forEach(t),b=(e,t)=>e.map(t),w=(e,...t)=>e.push(...t),S=e=>e.shift(),p=Object,v=e=>p.getPrototypeOf(e),C=p.entries,M=p.keys,A=p.freeze,T=(e,t)=>f(C(e),(([e,s])=>t(s,e))),k=e=>(e=>!l(e)&&g(v(e),(e=>e==p.prototype||l(v(e))),(()=>!0)))(e)&&0==(e=>h(M(e)))(e),m=(e,t,s)=>(((e,t)=>t in e)(e,t)||(e[t]=s()),e[t]),x=JSON.stringify,L=JSON.parse,D=(e,t)=>{const s=e.indexOf("\n");-1!==s&&t(d(e,0,s),d(e,s+1))},P=(e,...t)=>O(e??s,x(t,((e,t)=>void 0===t?"￼":t))),O=(e,t)=>e+"\n"+t,I=e=>l(e)||0==(e=>e?.size??0)(e),H=(e,t)=>e?.forEach(t),W=(e,t)=>e?.delete(t),j=e=>new Map(e),R=(e,t)=>e?.get(t),z=(e,t,s)=>l(s)?(W(e,t),e):e?.set(t,s),E=(e,t,s,a)=>{var n,r;return n=e,r=t,n?.has(r)?a?.(R(e,t)):z(e,t,s()),R(e,t)},N=(e,t,s,a,n=0)=>g((s?E:R)(e,t[n],n>h(t)-2?s:j),(r=>{if(n>h(t)-2)return a?.(r)&&z(e,t[n]),r;const o=N(r,t,s,a,n+1);return I(r)&&z(e,t[n]),o})),F=(e,t)=>t?[e,t]:[e],U=(e,t)=>((e??"")>(t??"")?e:t)??"",V=(e="")=>F(((e=[])=>p.fromEntries(e))(),e),q=e=>new Set(u(e)||l(e)?e:[e]),J=/^\d+$/,$=j(),B=j(),G=(e,t,a,n,r,o,i,c={},d=0,b=[])=>{let p,v,C,M=0,T=0,m=0;E($,b,(()=>0)),E(B,b,(()=>[]));const x=j(),[L,D,P,O,F]=((e=1,t,s)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!s),([[e],[t]])=>!k(e)||!k(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!k(e)||!k(t),t.setContent]:y("Store type not supported by this Persister"))(i,e,d),[U,V,G]=(()=>{let e;const[t,a]=(()=>{const e=[];let t=0;return[a=>(a?S(e):null)??s+t++,t=>{J.test(t)&&h(e)<1e3&&w(e,t)}]})(),n=j();return[(a,r,o,i=[],c=()=>[])=>{e??=te;const l=t(1);var g,u;return z(n,l,[a,r,o,i,c]),g=N(r,o??[s],q),u=l,g?.add(u),l},(t,a,...r)=>f(((e,t=[s])=>{const a=[],n=(e,s)=>s==h(t)?w(a,e):null===t[s]?H(e,(e=>n(e,s+1))):f([t[s],null],(t=>n(R(e,t),s+1)));return n(e,0),a})(t,a),(t=>H(t,(t=>R(n,t)[0](e,...a??[],...r))))),e=>g(R(n,e),(([,t,r])=>(N(t,r??[s],void 0,(t=>(W(t,e),I(t)?1:0))),z(n,e),a(e),r))),t=>g(R(n,t),(([t,,s=[],a,n])=>{const r=(...o)=>{const i=h(o);i==h(s)?t(e,...o,...n(o)):l(s[i])?f(a[i]?.(...o)??[],(e=>r(...o,e))):r(...o,s[i])};r()}))]})(),K=e=>{e!=M&&(M=e,V(x,void 0,M))},Q=t=>{(L&&u(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},X=async e=>(2!=M&&(K(1),T++,await ee((async()=>{try{const s=await t();u(s)?Q(s):e?F(e):y("Content is not an array: "+s)}catch(t){e&&F(e)}K(0)}))),te),Y=()=>(v&&(r(v),v=void 0),te),Z=async e=>(1!=M&&(K(2),m++,await ee((async()=>{try{await a(D,e)}catch(e){}K(0)}))),te),_=()=>(C&&(e.delListener(C),C=void 0),te),ee=async(...e)=>(w(R(B,b),...e),await(async()=>{if(!R($,b)){for(z($,b,1);!l(p=S(R(B,b)));)try{await p()}catch(e){}z($,b,0)}})(),te),te={load:X,startAutoLoad:async e=>{Y(),await X(e);try{v=await n((async(e,t)=>{t||e?2!=M&&(K(1),T++,Q(t??e),K(0)):await X()}))}catch(e){}return te},stopAutoLoad:Y,isAutoLoading:()=>!l(v),save:Z,startAutoSave:async()=>(_(),await Z(),C=e.addDidFinishTransactionListener((()=>{const e=P();O(e)&&Z(e)})),te),stopAutoSave:_,isAutoSaving:()=>!l(C),getStatus:()=>M,addStatusListener:e=>U(e,x),delListener:t=>(G(t),e),schedule:ee,getStore:()=>e,destroy:()=>(R(B,b).splice(0,void 0),Y().stopAutoSave()),getStats:()=>({loads:T,saves:m}),...c};return A(te)},K=a("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),Q=r.crypto?e=>r.crypto.getRandomValues(e):e=>b(e,(()=>c(256*i.random()))),X=(e=16)=>{return t=(e,t)=>e+K[63&t],Q(new Uint8Array(e)).reduce(t,"");var t},Y=/\/([^?]*)/,Z="S",_=e=>{return(t=new URL(e.url).pathname,a=Y,t?.match(a))?.[1]??s;var t,a},ee=e=>"websocket"==e.headers.get("upgrade")?.toLowerCase()?e.headers.get("sec-websocket-key"):null,te=(e,t=null,s=null)=>new Response(s,{status:e,webSocket:t}),se=()=>te(426,null,"Upgrade required");class ae extends t.DurableObject{#e;constructor(e,t){super(e,t),this.ctx.blockConcurrencyWhile((async()=>await g(await this.createPersister(),(async e=>{const t=((e,t,a,r,i,c,u,d,h={})=>{let y,f=0,b=0,w=0;const S=j(),p=()=>X(11),v=(e,s,a,n)=>{b++,t(e,s,a,n)},C=async(e,t,s,a)=>new n(((n,r)=>{const c=a+"."+X(4),l=o((()=>{W(S,c),r(`No response from ${e??"anyone"} to ${c}, `+t)}),i);z(S,c,[e,(e,t)=>{clearTimeout(l),W(S,c),n([e,t,a])}]),v(e,c,t,s)})),M=(e,[t,s])=>{T(t,(([t,s],a)=>{const n=m(e[0],a,V);T(t,(([e,t],s)=>{const a=m(n[0],s,V);T(e,(([e,t],s)=>a[0][s]=F(e,t))),a[1]=U(a[1],t)})),n[1]=U(n[1],s)})),e[1]=U(e[1],s)},A=async(t=null,a,n=p())=>{try{l(a)&&([a,t,n]=await C(null,1,s,n));const[r,o]=a,[i,c]=e.getMergeableContentHashes();let g=V();if(i!=r){const[s,a]=(await C(t,4,e.getMergeableTableHashes(),n))[0];if(g=s,!k(a)){const[s,r]=(await C(t,5,e.getMergeableRowHashes(a),n))[0];if(M(g,s),!k(r)){const s=(await C(t,6,e.getMergeableCellHashes(r),n))[0];M(g,s)}}}return[g,c==o?V():(await C(t,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){}},x=G(e,(async()=>{const e=await A();return!e||k(e[0][0])&&k(e[1][0])?void 0:e}),(async(t,s)=>s?v(null,p(),3,s):v(null,p(),2,e.getMergeableContentHashes())),(e=>y=e),(()=>y=void 0),0,2,{startSync:async e=>(f=1,await(await x.startAutoLoad(e)).startAutoSave()),stopSync:()=>(f=0,x.stopAutoLoad().stopAutoSave()),destroy:()=>x.stopSync(),getSynchronizerStats:()=>({sends:b,receives:w}),...h},1);return a(((t,s,a,n)=>{const r=f||x.isAutoLoading();w++,0==a?g(R(S,s),(([e,s])=>l(e)||e==t?s(n,t):0)):2==a&&r?A(t,n,s??void 0).then((e=>{y?.(void 0,e)})).catch(d):3==a&&r?y?.(void 0,n):g(1==a&&(f||x.isAutoSaving())?e.getMergeableContentHashes():4==a?e.getMergeableTableDiff(n):5==a?e.getMergeableRowDiff(n):6==a?e.getMergeableCellDiff(n):7==a?e.getMergeableValueDiff(n):void 0,(e=>{v(t,s,0,e)}))})),x})(e.getStore(),((e,t,s,a)=>this.#t(Z,P(e,t,s,a))),(e=>this.#e=t=>((e,t)=>D(e,((e,s)=>{return t(e,...(a=s,L(a,((e,t)=>"￼"===t?void 0:t))));var a})))(t,e)),0,1);await e.load(),await e.startAutoSave(),o(t.startSync)}))))}fetch(e){const t=_(e);return g(ee(e),(e=>{const[a,n]=(r=new WebSocketPair,p.values(r));var r,o;return o=this.#s(),0==h(o)&&this.onPathId(t,1),this.ctx.acceptWebSocket(n,[e,t]),this.onClientId(t,e,1),n.send(P(Z,null,1,s)),te(101,a)}),se)}webSocketMessage(e,t){g(this.ctx.getTags(e)[0],(s=>this.#t(s,t.toString(),e)))}webSocketClose(e){const[t,s]=this.ctx.getTags(e);this.onClientId(s,t,-1),1==h(this.#s())&&this.onPathId(s,-1)}#t(e,t,a){D(t.toString(),((t,n)=>{const r=O(e,n);this.onMessage(e,t,n),t==s?(e!=Z&&this.#e?.(r),f(this.#s(),(e=>{e!=a&&e.send(r)}))):t==Z?this.#e?.(r):t!=e&&this.#s(t)[0]?.send(r)}))}#s(e){return this.ctx.getWebSockets(e)}createPersister(){}getPathId(){return this.ctx.getTags(this.#s()[0])?.[1]}getClientIds(){return b(this.#s(),(e=>this.ctx.getTags(e)[0]))}onPathId(e,t){}onClientId(e,t,s){}onMessage(e,t,s){}}e.WsServerDurableObject=ae,e.getWsServerDurableObjectFetch=e=>(t,s)=>ee(t)?s[e].get(s[e].idFromName(_(t))).fetch(t):se()},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("cloudflare:workers")):"function"==typeof define&&define.amd?define(["exports","cloudflare:workers"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsServerDurableObject={},e["cloudflare:workers"]);
