var e,t;e=this,t=function(e){"use strict";const t="",a="error",s=(e,t="",a)=>e.split(t,a),n=Promise,o=globalThis,r=Math,i=r.floor,c=e=>null==e,l=(e,t,a)=>c(e)?a?.():t(e),d=e=>Array.isArray(e),u=(e,t,a)=>e.slice(t,a),g=e=>e.length,y=e=>{throw Error(e)},h=(e,t)=>e.forEach(t),f=(e,t,a)=>e.reduce(t,a),v=(e,...t)=>e.push(...t),p=e=>e.shift(),S=Object,w=e=>S.getPrototypeOf(e),b=S.entries,A=S.keys,C=S.freeze,M=(e,t)=>h(b(e),(([e,a])=>t(a,e))),L=e=>(e=>!c(e)&&l(w(e),(e=>e==S.prototype||c(w(e))),(()=>!0)))(e)&&0==(e=>g(A(e)))(e),m=(e,t,a)=>(((e,t)=>t in e)(e,t)||(e[t]=a()),e[t]),T=e=>e?.size??0,H=(D=T,e=>f(O(e),((e,t)=>e+D(t)),0));var D;const k=e=>c(e)||0==T(e),O=e=>[...e?.values()??[]],P=(e,t)=>e?.forEach(t),x=(e,t)=>e?.delete(t),z=e=>new Map(e),E=e=>[...e?.keys()??[]],I=(e,t)=>e?.get(t),N=(e,t,a)=>c(a)?(x(e,t),e):e?.set(t,a),R=(e,t,a,s)=>{var n,o;return n=e,o=t,n?.has(o)?s?.(I(e,t)):N(e,t,a()),I(e,t)},V=(e,t,a,s,n=0)=>l((a?R:I)(e,t[n],n>g(t)-2?a:z),(o=>{if(n>g(t)-2)return s?.(o)&&N(e,t[n]),o;const r=V(o,t,a,s,n+1);return k(o)&&N(e,t[n]),r})),W=JSON.stringify,j=JSON.parse,J=(e,t)=>{const a=e.indexOf("\n");-1!==a&&t(u(e,0,a),u(e,a+1))},$=(e,t)=>e+"\n"+t,B=(e,t)=>t?[e,t]:[e],F=(e,t)=>((e??"")>(t??"")?e:t)??"",U=(e="")=>B(((e=[])=>S.fromEntries(e))(),e),q=e=>new Set(d(e)||c(e)?e:[e]),G=/^\d+$/,K=e=>{let a;const[s,n]=(()=>{const e=[];let a=0;return[s=>(s?p(e):null)??t+a++,t=>{G.test(t)&&g(e)<1e3&&v(e,t)}]})(),o=z();return[(n,r,i,c=[],l=()=>[])=>{a??=e();const d=s(1);var u,g;return N(o,d,[n,r,i,c,l]),u=V(r,i??[t],q),g=d,u?.add(g),d},(e,s,...n)=>h(((e,a=[t])=>{const s=[],n=(e,t)=>t==g(a)?v(s,e):null===a[t]?P(e,(e=>n(e,t+1))):h([a[t],null],(a=>n(I(e,a),t+1)));return n(e,0),s})(e,s),(e=>P(e,(e=>I(o,e)[0](a,...s??[],...n))))),e=>l(I(o,e),(([,a,s])=>(V(a,s??[t],void 0,(t=>(x(t,e),k(t)?1:0))),N(o,e),n(e),s))),e=>l(I(o,e),(([e,,t=[],s,n])=>{const o=(...r)=>{const i=g(r);i==g(t)?e(a,...r,...n(r)):c(t[i])?h(s[i]?.(...r)??[],(e=>o(...r,e))):o(...r,t[i])};o()}))]},Q=z(),X=z(),Y=s("-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz"),Z=o.crypto?e=>o.crypto.getRandomValues(e):e=>(e=>e.map((()=>i(256*r.random()))))(e),_=(e=16)=>f(Z(new Uint8Array(e)),((e,t)=>e+Y[63&t]),""),ee=/\/([^?]*)/;e.createWsServer=(e,s,o)=>{const r=z(),i=z(),u=z(),g=z(),[f,S,w]=K((()=>D)),b=e=>{e[1]?.destroy(),e[2]?.destroy()},A=(e,a,s)=>n=>J(n,((n,o)=>{const r=$(e,o);var i;n===t?("S"!==e&&s[3]?.(r),i=(t,a)=>t!==e?a.send(r):0,P(a,((e,t)=>i(t,e)))):"S"===n?s[3]?.(r):I(a,n)?.send(r)}));e.on("connection",((e,f)=>{return l((w=f.url,T=ee,w?.match(T)),(([,w])=>l(f.headers["sec-websocket-key"],(async f=>{const T=R(u,w,z),H=R(g,w,(()=>[0])),D=A(f,T,H);k(T)&&(S(r,void 0,w,1),await(async(e,a,r)=>l(await(s?.(a)),(a=>{e[0]=1,e[1]=d(a)?a[0]:a;const s=A("S",r,e);e[2]=((e,a,s,o,r,i,u,g,h={})=>{let f,S=0,w=0,b=0;const A=z(),T=()=>_(11),H=(e,t,s,n)=>{w++,a(e,t,s,n)},D=async(e,t,a,s)=>new n(((n,o)=>{const i=s+"."+_(4),c=((e,t=0)=>setTimeout(e,1e3*t))((()=>{x(A,i),o(`No response from ${e??"anyone"} to ${i}, `+t)}),r);N(A,i,[e,(e,t)=>{clearTimeout(c),x(A,i),n([e,t,s])}]),H(e,i,t,a)})),k=(e,[t,a])=>{M(t,(([t,a],s)=>{const n=m(e[0],s,U);M(t,(([e,t],a)=>{const s=m(n[0],a,U);M(e,(([e,t],a)=>s[0][a]=B(e,t))),s[1]=F(s[1],t)})),n[1]=F(n[1],a)})),e[1]=F(e[1],a)},O=async(a=null,s,n=T())=>{try{c(s)&&([s,a,n]=await D(null,1,t,n));const[o,r]=s,[i,l]=e.getMergeableContentHashes();let d=U();if(i!=o){const[t,s]=(await D(a,4,e.getMergeableTableHashes(),n))[0];if(d=t,!L(s)){const[t,o]=(await D(a,5,e.getMergeableRowHashes(s),n))[0];if(k(d,t),!L(o)){const t=(await D(a,6,e.getMergeableCellHashes(o),n))[0];k(d,t)}}}return[d,l==r?U():(await D(a,7,e.getMergeableValueHashes(),n))[0],1]}catch(e){g?.(e)}},P=((e,t,a,s,n,o,r,i={},l=0,u=[])=>{let g,h,f,S=0,w=0,b=0;R(Q,u,(()=>0)),R(X,u,(()=>[]));const A=z(),[M,m,T,H,D]=((e=1,t,a)=>1!=e&&t.isMergeable()?[1,t.getMergeableContent,()=>t.getTransactionMergeableChanges(!a),([[e],[t]])=>!L(e)||!L(t),t.setDefaultContent]:2!=e?[0,t.getContent,t.getTransactionChanges,([e,t])=>!L(e)||!L(t),t.setContent]:y("Store type not supported by this Persister"))(r,e,l),[k,O,P]=K((()=>B)),x=e=>{e!=S&&(S=e,O(A,void 0,S))},E=t=>{(M&&d(t?.[0])?1===t?.[2]?e.applyMergeableChanges:e.setMergeableContent:1===t?.[2]?e.applyChanges:e.setContent)(t)},V=async e=>(2!=S&&(x(1),w++,await $((async()=>{try{const a=await t();d(a)?E(a):e?D(e):y("Content is not an array: "+a)}catch(t){o?.(t),e&&D(e)}x(0)}))),B),W=()=>(h&&(n(h),h=void 0),B),j=async e=>(1!=S&&(x(2),b++,await $((async()=>{try{await a(m,e)}catch(e){o?.(e)}x(0)}))),B),J=()=>(f&&(e.delListener(f),f=void 0),B),$=async(...e)=>(v(I(X,u),...e),await(async()=>{if(!I(Q,u)){for(N(Q,u,1);!c(g=p(I(X,u)));)try{await g()}catch(e){o?.(e)}N(Q,u,0)}})(),B),B={load:V,startAutoLoad:async e=>{W(),await V(e);try{h=await s((async(e,t)=>{t||e?2!=S&&(x(1),w++,E(t??e),x(0)):await V()}))}catch(e){o?.(e)}return B},stopAutoLoad:W,isAutoLoading:()=>!c(h),save:j,startAutoSave:async()=>(J(),await j(),f=e.addDidFinishTransactionListener((()=>{const e=T();H(e)&&j(e)})),B),stopAutoSave:J,isAutoSaving:()=>!c(f),getStatus:()=>S,addStatusListener:e=>k(e,A),delListener:t=>(P(t),e),schedule:$,getStore:()=>e,destroy:()=>(I(X,u).splice(0,void 0),W().stopAutoSave()),getStats:()=>({loads:w,saves:b}),...i};return C(B)})(e,(async()=>{const e=await O();return!e||L(e[0][0])&&L(e[1][0])?void 0:e}),(async(t,a)=>a?H(null,T(),3,a):H(null,T(),2,e.getMergeableContentHashes())),(e=>f=e),(()=>f=void 0),g,2,{startSync:async e=>(S=1,await(await P.startAutoLoad(e)).startAutoSave()),stopSync:()=>(S=0,P.stopAutoLoad().stopAutoSave()),destroy:()=>P.stopSync(),getSynchronizerStats:()=>({sends:w,receives:b}),...h},1);return s(((t,a,s,n)=>{const o=S||P.isAutoLoading();b++,0==s?l(I(A,a),(([e,a])=>c(e)||e==t?a(n,t):0)):2==s&&o?O(t,n,a??void 0).then((e=>{f?.(void 0,e)})).catch(g):3==s&&o?f?.(void 0,n):l(1==s&&(S||P.isAutoSaving())?e.getMergeableContentHashes():4==s?e.getMergeableTableDiff(n):5==s?e.getMergeableRowDiff(n):6==s?e.getMergeableCellDiff(n):7==s?e.getMergeableValueDiff(n):void 0,(e=>{H(t,a,0,e)}))})),P})(e[1].getStore(),((e,a,n,o)=>s(((e,...a)=>$(e??t,W(a,((e,t)=>void 0===t?"￼":t))))(e,a,n,o))),(t=>e[3]=e=>((e,t)=>J(e,((e,a)=>{return t(e,...(s=a,j(s,((e,t)=>"￼"===t?void 0:t))));var s})))(e,t)),0,1,0,0,o),e[4]=[],e[5]=d(a)?a[1]:e=>0})))(H,w,T)),N(T,f,e),S(i,[w],f,1),e.on("message",(e=>{const t=e.toString("utf8");0==H[0]?D(t):v(H[4],t)})),1==H[0]&&(await(async e=>{e[0]=2,await e[1].schedule(e[1].startAutoLoad,e[1].startAutoSave,e[2].startSync),e[5](e[1].getStore()),e[0]=0})(H),h(H[4],D),H[4]=[]),e.on("close",(()=>{x(T,f),S(i,[w],f,-1),k(T)&&(b(H),x(g,w),x(u,w),S(r,void 0,w,-1))})),o&&e.on(a,o)}))));var w,T})),o&&e.on(a,o);const D={getWebSocketServer:()=>e,getPathIds:()=>E(u),getClientIds:e=>E(I(u,e)),addPathIdsListener:e=>f(e,r),addClientIdsListener:(e,t)=>f(t,i,[e]),delListener:e=>(w(e),D),getStats:()=>({paths:T(u),clients:H(u)}),destroy:()=>{u.clear(),P(g,b),e.close()}};return C(D)}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBaseSynchronizerWsServer={});
